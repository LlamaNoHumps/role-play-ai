<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²æ‰®æ¼”AI</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            width: 100%;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            overflow: hidden;
        }

        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow: hidden;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #34495e;
            flex-shrink: 0;
        }

        .create-role-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .create-role-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .recent-chats {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .recent-chats h3 {
            margin-bottom: 15px;
            color: #bdc3c7;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-item:hover {
            background: #34495e;
        }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            font-size: 12px;
            color: #95a5a6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .no-chats {
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
            padding: 20px;
            font-style: italic;
        }

        /* å³ä¾§ä¸»è¦å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ  */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item.logout {
            color: #e74c3c;
        }

        .dropdown-item.logout:hover {
            background-color: #ffeaea;
        }

        .welcome-text {
            font-size: 16px;
            color: #2c3e50;
        }

        .login-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
        }

        .search-container {
            position: relative;
        }

        .search-input {
            padding: 10px 16px;
            padding-right: 40px;
            border: 2px solid #ecf0f1;
            border-radius: 20px;
            outline: none;
            width: 300px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #7f8c8d;
        }

        /* è§’è‰²å¡ç‰‡åŒºåŸŸ */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .role-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .role-image {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            font-weight: bold;
        }

        .role-info {
            padding: 15px;
            flex: 1;
            /* ç¡®ä¿å†…å®¹å‚ç›´æ’åˆ—ï¼šåå­—åœ¨ä¸Šï¼Œæè¿°åœ¨ä¸‹ */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .role-actions {
            padding: 0 15px 15px 15px;
            display: flex;
            justify-content: flex-end;
        }

        .chat-role-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .chat-role-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .role-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            /* ç¡®ä¿æ–‡å­—æ°´å¹³æ˜¾ç¤º */
            writing-mode: horizontal-tb;
            text-orientation: mixed;
            /* é™åˆ¶æ˜¾ç¤º1è¡Œï¼Œå¤šä½™æ–‡å­—æ˜¾ç¤ºçœç•¥å· */
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.2em * 1);
            /* 1è¡Œçš„é«˜åº¦ */
        }

        .role-description {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.4;
            /* é™åˆ¶æ˜¾ç¤º5è¡Œï¼Œå¤šä½™æ–‡å­—æ˜¾ç¤ºçœç•¥å· */
            display: -webkit-box;
            -webkit-line-clamp: 5;
            line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.4em * 5);
            /* 5è¡Œçš„é«˜åº¦ */
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #7f8c8d;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 18px;
            margin-bottom: 20px;
        }

        /* ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .auth-modal {
            background: white;
            border-radius: 16px;
            width: 420px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 30px 30px 20px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .auth-tabs {
            display: flex;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #7f8c8d;
        }

        .auth-tab.active {
            background: white;
            color: #2c3e50;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-body {
            padding: 20px 30px 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .form-input.error {
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview-text {
            font-size: 24px;
            color: #7f8c8d;
        }

        .avatar-actions {
            display: flex;
            gap: 10px;
        }

        .avatar-btn {
            padding: 8px 16px;
            border: 1px solid #3498db;
            border-radius: 6px;
            background: white;
            color: #3498db;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .avatar-btn:hover {
            background: #3498db;
            color: white;
        }

        .avatar-btn.primary {
            background: #3498db;
            color: white;
        }

        .avatar-btn.primary:hover {
            background: #2980b9;
        }

        .default-avatars {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .default-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 20px;
        }

        .default-avatar:hover {
            transform: scale(1.1);
            border-color: #3498db;
        }

        .default-avatar.selected {
            border-color: #3498db;
            transform: scale(1.1);
        }

        #avatarInput {
            display: none;
        }

        .auth-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }

        .auth-submit:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }

        /* åˆ›å»ºè§’è‰²é¡µé¢ */
        .create-role-page {
            display: none;
        }

        .create-role-page.active {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
        }

        .create-role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .back-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .back-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(127, 140, 141, 0.3);
        }

        .create-role-content {
            flex: 1;
            padding: 30px;
            display: flex;
            justify-content: center;
            background: white;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .role-form {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            position: relative;
            z-index: 1;
            overflow: visible;
            box-sizing: border-box;
        }

        .role-form * {
            box-sizing: border-box;
        }

        .role-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border-radius: 12px;
            z-index: -1;
        }

        .role-avatar-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .role-avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #ecf0f1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .role-avatar-preview:hover {
            border-color: #3498db;
            transform: scale(1.05);
        }

        .role-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .role-avatar-text {
            font-size: 48px;
            color: #7f8c8d;
        }

        .avatar-upload-hint {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .role-avatar-preview:hover .avatar-upload-hint {
            opacity: 1;
        }

        .role-default-avatars {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 15px;
            justify-items: center;
        }

        .role-default-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 24px;
        }

        .role-default-avatar:hover {
            transform: scale(1.1);
            border-color: #3498db;
        }

        .role-default-avatar.selected {
            border-color: #3498db;
            border-width: 3px;
            transform: scale(1.1);
        }

        .role-input-group {
            margin-bottom: 25px;
        }

        .role-input-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .role-input-main {
            flex: 1;
        }

        .auto-fill-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 28px;
        }

        .auto-fill-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .auto-fill-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .role-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }

        .role-textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .role-textarea.error {
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }

        .create-submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            margin-bottom: 30px;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
            position: relative;
            z-index: 10;
        }

        .create-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.5);
            background: linear-gradient(135deg, #229954, #27ae60);
        }

        .create-submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(189, 195, 199, 0.3);
        }

        .role-select-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .role-radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .role-radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            accent-color: #3498db;
            cursor: pointer;
        }

        .radio-label {
            font-size: 14px;
            color: #2c3e50;
            cursor: pointer;
        }

        .role-radio-option:hover .radio-label {
            color: #3498db;
        }

        #roleAvatarInput {
            display: none;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            .sidebar {
                width: 100%;
                height: 200px;
                flex-shrink: 0;
            }

            .main-content {
                flex: 1;
                overflow: hidden;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .search-input {
                width: 100%;
            }

            .roles-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .content-area {
                padding: 20px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .auth-modal {
                width: 95vw;
            }

            .modal-body {
                padding: 15px 20px 25px;
            }

            .modal-header {
                padding: 20px 20px 15px;
            }
        }

        /* æ–°èŠå¤©é¡µé¢æ ·å¼ */
        .chat-content {
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* æ˜ç¡®è®¾ç½®é«˜åº¦ */
        }

        .chat-messages {
            padding: 20px 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            height: calc(100vh - 160px);
            /* è°ƒæ•´ï¼šå¤´éƒ¨çº¦80px + è¾“å…¥æ¡†çº¦80px */
            max-height: calc(100vh - 160px);
            /* ç¡®ä¿ä¸ä¼šè¶…è¿‡è®¾å®šé«˜åº¦ */
            flex-shrink: 0;
            /* é˜²æ­¢è¢«å‹ç¼© */
            box-sizing: border-box;
            /* åŒ…å«paddingåœ¨å†… */
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 70%;
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message.role {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .message-avatar.role {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .message.role .message-content {
            background: white;
            color: #2c3e50;
        }

        .message-voice {
            margin-top: 8px;
            min-width: 250px;
            /* ç¡®ä¿æœ€å°å®½åº¦è¶³å¤Ÿæ˜¾ç¤ºå®Œæ•´æ§ä»¶ */
        }

        .message-voice audio {
            width: 100%;
            min-width: 250px;
            /* éŸ³é¢‘æ§ä»¶æœ€å°å®½åº¦ */
            max-width: 400px;
            /* å¢åŠ æœ€å¤§å®½åº¦ */
            height: 36px;
            /* å¢åŠ é«˜åº¦ï¼Œè®©æ§ä»¶æ›´å®¹æ˜“æ“ä½œ */
            border-radius: 8px;
            /* æ·»åŠ åœ†è§’ */
            background-color: linear-gradient(135deg, #3498db, #2980b9);
            /* æ·»åŠ èƒŒæ™¯è‰² */
            outline: none;
            /* å»é™¤ç„¦ç‚¹è½®å»“ */
        }

        .message-voice audio::-webkit-media-controls-panel {
            background-color: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 8px;
        }

        /* ç”¨æˆ·å‘é€çš„è¯­éŸ³æ¶ˆæ¯å³å¯¹é½ */
        .message.user .message-voice {
            text-align: right;
        }

        /* åŒ…å«è¯­éŸ³çš„æ¶ˆæ¯å®¹å™¨éœ€è¦æ›´å¤§çš„æœ€å°å®½åº¦ */
        .message-content:has(.message-voice),
        .message-content.has-voice {
            min-width: 280px !important;
        }

        /* ç¡®ä¿æ‰€æœ‰æ¶ˆæ¯å®¹å™¨éƒ½æœ‰åŸºæœ¬çš„æœ€å°å®½åº¦ */
        .message-content {
            min-width: 180px;
        }

        /* è¯­éŸ³æ¶ˆæ¯çš„æ–‡æœ¬æ ·å¼ */
        .message-text {
            margin-bottom: 4px;
        }

        .message-text:last-child {
            margin-bottom: 0;
        }

        /* è¯­éŸ³æ¶ˆæ¯æ ‡è¯†æ–‡æœ¬çš„æ ·å¼ */
        .message.has-voice .message-text {
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .message.user.has-voice .message-text {
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-input {
            padding: 15px 30px;
            background: white;
            border-top: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.4;
            overflow-y: auto;
        }

        .message-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .voice-btn,
        .send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .voice-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .send-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .voice-btn:hover,
        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            text-align: center;
        }

        .chat-empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .chat-empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .chat-empty-hint {
            font-size: 14px;
            opacity: 0.7;
        }

        .role-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-avatar-chat {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .role-avatar-chat img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .role-name-chat {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* å¯¹è¯é¡µé¢æ ·å¼ */
        .chat-page {
            display: none;
            width: 100%;
            height: 100vh;
            background: #ecf0f1;
        }

        .chat-page.active {
            display: flex;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .role-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-avatar-chat {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .role-avatar-chat img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .role-name-chat {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .chat-back-btn {
            margin-left: auto;
            padding: 8px 16px;
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-back-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 70%;
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message.role {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .message-avatar.role {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .message.role .message-content {
            background: white;
            color: #2c3e50;
        }

        .message-time {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: center;
        }

        .chat-input {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.4;
            overflow-y: auto;
        }

        .message-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .voice-btn:active {
            transform: scale(0.95);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* èŠå¤©è®°å½•ä¸ºç©ºæ—¶çš„æç¤º */
        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            text-align: center;
        }

        .chat-empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .chat-empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .chat-empty-hint {
            font-size: 14px;
            opacity: 0.7;
        }

        /* æœ€è¿‘å¯¹è¯è§’è‰²åˆ—è¡¨ */
        .recent-roles {
            flex: 1;
            overflow-y: auto;
            padding-top: 10px;
        }

        /* æœ€è¿‘èŠå¤©è§’è‰²é¡¹æ ·å¼ */
        .recent-role-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 5px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
        }

        .recent-role-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .recent-role-item.active {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .recent-role-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            flex-shrink: 0;
            margin-right: 12px;
        }

        .recent-role-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .recent-role-info {
            flex: 1;
            min-width: 0;
        }

        .recent-role-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-role-desc {
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            .create-role-page.active {
                width: 100%;
                height: 100vh;
            }

            .create-role-header {
                padding: 15px 20px;
            }

            .create-role-content {
                padding: 20px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .role-form {
                max-width: 100%;
                padding: 20px;
                position: relative;
                z-index: 1;
                overflow: visible;
                box-sizing: border-box;
            }

            .role-form::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                border-radius: 12px;
                z-index: -1;
            }

            .role-select-group {
                flex-direction: column;
                gap: 10px;
            }

            .chat-content {
                height: 100%;
            }

            .chat-messages {
                padding: 15px;
                height: calc(100vh - 120px);
                /* ç§»åŠ¨ç«¯å›ºå®šé«˜åº¦ */
                max-height: calc(100vh - 120px);
                /* ç¡®ä¿ä¸ä¼šè¶…è¿‡è®¾å®šé«˜åº¦ */
                flex-shrink: 0;
                /* é˜²æ­¢è¢«å‹ç¼© */
                box-sizing: border-box;
                /* åŒ…å«paddingåœ¨å†… */
            }

            .message {
                max-width: 85%;
            }

            .chat-header {
                padding: 10px 15px;
            }

            .role-avatar-chat {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .role-name-chat {
                font-size: 18px;
            }

            .message-avatar {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }

            .message-input {
                font-size: 16px;
                padding: 10px 16px;
            }

            .voice-btn,
            .send-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="create-role-btn" onclick="createRole()">
                    <span>â•</span>
                    åˆ›å»ºè§’è‰²
                </button>
            </div>

            <div class="recent-chats">
                <h3>æœ€è¿‘å¯¹è¯</h3>
                <div id="chatList">
                    <div class="no-chats">ç™»å½•åæŸ¥çœ‹å¯¹è¯è®°å½•</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ä¸»è¦å†…å®¹åŒº -->
        <div class="main-content">
            <!-- é¡¶éƒ¨æ  -->
            <div class="header">
                <div class="user-info" id="userInfo">
                    <!-- å·²ç™»å½•çŠ¶æ€ -->
                    <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">ç”¨</div>
                    <span class="welcome-text" id="welcomeText">æ¬¢è¿ï¼Œç”¨æˆ·å</span>

                    <!-- ç”¨æˆ·ä¸‹æ‹‰èœå• -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="showUserProfile()">ä¸ªäººèµ„æ–™</div>
                        <div class="dropdown-item logout" onclick="logout()">é€€å‡ºç™»å½•</div>
                    </div>

                    <!-- æœªç™»å½•çŠ¶æ€ -->
                    <!-- <button class="login-btn" onclick="login()">ç™»å½•</button> -->
                </div>

                <div class="search-container">
                    <input type="text" class="search-input" placeholder="æœç´¢è§’è‰²..." id="searchInput"
                        oninput="searchRoles()">
                    <button class="search-btn">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- è§’è‰²å¡ç‰‡åŒºåŸŸ -->
            <div class="content-area">
                <div class="roles-grid" id="rolesGrid">
                    <!-- ç¤ºä¾‹è§’è‰²å¡ç‰‡ -->
                    <div class="role-card" onclick="selectRole('princess')">
                        <div class="role-image">ğŸ‘‘</div>
                        <div class="role-info">
                            <div class="role-name">è‰¾è‰å¨…å…¬ä¸»</div>
                            <div class="role-description">æ¥è‡ªé­”æ³•ç‹å›½çš„ä¼˜é›…å…¬ä¸»ï¼Œå–„è‰¯èªæ…§ï¼Œæ‹¥æœ‰å¼ºå¤§çš„é­”æ³•åŠ›é‡</div>
                        </div>
                    </div>

                    <div class="role-card" onclick="selectRole('assistant')">
                        <div class="role-image">ğŸ¤–</div>
                        <div class="role-info">
                            <div class="role-name">æ™ºèƒ½åŠ©æ‰‹</div>
                            <div class="role-description">ä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨è§£å†³å„ç§é—®é¢˜å’Œæä¾›å»ºè®®</div>
                        </div>
                    </div>

                    <div class="role-card" onclick="selectRole('catgirl')">
                        <div class="role-image">ğŸ±</div>
                        <div class="role-info">
                            <div class="role-name">çŒ«å¨˜å¥³ä»†</div>
                            <div class="role-description">å¯çˆ±çš„çŒ«å¨˜å¥³ä»†ï¼Œæ¸©æŸ”ä½“è´´ï¼Œä¼šç…§é¡¾ä¸»äººçš„æ—¥å¸¸ç”Ÿæ´»</div>
                        </div>
                    </div>

                    <div class="role-card" onclick="selectRole('detective')">
                        <div class="role-image">ğŸ•µï¸</div>
                        <div class="role-info">
                            <div class="role-name">åä¾¦æ¢</div>
                            <div class="role-description">æ•é”çš„è§‚å¯ŸåŠ›å’Œé€»è¾‘æ€ç»´ï¼Œæ“…é•¿è§£å†³å„ç§ç¥ç§˜æ¡ˆä»¶</div>
                        </div>
                    </div>

                    <div class="role-card" onclick="selectRole('wizard')">
                        <div class="role-image">ğŸ§™â€â™‚ï¸</div>
                        <div class="role-info">
                            <div class="role-name">å¤è€æ³•å¸ˆ</div>
                            <div class="role-description">æ‹¥æœ‰åƒå¹´æ™ºæ…§çš„æ³•å¸ˆï¼ŒæŒæ¡ç€å¤è€è€Œå¼ºå¤§çš„é­”æ³•çŸ¥è¯†</div>
                        </div>
                    </div>

                    <div class="role-card" onclick="selectRole('teacher')">
                        <div class="role-image">ğŸ‘©â€ğŸ«</div>
                        <div class="role-info">
                            <div class="role-name">æ¸©æŸ”è€å¸ˆ</div>
                            <div class="role-description">è€å¿ƒæ¸©å’Œçš„è€å¸ˆï¼Œæ“…é•¿æ•™å­¦å’Œå¼•å¯¼å­¦ç”Ÿæ€è€ƒ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ›å»ºè§’è‰²é¡µé¢ -->
            <div class="create-role-page" id="createRolePage">
                <div class="create-role-header">
                    <h2 class="page-title">åˆ›å»ºæ–°è§’è‰²</h2>
                    <button class="back-btn" onclick="backToHome()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 6L9.207 7.293a1 1 0 0 0 0 1.414L11.5 10l-.707.707L9.207 9.121a1 1 0 0 0-1.414 0L6.207 10.707L5.5 10l2.293-1.586a1 1 0 0 0 0-1.414L5.5 6l.707-.707L7.793 6.879a1 1 0 0 0 1.414 0L11.5 5.293 11.5 6z" />
                        </svg>
                        è¿”å›
                    </button>
                </div>

                <div class="create-role-content">
                    <form class="role-form" id="roleForm">
                        <!-- è§’è‰²å¤´åƒéƒ¨åˆ† -->
                        <div class="role-avatar-section">
                            <div class="role-avatar-preview" id="roleAvatarPreview" onclick="uploadRoleAvatar()">
                                <div class="role-avatar-text">ğŸ­</div>
                                <div class="avatar-upload-hint">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</div>
                            </div>
                            <input type="file" id="roleAvatarInput" accept="image/*"
                                onchange="handleRoleAvatarUpload(event)">

                            <div class="role-default-avatars">
                                <div class="role-default-avatar selected" data-avatar="ğŸ­"
                                    onclick="chooseRoleDefaultAvatar('ğŸ­')">ğŸ­</div>
                                <div class="role-default-avatar" data-avatar="ğŸ‘‘"
                                    onclick="chooseRoleDefaultAvatar('ğŸ‘‘')">ğŸ‘‘</div>
                                <div class="role-default-avatar" data-avatar="ğŸ¦¸"
                                    onclick="chooseRoleDefaultAvatar('ğŸ¦¸')">ğŸ¦¸</div>
                                <div class="role-default-avatar" data-avatar="ğŸ§™"
                                    onclick="chooseRoleDefaultAvatar('ğŸ§™')">ğŸ§™</div>
                                <div class="role-default-avatar" data-avatar="ğŸ±"
                                    onclick="chooseRoleDefaultAvatar('ğŸ±')">ğŸ±</div>
                                <div class="role-default-avatar" data-avatar="ğŸ¤–"
                                    onclick="chooseRoleDefaultAvatar('ğŸ¤–')">ğŸ¤–</div>
                                <div class="role-default-avatar" data-avatar="ğŸ¦„"
                                    onclick="chooseRoleDefaultAvatar('ğŸ¦„')">ğŸ¦„</div>
                                <div class="role-default-avatar" data-avatar="ğŸ¶"
                                    onclick="chooseRoleDefaultAvatar('ğŸ¶')">ğŸ¶</div>
                                <div class="role-default-avatar" data-avatar="ğŸ¦Š"
                                    onclick="chooseRoleDefaultAvatar('ğŸ¦Š')">ğŸ¦Š</div>
                                <div class="role-default-avatar" data-avatar="ğŸ¼"
                                    onclick="chooseRoleDefaultAvatar('ğŸ¼')">ğŸ¼</div>
                                <div class="role-default-avatar" data-avatar="ğŸ‘¨â€ğŸ“"
                                    onclick="chooseRoleDefaultAvatar('ğŸ‘¨â€ğŸ“')">ğŸ‘¨â€ğŸ“</div>
                                <div class="role-default-avatar" data-avatar="ğŸ‘©â€ğŸ«"
                                    onclick="chooseRoleDefaultAvatar('ğŸ‘©â€ğŸ«')">ğŸ‘©â€ğŸ«</div>
                            </div>
                        </div>

                        <!-- è§’è‰²åç§° -->
                        <div class="role-input-group">
                            <div class="role-input-row">
                                <div class="role-input-main">
                                    <label class="form-label" for="roleName">è§’è‰²åç§°</label>
                                    <input type="text" id="roleName" class="form-input" placeholder="è¯·è¾“å…¥è§’è‰²åç§°"
                                        maxlength="50">
                                    <div class="error-message" id="roleNameError"></div>
                                </div>
                                <button type="button" class="auto-fill-btn" onclick="autoFillDescription()"
                                    id="autoFillBtn">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path
                                            d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM4.5 9a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM4 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 0 1h-4z" />
                                    </svg>
                                    è‡ªåŠ¨å¡«å†™
                                </button>
                            </div>
                        </div>

                        <!-- è§’è‰²æè¿° -->
                        <div class="role-input-group">
                            <label class="form-label" for="roleDescription">è§’è‰²æè¿°</label>
                            <textarea id="roleDescription" class="role-textarea" placeholder="è¯·æè¿°è§’è‰²çš„èƒŒæ™¯ã€æ€§æ ¼ã€å¤–è²Œç­‰åŸºæœ¬ä¿¡æ¯..."
                                maxlength="500"></textarea>
                            <div class="error-message" id="roleDescriptionError"></div>
                        </div>

                        <!-- è§’è‰²ç‰¹ç‚¹ -->
                        <div class="role-input-group">
                            <label class="form-label" for="roleTraits">è§’è‰²ç‰¹ç‚¹</label>
                            <textarea id="roleTraits" class="role-textarea" placeholder="è¯·æè¿°è§’è‰²çš„ç‰¹ç‚¹ã€æŠ€èƒ½ã€çˆ±å¥½ã€è¯´è¯é£æ ¼ç­‰..."
                                maxlength="500"></textarea>
                            <div class="error-message" id="roleTraitsError"></div>
                        </div>

                        <!-- è§’è‰²æ€§åˆ« -->
                        <div class="role-input-group">
                            <label class="form-label">è§’è‰²æ€§åˆ«</label>
                            <div class="role-select-group">
                                <label class="role-radio-option">
                                    <input type="radio" name="roleGender" value="male" id="genderMale" checked>
                                    <span class="radio-label">ç”·æ€§</span>
                                </label>
                                <label class="role-radio-option">
                                    <input type="radio" name="roleGender" value="female" id="genderFemale">
                                    <span class="radio-label">å¥³æ€§</span>
                                </label>
                            </div>
                        </div>

                        <!-- è¯­éŸ³ç±»å‹ -->
                        <div class="role-input-group">
                            <label class="form-label">è¯­éŸ³ç±»å‹</label>
                            <div class="role-select-group">
                                <label class="role-radio-option">
                                    <input type="radio" name="roleVoiceType" value="mature" id="voiceMature" checked>
                                    <span class="radio-label">æˆç†Ÿ</span>
                                </label>
                                <label class="role-radio-option">
                                    <input type="radio" name="roleVoiceType" value="young" id="voiceYoung">
                                    <span class="radio-label">å¹´è½»</span>
                                </label>
                            </div>
                        </div>

                        <!-- åˆ›å»ºæŒ‰é’® -->
                        <button type="submit" class="create-submit-btn" id="createSubmitBtn">åˆ›å»ºè§’è‰²</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- èŠå¤©é¡µé¢ -->
        <div class="create-role-page" id="chatPageNew">
            <div class="create-role-header">
                <h2 class="page-title" id="currentRoleNameNew">é€‰æ‹©ä¸€ä¸ªè§’è‰²å¼€å§‹å¯¹è¯</h2>
                <button class="back-btn" onclick="backToHome()">è¿”å›ä¸»é¡µ</button>
            </div>

            <div class="chat-content">
                <div class="chat-messages" id="chatMessagesNew">
                    <div class="chat-empty" id="chatEmptyNew">
                        <div class="chat-empty-icon">ğŸ’¬</div>
                        <div class="chat-empty-text">è¿˜æ²¡æœ‰èŠå¤©è®°å½•</div>
                        <div class="chat-empty-hint">é€‰æ‹©ä¸€ä¸ªè§’è‰²å¼€å§‹æœ‰è¶£çš„å¯¹è¯å§ï¼</div>
                    </div>
                </div>

                <div class="chat-input">
                    <textarea class="message-input" id="messageInputNew" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"
                        onkeydown="handleInputKeydown(event)" oninput="adjustTextareaHeight(this)"></textarea>
                    <button class="voice-btn" id="voiceBtnNew" onclick="startVoiceInput()" title="è¯­éŸ³è¾“å…¥">
                        ğŸ¤
                    </button>
                    <button class="send-btn" id="sendBtnNew" onclick="sendMessage()" title="å‘é€æ¶ˆæ¯" disabled>
                        â¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="authModal">
        <div class="auth-modal">
            <button class="modal-close" onclick="closeAuthModal()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                </svg>
            </button>

            <div class="modal-header">
                <h2 class="modal-title">æ¬¢è¿æ¥åˆ°è§’è‰²æ‰®æ¼”AI</h2>
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchTab('login')" id="loginTab">ç™»å½•</button>
                    <button class="auth-tab" onclick="switchTab('register')" id="registerTab">æ³¨å†Œ</button>
                </div>
            </div>

            <div class="modal-body">
                <!-- ç™»å½•è¡¨å• -->
                <form id="loginForm" style="display: block;">
                    <div class="form-group">
                        <label class="form-label" for="loginUsername">ç”¨æˆ·å</label>
                        <input type="text" id="loginUsername" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        <div class="error-message" id="loginUsernameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="loginPassword">å¯†ç </label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç ">
                        <div class="error-message" id="loginPasswordError"></div>
                    </div>

                    <button type="submit" class="auth-submit" id="loginSubmit">ç™»å½•</button>
                </form>

                <!-- æ³¨å†Œè¡¨å• -->
                <form id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="registerUsername">ç”¨æˆ·å</label>
                        <input type="text" id="registerUsername" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        <div class="error-message" id="registerUsernameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="registerPassword">å¯†ç </label>
                        <input type="password" id="registerPassword" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç ">
                        <div class="error-message" id="registerPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                        <div class="error-message" id="confirmPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ç”¨æˆ·å¤´åƒ</label>
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="avatarPreview">
                                <div class="avatar-preview-text">ğŸ‘¤</div>
                            </div>
                            <div class="avatar-actions">
                                <button type="button" class="avatar-btn" onclick="selectDefaultAvatar()">é€‰æ‹©é»˜è®¤å¤´åƒ</button>
                                <button type="button" class="avatar-btn primary" onclick="uploadAvatar()">ä¸Šä¼ å¤´åƒ</button>
                            </div>
                            <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarUpload(event)">
                        </div>

                        <div class="default-avatars" id="defaultAvatars" style="display: none;">
                            <div class="default-avatar" data-avatar="ğŸ‘¤" onclick="chooseDefaultAvatar('ğŸ‘¤')">ğŸ‘¤</div>
                            <div class="default-avatar" data-avatar="ğŸ­" onclick="chooseDefaultAvatar('ğŸ­')">ğŸ­</div>
                            <div class="default-avatar" data-avatar="ğŸ¦„" onclick="chooseDefaultAvatar('ğŸ¦„')">ğŸ¦„</div>
                            <div class="default-avatar" data-avatar="ğŸ±" onclick="chooseDefaultAvatar('ğŸ±')">ğŸ±</div>
                            <div class="default-avatar" data-avatar="ğŸ¶" onclick="chooseDefaultAvatar('ğŸ¶')">ğŸ¶</div>
                            <div class="default-avatar" data-avatar="ğŸ¦Š" onclick="chooseDefaultAvatar('ğŸ¦Š')">ğŸ¦Š</div>
                            <div class="default-avatar" data-avatar="ğŸ¼" onclick="chooseDefaultAvatar('ğŸ¼')">ğŸ¼</div>
                            <div class="default-avatar" data-avatar="ğŸ¯" onclick="chooseDefaultAvatar('ğŸ¯')">ğŸ¯</div>
                        </div>
                    </div>

                    <button type="submit" class="auth-submit" id="registerSubmit">æ³¨å†Œ</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ====== Socket.IO èŠå¤©ç³»ç»Ÿ ======
        let socket = null;

        // åˆå§‹åŒ–Socket.IOè¿æ¥
        function initSocket() {
            console.log('åˆå§‹åŒ–Socket.IOè¿æ¥...');

            // æ£€æŸ¥å½“å‰URLå’Œåè®®
            console.log('å½“å‰URL:', window.location.href);
            console.log('åè®®:', window.location.protocol);

            // æ˜ç¡®æŒ‡å®šSocket.IOæœåŠ¡å™¨åœ°å€
            socket = io({
                autoConnect: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5,
                timeout: 20000
            });

            console.log('Socket.IOé…ç½®å®Œæˆ');

            // è¿æ¥æˆåŠŸ
            socket.on('connect', () => {
                console.log('Socketè¿æ¥æˆåŠŸ:', socket.id);
                console.log('Socketè¿æ¥çŠ¶æ€:', socket.connected);
                console.log('Socketå¯¹è±¡:', socket);

                // æµ‹è¯•å‘é€ä¸€ä¸ªç®€å•æ¶ˆæ¯
                setTimeout(() => {
                    console.log('å‘é€æµ‹è¯•æ¶ˆæ¯...');
                    socket.emit('test', { test: 'hello from frontend' });
                }, 1000);
            });

            // è¿æ¥æ–­å¼€
            socket.on('disconnect', (reason) => {
                console.log('Socketè¿æ¥æ–­å¼€, åŸå› :', reason);
            });

            // æ¥æ”¶æ¥è‡ªåç«¯çš„æ¶ˆæ¯
            socket.on('message', (data) => {
                console.log('=== æ¥æ”¶åˆ°messageäº‹ä»¶ ===');
                console.log('æ¶ˆæ¯æ•°æ®:', data);
                console.log('æ•°æ®ç±»å‹:', typeof data);
                console.log('========================');
                handleReceivedMessage(data);
                hideTypingIndicator(); // æ”¶åˆ°å›å¤åéšè—"æ­£åœ¨å›å¤"çŠ¶æ€
            });

            // æ¥æ”¶è¯­éŸ³è½¬æ–‡å­—æ›´æ–°äº‹ä»¶
            socket.on('update_message', (data) => {
                console.log('=== æ¥æ”¶åˆ°update_messageäº‹ä»¶ ===');
                console.log('æ›´æ–°æ•°æ®:', data);
                console.log('==============================');
                handleMessageUpdate(data);
            });

            // è¿æ¥é”™è¯¯å¤„ç†
            socket.on('connect_error', (error) => {
                console.error('Socketè¿æ¥é”™è¯¯:', error);
            });

            // ç›‘å¬æ‰€æœ‰äº‹ä»¶ï¼ˆè°ƒè¯•ç”¨ï¼‰
            socket.onAny((event, ...args) => {
                console.log('=== Socketäº‹ä»¶ ===');
                console.log('äº‹ä»¶å:', event);
                console.log('å‚æ•°:', args);
                console.log('æ—¶é—´:', new Date().toLocaleTimeString());
                console.log('================');
            });

            // é¢å¤–ç›‘å¬ä¸€äº›å¯èƒ½çš„äº‹ä»¶åç§°
            socket.on('msg', (data) => {
                console.log('æ”¶åˆ°msgäº‹ä»¶:', data);
            });

            socket.on('response', (data) => {
                console.log('æ”¶åˆ°responseäº‹ä»¶:', data);
            });

            // å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
            setInterval(() => {
                if (socket) {
                    console.log('SocketçŠ¶æ€æ£€æŸ¥ - è¿æ¥:', socket.connected, 'ID:', socket.id);
                }
            }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // å‘é€æ¶ˆæ¯åˆ°åç«¯
        function sendSocketMessage(userId, roleId, text) {
            if (!socket) {
                console.error('Socketæœªåˆå§‹åŒ–');
                return;
            }

            if (!socket.connected) {
                console.error('Socketæœªè¿æ¥');
                return;
            }

            const messageData = {
                user_id: parseInt(userId),
                role_id: parseInt(roleId),
                timestamp: Date.now(),
                text: text
            };

            console.log('=== å‘é€æ¶ˆæ¯ ===');
            console.log('Socket ID:', socket.id);
            console.log('Socketè¿æ¥çŠ¶æ€:', socket.connected);
            console.log('æ¶ˆæ¯æ•°æ®:', messageData);
            console.log('===============');

            socket.emit('message', messageData);
        }

        // å‘é€è¯­éŸ³æ¶ˆæ¯åˆ°åç«¯
        function sendVoiceMessage(userId, roleId, voiceUrl, messageId) {
            if (!socket) {
                console.error('Socketæœªåˆå§‹åŒ–');
                return;
            }

            if (!socket.connected) {
                console.error('Socketæœªè¿æ¥');
                return;
            }

            const messageData = {
                user_id: parseInt(userId),
                role_id: parseInt(roleId),
                timestamp: Date.now(),
                voice_url: voiceUrl,
                id: messageId
            };

            console.log('=== å‘é€è¯­éŸ³æ¶ˆæ¯ ===');
            console.log('Socket ID:', socket.id);
            console.log('Socketè¿æ¥çŠ¶æ€:', socket.connected);
            console.log('è¯­éŸ³æ¶ˆæ¯æ•°æ®:', messageData);
            console.log('=================');

            socket.emit('voice', messageData);
        }

        // å¤„ç†æ¶ˆæ¯æ›´æ–°ï¼ˆè¯­éŸ³è½¬æ–‡å­—ï¼‰
        function handleMessageUpdate(data) {
            console.log('å¤„ç†æ¶ˆæ¯æ›´æ–°:', data);

            if (!data.id || !data.text) {
                console.error('æ¶ˆæ¯æ›´æ–°æ•°æ®ä¸å®Œæ•´:', data);
                return;
            }

            // æŸ¥æ‰¾å¯¹åº”IDçš„æ¶ˆæ¯å¹¶æ›´æ–°æ–‡æœ¬
            const messageIndex = chatMessages.findIndex(msg => msg.id === data.id);
            if (messageIndex !== -1) {
                chatMessages[messageIndex].message = data.text;
                console.log('æ¶ˆæ¯æ–‡æœ¬å·²æ›´æ–°:', chatMessages[messageIndex]);
                renderChatMessages();
                showTypingIndicator(); // æ˜¾ç¤º"æ­£åœ¨å›å¤"çŠ¶æ€
            } else {
                console.error('æ‰¾ä¸åˆ°å¯¹åº”IDçš„æ¶ˆæ¯:', data.id);
            }
        }

        // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        function handleReceivedMessage(data) {
            console.log('å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯:', data);
            console.log('å½“å‰èŠå¤©è§’è‰²:', currentChatRole);

            if (!currentChatRole) {
                console.log('æ²¡æœ‰å½“å‰èŠå¤©è§’è‰²ï¼Œå¿½ç•¥æ¶ˆæ¯');
                return;
            }

            const currentRoleId = parseInt(currentChatRole.id);
            const messageRoleId = parseInt(data.role_id);
            console.log('è§’è‰²IDæ¯”è¾ƒ:', { currentRoleId, messageRoleId });

            if (currentRoleId !== messageRoleId) {
                console.log('æ¶ˆæ¯è§’è‰²ä¸åŒ¹é…ï¼Œå¿½ç•¥', {
                    current: currentRoleId,
                    received: messageRoleId
                });
                return;
            }

            console.log('æ¶ˆæ¯éªŒè¯é€šè¿‡ï¼Œæ·»åŠ åˆ°èŠå¤©è®°å½•');

            // æ·»åŠ è§’è‰²æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const message = {
                id: ++messageIdCounter, // ä¸ºæ¥æ”¶åˆ°çš„æ¶ˆæ¯ä¹Ÿæ·»åŠ ID
                sender: 'role',
                message: data.text,
                timestamp: new Date(data.timestamp),
                voice: data.voice_url
            };

            chatMessages.push(message);
            console.log('æ¶ˆæ¯å·²æ·»åŠ ï¼Œé‡æ–°æ¸²æŸ“ç•Œé¢');
            renderChatMessages();
        }

        // ç”¨æˆ·çŠ¶æ€ç®¡ç†
        let isLoggedIn = false; // æ”¹ä¸ºæœªç™»å½•çŠ¶æ€
        let currentUser = {
            id: "",
            name: "",
            avatar: ""
        };

        // å½“å‰é€‰æ‹©çš„å¤´åƒ
        let selectedAvatar = 'ğŸ‘¤';
        let selectedAvatarType = 'default'; // 'default' æˆ– 'custom'
        let customAvatarFile = null;

        // SHA-256 å“ˆå¸Œå‡½æ•°
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // è§’è‰²æ•°æ®
        let roles = [];

        // åŠ è½½è§’è‰²åˆ—è¡¨
        async function loadRoles() {
            try {
                const response = await fetch('/api/role/list', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('è§’è‰²åˆ—è¡¨æ•°æ®:', data);
                    if (Array.isArray(data)) {
                        roles = data.map(role => ({
                            id: String(role.role_id), // ç¡®ä¿IDå§‹ç»ˆæ˜¯å­—ç¬¦ä¸²
                            name: role.name,
                            description: role.description,
                            traits: role.traits,
                            image_url: role.image_url,
                            // å…¼å®¹æ€§ï¼šå¦‚æœimage_urlæ˜¯emojiï¼Œè®¾ç½®emojiå­—æ®µ
                            emoji: isEmoji(role.image_url) ? role.image_url : null
                        }));
                    } else {
                        console.warn('è§’è‰²åˆ—è¡¨æ ¼å¼é”™è¯¯ï¼ŒæœŸæœ›æ•°ç»„ä½†æ”¶åˆ°:', data);
                        roles = [];
                    }
                } else {
                    console.warn('è·å–è§’è‰²åˆ—è¡¨å¤±è´¥:', response.status);
                    // å¦‚æœæœªç™»å½•æˆ–APIä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤è§’è‰²æ•°æ®
                    roles = getDefaultRoles();
                }
            } catch (error) {
                console.error('åŠ è½½è§’è‰²åˆ—è¡¨é”™è¯¯:', error);
                // ç½‘ç»œé”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤è§’è‰²æ•°æ®
                roles = getDefaultRoles();
            }
        }

        // è·å–è§’è‰²è¯¦æƒ…
        async function getRoleDetails(roleId) {
            try {
                const response = await fetch(`/api/role/details?role_id=${parseInt(roleId)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return {
                        name: data.name,
                        description: data.description,
                        traits: data.traits,
                        image_url: data.image_url
                    };
                } else {
                    console.warn('è·å–è§’è‰²è¯¦æƒ…å¤±è´¥:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('è·å–è§’è‰²è¯¦æƒ…é”™è¯¯:', error);
                return null;
            }
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºemoji
        function isEmoji(str) {
            if (!str || str.length > 4) return false;
            const emojiRegex = /^[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F900}-\u{1F9FF}]|[\u{1F018}-\u{1F270}]$/u;
            return emojiRegex.test(str);
        }

        // è·å–é»˜è®¤è§’è‰²æ•°æ®ï¼ˆä½œä¸ºfallbackï¼‰
        function getDefaultRoles() {
            return [
                {
                    id: 'princess',
                    name: 'è‰¾è‰å¨…å…¬ä¸»',
                    emoji: 'ğŸ‘‘',
                    image_url: 'ğŸ‘‘',
                    description: 'æ¥è‡ªé­”æ³•ç‹å›½çš„ä¼˜é›…å…¬ä¸»ï¼Œå–„è‰¯èªæ…§ï¼Œæ‹¥æœ‰å¼ºå¤§çš„é­”æ³•åŠ›é‡',
                    traits: 'ä¼˜é›…ã€å–„è‰¯ã€èªæ…§ã€é­”æ³•'
                },
                {
                    id: 'assistant',
                    name: 'æ™ºèƒ½åŠ©æ‰‹',
                    emoji: 'ğŸ¤–',
                    image_url: 'ğŸ¤–',
                    description: 'ä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨è§£å†³å„ç§é—®é¢˜å’Œæä¾›å»ºè®®',
                    traits: 'ä¸“ä¸šã€é«˜æ•ˆã€æœ‰å¸®åŠ©ã€æ™ºèƒ½'
                },
                {
                    id: 'catgirl',
                    name: 'çŒ«å¨˜å¥³ä»†',
                    emoji: 'ğŸ±',
                    image_url: 'ğŸ±',
                    description: 'å¯çˆ±çš„çŒ«å¨˜å¥³ä»†ï¼Œæ¸©æŸ”ä½“è´´ï¼Œä¼šç…§é¡¾ä¸»äººçš„æ—¥å¸¸ç”Ÿæ´»',
                    traits: 'å¯çˆ±ã€æ¸©æŸ”ã€ä½“è´´ã€å¿ è¯š'
                },
                {
                    id: 'detective',
                    name: 'åä¾¦æ¢',
                    emoji: 'ğŸ•µï¸',
                    image_url: 'ğŸ•µï¸',
                    description: 'æ•é”çš„è§‚å¯ŸåŠ›å’Œé€»è¾‘æ€ç»´ï¼Œæ“…é•¿è§£å†³å„ç§ç¥ç§˜æ¡ˆä»¶',
                    traits: 'æ•é”ã€é€»è¾‘ã€æ¨ç†ã€ç¥ç§˜'
                },
                {
                    id: 'wizard',
                    name: 'å¤è€æ³•å¸ˆ',
                    emoji: 'ğŸ§™â€â™‚ï¸',
                    image_url: 'ğŸ§™â€â™‚ï¸',
                    description: 'æ‹¥æœ‰åƒå¹´æ™ºæ…§çš„æ³•å¸ˆï¼ŒæŒæ¡ç€å¤è€è€Œå¼ºå¤§çš„é­”æ³•çŸ¥è¯†',
                    traits: 'æ™ºæ…§ã€ç¥ç§˜ã€å¼ºå¤§ã€å¤è€'
                },
                {
                    id: 'teacher',
                    name: 'æ¸©æŸ”è€å¸ˆ',
                    emoji: 'ğŸ‘©â€ğŸ«',
                    image_url: 'ğŸ‘©â€ğŸ«',
                    description: 'è€å¿ƒæ¸©å’Œçš„è€å¸ˆï¼Œæ“…é•¿æ•™å­¦å’Œå¼•å¯¼å­¦ç”Ÿæ€è€ƒ',
                    traits: 'è€å¿ƒã€æ¸©å’Œã€æ•™å­¦ã€å¼•å¯¼'
                }
            ];
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initPage() {
            // åˆå§‹åŒ–Socket.IOè¿æ¥
            initSocket();

            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„tokenï¼Œå°è¯•æ¢å¤ç™»å½•çŠ¶æ€
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const response = await fetch('/api/auth/verify', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        isLoggedIn = true;
                        currentUser = {
                            id: userData.user_id,
                            name: userData.username,
                            avatar: userData.avatar
                        };
                    } else {
                        // Tokenæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
                        localStorage.removeItem('authToken');
                        isLoggedIn = false;
                    }
                } catch (error) {
                    console.error('éªŒè¯tokenå¤±è´¥:', error);
                    localStorage.removeItem('authToken');
                    isLoggedIn = false;
                }
            }

            updateUserInfo();
            await loadRoles();
            renderRoles(roles);

            // å¦‚æœå·²ç™»å½•ï¼ŒåŠ è½½æœ€è¿‘å¯¹è¯
            if (isLoggedIn) {
                await loadRecentChats();
            }

            // ä»URLé”šç‚¹æ¢å¤é¡µé¢çŠ¶æ€
            restoreFromUrlHash();
        }

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            if (isLoggedIn) {
                // åˆ¤æ–­å¤´åƒæ ¼å¼ï¼šURLã€base64æˆ–è¡¨æƒ…ç¬¦å·
                let avatarElement;
                if (currentUser.avatar.startsWith('http') || currentUser.avatar.startsWith('/')) {
                    // å›¾ç‰‡URL
                    avatarElement = `<img src="${currentUser.avatar}" alt="ç”¨æˆ·å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else if (currentUser.avatar.startsWith('data:image')) {
                    // base64æ ¼å¼
                    avatarElement = `<img src="${currentUser.avatar}" alt="ç”¨æˆ·å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    // è¡¨æƒ…ç¬¦å·
                    avatarElement = currentUser.avatar;
                }

                userInfo.innerHTML = `
                    <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">${avatarElement}</div>
                    <span class="welcome-text">æ¬¢è¿ï¼Œ${currentUser.name}</span>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="showUserProfile()">ä¸ªäººèµ„æ–™</div>
                        <div class="dropdown-item logout" onclick="logout()">é€€å‡ºç™»å½•</div>
                    </div>
                `;
            } else {
                userInfo.innerHTML = `
                    <button class="login-btn" onclick="login()">ç™»å½•</button>
                `;
            }
        }

        // ç”¨æˆ·ä¸‹æ‹‰èœå•æ§åˆ¶
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // æ˜¾ç¤ºç”¨æˆ·èµ„æ–™ï¼ˆæš‚æ—¶ç”¨alertä»£æ›¿ï¼‰
        function showUserProfile() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');
            alert('ä¸ªäººèµ„æ–™åŠŸèƒ½å¾…å®ç°');
        }

        // é€€å‡ºç™»å½•
        function logout() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');

            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('authToken');

            // é‡ç½®ç™»å½•çŠ¶æ€
            isLoggedIn = false;
            currentUser = { id: null, name: '', avatar: '' };

            // æ›´æ–°UI
            updateUserInfo();

            // é‡æ–°åŠ è½½é¡µé¢æ•°æ®
            loadRoles();
            document.getElementById('chatList').innerHTML = '<div class="no-chats">ç™»å½•åæŸ¥çœ‹å¯¹è¯è®°å½•</div>';

            // å¦‚æœå½“å‰åœ¨èŠå¤©é¡µé¢ï¼Œè¿”å›ä¸»é¡µ
            if (currentPage === 'chat') {
                backToHome();
            }

            alert('å·²é€€å‡ºç™»å½•');
        }

        // æ¸²æŸ“è§’è‰²å¡ç‰‡
        function renderRoles(rolesToRender) {
            const rolesGrid = document.getElementById('rolesGrid');
            if (rolesToRender.length === 0) {
                rolesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">ğŸ”</div>
                        <div class="empty-text">æš‚æ— è§’è‰²</div>
                    </div>
                `;
                return;
            }

            rolesGrid.innerHTML = rolesToRender.map(role => {
                // å¤„ç†è§’è‰²å›¾ç‰‡æ˜¾ç¤º
                let roleImageContent = '';
                if (role.image_url) {
                    if (isEmoji(role.image_url)) {
                        // å¦‚æœæ˜¯emojiï¼Œç›´æ¥æ˜¾ç¤º
                        roleImageContent = role.image_url;
                    } else {
                        // å¦‚æœæ˜¯URLï¼Œæ˜¾ç¤ºå›¾ç‰‡
                        roleImageContent = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                    }
                } else if (role.emoji) {
                    // å…¼å®¹æ—§çš„emojiå­—æ®µ
                    roleImageContent = role.emoji;
                } else {
                    // é»˜è®¤å¤´åƒ
                    roleImageContent = 'ğŸ­';
                }

                return `
                    <div class="role-card">
                        <div class="role-image" onclick="selectRole('${role.id}')">${roleImageContent}</div>
                        <div class="role-info" onclick="selectRole('${role.id}')">
                            <div class="role-name">${role.name}</div>
                            <div class="role-description">${role.description}</div>
                        </div>
                        <div class="role-actions">
                            <button class="chat-role-btn" onclick="event.stopPropagation(); startChatWithRole('${role.id}')" title="å¼€å§‹å¯¹è¯">
                                ğŸ’¬
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æœç´¢è§’è‰²
        async function searchRoles() {
            const searchTerm = document.getElementById('searchInput').value.trim();

            if (!searchTerm) {
                // å¦‚æœæœç´¢è¯ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰è§’è‰²
                renderRoles(roles);
                return;
            }

            try {
                // è°ƒç”¨åç«¯æœç´¢æ¥å£
                const response = await fetch(`/api/role/search?q=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const searchResults = await response.json();
                    const formattedResults = searchResults.map(role => ({
                        id: String(role.role_id), // ç¡®ä¿IDæ˜¯å­—ç¬¦ä¸²
                        name: role.name,
                        description: role.description,
                        traits: role.traits,
                        image_url: role.image_url,
                        gender: role.gender,
                        voice_type: role.voice_type
                    }));
                    renderRoles(formattedResults);
                } else {
                    console.warn('æœç´¢è¯·æ±‚å¤±è´¥:', response.status);
                    // é™çº§åˆ°å®¢æˆ·ç«¯æœç´¢
                    const filteredRoles = roles.filter(role =>
                        role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        role.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (role.traits && role.traits.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                    renderRoles(filteredRoles);
                }
            } catch (error) {
                console.error('æœç´¢é”™è¯¯:', error);
                // é™çº§åˆ°å®¢æˆ·ç«¯æœç´¢
                const filteredRoles = roles.filter(role =>
                    role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    role.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (role.traits && role.traits.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                renderRoles(filteredRoles);
            }
        }

        // å½“å‰é¡µé¢çŠ¶æ€
        let currentPage = 'home'; // 'home', 'create-role', 'chat'
        let currentChatRoleId = null; // å½“å‰èŠå¤©çš„è§’è‰²ID
        let pendingAction = null; // ç™»å½•åéœ€è¦æ‰§è¡Œçš„æ“ä½œ

        // è®¾ç½®ç™»å½•åéœ€è¦æ‰§è¡Œçš„æ“ä½œ
        function setPendingAction(action, params = null) {
            pendingAction = {
                action: action,
                params: params
            };
            console.log('è®¾ç½®ç™»å½•åå¾…æ‰§è¡Œæ“ä½œ:', pendingAction);
        }

        // æ‰§è¡Œç™»å½•åçš„å¾…å¤„ç†æ“ä½œ
        function executePendingAction() {
            if (!pendingAction) return;

            console.log('æ‰§è¡Œç™»å½•åå¾…å¤„ç†æ“ä½œ:', pendingAction);
            const { action, params } = pendingAction;

            // æ¸…é™¤å¾…å¤„ç†æ“ä½œ
            pendingAction = null;

            // æ‰§è¡Œå¯¹åº”çš„æ“ä½œ
            switch (action) {
                case 'createRole':
                    showCreateRolePage();
                    break;
                case 'selectRole':
                    if (params && params.roleId) {
                        startChatWithRole(params.roleId);
                    }
                    break;
                case 'openChat':
                    if (params && params.roleId) {
                        openChatDirect(params.roleId);
                    }
                    break;
                case 'startChatWithRole':
                    if (params && params.roleId) {
                        startChatWithRole(params.roleId);
                    }
                    break;
                default:
                    console.warn('æœªçŸ¥çš„å¾…å¤„ç†æ“ä½œ:', action);
                    break;
            }
        }

        // æ›´æ–°URLé”šç‚¹
        function updateUrlHash() {
            let hash = '';
            switch (currentPage) {
                case 'create-role':
                    hash = '#create-role';
                    break;
                case 'chat':
                    if (currentChatRoleId) {
                        hash = `#chat/${currentChatRoleId}`;
                    } else {
                        hash = '#chat';
                    }
                    break;
                case 'home':
                default:
                    hash = '#home';
                    break;
            }
            console.log('æ›´æ–°URLé”šç‚¹:', hash);
            window.location.hash = hash;
        }

        // ä»URLé”šç‚¹æ¢å¤é¡µé¢çŠ¶æ€
        function restoreFromUrlHash() {
            const hash = window.location.hash.substring(1); // ç§»é™¤ # ç¬¦å·
            console.log('ä»URLé”šç‚¹æ¢å¤é¡µé¢çŠ¶æ€:', hash);

            if (!hash) {
                backToHome();
                return;
            }

            const parts = hash.split('/');
            const page = parts[0];

            switch (page) {
                case 'create-role':
                    showCreateRolePage();
                    break;
                case 'chat':
                    const roleId = parts[1];
                    if (roleId && isLoggedIn) {
                        // åªæœ‰åœ¨ç™»å½•çŠ¶æ€ä¸‹æ‰æ¢å¤èŠå¤©é¡µé¢
                        showChatPage(roleId);
                    } else if (!isLoggedIn) {
                        // æœªç™»å½•æ—¶è·³è½¬åˆ°ä¸»é¡µ
                        backToHome();
                    } else {
                        // æ²¡æœ‰è§’è‰²IDï¼Œæ˜¾ç¤ºèŠå¤©é¡µé¢ä½†ä¸åŠ è½½ç‰¹å®šå¯¹è¯
                        showChatPage(null);
                    }
                    break;
                case 'home':
                default:
                    backToHome();
                    break;
            }
        }

        // ç›‘å¬æµè§ˆå™¨å‰è¿›åé€€äº‹ä»¶
        window.addEventListener('hashchange', function () {
            console.log('æ£€æµ‹åˆ°é”šç‚¹å˜åŒ–');
            restoreFromUrlHash();
        });

        // è§’è‰²åˆ›å»ºç›¸å…³å˜é‡
        let selectedRoleAvatar = 'ğŸ­';
        let selectedRoleAvatarType = 'default';
        let customRoleAvatarFile = null;

        // åˆ›å»ºè§’è‰²
        function createRole() {
            if (!isLoggedIn) {
                setPendingAction('createRole');
                showAuthModal();
                return;
            }
            showCreateRolePage();
        }

        // æ˜¾ç¤ºåˆ›å»ºè§’è‰²é¡µé¢
        function showCreateRolePage() {
            currentPage = 'create-role';
            currentChatRoleId = null;

            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('chatPageNew').classList.remove('active');
            document.getElementById('createRolePage').classList.add('active');

            // é‡ç½®è¡¨å•ï¼Œç¡®ä¿æ¯æ¬¡æ‰“å¼€éƒ½æ˜¯å¹²å‡€çš„
            resetRoleForm();

            // åªåœ¨å½“å‰URLä¸æ˜¯create-roleæ—¶æ‰æ›´æ–°é”šç‚¹
            if (window.location.hash !== '#create-role') {
                updateUrlHash();
            }
        }

        // é‡ç½®è§’è‰²è¡¨å•
        function resetRoleForm() {
            document.getElementById('roleForm').reset();
            selectedRoleAvatar = 'ğŸ­';
            selectedRoleAvatarType = 'default';
            customRoleAvatarFile = null;
            updateRoleAvatarPreview();
            clearErrors(['roleNameError', 'roleDescriptionError', 'roleTraitsError']);

            // é‡ç½®é»˜è®¤å¤´åƒé€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.role-default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector('[data-avatar="ğŸ­"]').classList.add('selected');
        }

        // è§’è‰²å¤´åƒç›¸å…³å‡½æ•°
        function uploadRoleAvatar() {
            document.getElementById('roleAvatarInput').click();
        }

        function handleRoleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MBé™åˆ¶
                    alert('å¤´åƒæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }

                customRoleAvatarFile = file;
                selectedRoleAvatarType = 'custom';

                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedRoleAvatar = e.target.result;
                    updateRoleAvatarPreview();
                };
                reader.readAsDataURL(file);

                // æ¸…é™¤é»˜è®¤å¤´åƒé€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.role-default-avatar').forEach(el => {
                    el.classList.remove('selected');
                });
            }
        }

        function chooseRoleDefaultAvatar(avatar) {
            selectedRoleAvatar = avatar;
            selectedRoleAvatarType = 'default';
            customRoleAvatarFile = null;
            updateRoleAvatarPreview();

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.role-default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-avatar="${avatar}"]`).classList.add('selected');
        }

        function updateRoleAvatarPreview() {
            const preview = document.getElementById('roleAvatarPreview');
            if (selectedRoleAvatarType === 'custom') {
                preview.innerHTML = `
                    <img src="${selectedRoleAvatar}" alt="è§’è‰²å¤´åƒ">
                    <div class="avatar-upload-hint">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
                `;
            } else {
                preview.innerHTML = `
                    <div class="role-avatar-text">${selectedRoleAvatar}</div>
                    <div class="avatar-upload-hint">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</div>
                `;
            }
        }

        // è‡ªåŠ¨å¡«å†™æè¿°å’Œç‰¹ç‚¹
        let currentAutoFillController = null; // ç”¨äºå­˜å‚¨å½“å‰è¯·æ±‚çš„controller

        async function autoFillDescription() {
            const roleName = document.getElementById('roleName').value.trim();

            if (!roleName) {
                showError('roleNameError', 'è¯·å…ˆè¾“å…¥è§’è‰²åç§°');
                return;
            }

            const btn = document.getElementById('autoFillBtn');
            const originalHTML = btn.innerHTML;

            // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ï¼Œå…ˆå–æ¶ˆå®ƒ
            if (currentAutoFillController) {
                currentAutoFillController.abort();
            }

            // åˆ›å»ºæ–°çš„AbortController
            currentAutoFillController = new AbortController();

            // æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºç”Ÿæˆä¸­ï¼Œå¹¶æ·»åŠ å–æ¶ˆåŠŸèƒ½
            btn.onclick = () => {
                if (currentAutoFillController) {
                    currentAutoFillController.abort();
                    currentAutoFillController = null;
                }
                resetAutoFillButton(btn, originalHTML);
            };
            btn.innerHTML = `
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <circle cx="8" cy="8" r="3" opacity="0.3"/>
                    <path d="M8 0 A8 8 0 0 1 8 16 A8 8 0 0 1 8 0" opacity="0.8">
                        <animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" values="0 8 8;360 8 8"/>
                    </path>
                </svg>
                ç”Ÿæˆä¸­... (ç‚¹å‡»å–æ¶ˆ)
            `;

            try {
                // è·å–å½“å‰å·²å¡«å†™çš„å†…å®¹ï¼ˆå¯é€‰ï¼‰
                const currentDescription = document.getElementById('roleDescription').value.trim();
                const currentTraits = document.getElementById('roleTraits').value.trim();
                const gender = document.querySelector('input[name="roleGender"]:checked').value;
                const voiceType = document.querySelector('input[name="roleVoiceType"]:checked').value;

                // è°ƒç”¨AIç”Ÿæˆæ¥å£ï¼Œä¸è®¾ç½®è¶…æ—¶é™åˆ¶
                const response = await fetch('/api/role/auto-fill', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: roleName,
                        description: currentDescription || undefined,
                        traits: currentTraits || undefined,
                        gender: gender,
                        voice_type: voiceType
                    }),
                    signal: currentAutoFillController.signal
                });

                const data = await response.json();

                if (response.ok) {
                    // ç›´æ¥ä½¿ç”¨è¿”å›çš„descriptionå’Œtraits
                    if (data.description) {
                        document.getElementById('roleDescription').value = data.description;
                    }
                    if (data.traits) {
                        document.getElementById('roleTraits').value = data.traits;
                    }
                    // å¤„ç†è¿”å›çš„æ€§åˆ«å’Œè¯­éŸ³ç±»å‹
                    if (data.gender) {
                        const genderRadio = document.querySelector(`input[name="roleGender"][value="${data.gender}"]`);
                        if (genderRadio) {
                            genderRadio.checked = true;
                        }
                    }
                    if (data.voice_type) {
                        const voiceTypeRadio = document.querySelector(`input[name="roleVoiceType"][value="${data.voice_type}"]`);
                        if (voiceTypeRadio) {
                            voiceTypeRadio.checked = true;
                        }
                    }
                } else {
                    alert('è‡ªåŠ¨å¡«å†™å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™');
                }
            } catch (error) {
                console.error('è‡ªåŠ¨å¡«å†™é”™è¯¯:', error);
                if (error.name === 'AbortError') {
                    console.log('è¯·æ±‚å·²è¢«ç”¨æˆ·å–æ¶ˆ');
                } else {
                    alert('ç½‘ç»œé”™è¯¯æˆ–AIç”Ÿæˆè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                }
            } finally {
                resetAutoFillButton(btn, originalHTML);
                currentAutoFillController = null;
            }
        }

        // é‡ç½®è‡ªåŠ¨å¡«å†™æŒ‰é’®çŠ¶æ€
        function resetAutoFillButton(btn, originalHTML) {
            btn.innerHTML = originalHTML;
            btn.onclick = autoFillDescription;
        }

        // è§’è‰²è¡¨å•éªŒè¯
        function validateRoleForm() {
            let isValid = true;
            const name = document.getElementById('roleName').value.trim();
            const description = document.getElementById('roleDescription').value.trim();
            const traits = document.getElementById('roleTraits').value.trim();

            clearErrors(['roleNameError', 'roleDescriptionError', 'roleTraitsError']);

            if (!name) {
                showError('roleNameError', 'è¯·è¾“å…¥è§’è‰²åç§°');
                isValid = false;
            } else if (name.length < 2) {
                showError('roleNameError', 'è§’è‰²åç§°è‡³å°‘2ä¸ªå­—ç¬¦');
                isValid = false;
            }

            if (!description) {
                showError('roleDescriptionError', 'è¯·è¾“å…¥è§’è‰²æè¿°');
                isValid = false;
            } else if (description.length < 20) {
                showError('roleDescriptionError', 'è§’è‰²æè¿°è‡³å°‘20ä¸ªå­—ç¬¦');
                isValid = false;
            }

            if (!traits) {
                showError('roleTraitsError', 'è¯·è¾“å…¥è§’è‰²ç‰¹ç‚¹');
                isValid = false;
            } else if (traits.length < 20) {
                showError('roleTraitsError', 'è§’è‰²ç‰¹ç‚¹è‡³å°‘20ä¸ªå­—ç¬¦');
                isValid = false;
            }

            return isValid;
        }

        // å¤„ç†è§’è‰²åˆ›å»º
        async function handleRoleCreate(event) {
            event.preventDefault();

            if (!validateRoleForm()) return;

            const name = document.getElementById('roleName').value.trim();
            const description = document.getElementById('roleDescription').value.trim();
            const traits = document.getElementById('roleTraits').value.trim();
            const gender = document.querySelector('input[name="roleGender"]:checked').value;
            const voiceType = document.querySelector('input[name="roleVoiceType"]:checked').value;

            const submitBtn = document.getElementById('createSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'åˆ›å»ºä¸­...';

            try {
                let avatar = null;

                // å¤„ç†å¤´åƒ
                if (selectedRoleAvatarType === 'default' && selectedRoleAvatar) {
                    avatar = selectedRoleAvatar;
                } else if (selectedRoleAvatarType === 'custom' && customRoleAvatarFile) {
                    // å¦‚æœæ˜¯è‡ªå®šä¹‰å¤´åƒï¼Œå…ˆä¸Šä¼ å¤´åƒè·å–file_url
                    const uploadResponse = await fetch('/api/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'X-File-Name': customRoleAvatarFile.name,
                            'Content-Type': customRoleAvatarFile.type || 'application/octet-stream'
                        },
                        body: customRoleAvatarFile
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        avatar = uploadData.file_url;
                    } else {
                        throw new Error('å¤´åƒä¸Šä¼ å¤±è´¥');
                    }
                }

                // åˆ›å»ºè§’è‰²è¯·æ±‚
                const response = await fetch('/api/role/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        traits: traits,
                        avatar: avatar,
                        gender: gender,
                        voice_type: voiceType
                    })
                });

                const data = await response.json();

                if (response.ok && data.role_id) {
                    // åˆ›å»ºæˆåŠŸ
                    alert('è§’è‰²åˆ›å»ºæˆåŠŸï¼');

                    // æ¸…ç©ºè¡¨å•
                    resetRoleForm();

                    // é‡æ–°åŠ è½½è§’è‰²åˆ—è¡¨ä»¥è·å–æœ€æ–°æ•°æ®
                    await loadRoles();

                    // è¿”å›ä¸»é¡µå¹¶åˆ·æ–°è§’è‰²åˆ—è¡¨
                    backToHome();
                    renderRoles(roles);
                } else {
                    // åˆ›å»ºå¤±è´¥
                    alert(data.message || 'è§’è‰²åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºè§’è‰²é”™è¯¯:', error);
                alert('åˆ›å»ºå¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'åˆ›å»ºè§’è‰²';
            }
        }

        // é€‰æ‹©è§’è‰²
        async function selectRole(roleId) {
            if (!isLoggedIn) {
                setPendingAction('selectRole', { roleId: roleId });
                showAuthModal();
                return;
            }

            // ç›´æ¥å¯¼èˆªåˆ°èŠå¤©é¡µé¢
            startChatWithRole(roleId);
        }

        // æ‰“å¼€å¯¹è¯
        async function openChat(roleId) {
            if (!isLoggedIn) {
                setPendingAction('openChat', { roleId: roleId });
                showAuthModal();
                return;
            }

            try {
                // ç¡®ä¿è§’è‰²åˆ—è¡¨å·²åŠ è½½
                if (roles.length === 0) {
                    await loadRoles();
                }

                showChatPage(roleId);
            } catch (error) {
                console.error('æ‰“å¼€å¯¹è¯å¤±è´¥:', error);
                alert('æ‰“å¼€å¯¹è¯å¤±è´¥: ' + error.message);
            }
        }

        // ç›´æ¥æ‰“å¼€èŠå¤©ï¼ˆç”¨äºç™»å½•åè‡ªåŠ¨æ‰§è¡Œï¼‰
        async function openChatDirect(roleId) {
            try {
                // ç¡®ä¿è§’è‰²åˆ—è¡¨å·²åŠ è½½
                if (roles.length === 0) {
                    await loadRoles();
                }

                showChatPage(roleId);
            } catch (error) {
                console.error('æ‰“å¼€å¯¹è¯å¤±è´¥:', error);
                alert('æ‰“å¼€å¯¹è¯å¤±è´¥: ' + error.message);
            }
        }

        // ç™»å½•åŠŸèƒ½
        function login() {
            showAuthModal();
        }

        // æ˜¾ç¤ºè®¤è¯æ¨¡æ€æ¡†
        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // å…³é—­è®¤è¯æ¨¡æ€æ¡†
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            resetForms();
        }

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ ‡ç­¾
        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
            resetForms();
        }

        // é‡ç½®è¡¨å•
        function resetForms() {
            // é‡ç½®ç™»å½•è¡¨å•
            document.getElementById('loginForm').reset();
            clearErrors(['loginUsernameError', 'loginPasswordError']);

            // é‡ç½®æ³¨å†Œè¡¨å•
            document.getElementById('registerForm').reset();
            clearErrors(['registerUsernameError', 'registerPasswordError', 'confirmPasswordError']);

            // é‡ç½®å¤´åƒé€‰æ‹©
            selectedAvatar = 'ğŸ‘¤';
            selectedAvatarType = 'default';
            customAvatarFile = null;
            updateAvatarPreview();
            hideDefaultAvatars();
        }

        // æ¸…é™¤é”™è¯¯ä¿¡æ¯
        function clearErrors(errorIds) {
            errorIds.forEach(id => {
                const errorElement = document.getElementById(id);
                errorElement.textContent = '';
                errorElement.classList.remove('show');

                const input = errorElement.previousElementSibling;
                if (input && (input.classList.contains('form-input') || input.classList.contains('role-textarea'))) {
                    input.classList.remove('error');
                }
            });
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            const input = errorElement.previousElementSibling;

            errorElement.textContent = message;
            errorElement.classList.add('show');
            if (input) {
                input.classList.add('error');
            }
        }

        // å¤´åƒç›¸å…³å‡½æ•°
        function selectDefaultAvatar() {
            const defaultAvatars = document.getElementById('defaultAvatars');
            defaultAvatars.style.display = defaultAvatars.style.display === 'none' ? 'grid' : 'none';
        }

        function hideDefaultAvatars() {
            document.getElementById('defaultAvatars').style.display = 'none';
        }

        function chooseDefaultAvatar(avatar) {
            selectedAvatar = avatar;
            selectedAvatarType = 'default';
            customAvatarFile = null;
            updateAvatarPreview();
            hideDefaultAvatars();

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-avatar="${avatar}"]`).classList.add('selected');
        }

        function uploadAvatar() {
            document.getElementById('avatarInput').click();
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            console.log('é€‰æ‹©çš„æ–‡ä»¶:', file);
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MBé™åˆ¶
                    alert('å¤´åƒæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }

                customAvatarFile = file;
                selectedAvatarType = 'custom';

                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedAvatar = e.target.result;
                    updateAvatarPreview();
                };
                reader.readAsDataURL(file);
                hideDefaultAvatars();
            }
        }

        function updateAvatarPreview() {
            const preview = document.getElementById('avatarPreview');
            if (selectedAvatarType === 'custom') {
                preview.innerHTML = `<img src="${selectedAvatar}" alt="å¤´åƒé¢„è§ˆ">`;
            } else {
                // ä¸ºé»˜è®¤å¤´åƒæ˜¾ç¤ºè¡¨æƒ…ç¬¦å·ï¼Œä½†å­˜å‚¨æ—¶ä¼šè½¬æ¢ä¸ºbase64
                preview.innerHTML = `<div class="avatar-preview-text">${selectedAvatar}</div>`;
            }
        }

        // è¡¨å•éªŒè¯
        function validateLogin() {
            let isValid = true;
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            clearErrors(['loginUsernameError', 'loginPasswordError']);

            if (!username) {
                showError('loginUsernameError', 'è¯·è¾“å…¥ç”¨æˆ·å');
                isValid = false;
            }

            if (!password) {
                showError('loginPasswordError', 'è¯·è¾“å…¥å¯†ç ');
                isValid = false;
            }

            return isValid;
        }

        function validateRegister() {
            let isValid = true;
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            clearErrors(['registerUsernameError', 'registerPasswordError', 'confirmPasswordError']);

            if (!username) {
                showError('registerUsernameError', 'è¯·è¾“å…¥ç”¨æˆ·å');
                isValid = false;
            } else if (username.length < 3) {
                showError('registerUsernameError', 'ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦');
                isValid = false;
            } else if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(username)) {
                showError('registerUsernameError', 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡');
                isValid = false;
            }

            if (!password) {
                showError('registerPasswordError', 'è¯·è¾“å…¥å¯†ç ');
                isValid = false;
            } else if (password.length < 6) {
                showError('registerPasswordError', 'å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦');
                isValid = false;
            }

            if (!confirmPassword) {
                showError('confirmPasswordError', 'è¯·ç¡®è®¤å¯†ç ');
                isValid = false;
            } else if (password !== confirmPassword) {
                showError('confirmPasswordError', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                isValid = false;
            }

            return isValid;
        }

        // å¤„ç†ç™»å½•
        async function handleLogin(event) {
            event.preventDefault();

            if (!validateLogin()) return;

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            const submitBtn = document.getElementById('loginSubmit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ç™»å½•ä¸­...';

            try {
                const hashedPassword = await hashPassword(password);

                // å‘é€ç™»å½•è¯·æ±‚
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: hashedPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // ç™»å½•æˆåŠŸ
                    localStorage.setItem('authToken', data.token);
                    isLoggedIn = true;
                    currentUser = {
                        id: data.user_id,
                        name: data.username,
                        avatar: data.avatar
                    };

                    updateUserInfo();
                    closeAuthModal();

                    // é‡æ–°åŠ è½½è§’è‰²åˆ—è¡¨
                    await loadRoles();
                    renderRoles(roles);

                    // åŠ è½½æœ€è¿‘å¯¹è¯
                    await loadRecentChats();

                    // æ‰§è¡Œç™»å½•åçš„å¾…å¤„ç†æ“ä½œ
                    executePendingAction();

                    alert('ç™»å½•æˆåŠŸï¼');
                } else {
                    // ç™»å½•å¤±è´¥
                    showError('loginPasswordError', 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showError('loginPasswordError', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ç™»å½•';
            }
        }

        // å¤„ç†æ³¨å†Œ
        async function handleRegister(event) {
            event.preventDefault();

            if (!validateRegister()) return;

            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            const submitBtn = document.getElementById('registerSubmit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æ³¨å†Œä¸­...';

            try {
                const hashedPassword = await hashPassword(password);

                // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å¤´åƒ
                let avatarUrl;
                if (selectedAvatarType === 'custom' && customAvatarFile) {
                    // ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ
                    submitBtn.textContent = 'ä¸Šä¼ å¤´åƒä¸­...';
                    avatarUrl = await uploadCustomAvatar(customAvatarFile);
                } else {
                    // ä¸Šä¼ é»˜è®¤å¤´åƒï¼ˆè½¬æ¢ä¸ºblobåä¸Šä¼ ï¼‰
                    submitBtn.textContent = 'ç”Ÿæˆå¤´åƒä¸­...';
                    avatarUrl = await uploadDefaultAvatar(selectedAvatar);
                }

                // ç¬¬äºŒæ­¥ï¼šæ³¨å†Œç”¨æˆ·
                submitBtn.textContent = 'åˆ›å»ºè´¦æˆ·ä¸­...';
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: hashedPassword,
                        avatar: avatarUrl
                    })
                });

                if (response.ok) {
                    // æ³¨å†ŒæˆåŠŸ
                    alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');

                    // åˆ‡æ¢åˆ°ç™»å½•æ ‡ç­¾
                    switchTab('login');

                    // é¢„å¡«ç”¨æˆ·å
                    document.getElementById('loginUsername').value = username;
                } else {
                    // æ³¨å†Œå¤±è´¥
                    const errorData = await response.json().catch(() => ({}));
                    showError('registerPasswordError', errorData.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showError('registerPasswordError', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'æ³¨å†Œ';
            }
        }

        // ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ
        async function uploadCustomAvatar(file) {
            const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                    'X-File-Name': file.name,
                    'Content-Type': file.type || 'application/octet-stream'
                },
                body: file
            });

            if (!response.ok) {
                throw new Error('å¤´åƒä¸Šä¼ å¤±è´¥');
            }

            const data = await response.json();
            return data.file_url;
        }

        // ä¸Šä¼ é»˜è®¤å¤´åƒ
        async function uploadDefaultAvatar(emoji) {
            // ç”Ÿæˆé»˜è®¤å¤´åƒçš„Blob
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 200;

            // è®¾ç½®èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 200, 200);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 200, 200);

            // ç»˜åˆ¶emoji
            ctx.font = '120px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(emoji, 100, 100);

            // è½¬æ¢ä¸ºBlob
            return new Promise((resolve, reject) => {
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        reject(new Error('å¤´åƒç”Ÿæˆå¤±è´¥'));
                        return;
                    }

                    try {
                        const fileName = `default_avatar_${emoji.codePointAt(0)}.png`;
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            headers: {
                                'X-File-Name': fileName,
                                'Content-Type': 'image/png'
                            },
                            body: blob
                        });

                        if (!response.ok) {
                            throw new Error('é»˜è®¤å¤´åƒä¸Šä¼ å¤±è´¥');
                        }

                        const data = await response.json();
                        resolve(data.file_url);
                    } catch (error) {
                        reject(error);
                    }
                }, 'image/png');
            });
        }        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function () {
            initPage();

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('roleForm').addEventListener('submit', handleRoleCreate);

            // æ¶ˆæ¯è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
            const messageInput = document.getElementById('messageInputNew');
            if (messageInput) {
                messageInput.addEventListener('input', function () {
                    adjustTextareaHeight(this);
                });
                messageInput.addEventListener('keydown', handleInputKeydown);
            }

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('authModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeAuthModal();
                }
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ç”¨æˆ·ä¸‹æ‹‰èœå•
            document.addEventListener('click', function (event) {
                const userInfo = document.getElementById('userInfo');
                const dropdown = document.getElementById('userDropdown');

                if (userInfo && dropdown && !userInfo.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    if (document.getElementById('authModal').classList.contains('active')) {
                        closeAuthModal();
                    }
                }
            });
        });

        // ====== å¯¹è¯ç›¸å…³API ======

        // åˆ›å»ºä¸è§’è‰²çš„å¯¹è¯
        async function createConversation(roleId) {
            try {
                const response = await fetch('/api/conversation/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        user_id: parseInt(currentUser.id),
                        role_id: parseInt(roleId)
                    })
                });

                if (!response.ok) {
                    throw new Error('åˆ›å»ºå¯¹è¯å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºå¯¹è¯é”™è¯¯:', error);
                // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºå¯¹è¯å¯èƒ½å·²ç»å­˜åœ¨
            }
        }

        // è·å–ç”¨æˆ·çš„å¯¹è¯åˆ—è¡¨
        async function loadRecentChats() {
            try {
                const response = await fetch(`/api/conversation/list?user_id=${parseInt(currentUser.id)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('è·å–å¯¹è¯åˆ—è¡¨å¤±è´¥');
                }

                const roleIds = await response.json();
                await renderRecentChats(roleIds);
            } catch (error) {
                console.error('åŠ è½½æœ€è¿‘å¯¹è¯é”™è¯¯:', error);
            }
        }

        // æ¸²æŸ“æœ€è¿‘å¯¹è¯åˆ—è¡¨
        async function renderRecentChats(roleIds) {
            const chatListElement = document.getElementById('chatList');

            if (roleIds.length === 0) {
                chatListElement.innerHTML = '<div class="no-chats">è¿˜æ²¡æœ‰å¯¹è¯è®°å½•</div>';
                return;
            }

            // ç¡®ä¿è§’è‰²åˆ—è¡¨å·²åŠ è½½
            if (roles.length === 0) {
                await loadRoles();
            }

            const chatItems = roleIds.map(roleId => {
                const role = roles.find(r => String(r.id) === String(roleId));
                if (!role) return '';

                // åˆ¤æ–­å¤´åƒæ ¼å¼
                let avatarHtml;
                if (role.image_url && (role.image_url.startsWith('http') || role.image_url.startsWith('/'))) {
                    avatarHtml = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else if (role.image_url && role.image_url.startsWith('data:image')) {
                    avatarHtml = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    avatarHtml = role.image_url || 'ğŸ­';
                }

                return `
                    <div class="chat-item" onclick="openChat('${role.id}')">
                        <div class="chat-avatar">${avatarHtml}</div>
                        <div class="chat-info">
                            <div class="chat-name">${role.name}</div>
                            <div class="chat-preview">ç‚¹å‡»å¼€å§‹å¯¹è¯</div>
                        </div>
                    </div>
                `;
            }).filter(item => item).join('');

            chatListElement.innerHTML = chatItems;
        }

        // è·å–å¯¹è¯çš„èŠå¤©è®°å½•
        async function loadChatDialogs(roleId) {
            try {
                const response = await fetch(`/api/conversation/dialogs?user_id=${parseInt(currentUser.id)}&role_id=${parseInt(roleId)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('è·å–èŠå¤©è®°å½•å¤±è´¥');
                }

                const dialogs = await response.json();
                return dialogs.map(dialog => ({
                    id: ++messageIdCounter, // ä¸ºå†å²æ¶ˆæ¯ä¹Ÿæ·»åŠ ID
                    sender: dialog.is_user ? 'user' : 'role',
                    message: dialog.text,
                    timestamp: dialog.timestamp,
                    voice: dialog.voice // è¯­éŸ³æ–‡ä»¶URLï¼ˆå¦‚æœæœ‰ï¼‰
                }));
            } catch (error) {
                console.error('åŠ è½½èŠå¤©è®°å½•é”™è¯¯:', error);
                return [];
            }
        }

        // ====== èŠå¤©ç›¸å…³åŠŸèƒ½ ======

        let currentChatRole = null; // å½“å‰èŠå¤©çš„è§’è‰²
        let chatMessages = []; // èŠå¤©æ¶ˆæ¯å†å²

        // æ˜¾ç¤ºèŠå¤©é¡µé¢
        function showChatPage(roleId) {
            console.log('æ˜¾ç¤ºèŠå¤©é¡µé¢ï¼Œæ¥æ”¶åˆ°çš„è§’è‰²ID:', roleId);
            currentPage = 'chat';
            currentChatRoleId = roleId;

            // éšè—å…¶ä»–é¡µé¢
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('createRolePage').classList.remove('active');

            // æ˜¾ç¤ºæ–°çš„èŠå¤©é¡µé¢
            document.getElementById('chatPageNew').classList.add('active');

            if (roleId) {
                // å¦‚æœæŒ‡å®šäº†è§’è‰²IDï¼ŒåŠ è½½è¯¥è§’è‰²çš„èŠå¤©
                console.log('è°ƒç”¨loadChatRoleï¼Œè§’è‰²ID:', roleId);
                loadChatRole(roleId);
            } else {
                // å¦åˆ™æ˜¾ç¤ºé»˜è®¤çŠ¶æ€
                resetChatPage();
            }

            // åªåœ¨å½“å‰URLä¸åŒ¹é…æ—¶æ‰æ›´æ–°é”šç‚¹
            const expectedHash = roleId ? `#chat/${roleId}` : '#chat';
            if (window.location.hash !== expectedHash) {
                updateUrlHash();
            }
        }

        // åŠ è½½èŠå¤©è§’è‰²
        async function loadChatRole(roleId) {
            try {
                console.log('å°è¯•åŠ è½½è§’è‰²ID:', roleId, 'ç±»å‹:', typeof roleId);
                console.log('å½“å‰è§’è‰²åˆ—è¡¨:', roles);

                // ç¡®ä¿IDéƒ½æ˜¯å­—ç¬¦ä¸²æ ¼å¼è¿›è¡Œæ¯”è¾ƒ
                const targetId = String(roleId);
                const role = roles.find(r => String(r.id) === targetId);

                if (!role) {
                    console.error('è§’è‰²ä¸å­˜åœ¨ï¼Œç›®æ ‡ID:', targetId);
                    console.error('å¯ç”¨è§’è‰²IDåˆ—è¡¨:', roles.map(r => String(r.id)));
                    throw new Error(`è§’è‰²ä¸å­˜åœ¨ï¼ŒID: ${targetId}`);
                }

                currentChatRole = role;
                console.log('æˆåŠŸåŠ è½½è§’è‰²:', role);

                // æ›´æ–°èŠå¤©å¤´éƒ¨ - åªæ˜¾ç¤ºè§’è‰²å
                const nameElement = document.getElementById('currentRoleNameNew');
                nameElement.textContent = role.name;

                // åŠ è½½å†å²èŠå¤©è®°å½•
                chatMessages = await loadChatDialogs(roleId);
                renderChatMessages();

                // å¯ç”¨è¾“å…¥æ¡†
                enableChatInput();

                // Socket.IOä¼šè‡ªåŠ¨å°†ç”¨æˆ·åŠ å…¥socket.idæˆ¿é—´ï¼Œæ— éœ€æ‰‹åŠ¨åŠ å…¥

            } catch (error) {
                console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
                alert('åŠ è½½è§’è‰²å¤±è´¥: ' + error.message);
            }
        }

        // é‡ç½®èŠå¤©é¡µé¢
        function resetChatPage() {
            currentChatRole = null;
            chatMessages = [];

            // é‡ç½®å¤´éƒ¨ - åªæ›´æ–°è§’è‰²å
            document.getElementById('currentRoleNameNew').textContent = 'é€‰æ‹©ä¸€ä¸ªè§’è‰²å¼€å§‹å¯¹è¯';

            // æ˜¾ç¤ºç©ºçŠ¶æ€
            showChatEmpty();

            // ç¦ç”¨è¾“å…¥æ¡†
            disableChatInput();
        }

        // æ¸²æŸ“èŠå¤©æ¶ˆæ¯
        function renderChatMessages() {
            const container = document.getElementById('chatMessagesNew');
            const emptyDiv = document.getElementById('chatEmptyNew');

            if (chatMessages.length === 0) {
                showChatEmpty();
                return;
            }

            // éšè—ç©ºçŠ¶æ€
            emptyDiv.style.display = 'none';

            container.innerHTML = chatMessages.map(message => {
                const isUser = message.sender === 'user';
                let avatarHtml;

                if (isUser) {
                    // ç”¨æˆ·å¤´åƒå¤„ç†
                    if (currentUser.avatar) {
                        if (isEmoji(currentUser.avatar)) {
                            avatarHtml = currentUser.avatar;
                        } else {
                            avatarHtml = `<img src="${currentUser.avatar}" alt="${currentUser.name}">`;
                        }
                    } else {
                        avatarHtml = 'ğŸ‘¤';
                    }
                } else {
                    // è§’è‰²å¤´åƒå¤„ç†
                    if (currentChatRole.image_url) {
                        if (isEmoji(currentChatRole.image_url)) {
                            avatarHtml = currentChatRole.image_url;
                        } else {
                            avatarHtml = `<img src="${currentChatRole.image_url}" alt="${currentChatRole.name}">`;
                        }
                    } else {
                        avatarHtml = 'ğŸ­';
                    }
                }

                // æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒæ–‡æœ¬å’Œè¯­éŸ³
                let messageContent = `<div class="message-text">${message.message}</div>`;
                let hasVoiceClass = '';
                if (message.voice) {
                    hasVoiceClass = ' has-voice'; // æ·»åŠ CSSç±»æ ‡è¯†
                    messageContent += `
                        <div class="message-voice">
                            <audio controls preload="metadata">
                                <source src="${message.voice}" type="audio/mpeg">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                            </audio>
                        </div>
                    `;
                }

                return `
                    <div class="message ${isUser ? 'user' : 'role'}${hasVoiceClass}">
                        <div class="message-avatar ${isUser ? 'user' : 'role'}">${avatarHtml}</div>
                        <div class="message-content${hasVoiceClass}">${messageContent}</div>
                    </div>
                `;
            }).join('') + '<div id="chatEmptyNew" style="display: none;"></div>';

            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }

        // æ˜¾ç¤ºèŠå¤©ç©ºçŠ¶æ€
        function showChatEmpty() {
            const container = document.getElementById('chatMessagesNew');

            // æ¸…ç©ºæ¶ˆæ¯
            container.innerHTML = `
                <div class="chat-empty" id="chatEmptyNew">
                    <div class="chat-empty-icon">ğŸ’¬</div>
                    <div class="chat-empty-text">${currentChatRole ? 'å¼€å§‹ä¸ ' + currentChatRole.name + ' å¯¹è¯å§ï¼' : 'è¿˜æ²¡æœ‰èŠå¤©è®°å½•'}</div>
                    <div class="chat-empty-hint">${currentChatRole ? 'è¾“å…¥æ¶ˆæ¯å¼€å§‹æœ‰è¶£çš„è§’è‰²æ‰®æ¼”' : 'é€‰æ‹©ä¸€ä¸ªè§’è‰²å¼€å§‹æœ‰è¶£çš„å¯¹è¯å§ï¼'}</div>
                </div>
            `;
        }

        // å¯ç”¨èŠå¤©è¾“å…¥
        function enableChatInput() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            input.disabled = false;
            input.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
            checkSendButton();
        }

        // ç¦ç”¨èŠå¤©è¾“å…¥
        function disableChatInput() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            input.disabled = true;
            input.placeholder = 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²...';
            sendBtn.disabled = true;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            if (!currentChatRole) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }

            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const input = document.getElementById('messageInputNew');
            const message = input.value.trim();

            if (!message) {
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            chatMessages.push({
                id: ++messageIdCounter, // ä¸ºæ–‡æœ¬æ¶ˆæ¯ä¹Ÿæ·»åŠ ID
                sender: 'user',
                message: message,
                timestamp: new Date()
            });

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            input.style.height = 'auto';
            checkSendButton();

            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
            renderChatMessages();

            // é€šè¿‡Socket.IOå‘é€æ¶ˆæ¯åˆ°åç«¯
            sendSocketMessage(currentUser.id, currentChatRole.id, message);
        }

        // å¤„ç†è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
        function handleInputKeydown(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    // Shift+Enter æ¢è¡Œ
                    return;
                } else {
                    // Enter å‘é€æ¶ˆæ¯
                    event.preventDefault();
                    sendMessage();
                }
            }
        }

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

            // æ£€æŸ¥å‘é€æŒ‰é’®çŠ¶æ€
            checkSendButton();
        }

        // æ£€æŸ¥å‘é€æŒ‰é’®çŠ¶æ€
        function checkSendButton() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            if (currentChatRole && input.value.trim()) {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = true;
            }
        }

        // è¯­éŸ³å½•åˆ¶ç›¸å…³å˜é‡
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let messageIdCounter = 0; // æ¶ˆæ¯IDè®¡æ•°å™¨

        // è¯­éŸ³è¾“å…¥åŠŸèƒ½
        async function startVoiceInput() {
            if (!currentChatRole) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²');
                return;
            }

            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            if (isRecording) {
                // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œåœæ­¢å½•éŸ³
                stopRecording();
            } else {
                // å¼€å§‹å½•éŸ³
                await startRecording();
            }
        }

        // å¼€å§‹å½•åˆ¶è¯­éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒçš„éŸ³é¢‘æ ¼å¼
                let mimeType = 'audio/mp4'; // é»˜è®¤ä½¿ç”¨mp4æ ¼å¼ï¼Œæ¯”webmæ›´æ¥è¿‘mp3
                if (MediaRecorder.isTypeSupported('audio/mpeg')) {
                    mimeType = 'audio/mpeg';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                } else if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus'; // å¤‡ç”¨æ–¹æ¡ˆ
                }

                console.log('ä½¿ç”¨éŸ³é¢‘æ ¼å¼:', mimeType);

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });

                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await uploadAndSendVoice(audioBlob);

                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘æµ
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                updateVoiceButton();

                console.log('å¼€å§‹å½•éŸ³...');
            } catch (error) {
                console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }

        // åœæ­¢å½•åˆ¶è¯­éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                updateVoiceButton();
                console.log('åœæ­¢å½•éŸ³...');
            }
        }

        // æ›´æ–°è¯­éŸ³æŒ‰é’®çŠ¶æ€
        function updateVoiceButton() {
            const voiceBtn = document.getElementById('voiceBtnNew');
            if (isRecording) {
                voiceBtn.innerHTML = 'â¹ï¸';
                voiceBtn.title = 'ç‚¹å‡»åœæ­¢å½•éŸ³';
                voiceBtn.style.backgroundColor = '#ff4757';
            } else {
                voiceBtn.innerHTML = 'ğŸ¤';
                voiceBtn.title = 'ç‚¹å‡»å½•åˆ¶è¯­éŸ³';
                voiceBtn.style.backgroundColor = '';
            }
        }

        // ä¸Šä¼ è¯­éŸ³å¹¶å‘é€æ¶ˆæ¯
        async function uploadAndSendVoice(audioBlob) {
            try {
                console.log('å¼€å§‹ä¸Šä¼ è¯­éŸ³æ–‡ä»¶ï¼Œå¤§å°:', audioBlob.size);

                // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œè§’è‰²
                if (!currentUser || !currentChatRole) {
                    throw new Error('ç”¨æˆ·æœªç™»å½•æˆ–æœªé€‰æ‹©è§’è‰²');
                }

                // ä¸Šä¼ è¯­éŸ³æ–‡ä»¶
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'X-File-Name': `voice_${Date.now()}.mp3`,
                        'Content-Type': 'audio/mpeg'
                    },
                    body: audioBlob
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`è¯­éŸ³ä¸Šä¼ å¤±è´¥: ${response.status} ${errorText}`);
                }

                const uploadData = await response.json();
                console.log('ä¸Šä¼ å“åº”:', uploadData);

                if (!uploadData.file_url) {
                    throw new Error('ä¸Šä¼ å“åº”ä¸­ç¼ºå°‘file_url');
                }

                const voiceUrl = uploadData.file_url;
                console.log('è¯­éŸ³ä¸Šä¼ æˆåŠŸï¼ŒURL:', voiceUrl);

                // ç”Ÿæˆæ¶ˆæ¯ID
                messageIdCounter++;
                const messageId = messageIdCounter;

                // æ·»åŠ ç”¨æˆ·è¯­éŸ³æ¶ˆæ¯åˆ°ç•Œé¢ï¼ˆæ˜¾ç¤ºä¸º"[æ­£åœ¨å°†è¯­éŸ³è½¬æ¢æˆæ–‡å­—]"ï¼‰
                chatMessages.push({
                    id: messageId,
                    sender: 'user',
                    message: '[æ­£åœ¨å°†è¯­éŸ³è½¬æ¢æˆæ–‡å­—]',
                    timestamp: new Date(),
                    voice: voiceUrl
                });

                // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
                renderChatMessages();

                // é€šè¿‡Socketå‘é€è¯­éŸ³æ¶ˆæ¯åˆ°åç«¯
                sendVoiceMessage(currentUser.id, currentChatRole.id, voiceUrl, messageId);

            } catch (error) {
                console.error('è¯­éŸ³å¤„ç†å¤±è´¥:', error);
                alert('è¯­éŸ³å‘é€å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤º"æ­£åœ¨å›å¤"çŠ¶æ€
        function showTypingIndicator() {
            const roleNameElement = document.getElementById('currentRoleNameNew');
            if (roleNameElement && currentChatRole) {
                roleNameElement.innerHTML = `${currentChatRole.name} <span style="font-size: 12px; color: #7f8c8d; font-weight: normal;">æ­£åœ¨å›å¤</span>`;
            }
        }

        // éšè—"æ­£åœ¨å›å¤"çŠ¶æ€
        function hideTypingIndicator() {
            const roleNameElement = document.getElementById('currentRoleNameNew');
            if (roleNameElement && currentChatRole) {
                roleNameElement.textContent = currentChatRole.name;
            }
        }

        // ä¿®æ”¹ç°æœ‰çš„è§’è‰²å¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼Œæ·»åŠ èŠå¤©åŠŸèƒ½
        async function startChatWithRole(roleId) {
            console.log('å¼€å§‹èŠå¤©ï¼Œè§’è‰²ID:', roleId);
            console.log('å½“å‰ç™»å½•çŠ¶æ€:', isLoggedIn);

            if (!isLoggedIn) {
                setPendingAction('startChatWithRole', { roleId: roleId });
                showAuthModal();
                return;
            }

            try {
                // åˆ›å»ºä¸è§’è‰²çš„å¯¹è¯ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                await createConversation(roleId);

                // ç¡®ä¿è§’è‰²åˆ—è¡¨å·²åŠ è½½
                if (roles.length === 0) {
                    console.log('è§’è‰²åˆ—è¡¨ä¸ºç©ºï¼Œé‡æ–°åŠ è½½...');
                    await loadRoles();
                }

                console.log('å½“å‰rolesæ•°ç»„:', roles);
                showChatPage(roleId);

                // æ›´æ–°æœ€è¿‘å¯¹è¯åˆ—è¡¨
                await loadRecentChats();
            } catch (error) {
                console.error('å¯åŠ¨å¯¹è¯å¤±è´¥:', error);
                alert('å¯åŠ¨å¯¹è¯å¤±è´¥: ' + error.message);
            }
        }

        // ä¿®æ”¹backToHomeå‡½æ•°ï¼Œæ”¯æŒä»èŠå¤©é¡µé¢è¿”å›
        function backToHome() {
            currentPage = 'home';
            currentChatRoleId = null;

            document.querySelector('.header').style.display = 'flex';
            document.querySelector('.content-area').style.display = 'block';
            document.getElementById('createRolePage').classList.remove('active');
            document.getElementById('chatPageNew').classList.remove('active');

            // åªåœ¨å½“å‰URLä¸æ˜¯homeæ—¶æ‰æ›´æ–°é”šç‚¹ï¼Œé¿å…æ— é™å¾ªç¯
            if (window.location.hash !== '#home') {
                updateUrlHash();
            }
        }
    </script>
</body>

</html>