<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色扮演AI</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            width: 100%;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            overflow: hidden;
        }

        /* 左侧边栏 */
        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow: hidden;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #34495e;
            flex-shrink: 0;
        }

        .create-role-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .create-role-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .debate-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .debate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .recent-chats {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            /* 确保可以收缩 */
        }

        .recent-chats h3 {
            margin-bottom: 15px;
            color: #bdc3c7;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* 历史辩论样式 */
        .recent-debates {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            /* 确保可以收缩 */
            border-top: 1px solid #34495e;
        }

        .recent-debates h3 {
            margin-bottom: 15px;
            color: #bdc3c7;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .debate-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(52, 73, 94, 0.3);
        }

        .debate-item:hover {
            background: #34495e;
        }

        .debate-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .debate-item-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .debate-delete-btn {
            color: #7f8c8d;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            opacity: 0.6;
        }

        .debate-delete-btn:hover {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            opacity: 1;
        }

        .debate-roles {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .debate-role-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            overflow: hidden;
        }

        .debate-role-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .debate-role-avatar.pro {
            border: 2px solid #27ae60;
        }

        .debate-role-avatar.con {
            border: 2px solid #e74c3c;
        }

        .debate-vs {
            color: #bdc3c7;
            font-size: 12px;
            font-weight: 600;
        }

        .debate-time {
            color: #7f8c8d;
            font-size: 11px;
        }

        .debate-topic {
            color: #ecf0f1;
            font-size: 13px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
        }

        .no-debates {
            text-align: center;
            color: #7f8c8d;
            padding: 20px;
            font-style: italic;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-item:hover {
            background: #34495e;
        }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            font-size: 12px;
            color: #95a5a6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .chat-delete {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #95a5a6;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .chat-delete:hover {
            background: #e74c3c;
            color: white;
        }

        .no-chats {
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
            padding: 20px;
            font-style: italic;
        }

        /* 右侧主要内容区 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* 顶部栏 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            z-index: 1000;
        }

        /* Loading 指示器样式 */
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e1e8ed;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .user-dropdown {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item.logout {
            color: #e74c3c;
        }

        .dropdown-item.logout:hover {
            background-color: #ffeaea;
        }

        /* 用户设置页面样式 */
        .user-settings-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
        }

        .user-settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: #f8f9fa;
        }

        .user-settings-content-inner {
            max-width: 800px;
            margin: 0 auto;
        }

        .setting-section {
            margin-bottom: 40px;
            padding: 24px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        /* 头像部分 */
        #settingsAvatar {
            width: 200px;
            height: 200px;
            object-fit: cover;
        }



        .avatar-section {
            text-align: center;
        }

        .avatar-container {
            display: inline-block;
            text-align: center;
            position: relative;
            cursor: pointer;
            border-radius: 50%;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .avatar-container:hover {
            transform: scale(1.05);
        }

        .clickable-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            transition: all 0.3s ease;
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .avatar-container:hover .avatar-overlay {
            opacity: 1;
        }

        .setting-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .setting-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .update-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .update-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(39, 174, 96, 0.3);
        }

        /* 密码部分 */
        .password-section label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .password-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .password-field {
            display: flex;
            flex-direction: column;
        }

        /* 角色列表部分 */
        .roles-header {
            margin-bottom: 20px;
        }

        .roles-header h3 {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .roles-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .role-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            position: relative;
            transition: all 0.3s ease;
        }

        .role-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .role-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .role-description {
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.4;
        }

        .role-delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .role-delete-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        /* 操作区域 */
        .actions-section {
            text-align: center;
        }

        .danger-btn {
            padding: 12px 32px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .danger-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(231, 76, 60, 0.3);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .user-settings-container {
                margin: 10px;
                padding: 20px;
            }

            .roles-list {
                grid-template-columns: 1fr;
            }
        }

        .welcome-text {
            font-size: 16px;
            color: #2c3e50;
        }

        .login-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
        }

        .search-container {
            position: relative;
        }

        .search-input {
            padding: 10px 16px;
            padding-right: 40px;
            border: 2px solid #ecf0f1;
            border-radius: 20px;
            outline: none;
            width: 300px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #7f8c8d;
        }

        /* 角色卡片区域 */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .role-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .role-image {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            font-weight: bold;
        }

        .role-info {
            padding: 15px;
            flex: 1;
            /* 确保内容垂直排列：名字在上，描述在下 */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .role-actions {
            padding: 0 15px 15px 15px;
            display: flex;
            justify-content: flex-end;
        }

        .chat-role-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .chat-role-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .role-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            /* 确保文字水平显示 */
            writing-mode: horizontal-tb;
            text-orientation: mixed;
            /* 限制显示1行，多余文字显示省略号 */
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.2em * 1);
            /* 1行的高度 */
        }

        .role-description {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.4;
            /* 限制显示5行，多余文字显示省略号 */
            display: -webkit-box;
            -webkit-line-clamp: 5;
            line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.4em * 5);
            /* 5行的高度 */
        }

        /* 空状态 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #7f8c8d;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 18px;
            margin-bottom: 20px;
        }

        /* 登录/注册模态框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .auth-modal {
            background: white;
            border-radius: 16px;
            width: 420px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 30px 30px 20px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .auth-tabs {
            display: flex;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #7f8c8d;
        }

        .auth-tab.active {
            background: white;
            color: #2c3e50;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-body {
            padding: 20px 30px 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .form-input.error {
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview-text {
            font-size: 24px;
            color: #7f8c8d;
        }

        .avatar-actions {
            display: flex;
            gap: 10px;
        }

        .avatar-btn {
            padding: 8px 16px;
            border: 1px solid #3498db;
            border-radius: 6px;
            background: white;
            color: #3498db;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .avatar-btn:hover {
            background: #3498db;
            color: white;
        }

        .avatar-btn.primary {
            background: #3498db;
            color: white;
        }

        .avatar-btn.primary:hover {
            background: #2980b9;
        }

        .default-avatars {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .default-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 20px;
        }

        .default-avatar:hover {
            transform: scale(1.1);
            border-color: #3498db;
        }

        .default-avatar.selected {
            border-color: #3498db;
            transform: scale(1.1);
        }

        #avatarInput {
            display: none;
        }

        .auth-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }

        .auth-submit:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }

        /* 角色选择弹窗样式 */
        .role-select-modal {
            background: white;
            border-radius: 16px;
            width: 600px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .role-select-info {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .role-search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .role-search-input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .role-search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 16px;
        }

        .role-list-container {
            flex: 1;
            overflow-y: auto;
            min-height: 300px;
            max-height: 400px;
        }

        .role-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            padding: 10px 0;
        }

        .role-item {
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .role-item:hover {
            border-color: #3498db;
            background: #f8fcff;
            transform: translateY(-2px);
        }

        .role-item.selected {
            border-color: #3498db;
            background: #e8f4fd;
        }

        .role-item-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .role-item-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .role-item-info {
            flex: 1;
            min-width: 0;
        }

        .role-item-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .role-item-desc {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .role-list-loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }

        .role-list-empty {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .empty-hint {
            font-size: 14px;
            opacity: 0.8;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .role-select-modal {
                width: 95vw;
                max-height: 85vh;
            }

            .role-list {
                grid-template-columns: 1fr;
            }

            .modal-header {
                padding: 20px 20px 15px;
            }

            .modal-body {
                padding: 15px 20px 25px;
            }
        }

        /* 创建角色页面 */
        .create-role-page {
            display: none;
        }

        .create-role-page.active {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
        }

        .create-role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .back-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .back-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(127, 140, 141, 0.3);
        }

        .create-role-content {
            flex: 1;
            padding: 30px;
            display: flex;
            justify-content: center;
            background: white;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .role-form {
            width: 100%;
            max-width: 700px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            position: relative;
            z-index: 1;
            overflow: visible;
            box-sizing: border-box;
        }

        .role-form * {
            box-sizing: border-box;
        }

        .role-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border-radius: 12px;
            z-index: -1;
        }

        .role-avatar-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .role-avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #ecf0f1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .role-avatar-preview:hover {
            border-color: #3498db;
            transform: scale(1.05);
        }

        .role-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .role-avatar-text {
            font-size: 48px;
            color: #7f8c8d;
        }

        .avatar-upload-hint {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .role-avatar-preview:hover .avatar-upload-hint {
            opacity: 1;
        }

        .role-default-avatars {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 15px;
            justify-items: center;
        }

        .role-default-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 24px;
        }

        .role-default-avatar:hover {
            transform: scale(1.1);
            border-color: #3498db;
        }

        .role-default-avatar.selected {
            border-color: #3498db;
            border-width: 3px;
            transform: scale(1.1);
        }

        .role-input-group {
            margin-bottom: 25px;
        }

        .role-input-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .role-input-main {
            flex: 1;
        }

        .auto-fill-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .auto-fill-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .auto-fill-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .auto-fill-container {
            display: flex;
            align-items: center;
            margin-top: 12px;
            margin-bottom: 16px;
        }

        .auto-fill-progress {
            font-size: 12px;
            color: #7f8c8d;
            margin-left: 12px;
            display: flex;
            align-items: center;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }
        }

        .role-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }

        .role-textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .role-textarea.error {
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }

        .create-submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            margin-bottom: 30px;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
            position: relative;
            z-index: 10;
        }

        .create-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.5);
            background: linear-gradient(135deg, #229954, #27ae60);
        }

        .create-submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(189, 195, 199, 0.3);
        }

        .role-select-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .role-radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .role-radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            accent-color: #3498db;
            cursor: pointer;
        }

        .radio-label {
            font-size: 14px;
            color: #2c3e50;
            cursor: pointer;
        }

        .role-radio-option:hover .radio-label {
            color: #3498db;
        }

        /* 角色属性组合布局 */
        .role-attribute-group {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 30px;
            margin: 20px 0;
        }

        /* 声音选择容器 */
        .voice-select-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 8px;
        }

        .voice-loading {
            text-align: center;
            color: #7f8c8d;
            padding: 20px;
            font-style: italic;
        }

        .voice-error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
        }

        .voice-error-text {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .retry-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .retry-btn:hover {
            background: #2980b9;
        }

        .voice-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .voice-option:hover {
            background-color: #f8f9fa;
        }

        .voice-option input[type="radio"] {
            width: 16px;
            height: 16px;
            margin-right: 12px;
            accent-color: #3498db;
            cursor: pointer;
        }

        .voice-label {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .voice-name {
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
        }

        .voice-type {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .voice-play-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .voice-play-btn:hover {
            background-color: #e8f4fd;
        }

        /* 响应式调整 */
        @media (max-width: 1024px) {
            .role-attribute-group {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .voice-select-container {
                max-height: 150px;
            }
        }

        #roleAvatarInput {
            display: none;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            .sidebar {
                width: 100%;
                height: 200px;
                flex-shrink: 0;
            }

            .main-content {
                flex: 1;
                overflow: hidden;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .search-input {
                width: 100%;
            }

            .roles-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .content-area {
                padding: 20px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .auth-modal {
                width: 95vw;
            }

            .modal-body {
                padding: 15px 20px 25px;
            }

            .modal-header {
                padding: 20px 20px 15px;
            }
        }

        /* 辩论页面样式 */
        .debate-setup-container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .debate-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .debate-roles-container {
            display: flex;
            align-items: stretch;
            gap: 30px;
            margin-top: 20px;
        }

        .debate-role-selection {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .role-label {
            font-size: 16px;
            font-weight: 500;
            color: #34495e;
            margin-bottom: 15px;
            text-align: center;
        }

        .role-selector {
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .role-selector:hover {
            border-color: #3498db;
            background: #f0f8ff;
            transform: translateY(-2px);
        }

        .role-selector.selected {
            border-color: #3498db;
            background: #e8f4fd;
        }

        /* 未选中状态：横向布局 */
        .role-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        /* 选中状态：垂直布局 */
        .role-preview.selected {
            flex-direction: column;
            gap: 10px;
        }

        .role-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .role-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* 选中状态的头像：更大 */
        .role-preview.selected .role-avatar {
            width: 60px;
            height: 60px;
            font-size: 28px;
        }

        .role-info {
            flex: 1;
            min-width: 0;
        }

        /* 选中状态的信息：居中对齐 */
        .role-preview.selected .role-info {
            text-align: center;
        }

        .role-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 选中状态的名字：无底边距，更大字体 */
        .role-preview.selected .role-name {
            font-size: 18px;
            margin-bottom: 0;
        }

        .role-desc {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.4;
        }

        /* 选中状态隐藏描述 */
        .role-preview.selected .role-desc {
            display: none;
        }

        .vs-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            align-self: center;
        }

        .debate-settings {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .setting-label {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
        }

        .setting-value {
            font-size: 16px;
            color: #7f8c8d;
            font-style: italic;
        }

        .setting-select {
            padding: 8px 12px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 14px;
            color: #2c3e50;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .setting-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .setting-radio-group {
            display: flex;
            gap: 20px;
        }

        .setting-radio {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #2c3e50;
        }

        .setting-radio input[type="radio"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            accent-color: #3498db;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .debate-roles-container {
                flex-direction: column;
                gap: 20px;
                align-items: center;
            }

            .debate-role-selection {
                width: 100%;
                max-width: 300px;
            }

            .vs-divider {
                transform: rotate(90deg);
                align-self: center;
            }

            .debate-setup-container {
                padding: 20px;
            }

            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .setting-radio-group {
                width: 100%;
                justify-content: flex-start;
            }
        }

        /* 新聊天页面样式 */
        .chat-content {
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* 明确设置高度 */
        }

        .chat-messages {
            padding: 20px 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            height: calc(100vh - 160px);
            /* 调整：头部约80px + 输入框约80px */
            max-height: calc(100vh - 160px);
            /* 确保不会超过设定高度 */
            flex-shrink: 0;
            /* 防止被压缩 */
            box-sizing: border-box;
            /* 包含padding在内 */
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 70%;
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message.role {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .message-avatar.role {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .message.role .message-content {
            background: white;
            color: #2c3e50;
        }

        .message-voice {
            margin-top: 8px;
            min-width: 250px;
            /* 确保最小宽度足够显示完整控件 */
        }

        .message-voice audio {
            width: 100%;
            min-width: 250px;
            /* 音频控件最小宽度 */
            max-width: 400px;
            /* 增加最大宽度 */
            height: 36px;
            /* 增加高度，让控件更容易操作 */
            border-radius: 8px;
            /* 添加圆角 */
            background-color: linear-gradient(135deg, #3498db, #2980b9);
            /* 添加背景色 */
            outline: none;
            /* 去除焦点轮廓 */
        }

        .message-voice audio::-webkit-media-controls-panel {
            background-color: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 8px;
        }

        /* 用户发送的语音消息右对齐 */
        .message.user .message-voice {
            text-align: right;
        }

        /* 包含语音的消息容器需要更大的最小宽度 */
        .message-content:has(.message-voice),
        .message-content.has-voice {
            min-width: 280px !important;
        }

        /* 确保所有消息容器都有基本的最小宽度 */
        .message-content {
            min-width: 180px;
        }

        /* 语音消息的文本样式 */
        .message-text {
            margin-bottom: 4px;
        }

        .message-text:last-child {
            margin-bottom: 0;
        }

        /* 时间戳样式 */
        .message-timestamp {
            font-size: 0.75em;
            color: #95a5a6;
            margin-top: 4px;
            text-align: right;
            font-weight: 400;
            transition: opacity 0.3s ease;
        }

        .message.user .message-timestamp {
            color: rgba(255, 255, 255, 0.7);
        }

        .message.role .message-timestamp {
            color: #95a5a6;
            text-align: left;
        }

        /* 正在回复的闪动消息框样式 */
        .typing-indicator {
            display: none;
            padding: 8px 0;
            margin-bottom: 15px;
        }

        .typing-indicator.show {
            display: block;
        }

        .typing-message {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            max-width: 70%;
        }

        .typing-message .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            flex-shrink: 0;
        }

        .typing-message .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .typing-bubble {
            background: #f8f9fa;
            border-radius: 18px 18px 18px 4px;
            padding: 16px 20px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            min-height: 20px;
            display: flex;
            align-items: center;
            animation: typingPulse 1.5s infinite ease-in-out;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #95a5a6;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingPulse {

            0%,
            100% {
                opacity: 0.8;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.02);
            }
        }

        @keyframes typingBounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* 语音消息标识文本的样式 */
        .message.has-voice .message-text {
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .message.user.has-voice .message-text {
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-input {
            padding: 15px 30px;
            background: white;
            border-top: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.4;
            overflow-y: auto;
        }

        .message-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .voice-btn,
        .send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .voice-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .send-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .voice-btn:hover,
        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            text-align: center;
        }

        .chat-empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .chat-empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .chat-empty-hint {
            font-size: 14px;
            opacity: 0.7;
        }

        .role-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-avatar-chat {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .role-avatar-chat img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .role-name-chat {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* 对话页面样式 */
        .chat-page {
            display: none;
            width: 100%;
            height: 100vh;
            background: #ecf0f1;
        }

        .chat-page.active {
            display: flex;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .role-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-avatar-chat {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .role-avatar-chat img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .role-name-chat {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .chat-back-btn {
            margin-left: auto;
            padding: 8px 16px;
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-back-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 70%;
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message.role {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .message-avatar.role {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .message.role .message-content {
            background: white;
            color: #2c3e50;
        }

        .message-time {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: center;
        }

        .chat-input {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.4;
            overflow-y: auto;
        }

        .message-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .voice-btn:active {
            transform: scale(0.95);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 聊天记录为空时的提示 */
        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            text-align: center;
        }

        .chat-empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .chat-empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .chat-empty-hint {
            font-size: 14px;
            opacity: 0.7;
        }

        /* 最近对话角色列表 */
        .recent-roles {
            flex: 1;
            overflow-y: auto;
            padding-top: 10px;
        }

        /* 最近聊天角色项样式 */
        .recent-role-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 5px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
        }

        .recent-role-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .recent-role-item.active {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .recent-role-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            flex-shrink: 0;
            margin-right: 12px;
        }

        .recent-role-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .recent-role-info {
            flex: 1;
            min-width: 0;
        }

        .recent-role-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-role-desc {
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 响应式适配 */
        @media (max-width: 768px) {
            .create-role-page.active {
                width: 100%;
                height: 100vh;
            }

            .create-role-header {
                padding: 15px 20px;
            }

            .create-role-content {
                padding: 20px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .role-form {
                max-width: 100%;
                padding: 20px;
                position: relative;
                z-index: 1;
                overflow: visible;
                box-sizing: border-box;
            }

            .role-form::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                border-radius: 12px;
                z-index: -1;
            }

            .role-select-group {
                flex-direction: column;
                gap: 10px;
            }

            .chat-content {
                height: 100%;
            }

            .chat-messages {
                padding: 15px;
                height: calc(100vh - 120px);
                /* 移动端固定高度 */
                max-height: calc(100vh - 120px);
                /* 确保不会超过设定高度 */
                flex-shrink: 0;
                /* 防止被压缩 */
                box-sizing: border-box;
                /* 包含padding在内 */
            }

            .message {
                max-width: 85%;
            }

            .chat-header {
                padding: 10px 15px;
            }

            .role-avatar-chat {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .role-name-chat {
                font-size: 18px;
            }

            .message-avatar {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }

            .message-input {
                font-size: 16px;
                padding: 10px 16px;
            }

            .voice-btn,
            .send-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            /* 移动端 typing indicator 样式调整 */
            .typing-message .message-avatar {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }

            .typing-bubble {
                padding: 12px 16px;
                border-radius: 16px 16px 16px 4px;
            }

            .typing-dot {
                width: 6px;
                height: 6px;
            }
        }

        /* 辩论房间样式 */
        .debate-room-content {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .debate-messages {
            padding: 20px 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            height: calc(100vh - 160px);
            max-height: calc(100vh - 160px);
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .debate-empty {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .debate-empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .debate-empty-text {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .debate-empty-hint {
            font-size: 16px;
            opacity: 0.8;
            max-width: 400px;
            line-height: 1.5;
        }

        .debate-message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 70%;
            margin-bottom: 15px;
        }

        .debate-message.pro {
            align-self: flex-start;
        }

        .debate-message.con {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .debate-message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            overflow: hidden;
        }

        .debate-message.pro .debate-message-avatar {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .debate-message.con .debate-message-avatar {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .debate-message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .debate-message-content {
            background: white;
            padding: 15px 20px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.5;
            position: relative;
        }

        .debate-message.pro .debate-message-content {
            background: #e8f5e8;
            border: 1px solid #d4edda;
        }

        .debate-message.pro .debate-message-content::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 20px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid #e8f5e8;
        }

        .debate-message.con .debate-message-content {
            background: #ffeaa7;
            border: 1px solid #fab1a0;
        }

        .debate-message.con .debate-message-content::before {
            content: '';
            position: absolute;
            right: -8px;
            top: 20px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 8px solid #ffeaa7;
        }

        .debate-message-role {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .debate-message.pro .debate-message-role {
            color: #27ae60;
        }

        .debate-message.con .debate-message-role {
            color: #e74c3c;
        }

        /* 辩论消息样式 - 匹配聊天消息结构 */
        .debate-messages .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 70%;
            margin-bottom: 20px;
        }

        .debate-messages .message.pro {
            align-self: flex-start;
        }

        .debate-messages .message.con {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .debate-messages .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            overflow: hidden;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .debate-messages .message-avatar.pro {
            border-color: #27ae60;
        }

        .debate-messages .message-avatar.con {
            border-color: #e74c3c;
        }

        .debate-messages .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .debate-messages .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.4;
            min-width: 180px;
        }

        .debate-messages .message.pro .message-content {
            background: #e8f5e8;
            color: #2c3e50;
            border: 1px solid #d4edda;
        }

        .debate-messages .message.con .message-content {
            background: #fff3cd;
            color: #2c3e50;
            border: 1px solid #ffeaa7;
        }

        .debate-messages .message-content.has-voice {
            min-width: 280px !important;
        }

        .debate-messages .message-text {
            margin-bottom: 4px;
        }

        .debate-messages .message-text:last-child {
            margin-bottom: 0;
        }

        .debate-messages .message-voice {
            margin-top: 8px;
            min-width: 250px;
        }

        .debate-messages .message-voice audio {
            width: 100%;
            min-width: 250px;
            max-width: 400px;
            height: 36px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            outline: none;
        }

        .debate-messages .message-voice audio::-webkit-media-controls-panel {
            border-radius: 8px;
        }

        .debate-messages .message.con .message-voice {
            text-align: right;
        }

        .debate-messages .message-timestamp {
            margin-top: 6px;
            font-size: 11px;
            color: #7f8c8d;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .debate-messages .message.con .message-timestamp {
            text-align: right;
            justify-content: flex-end;
        }

        .debate-messages .debate-side-label {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            flex-shrink: 0;
        }

        .debate-messages .debate-side-label.pro {
            background: #27ae60;
        }

        .debate-messages .debate-side-label.con {
            background: #e74c3c;
        }

        .debate-messages .time-text {
            flex-shrink: 0;
        }

        /* 辩论打字指示器样式 */
        .debate-typing-indicator {
            padding: 20px 0;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .debate-typing-indicator .typing-dots {
            display: flex;
            gap: 4px;
        }

        .debate-controls {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #ecf0f1;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-shrink: 0;
        }

        .debate-control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .debate-start-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .debate-start-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .debate-end-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .debate-end-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .debate-control-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .debate-messages {
                padding: 15px 20px;
                height: calc(100vh - 140px);
                max-height: calc(100vh - 140px);
            }

            .debate-controls {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }

            .debate-control-btn {
                width: 100%;
            }

            .debate-empty {
                padding: 40px 15px;
            }

            .debate-empty-icon {
                font-size: 48px;
                margin-bottom: 15px;
            }

            .debate-empty-text {
                font-size: 20px;
            }

            .debate-empty-hint {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 左侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="create-role-btn" onclick="createRole()">
                    <span>➕</span>
                    创建角色
                </button>
                <button class="debate-btn" onclick="showDebate()">
                    <span>⚔️</span>
                    角色辩论
                </button>
            </div>

            <div class="recent-chats">
                <h3>最近对话</h3>
                <div id="chatList">
                    <div class="no-chats">登录后查看对话记录</div>
                </div>
                <div id="chatsLoading" class="loading-indicator" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>加载更多对话...</div>
                </div>
            </div>

            <div class="recent-debates">
                <h3>历史辩论</h3>
                <div id="debateList">
                    <div class="no-debates">登录后查看辩论记录</div>
                </div>
                <div id="debatesLoading" class="loading-indicator" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>加载更多辩论...</div>
                </div>
            </div>
        </div>

        <!-- 右侧主要内容区 -->
        <div class="main-content" id="main-content">
            <!-- 顶部栏 -->
            <div class="header">
                <div class="user-info" id="userInfo">
                    <!-- 已登录状态 -->
                    <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">用</div>
                    <span class="welcome-text" id="welcomeText">欢迎，用户名</span>

                    <!-- 用户下拉菜单 -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="showUserSettings()">用户设置</div>
                        <div class="dropdown-item logout" onclick="logout()">退出登录</div>
                    </div>

                    <!-- 未登录状态 -->
                    <!-- <button class="login-btn" onclick="login()">登录</button> -->
                </div>

                <div class="search-container">
                    <input type="text" class="search-input" placeholder="搜索角色..." id="searchInput"
                        oninput="searchRoles()">
                    <button class="search-btn">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- 角色卡片区域 -->
            <div class="content-area">
                <div class="roles-grid" id="rolesGrid">
                    <!-- 动态加载的角色将显示在这里 -->
                </div>
                <div id="rolesLoading" class="loading-indicator" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>加载更多角色...</div>
                </div>
            </div>

            <!-- 创建角色页面 -->
            <div class="create-role-page" id="createRolePage">
                <div class="create-role-header">
                    <h2 class="page-title">创建新角色</h2>
                    <button class="back-btn" onclick="backToHome()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
                        </svg>
                        返回
                    </button>
                </div>

                <div class="create-role-content">
                    <form class="role-form" id="roleForm">
                        <!-- 角色头像部分 -->
                        <div class="role-avatar-section">
                            <div class="role-avatar-preview" id="roleAvatarPreview" onclick="uploadRoleAvatar()">
                                <div class="role-avatar-text">🎭</div>
                                <div class="avatar-upload-hint">点击上传头像</div>
                            </div>
                            <input type="file" id="roleAvatarInput" accept="image/*"
                                onchange="handleRoleAvatarUpload(event)">

                            <div class="role-default-avatars">
                                <div class="role-default-avatar selected" data-avatar="🎭"
                                    onclick="chooseRoleDefaultAvatar('🎭')">🎭</div>
                                <div class="role-default-avatar" data-avatar="👑"
                                    onclick="chooseRoleDefaultAvatar('👑')">👑
                                </div>
                                <div class="role-default-avatar" data-avatar="🦸"
                                    onclick="chooseRoleDefaultAvatar('🦸')">🦸
                                </div>
                                <div class="role-default-avatar" data-avatar="🧙"
                                    onclick="chooseRoleDefaultAvatar('🧙')">🧙
                                </div>
                                <div class="role-default-avatar" data-avatar="🐱"
                                    onclick="chooseRoleDefaultAvatar('🐱')">🐱
                                </div>
                                <div class="role-default-avatar" data-avatar="🤖"
                                    onclick="chooseRoleDefaultAvatar('🤖')">🤖
                                </div>
                                <div class="role-default-avatar" data-avatar="🦄"
                                    onclick="chooseRoleDefaultAvatar('🦄')">🦄
                                </div>
                                <div class="role-default-avatar" data-avatar="🐶"
                                    onclick="chooseRoleDefaultAvatar('🐶')">🐶
                                </div>
                                <div class="role-default-avatar" data-avatar="🦊"
                                    onclick="chooseRoleDefaultAvatar('🦊')">🦊
                                </div>
                                <div class="role-default-avatar" data-avatar="🐼"
                                    onclick="chooseRoleDefaultAvatar('🐼')">🐼
                                </div>
                                <div class="role-default-avatar" data-avatar="👨‍🎓"
                                    onclick="chooseRoleDefaultAvatar('👨‍🎓')">
                                    👨‍🎓</div>
                                <div class="role-default-avatar" data-avatar="👩‍🏫"
                                    onclick="chooseRoleDefaultAvatar('👩‍🏫')">
                                    👩‍🏫</div>
                            </div>
                        </div>

                        <!-- 角色名称 -->
                        <div class="role-input-group">
                            <label class="form-label" for="roleName">角色名称</label>
                            <input type="text" id="roleName" class="form-input" placeholder="请输入角色名称" maxlength="50">
                            <div class="error-message" id="roleNameError"></div>
                        </div>

                        <!-- 自动填写按钮 -->
                        <div class="auto-fill-container">
                            <button type="button" class="auto-fill-btn" onclick="autoFillDescription()"
                                id="autoFillBtn">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path
                                        d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM4.5 9a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM4 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 0 1h-4z" />
                                </svg>
                                自动填写
                            </button>
                            <div class="auto-fill-progress" id="autoFillProgress" style="display: none;">
                                正在准备...
                            </div>
                        </div>

                        <!-- 角色描述 -->
                        <div class="role-input-group">
                            <label class="form-label" for="roleDescription">角色描述</label>
                            <textarea id="roleDescription" class="role-textarea" placeholder="请描述角色的背景、性格、外貌等基本信息..."
                                maxlength="500"></textarea>
                            <div class="error-message" id="roleDescriptionError"></div>
                        </div>

                        <!-- 角色特点 -->
                        <div class="role-input-group">
                            <label class="form-label" for="roleTraits">角色特点</label>
                            <textarea id="roleTraits" class="role-textarea" placeholder="请描述角色的特点、技能、爱好、说话风格等..."
                                maxlength="500"></textarea>
                            <div class="error-message" id="roleTraitsError"></div>
                        </div>

                        <!-- 性别、年龄段和声音选择 -->
                        <div class="role-attribute-group">
                            <!-- 角色性别 -->
                            <div class="role-input-group">
                                <label class="form-label">角色性别</label>
                                <div class="role-select-group">
                                    <label class="role-radio-option">
                                        <input type="radio" name="roleGender" value="male" id="genderMale" checked>
                                        <span class="radio-label">男性</span>
                                    </label>
                                    <label class="role-radio-option">
                                        <input type="radio" name="roleGender" value="female" id="genderFemale">
                                        <span class="radio-label">女性</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 年龄段 -->
                            <div class="role-input-group">
                                <label class="form-label">年龄段</label>
                                <div class="role-select-group">
                                    <label class="role-radio-option">
                                        <input type="radio" name="roleAgeGroup" value="young" id="ageYoung" checked>
                                        <span class="radio-label">年轻</span>
                                    </label>
                                    <label class="role-radio-option">
                                        <input type="radio" name="roleAgeGroup" value="mature" id="ageMature">
                                        <span class="radio-label">成熟</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 声音选择 -->
                            <div class="role-input-group">
                                <label class="form-label">角色声音</label>
                                <div class="voice-select-container" id="voiceSelectContainer">
                                    <div class="voice-loading">正在加载声音列表...</div>
                                </div>
                            </div>
                        </div>

                        <!-- 创建按钮 -->
                        <button type="submit" class="create-submit-btn" id="createSubmitBtn">创建角色</button>
                    </form>
                </div>
            </div>

            <!-- 聊天页面 -->
            <div class="create-role-page" id="chatPageNew">
                <div class="create-role-header">
                    <h2 class="page-title" id="currentRoleNameNew">选择一个角色开始对话</h2>
                    <button class="back-btn" onclick="backToHome()">返回主页</button>
                </div>

                <div class="chat-content">
                    <div class="chat-messages" id="chatMessagesNew">
                        <div class="chat-empty" id="chatEmptyNew">
                            <div class="chat-empty-icon">💬</div>
                            <div class="chat-empty-text">还没有聊天记录</div>
                            <div class="chat-empty-hint">选择一个角色开始有趣的对话吧！</div>
                        </div>
                        <div id="dialogsLoading" class="loading-indicator" style="display: none;">
                            <div class="loading-spinner"></div>
                            <div>加载更多消息...</div>
                        </div>
                    </div>

                    <div class="chat-input">
                        <textarea class="message-input" id="messageInputNew" placeholder="输入消息..." rows="1"
                            onkeydown="handleInputKeydown(event)" oninput="adjustTextareaHeight(this)"></textarea>
                        <button class="voice-btn" id="voiceBtnNew" onclick="startVoiceInput()" title="语音输入">
                            🎤
                        </button>
                        <button class="send-btn" id="sendBtnNew" onclick="sendMessage()" title="发送消息" disabled>
                            ➤
                        </button>
                    </div>
                </div>
            </div>

            <!-- 辩论页面 -->
            <div class="create-role-page" id="debatePage">
                <div class="create-role-header">
                    <h2 class="page-title">角色辩论设置</h2>
                    <button class="back-btn" onclick="backToHome()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
                        </svg>
                        返回
                    </button>
                </div>

                <div class="create-role-content">
                    <div class="debate-setup-container">
                        <!-- 辩论主题设置 -->
                        <div class="debate-section">
                            <h3 class="section-title">辩论主题</h3>
                            <div class="role-input-group">
                                <textarea id="debateTopic" class="role-textarea"
                                    placeholder="请输入辩论主题，例如：人工智能的发展是否会对人类就业产生负面影响？" maxlength="200" rows="3"></textarea>
                                <div class="error-message" id="debateTopicError"></div>
                            </div>
                        </div>

                        <!-- 角色选择区域 -->
                        <div class="debate-section">
                            <h3 class="section-title">选择辩论角色</h3>
                            <div class="debate-roles-container">
                                <div class="debate-role-selection">
                                    <h4 class="role-label">正方角色</h4>
                                    <div class="role-selector" id="proRoleSelector" onclick="showRoleSelection('pro')">
                                        <div class="role-preview" id="proRolePreview">
                                            <div class="role-avatar">➕</div>
                                            <div class="role-info">
                                                <div class="role-name">点击选择正方角色</div>
                                                <div class="role-desc">支持辩论主题的一方</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="vs-divider">
                                    <span>VS</span>
                                </div>

                                <div class="debate-role-selection">
                                    <h4 class="role-label">反方角色</h4>
                                    <div class="role-selector" id="conRoleSelector" onclick="showRoleSelection('con')">
                                        <div class="role-preview" id="conRolePreview">
                                            <div class="role-avatar">➕</div>
                                            <div class="role-info">
                                                <div class="role-name">点击选择反方角色</div>
                                                <div class="role-desc">反对辩论主题的一方</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 开始辩论按钮 -->
                        <button type="button" class="create-submit-btn" id="startDebateBtn" onclick="startDebate()">
                            开始辩论
                        </button>
                    </div>
                </div>
            </div>

            <!-- 辩论房间界面 -->
            <div class="create-role-page" id="debateRoomPage">
                <div class="create-role-header">
                    <h2 class="page-title" id="debateRoomTitle">辩论主题</h2>
                    <button class="back-btn" onclick="backToHome()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
                        </svg>
                        返回
                    </button>
                </div>

                <div class="debate-room-content">
                    <div class="debate-messages" id="debateMessages">
                        <div class="debate-empty" id="debateEmpty">
                            <div class="debate-empty-icon">⚔️</div>
                            <div class="debate-empty-text">辩论即将开始</div>
                            <div class="debate-empty-hint">点击"开始辩论"按钮开始这场精彩的辩论</div>
                        </div>
                    </div>

                    <div class="debate-controls">
                        <button class="debate-control-btn debate-start-btn" id="debateStartBtn"
                            onclick="startDebateSession()">
                            开始辩论
                        </button>
                        <button class="debate-control-btn debate-end-btn" id="debateEndBtn" onclick="endDebateSession()"
                            disabled>
                            结束辩论
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建角色页面 -->

    <div class="modal-overlay" id="authModal">
        <div class="auth-modal">
            <button class="modal-close" onclick="closeAuthModal()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                </svg>
            </button>

            <div class="modal-header">
                <h2 class="modal-title">欢迎来到角色扮演AI</h2>
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchTab('login')" id="loginTab">登录</button>
                    <button class="auth-tab" onclick="switchTab('register')" id="registerTab">注册</button>
                </div>
            </div>

            <div class="modal-body">
                <!-- 登录表单 -->
                <form id="loginForm" style="display: block;">
                    <div class="form-group">
                        <label class="form-label" for="loginUsername">用户名</label>
                        <input type="text" id="loginUsername" class="form-input" placeholder="请输入用户名">
                        <div class="error-message" id="loginUsernameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="loginPassword">密码</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="请输入密码">
                        <div class="error-message" id="loginPasswordError"></div>
                    </div>

                    <button type="submit" class="auth-submit" id="loginSubmit">登录</button>
                </form>

                <!-- 注册表单 -->
                <form id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="registerUsername">用户名</label>
                        <input type="text" id="registerUsername" class="form-input" placeholder="请输入用户名">
                        <div class="error-message" id="registerUsernameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="registerPassword">密码</label>
                        <input type="password" id="registerPassword" class="form-input" placeholder="请输入密码">
                        <div class="error-message" id="registerPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">确认密码</label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="请再次输入密码">
                        <div class="error-message" id="confirmPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">用户头像</label>
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="avatarPreview">
                                <div class="avatar-preview-text">👤</div>
                            </div>
                            <div class="avatar-actions">
                                <button type="button" class="avatar-btn" onclick="selectDefaultAvatar()">选择默认头像</button>
                                <button type="button" class="avatar-btn primary" onclick="uploadAvatar()">上传头像</button>
                            </div>
                            <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarUpload(event)">
                        </div>

                        <div class="default-avatars" id="defaultAvatars" style="display: none;">
                            <div class="default-avatar" data-avatar="👤" onclick="chooseDefaultAvatar('👤')">👤</div>
                            <div class="default-avatar" data-avatar="🎭" onclick="chooseDefaultAvatar('🎭')">🎭</div>
                            <div class="default-avatar" data-avatar="🦄" onclick="chooseDefaultAvatar('🦄')">🦄</div>
                            <div class="default-avatar" data-avatar="🐱" onclick="chooseDefaultAvatar('🐱')">🐱</div>
                            <div class="default-avatar" data-avatar="🐶" onclick="chooseDefaultAvatar('🐶')">🐶</div>
                            <div class="default-avatar" data-avatar="🦊" onclick="chooseDefaultAvatar('🦊')">🦊</div>
                            <div class="default-avatar" data-avatar="🐼" onclick="chooseDefaultAvatar('🐼')">🐼</div>
                            <div class="default-avatar" data-avatar="🐯" onclick="chooseDefaultAvatar('🐯')">🐯</div>
                        </div>
                    </div>

                    <button type="submit" class="auth-submit" id="registerSubmit">注册</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 角色选择弹窗 -->
    <div class="modal-overlay" id="roleSelectModal">
        <div class="role-select-modal">
            <button class="modal-close" onclick="closeRoleSelectModal()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                </svg>
            </button>

            <div class="modal-header">
                <h2 class="modal-title">选择角色</h2>
                <div class="role-select-info">
                    <span id="roleSelectSideText">选择正方角色</span>
                </div>
            </div>

            <div class="modal-body">
                <!-- 搜索框 -->
                <div class="role-search-container">
                    <input type="text" class="role-search-input" id="roleSearchInput" placeholder="搜索角色名称..."
                        oninput="searchRolesForModal()">
                    <div class="search-icon">🔍</div>
                </div>

                <!-- 角色列表容器 -->
                <div class="role-list-container" id="roleListContainer">
                    <div class="role-list" id="roleList">
                        <!-- 角色列表将在这里动态加载 -->
                    </div>
                    <div class="role-list-loading" id="roleListLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <div>加载更多角色...</div>
                    </div>
                    <div class="role-list-empty" id="roleListEmpty" style="display: none;">
                        <div class="empty-icon">🎭</div>
                        <div class="empty-text">暂无角色</div>
                        <div class="empty-hint">请尝试其他搜索关键词</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====== Socket.IO 聊天系统 ======
        let socket = null;

        // 初始化Socket.IO连接
        function initSocket() {
            console.log('初始化Socket.IO连接...');

            // 检查当前URL和协议
            console.log('当前URL:', window.location.href);
            console.log('协议:', window.location.protocol);

            // 明确指定Socket.IO服务器地址
            socket = io({
                autoConnect: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5,
                timeout: 20000
            });

            console.log('Socket.IO配置完成');

            // 连接成功
            socket.on('connect', () => {
                console.log('Socket连接成功:', socket.id);
                console.log('Socket连接状态:', socket.connected);
                console.log('Socket对象:', socket);

                // 测试发送一个简单消息
                setTimeout(() => {
                    console.log('发送测试消息...');
                    socket.emit('test', { test: 'hello from frontend' });
                }, 1000);
            });

            // 连接断开
            socket.on('disconnect', (reason) => {
                console.log('Socket连接断开, 原因:', reason);
            });

            // 接收来自后端的消息
            socket.on('message', (data) => {
                console.log('=== 接收到message事件 ===');
                console.log('消息数据:', data);
                console.log('数据类型:', typeof data);
                console.log('========================');
                handleReceivedMessage(data);
                hideTypingIndicator(); // 收到回复后隐藏"正在回复"状态
            });

            // 接收语音转文字更新事件
            socket.on('update_message', (data) => {
                console.log('=== 接收到update_message事件 ===');
                console.log('更新数据:', data);
                console.log('==============================');
                handleMessageUpdate(data);
            });

            // 监听用户消息保存确认事件
            socket.on('user_message_saved', (data) => {
                console.log('=== 用户消息已保存 ===');
                console.log('数据:', data);
                console.log('===================');
                // 更新最近对话列表排序
                updateRecentChatsList();
            });

            // 监听角色构建进度事件
            socket.on('role_build_status', (status) => {
                console.log('=== 角色构建进度 ===');
                console.log('状态:', status);
                console.log('==================');
                updateAutoFillProgress(status);
            });

            // 连接错误处理
            socket.on('connect_error', (error) => {
                console.error('Socket连接错误:', error);
            });

            // 监听所有事件（调试用）
            socket.onAny((event, ...args) => {
                console.log('=== Socket事件 ===');
                console.log('事件名:', event);
                console.log('参数:', args);
                console.log('时间:', new Date().toLocaleTimeString());
                console.log('================');
            });

            // 额外监听一些可能的事件名称
            socket.on('msg', (data) => {
                console.log('收到msg事件:', data);
            });

            socket.on('response', (data) => {
                console.log('收到response事件:', data);

                // 处理接收到的角色回复消息
                if (data && data.role_id) {
                    handleReceivedMessage(data);
                }
            });

            // 定期检查连接状态
            setInterval(() => {
                if (socket) {
                    console.log('Socket状态检查 - 连接:', socket.connected, 'ID:', socket.id);
                }
            }, 10000); // 每10秒检查一次
        }

        // 发送消息到后端
        function sendSocketMessage(userId, roleId, text) {
            if (!socket) {
                console.error('Socket未初始化');
                return;
            }

            if (!socket.connected) {
                console.error('Socket未连接');
                return;
            }

            const messageData = {
                user_id: parseInt(userId),
                role_id: parseInt(roleId),
                timestamp: Date.now(),
                text: text
            };

            console.log('=== 发送消息 ===');
            console.log('Socket ID:', socket.id);
            console.log('Socket连接状态:', socket.connected);
            console.log('消息数据:', messageData);
            console.log('===============');

            socket.emit('message', messageData);
        }

        // 发送语音消息到后端
        function sendVoiceMessage(userId, roleId, voiceUrl, messageId) {
            if (!socket) {
                console.error('Socket未初始化');
                return;
            }

            if (!socket.connected) {
                console.error('Socket未连接');
                return;
            }

            const messageData = {
                user_id: parseInt(userId),
                role_id: parseInt(roleId),
                timestamp: Date.now(),
                voice_url: voiceUrl,
                id: messageId
            };

            console.log('=== 发送语音消息 ===');
            console.log('Socket ID:', socket.id);
            console.log('Socket连接状态:', socket.connected);
            console.log('语音消息数据:', messageData);
            console.log('=================');

            socket.emit('voice', messageData);
        }

        // 处理消息更新（语音转文字）
        function handleMessageUpdate(data) {
            console.log('处理消息更新:', data);

            if (!data.id || !data.text) {
                console.error('消息更新数据不完整:', data);
                return;
            }

            // 查找对应ID的消息并更新文本
            const messageIndex = chatMessages.findIndex(msg => msg.id === data.id);
            if (messageIndex !== -1) {
                chatMessages[messageIndex].message = data.text;
                console.log('消息文本已更新:', chatMessages[messageIndex]);
                renderChatMessages();
                showTypingIndicator(); // 显示"正在回复"状态
            } else {
                console.error('找不到对应ID的消息:', data.id);
            }
        }

        // 处理接收到的消息
        function handleReceivedMessage(data) {
            console.log('处理接收到的消息:', data);
            console.log('当前聊天角色:', currentChatRole);

            if (!currentChatRole) {
                console.log('没有当前聊天角色，忽略消息');
                return;
            }

            const currentRoleId = parseInt(currentChatRole.id);
            const messageRoleId = parseInt(data.role_id);
            console.log('角色ID比较:', { currentRoleId, messageRoleId });

            if (currentRoleId !== messageRoleId) {
                console.log('消息角色不匹配，忽略', {
                    current: currentRoleId,
                    received: messageRoleId
                });
                return;
            }

            console.log('消息验证通过，添加到聊天记录');

            // 添加角色消息到聊天记录
            const message = {
                id: ++messageIdCounter, // 为接收到的消息也添加ID
                sender: 'role',
                message: data.text,
                timestamp: data.timestamp || Math.floor(Date.now() / 1000),
                voice: data.voice_url
            };

            chatMessages.push(message);
            console.log('消息已添加，重新渲染界面');
            renderChatMessages();

            // 触发动态时间更新
            onNewMessageAdded();

            // 自动播放AI回复的语音
            if (data.voice_url) {
                console.log('自动播放AI语音:', data.voice_url);
                playVoice(data.voice_url);
            }

            // 更新最近对话列表排序
            updateRecentChatsList();
        }

        // 用户状态管理
        let isLoggedIn = false; // 改为未登录状态
        let currentUser = {
            id: "",
            name: "",
            avatar: ""
        };

        // 当前辩论ID
        let currentDebateId = null;

        // 当前选择的头像
        let selectedAvatar = '👤';
        let selectedAvatarType = 'default'; // 'default' 或 'custom'
        let customAvatarFile = null;

        // SHA-256 哈希函数
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // 角色数据
        let roles = [];

        // 声音数据
        let voiceList = [];
        let selectedVoice = null;

        // 懒加载状态
        const lazyLoadState = {
            roles: {
                offset: 0,
                limit: 15,
                loading: false,
                hasMore: true,
                total: 0
            },
            conversations: {
                offset: 0,
                limit: 15,
                loading: false,
                hasMore: true,
                total: 0
            },
            debates: {
                offset: 0,
                limit: 15,
                loading: false,
                hasMore: true,
                total: 0
            },
            dialogs: {
                offset: 0,
                limit: 20,
                loading: false,
                hasMore: true,
                total: 0
            }
        };

        // 加载角色列表（懒加载版本）
        async function loadRoles(append = false) {
            if (lazyLoadState.roles.loading) return;

            try {
                lazyLoadState.roles.loading = true;

                if (!append) {
                    // 重置数据
                    roles = [];
                    lazyLoadState.roles.offset = 0;
                    lazyLoadState.roles.hasMore = true;
                }

                if (!lazyLoadState.roles.hasMore) {
                    lazyLoadState.roles.loading = false;
                    return;
                }

                const url = `/api/role/list?offset=${lazyLoadState.roles.offset}&limit=${lazyLoadState.roles.limit}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('角色列表数据:', data);

                    if (data && data.items && Array.isArray(data.items)) {
                        const newRoles = data.items.map(role => ({
                            id: String(role.role_id),
                            user_id: role.user_id,
                            name: role.name,
                            description: role.description,
                            traits: role.traits,
                            image_url: role.image_url,
                            emoji: isEmoji(role.image_url) ? role.image_url : null
                        }));

                        if (append) {
                            roles.push(...newRoles);
                            // 渲染新角色（追加模式）
                            renderRoles(newRoles, true);
                        } else {
                            roles = newRoles;
                            // 渲染所有角色（替换模式）
                            renderRoles(roles, false);
                        }

                        lazyLoadState.roles.total = data.total;
                        lazyLoadState.roles.hasMore = data.has_more;
                        lazyLoadState.roles.offset += lazyLoadState.roles.limit;
                    } else {
                        console.warn('角色列表格式错误:', data);
                        if (!append) {
                            roles = [];
                            lazyLoadState.roles.hasMore = false;
                        }
                    }
                } else {
                    console.warn('获取角色列表失败:', response.status);
                    if (!append) {
                        roles = [];
                        lazyLoadState.roles.hasMore = false;
                    }
                }
            } catch (error) {
                console.error('加载角色列表错误:', error);
                if (!append) {
                    roles = [];
                    lazyLoadState.roles.hasMore = false;
                }
            } finally {
                lazyLoadState.roles.loading = false;
            }
        }

        // 获取角色详情
        async function getRoleDetails(roleId) {
            try {
                const response = await fetch(`/api/role/details?role_id=${parseInt(roleId)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return {
                        name: data.name,
                        description: data.description,
                        traits: data.traits,
                        image_url: data.image_url
                    };
                } else {
                    console.warn('获取角色详情失败:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('获取角色详情错误:', error);
                return null;
            }
        }

        // 检查是否为emoji
        function isEmoji(str) {
            if (!str || str.length > 4) return false;
            const emojiRegex = /^[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F900}-\u{1F9FF}]|[\u{1F018}-\u{1F270}]$/u;
            return emojiRegex.test(str);
        }

        // 格式化时间戳为友好显示格式
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';

            try {
                let date;

                // 处理不同的时间戳格式
                if (typeof timestamp === 'number') {
                    // 判断是毫秒还是秒格式
                    if (timestamp > 9999999999) { // 大于这个数字就是毫秒格式
                        date = new Date(timestamp);
                    } else {
                        // 否则是秒格式，转换为毫秒
                        date = new Date(timestamp * 1000);
                    }
                } else if (timestamp instanceof Date) {
                    date = timestamp;
                } else {
                    // 尝试解析字符串或其他格式
                    date = new Date(timestamp);
                }

                // 检查日期是否有效
                if (isNaN(date.getTime())) {
                    console.error('无效的时间戳:', timestamp);
                    return '';
                }

                const now = new Date();
                const diff = now - date;

                // 如果时间差为负数（未来的时间），直接显示日期
                if (diff < 0) {
                    const isThisYear = date.getFullYear() === now.getFullYear();
                    if (isThisYear) {
                        return `${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    } else {
                        return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    }
                }

                // 小于1分钟显示"刚刚"
                if (diff < 60000) {
                    return '刚刚';
                }

                // 小于1小时显示"X分钟前"
                if (diff < 3600000) {
                    const minutes = Math.floor(diff / 60000);
                    return `${minutes}分钟前`;
                }

                // 超过1小时显示具体日期时间
                const isThisYear = date.getFullYear() === now.getFullYear();

                if (isThisYear) {
                    return `${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                } else {
                    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                }
            } catch (error) {
                console.error('时间格式化错误:', error, '原始时间戳:', timestamp);
                return '';
            }
        }

        // 获取相对时间显示
        function getTimeAgo(timestamp) {
            if (!timestamp) return '';

            try {
                let date;
                if (typeof timestamp === 'number') {
                    if (timestamp > 9999999999) {
                        date = new Date(timestamp);
                    } else {
                        date = new Date(timestamp * 1000);
                    }
                } else {
                    date = new Date(timestamp);
                }

                if (isNaN(date.getTime())) {
                    return '';
                }

                const now = new Date();
                const diff = now - date;

                if (diff < 0) return '刚刚';
                if (diff < 60000) return '刚刚';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}分钟前`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}小时前`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)}天前`;

                return formatTimestamp(timestamp);
            } catch (error) {
                console.error('时间计算错误:', error);
                return '';
            }
        }

        // HTML转义函数
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 动态时间更新系统
        let timeUpdateInterval = null;

        // 启动动态时间更新
        function startTimeUpdates() {
            // 清除现有的定时器
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
            }

            // 每30秒更新一次时间显示
            timeUpdateInterval = setInterval(updateAllTimestamps, 30000);
        }

        // 更新页面上所有的时间戳显示
        function updateAllTimestamps() {
            const timestampElements = document.querySelectorAll('.message-timestamp[data-timestamp]');
            let hasRecentMessages = false;
            let updatedCount = 0;

            console.log(`[时间更新] 找到 ${timestampElements.length} 个时间戳元素`);

            timestampElements.forEach(element => {
                const originalTimestamp = parseInt(element.getAttribute('data-timestamp'));
                if (originalTimestamp) {
                    const now = Date.now();
                    const diff = now - originalTimestamp;

                    // 检查是否有1小时内的消息
                    if (diff < 3600000) {
                        hasRecentMessages = true;
                    }

                    const newText = formatTimestamp(originalTimestamp);

                    // 检查是否是辩论消息的时间戳（包含正反方标志）
                    const timeTextElement = element.querySelector('.time-text');
                    if (timeTextElement) {
                        // 辩论消息：只更新时间文本部分
                        if (timeTextElement.textContent !== newText) {
                            console.log(`[时间更新] 更新辩论时间: "${timeTextElement.textContent}" -> "${newText}"`);
                            timeTextElement.textContent = newText;
                            updatedCount++;

                            // 添加淡入效果，提示用户时间已更新
                            element.style.opacity = '0.6';
                            setTimeout(() => {
                                element.style.opacity = '1';
                            }, 150);
                        }
                    } else {
                        // 普通消息：更新整个时间戳
                        if (element.textContent !== newText) {
                            console.log(`[时间更新] 更新时间: "${element.textContent}" -> "${newText}"`);
                            element.textContent = newText;
                            updatedCount++;

                            // 添加淡入效果，提示用户时间已更新
                            element.style.opacity = '0.6';
                            setTimeout(() => {
                                element.style.opacity = '1';
                            }, 150);
                        }
                    }
                }
            });

            console.log(`[时间更新] 完成更新，共更新了 ${updatedCount} 个时间戳，有最近消息: ${hasRecentMessages}`);

            // 如果没有最近的消息，减少更新频率
            if (!hasRecentMessages) {
                adjustUpdateFrequency(false);
            }
        }

        // 调整更新频率
        function adjustUpdateFrequency(hasRecentMessages) {
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
            }

            // 如果有最近消息，30秒更新一次；否则2分钟更新一次
            const interval = hasRecentMessages ? 30000 : 120000;
            timeUpdateInterval = setInterval(updateAllTimestamps, interval);
        }

        // 停止动态时间更新
        function stopTimeUpdates() {
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
                timeUpdateInterval = null;
            }
        }

        // 当添加新消息时，重置更新频率
        function onNewMessageAdded() {
            // 立即更新一次时间戳
            updateAllTimestamps();
            // 重新启动高频更新
            startTimeUpdates();
        }

        // 获取默认角色数据（作为fallback）
        function getDefaultRoles() {
            return [
                {
                    id: 'princess',
                    name: '艾莉娅公主',
                    emoji: '👑',
                    image_url: '👑',
                    description: '来自魔法王国的优雅公主，善良聪慧，拥有强大的魔法力量',
                    traits: '优雅、善良、聪慧、魔法'
                },
                {
                    id: 'assistant',
                    name: '智能助手',
                    emoji: '🤖',
                    image_url: '🤖',
                    description: '专业的AI助手，可以帮助您解决各种问题和提供建议',
                    traits: '专业、高效、有帮助、智能'
                },
                {
                    id: 'catgirl',
                    name: '猫娘女仆',
                    emoji: '🐱',
                    image_url: '🐱',
                    description: '可爱的猫娘女仆，温柔体贴，会照顾主人的日常生活',
                    traits: '可爱、温柔、体贴、忠诚'
                },
                {
                    id: 'detective',
                    name: '名侦探',
                    emoji: '🕵️',
                    image_url: '🕵️',
                    description: '敏锐的观察力和逻辑思维，擅长解决各种神秘案件',
                    traits: '敏锐、逻辑、推理、神秘'
                },
                {
                    id: 'wizard',
                    name: '古老法师',
                    emoji: '🧙‍♂️',
                    image_url: '🧙‍♂️',
                    description: '拥有千年智慧的法师，掌握着古老而强大的魔法知识',
                    traits: '智慧、神秘、强大、古老'
                },
                {
                    id: 'teacher',
                    name: '温柔老师',
                    emoji: '👩‍🏫',
                    image_url: '👩‍🏫',
                    description: '耐心温和的老师，擅长教学和引导学生思考',
                    traits: '耐心、温和、教学、引导'
                }
            ];
        }

        // 初始化页面
        async function initPage() {
            // 初始化Socket.IO连接
            initSocket();

            // 检查本地存储的token，尝试恢复登录状态
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const response = await fetch('/api/auth/verify', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        isLoggedIn = true;
                        currentUser = {
                            id: userData.user_id,
                            name: userData.username,
                            avatar: userData.avatar
                        };
                    } else {
                        // Token无效，清除本地存储
                        localStorage.removeItem('authToken');
                        isLoggedIn = false;
                    }
                } catch (error) {
                    console.error('验证token失败:', error);
                    localStorage.removeItem('authToken');
                    isLoggedIn = false;
                }
            }

            updateUserInfo();
            await loadRoles();

            // 如果已登录，加载最近对话和历史辩论
            if (isLoggedIn) {
                await loadRecentChats();
                await loadRecentDebates();
            }

            // 从URL锚点恢复页面状态
            restoreFromUrlHash();

            // 启动动态时间更新
            startTimeUpdates();
        }

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', function () {
            stopTimeUpdates();
        });

        // 页面可见性变化时的处理
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                // 页面隐藏时停止更新
                console.log('[时间更新] 页面隐藏，暂停时间更新');
                stopTimeUpdates();
            } else {
                // 页面显示时恢复更新
                console.log('[时间更新] 页面显示，恢复时间更新');
                // 立即更新一次，然后启动定时器
                updateAllTimestamps();
                startTimeUpdates();
            }
        });

        // 更新用户信息显示
        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            if (isLoggedIn) {
                // 判断头像格式：URL、base64或表情符号
                let avatarElement;
                if (currentUser.avatar.startsWith('http') || currentUser.avatar.startsWith('/')) {
                    // 图片URL
                    avatarElement = `<img src="${currentUser.avatar}" alt="用户头像" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else if (currentUser.avatar.startsWith('data:image')) {
                    // base64格式
                    avatarElement = `<img src="${currentUser.avatar}" alt="用户头像" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    // 表情符号
                    avatarElement = currentUser.avatar;
                }

                userInfo.innerHTML = `
                    <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">${avatarElement}</div>
                    <span class="welcome-text">欢迎，${currentUser.name}</span>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="showUserSettings()">用户设置</div>
                        <div class="dropdown-item logout" onclick="logout()">退出登录</div>
                    </div>
                `;
            } else {
                userInfo.innerHTML = `
                    <button class="login-btn" onclick="login()">登录</button>
                `;
            }
        }

        // 用户下拉菜单控制
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // 显示用户设置
        function showUserSettings() {
            currentPage = 'user-settings';
            currentChatRoleId = null;

            // 关闭下拉菜单
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');

            // 隐藏其他页面
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('createRolePage').classList.remove('active');
            document.getElementById('chatPageNew').classList.remove('active');

            // 隐藏header
            document.querySelector('.header').style.display = 'none';

            const mainContent = document.getElementById('main-content');
            // 找到content-area的兄弟元素来插入用户设置
            const contentArea = document.querySelector('.content-area');

            // 创建用户设置容器
            let settingsContainer = document.getElementById('user-settings-page');
            if (!settingsContainer) {
                settingsContainer = document.createElement('div');
                settingsContainer.id = 'user-settings-page';
                settingsContainer.style.display = 'none';
                settingsContainer.className = 'content-area';
                mainContent.appendChild(settingsContainer);
            }

            // 显示用户设置页面
            settingsContainer.style.display = 'flex';
            settingsContainer.style.flexDirection = 'column';
            settingsContainer.style.padding = '0';

            settingsContainer.innerHTML = `
                <div class="user-settings-container">
                    <div class="create-role-header">
                        <h2 class="page-title">用户设置</h2>
                        <button class="back-btn" onclick="backToHome()">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
                            </svg>
                            返回
                        </button>
                    </div>
                    
                    <div class="user-settings-content">
                        <div class="user-settings-content-inner">
                            <!-- 头像部分 -->
                            <div class="setting-section avatar-section">
                                <div class="avatar-container" onclick="document.getElementById('avatarInput').click()" title="点击更换头像">
                                    <img id="settingsAvatar" class="user-avatar clickable-avatar" src="" alt="用户头像">
                                    <div class="avatar-overlay">更换</div>
                                    <input type="file" id="avatarInput" accept="image/*" onchange="updateUserAvatar()" style="display: none;">
                                </div>
                            </div>
                    
                    <!-- 密码部分 -->
                    <div class="setting-section password-section">
                        <div class="password-row">
                            <div class="password-field">
                                <label for="currentPassword">当前密码 *</label>
                                <input type="password" id="currentPassword" class="setting-input" placeholder="输入当前密码" required>
                            </div>
                            <div class="password-field">
                                <label for="newPassword">新密码 *</label>
                                <input type="password" id="newPassword" class="setting-input" placeholder="输入新密码" required>
                            </div>
                            <div class="password-field">
                                <label for="confirmPassword">确认密码 *</label>
                                <input type="password" id="confirmPassword" class="setting-input" placeholder="再次输入新密码" required>
                            </div>
                        </div>
                        <button onclick="updatePassword()" class="update-btn">更新密码</button>
                    </div>
                    
                    <!-- 角色列表部分 -->
                    <div class="setting-section roles-section">
                        <div class="roles-header">
                            <h3>我的角色</h3>
                        </div>
                        <div id="rolesList" class="roles-list">
                            <!-- 角色列表将在这里动态加载 -->
                        </div>
                    </div>
                    
                            <!-- 操作区域 -->
                            <div class="setting-section actions-section">
                                <button onclick="clearAllConversations()" class="danger-btn">清空所有对话</button>
                                <button onclick="deleteAllDebates()" class="danger-btn">删除所有辩论</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            loadUserSettings();

            // 只在当前URL不是user-settings时才更新锚点，避免无限循环
            if (window.location.hash !== '#user-settings') {
                updateUrlHash();
            }
        }

        // 退出登录
        function logout() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');

            // 清除本地存储
            localStorage.removeItem('authToken');

            // 重置登录状态
            isLoggedIn = false;
            currentUser = { id: null, name: '', avatar: '' };

            // 更新UI
            updateUserInfo();

            // 重新加载页面数据
            loadRoles();
            document.getElementById('chatList').innerHTML = '<div class="no-chats">登录后查看对话记录</div>';
            document.getElementById('debateList').innerHTML = '<div class="no-debates">登录后查看辩论记录</div>';

            // 如果当前在聊天页面，返回主页
            if (currentPage === 'chat') {
                backToHome();
            }

            alert('已退出登录');
        }

        // 初始化滚动监听器
        function initScrollListeners() {
            // 角色内容区域滚动监听（角色懒加载）
            const contentArea = document.querySelector('.content-area');
            if (contentArea) {
                contentArea.addEventListener('scroll', function () {
                    if (getCurrentPage() === 'home') {
                        handleMainContentScroll();
                    }
                });
            }

            // 侧边栏对话列表滚动监听
            const recentChats = document.querySelector('.recent-chats');
            if (recentChats) {
                recentChats.addEventListener('scroll', function () {
                    handleChatListScroll();
                });
            }

            // 侧边栏历史辩论列表滚动监听
            const recentDebates = document.querySelector('.recent-debates');
            if (recentDebates) {
                recentDebates.addEventListener('scroll', function () {
                    handleDebateListScroll();
                });
            }

            // 聊天消息区域滚动监听
            const chatMessages = document.getElementById('chatMessagesNew');
            if (chatMessages) {
                chatMessages.addEventListener('scroll', function () {
                    if (getCurrentPage() === 'chat') {
                        handleChatMessagesScroll();
                    }
                });
            }
        }

        // 处理主内容区域滚动（角色懒加载）
        function handleMainContentScroll() {
            const contentArea = document.querySelector('.content-area');
            const scrollTop = contentArea.scrollTop;
            const scrollHeight = contentArea.scrollHeight;
            const clientHeight = contentArea.clientHeight;

            // 检查是否有搜索内容
            const searchInput = document.getElementById('searchInput');
            const hasSearchTerm = searchInput && searchInput.value.trim().length > 0;

            console.log('角色区域滚动检测:', {
                scrollTop, scrollHeight, clientHeight,
                distance: scrollHeight - scrollTop - clientHeight,
                loading: lazyLoadState.roles.loading,
                hasMore: lazyLoadState.roles.hasMore,
                hasSearchTerm
            });

            // 如果有搜索词，不触发懒加载，避免覆盖搜索结果
            if (hasSearchTerm) {
                console.log('搜索模式，跳过懒加载');
                return;
            }

            // 距离底部100px时开始加载更多
            if (scrollHeight - scrollTop - clientHeight < 100 && !lazyLoadState.roles.loading && lazyLoadState.roles.hasMore) {
                console.log('触发角色懒加载');
                showLoadingIndicator('roles');
                loadRoles(true).finally(() => {
                    hideLoadingIndicator('roles');
                });
            }
        }

        // 处理对话列表滚动
        function handleChatListScroll() {
            const recentChats = document.querySelector('.recent-chats');
            const scrollTop = recentChats.scrollTop;
            const scrollHeight = recentChats.scrollHeight;
            const clientHeight = recentChats.clientHeight;

            console.log('对话列表滚动检测:', {
                scrollTop, scrollHeight, clientHeight,
                distance: scrollHeight - scrollTop - clientHeight,
                loading: lazyLoadState.conversations.loading,
                hasMore: lazyLoadState.conversations.hasMore
            });

            if (scrollHeight - scrollTop - clientHeight < 50 && !lazyLoadState.conversations.loading && lazyLoadState.conversations.hasMore) {
                console.log('触发对话懒加载');
                showLoadingIndicator('chats');
                loadRecentChats(true).then(() => {
                    hideLoadingIndicator('chats');
                });
            }
        }

        // 处理历史辩论列表滚动
        function handleDebateListScroll() {
            const recentDebates = document.querySelector('.recent-debates');
            const scrollTop = recentDebates.scrollTop;
            const scrollHeight = recentDebates.scrollHeight;
            const clientHeight = recentDebates.clientHeight;

            console.log('历史辩论列表滚动检测:', {
                scrollTop, scrollHeight, clientHeight,
                distance: scrollHeight - scrollTop - clientHeight,
                loading: lazyLoadState.debates.loading,
                hasMore: lazyLoadState.debates.hasMore
            });

            if (scrollHeight - scrollTop - clientHeight < 50 && !lazyLoadState.debates.loading && lazyLoadState.debates.hasMore) {
                console.log('触发历史辩论懒加载');
                showLoadingIndicator('debates');
                loadRecentDebates(true).then(() => {
                    hideLoadingIndicator('debates');
                });
            }
        }

        // 处理聊天消息滚动
        function handleChatMessagesScroll() {
            const chatMessagesElement = document.getElementById('chatMessagesNew');
            const scrollTop = chatMessagesElement.scrollTop;

            // 在顶部时加载更早的消息（聊天记录是从上往下滚动看历史消息）
            if (scrollTop < 100 && !lazyLoadState.dialogs.loading && lazyLoadState.dialogs.hasMore && currentChatRole) {
                showLoadingIndicator('dialogs');
                const currentScrollHeight = chatMessagesElement.scrollHeight;

                loadChatDialogs(currentChatRole.id, true).then((newMessages) => {
                    if (newMessages.length > 0) {
                        // 将新消息添加到数组前面（历史消息在前）
                        chatMessages = [...newMessages, ...chatMessages];
                        renderChatMessages();

                        // 保持滚动位置
                        const newScrollHeight = chatMessagesElement.scrollHeight;
                        chatMessagesElement.scrollTop = newScrollHeight - currentScrollHeight;
                    }
                    hideLoadingIndicator('dialogs');
                });
            }
        }

        // 显示加载指示器
        function showLoadingIndicator(type) {
            const indicators = {
                'roles': 'rolesLoading',
                'chats': 'chatsLoading',
                'debates': 'debatesLoading',
                'dialogs': 'dialogsLoading'
            };

            const elementId = indicators[type];
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'flex';
                }
            }
        }

        // 隐藏加载指示器
        function hideLoadingIndicator(type) {
            const indicators = {
                'roles': 'rolesLoading',
                'chats': 'chatsLoading',
                'debates': 'debatesLoading',
                'dialogs': 'dialogsLoading'
            };

            const elementId = indicators[type];
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'none';
                }
            }
        }

        // 获取当前页面
        function getCurrentPage() {
            const hash = window.location.hash;
            if (hash.startsWith('#chat/')) return 'chat';
            if (hash === '#create-role') return 'create-role';
            return 'home';
        }

        // 渲染角色卡片
        function renderRoles(rolesToRender, append = false) {
            const rolesGrid = document.getElementById('rolesGrid');

            if (!append && rolesToRender.length === 0) {
                rolesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">🔍</div>
                        <div class="empty-text">暂无角色</div>
                    </div>
                `;
                return;
            }

            const roleCardsHtml = rolesToRender.map(role => {
                // 调试信息
                console.log('渲染角色:', role.name, 'user_id:', role.user_id, 'currentUser:', currentUser);

                // 处理角色图片显示
                let roleImageContent = '';
                if (role.image_url) {
                    if (isEmoji(role.image_url)) {
                        // 如果是emoji，直接显示
                        roleImageContent = role.image_url;
                    } else {
                        // 如果是URL，显示图片
                        roleImageContent = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                    }
                } else if (role.emoji) {
                    // 兼容旧的emoji字段
                    roleImageContent = role.emoji;
                } else {
                    // 默认头像
                    roleImageContent = '🎭';
                }

                return `
                    <div class="role-card">
                        <div class="role-image" onclick="selectRole('${role.id}')">${roleImageContent}</div>
                        <div class="role-info" onclick="selectRole('${role.id}')">
                            <div class="role-name">${role.name}</div>
                            <div class="role-description">${role.description}</div>
                        </div>
                        <div class="role-actions">
                            <button class="chat-role-btn" onclick="event.stopPropagation(); startChatWithRole('${role.id}')" title="开始对话">
                                💬
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            if (append) {
                rolesGrid.innerHTML += roleCardsHtml;
            } else {
                rolesGrid.innerHTML = roleCardsHtml;
            }
        }

        // 搜索角色
        async function searchRoles() {
            console.log('searchRoles函数被调用！');

            // 简化逻辑：主要处理主界面搜索
            const mainSearchInput = document.getElementById('searchInput');
            const searchTerm = mainSearchInput?.value?.trim() || '';

            console.log('搜索调试信息:', {
                searchTerm,
                rolesCount: roles.length
            });

            if (!searchTerm) {
                // 如果搜索词为空，显示所有角色
                console.log('搜索词为空，显示所有角色');
                renderRoles(roles);
                return;
            }

            console.log('开始搜索，搜索词:', searchTerm);

            try {
                // 调用后端搜索接口
                const response = await fetch(`/api/role/search?q=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const searchResults = await response.json();
                    const formattedResults = searchResults.map(role => ({
                        id: String(role.role_id), // 确保ID是字符串
                        name: role.name,
                        description: role.description,
                        traits: role.traits,
                        image_url: role.image_url,
                        gender: role.gender,
                        voice_type: role.voice_type
                    }));
                    renderRoles(formattedResults);
                } else {
                    console.warn('搜索请求失败:', response.status);
                    // 降级到客户端搜索
                    const filteredRoles = roles.filter(role =>
                        role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        role.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (role.traits && role.traits.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                    renderRoles(filteredRoles);
                }
            } catch (error) {
                console.error('搜索错误:', error);
                // 降级到客户端搜索
                const filteredRoles = roles.filter(role =>
                    role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    role.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (role.traits && role.traits.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                renderRoles(filteredRoles);
            }
        }

        // 当前页面状态
        let currentPage = 'home'; // 'home', 'create-role', 'chat'
        let currentChatRoleId = null; // 当前聊天的角色ID
        let pendingAction = null; // 登录后需要执行的操作

        // 设置登录后需要执行的操作
        function setPendingAction(action, params = null) {
            pendingAction = {
                action: action,
                params: params
            };
            console.log('设置登录后待执行操作:', pendingAction);
        }

        // 执行登录后的待处理操作
        function executePendingAction() {
            if (!pendingAction) return;

            console.log('执行登录后待处理操作:', pendingAction);
            const { action, params } = pendingAction;

            // 清除待处理操作
            pendingAction = null;

            // 执行对应的操作
            switch (action) {
                case 'createRole':
                    showCreateRolePage();
                    break;
                case 'selectRole':
                    if (params && params.roleId) {
                        startChatWithRole(params.roleId);
                    }
                    break;
                case 'openChat':
                    if (params && params.roleId) {
                        openChatDirect(params.roleId);
                    }
                    break;
                case 'startChatWithRole':
                    if (params && params.roleId) {
                        startChatWithRole(params.roleId);
                    }
                    break;
                default:
                    console.warn('未知的待处理操作:', action);
                    break;
            }
        }

        // 更新URL锚点
        function updateUrlHash(customHash = null) {
            let hash = '';

            // 如果提供了自定义hash，直接使用
            if (customHash) {
                hash = `#${customHash}`;
            } else {
                // 否则根据currentPage生成hash
                switch (currentPage) {
                    case 'create-role':
                        hash = '#create-role';
                        break;
                    case 'debate':
                        hash = '#debate';
                        break;
                    case 'chat':
                        if (currentChatRoleId) {
                            hash = `#chat/${currentChatRoleId}`;
                        } else {
                            hash = '#chat';
                        }
                        break;
                    case 'user-settings':
                        hash = '#user-settings';
                        break;
                    case 'home':
                    default:
                        hash = '#home';
                        break;
                }
            }
            console.log('更新URL锚点:', hash);
            window.location.hash = hash;
        }

        // 从URL锚点恢复页面状态
        function restoreFromUrlHash() {
            const hash = window.location.hash.substring(1); // 移除 # 符号
            console.log('从URL锚点恢复页面状态:', hash);
            console.log('restoreFromUrlHash调用堆栈:', new Error().stack);

            if (!hash) {
                console.log('hash为空，调用backToHome');
                backToHome();
                return;
            }

            // 分离页面名称和参数
            const questionMarkIndex = hash.indexOf('?');
            let pageWithPath = hash;
            if (questionMarkIndex > 0) {
                pageWithPath = hash.substring(0, questionMarkIndex);
            }

            const parts = pageWithPath.split('/');
            const page = parts[0];

            console.log('解析结果:', { hash, pageWithPath, parts, page });

            switch (page) {
                case 'create-role':
                    showCreateRolePage();
                    break;
                case 'debate':
                    showDebate();
                    break;
                case 'debate-room':
                    console.log('处理debate-room路由，hash:', hash);
                    // 检查是否包含参数
                    const questionMarkIndex = hash.indexOf('?');
                    console.log('questionMarkIndex:', questionMarkIndex);
                    if (questionMarkIndex > 0) {
                        // 解析URL参数
                        const paramString = hash.substring(questionMarkIndex + 1);
                        console.log('paramString:', paramString);
                        const params = new URLSearchParams(paramString);
                        const userId = params.get('user_id');
                        const role1Id = params.get('role1_id');
                        const role2Id = params.get('role2_id');
                        const debateId = params.get('debate_id');

                        console.log('解析出的参数:', { userId, role1Id, role2Id, debateId });
                        console.log('当前用户状态:', { isLoggedIn, currentUser });

                        if (userId && role1Id && role2Id && isLoggedIn && currentUser?.id == parseInt(userId)) {
                            // 根据参数恢复辩论房间状态
                            console.log('开始恢复辩论房间，参数:', { userId, role1Id, role2Id, debateId });
                            restoreDebateRoomFromParams(role1Id, role2Id, debateId);
                        } else {
                            // 参数不完整或用户不匹配，回到辩论设置页面
                            console.log('恢复辩论房间失败，条件不满足:', {
                                userId,
                                role1Id,
                                role2Id,
                                isLoggedIn,
                                currentUserId: currentUser?.id,
                                userIdParsed: parseInt(userId),
                                comparison: currentUser?.id == parseInt(userId)
                            });
                            showDebate();
                        }
                    } else {
                        console.log('没有找到参数，使用默认逻辑');
                        // 如果已有选定的辩论角色，显示辩论房间
                        if (currentDebateRoles && currentDebateRoles.pro && currentDebateRoles.con) {
                            showDebateRoom();
                        } else {
                            // 否则回到辩论设置页面
                            showDebate();
                        }
                    }
                    break;
                case 'chat':
                    const roleId = parts[1];
                    if (roleId && isLoggedIn) {
                        // 只有在登录状态下才恢复聊天页面
                        showChatPage(roleId);
                    } else if (!isLoggedIn) {
                        // 未登录时跳转到主页
                        backToHome();
                    } else {
                        // 没有角色ID，显示聊天页面但不加载特定对话
                        showChatPage(null);
                    }
                    break;
                case 'user-settings':
                    if (isLoggedIn) {
                        // 只有在登录状态下才显示用户设置
                        showUserSettings();
                    } else {
                        // 未登录时跳转到主页
                        backToHome();
                    }
                    break;
                case 'home':
                default:
                    backToHome();
                    break;
            }
        }

        // 监听浏览器前进后退事件
        window.addEventListener('hashchange', function () {
            console.log('检测到锚点变化');
            restoreFromUrlHash();
        });

        // 角色创建相关变量
        let selectedRoleAvatar = '🎭';
        let selectedRoleAvatarType = 'default';
        let customRoleAvatarFile = null;

        // 创建角色
        function createRole() {
            if (!isLoggedIn) {
                setPendingAction('createRole');
                showAuthModal();
                return;
            }
            showCreateRolePage();
        }

        // 显示辩论页面
        function showDebate() {
            currentPage = 'debate';
            currentChatRoleId = null;

            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('createRolePage').classList.remove('active');
            document.getElementById('chatPageNew').classList.remove('active');
            document.getElementById('debatePage').classList.add('active');

            // 重置辩论表单
            resetDebateForm();

            // 更新URL锚点
            updateUrlHash('debate');
        }

        // 重置辩论表单
        function resetDebateForm() {
            document.getElementById('debateTopic').value = '';

            // 重置角色选择
            selectedRoles = { pro: null, con: null };
            resetRoleSelection('pro');
            resetRoleSelection('con');

            // 清除错误信息
            clearErrors(['debateTopicError']);
        }        // 重置角色选择显示
        function resetRoleSelection(side) {
            const preview = document.getElementById(side + 'RolePreview');
            const selector = document.getElementById(side + 'RoleSelector');

            preview.innerHTML = `
                <div class="role-avatar">➕</div>
                <div class="role-info">
                    <div class="role-name">点击选择${side === 'pro' ? '正方' : '反方'}角色</div>
                    <div class="role-desc">${side === 'pro' ? '支持辩论主题的一方' : '反对辩论主题的一方'}</div>
                </div>
            `;

            // 移除选中状态
            preview.classList.remove('selected');
            selector.classList.remove('selected');
        }

        // 角色选择相关变量
        let currentRoleSelectSide = null;
        let roleListOffset = 0;
        let roleListHasMore = true;
        let isLoadingRoles = false;
        let roleSearchTimeout = null;
        let selectedRoles = { pro: null, con: null };

        // 显示角色选择弹窗
        function showRoleSelection(side) {
            currentRoleSelectSide = side;

            // 更新弹窗标题
            document.getElementById('roleSelectSideText').textContent =
                side === 'pro' ? '选择正方角色' : '选择反方角色';

            // 显示弹窗
            document.getElementById('roleSelectModal').classList.add('active');

            // 清空搜索框
            document.getElementById('roleSearchInput').value = '';

            // 加载初始角色列表
            loadInitialRoles();
        }

        // 关闭角色选择弹窗
        function closeRoleSelectModal() {
            document.getElementById('roleSelectModal').classList.remove('active');
            currentRoleSelectSide = null;
        }

        // 加载初始角色列表
        async function loadInitialRoles() {
            roleListOffset = 0;
            roleListHasMore = true;
            document.getElementById('roleList').innerHTML = '';
            await loadMoreRoles();
        }

        // 加载更多角色
        async function loadMoreRoles() {
            if (isLoadingRoles || !roleListHasMore) return;

            isLoadingRoles = true;
            showRoleListLoading();

            try {
                const response = await fetch(`/api/role/list?offset=${roleListOffset}&limit=15`);
                if (response.ok) {
                    const data = await response.json();
                    appendRolesToList(data.items);
                    roleListOffset += data.items.length;
                    roleListHasMore = data.has_more;
                } else {
                    console.error('加载角色列表失败:', response.status);
                }
            } catch (error) {
                console.error('加载角色列表错误:', error);
            } finally {
                isLoadingRoles = false;
                hideRoleListLoading();
            }
        }

        // 角色选择模态框的搜索函数
        async function searchRolesForModal() {
            const keyword = document.getElementById('roleSearchInput').value.trim();

            // 清除之前的搜索定时器
            if (roleSearchTimeout) {
                clearTimeout(roleSearchTimeout);
            }

            // 设置新的搜索定时器（防抖）
            roleSearchTimeout = setTimeout(async () => {
                if (keyword === '') {
                    // 如果搜索框为空，加载初始列表
                    await loadInitialRoles();
                } else {
                    // 执行搜索
                    await performSearch(keyword);
                }
            }, 500);
        }

        // 执行搜索
        async function performSearch(keyword) {
            showRoleListLoading();

            try {
                const response = await fetch(`/api/role/search?q=${encodeURIComponent(keyword)}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('roleList').innerHTML = '';
                    appendRolesToList(data);
                    roleListHasMore = false; // 搜索结果不支持分页

                    if (data.length === 0) {
                        showRoleListEmpty();
                    }
                } else {
                    console.error('搜索角色失败:', response.status);
                }
            } catch (error) {
                console.error('搜索角色错误:', error);
            } finally {
                hideRoleListLoading();
            }
        }

        // 开始辩论
        async function startDebate() {
            // 验证输入
            const topic = document.getElementById('debateTopic').value.trim();
            if (!topic) {
                showError('debateTopicError', '请输入辩论主题');
                return;
            }

            if (!selectedRoles.pro || !selectedRoles.con) {
                alert('请选择正方和反方角色');
                return;
            }

            if (!isLoggedIn) {
                showAuthModal();
                return;
            }

            // 获取用户ID
            const userId = currentUser?.id;
            console.log('当前用户信息:', currentUser);
            console.log('用户ID:', userId);
            if (!userId) {
                console.error('用户信息错误:', currentUser);
                alert('用户信息错误，请重新登录');
                return;
            }

            const startBtn = document.getElementById('startDebateBtn');
            startBtn.disabled = true;
            startBtn.textContent = '创建辩论中...';

            try {
                const response = await fetch('/api/debate/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        role1_id: selectedRoles.pro.role_id,
                        role2_id: selectedRoles.con.role_id,
                        topic: topic
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    const debateId = result.debate_id;
                    console.log('辩论创建成功，debate_id:', debateId);

                    // 存储当前辩论ID
                    currentDebateId = debateId;

                    // 进入辩论界面
                    showDebateRoom(topic, selectedRoles.pro, selectedRoles.con);

                    // 更新历史辩论列表
                    updateRecentDebatesList();
                } else {
                    console.error('创建辩论失败:', response.status);
                    alert('创建辩论失败，请稍后重试');
                }
            } catch (error) {
                console.error('创建辩论错误:', error);
                alert('创建辩论失败：' + error.message);
            } finally {
                startBtn.disabled = false;
                startBtn.textContent = '开始辩论';
            }
        }

        // 显示辩论房间
        function showDebateRoom(topic, proRole, conRole) {
            // 如果没有传入参数，尝试使用当前存储的信息
            if (!topic && !proRole && !conRole) {
                if (!currentDebateRoles || !currentDebateRoles.pro || !currentDebateRoles.con || !currentDebateTopic) {
                    alert('辩论信息不完整，返回辩论设置页面');
                    showDebate();
                    return;
                }
                topic = currentDebateTopic;
                proRole = currentDebateRoles.pro;
                conRole = currentDebateRoles.con;
            }

            currentPage = 'debate-room';
            currentChatRoleId = null;

            // 隐藏其他页面
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('createRolePage').classList.remove('active');
            document.getElementById('chatPageNew').classList.remove('active');
            document.getElementById('debatePage').classList.remove('active');
            document.getElementById('debateRoomPage').classList.add('active');

            // 设置辩论信息
            document.getElementById('debateRoomTitle').textContent = topic;

            // 存储辩论角色信息
            currentDebateRoles = { pro: proRole, con: conRole };
            currentDebateTopic = topic;

            console.log('设置辩论角色:', {
                pro: { name: proRole.name, id: proRole.role_id || proRole.id },
                con: { name: conRole.name, id: conRole.role_id || conRole.id }
            });

            // 重置辩论状态
            debateDialogs = [];
            debateOffset = 0;
            debateHasMore = true;
            debateSessionActive = false;

            // 清空消息区域
            document.getElementById('debateMessages').innerHTML = `
                <div class="debate-empty" id="debateEmpty">
                    <div class="debate-empty-icon">⚔️</div>
                    <div class="debate-empty-text">辩论即将开始</div>
                    <div class="debate-empty-hint">点击"开始辩论"按钮开始这场精彩的辩论</div>
                </div>
            `;

            // 重置按钮状态
            document.getElementById('debateStartBtn').disabled = false;
            document.getElementById('debateEndBtn').disabled = true;

            // 更新URL锚点 - 如果当前URL已经包含参数，则保留参数
            const currentHash = window.location.hash.substring(1);
            if (currentHash.startsWith('debate-room?')) {
                // 如果当前URL已经包含参数，保持不变
                console.log('保留当前URL参数:', currentHash);
            } else {
                // 否则设置基础的debate-room锚点
                updateUrlHash('debate-room');
            }

            // 立即加载历史对话
            setTimeout(async () => {
                await loadDebateHistory();
            }, 100);
        }

        // 辩论会话控制
        let currentDebateRoles = null;
        let currentDebateTopic = null;
        let debateSessionActive = false;
        let debateAudio = null; // 当前播放的音频
        let isLoadingDebateHistory = false;
        let debateDialogs = []; // 存储辩论对话记录
        let debateOffset = 0;
        let debateHasMore = true;

        // 根据URL参数恢复辩论房间状态
        async function restoreDebateRoomFromParams(role1Id, role2Id, debateId) {
            console.log('开始恢复辩论房间状态:', { role1Id, role2Id, debateId, currentUser });

            try {
                // 设置当前辩论ID
                currentDebateId = parseInt(debateId);

                if (!currentUser || !currentUser.id) {
                    console.error('用户未登录，无法恢复辩论房间');
                    return;
                }

                // 获取角色详情
                console.log('开始获取角色详情...');
                const [role1Response, role2Response] = await Promise.all([
                    fetch(`/api/role/details?role_id=${role1Id}`),
                    fetch(`/api/role/details?role_id=${role2Id}`)
                ]);

                console.log('角色详情响应状态:', { role1: role1Response.status, role2: role2Response.status });

                if (!role1Response.ok || !role2Response.ok) {
                    console.error('加载角色详情失败:', {
                        role1Status: role1Response.status,
                        role2Status: role2Response.status
                    });
                    return;
                }

                const [role1Data, role2Data] = await Promise.all([
                    role1Response.json(),
                    role2Response.json()
                ]);

                console.log('获取到角色数据:', { role1Data, role2Data });

                // 构建角色对象
                const role1 = {
                    role_id: role1Data.role_id,
                    id: role1Data.role_id,
                    name: role1Data.name,
                    description: role1Data.description,
                    traits: role1Data.traits,
                    image_url: role1Data.image_url,
                    voice_type: role1Data.voice_type
                };

                const role2 = {
                    role_id: role2Data.role_id,
                    id: role2Data.role_id,
                    name: role2Data.name,
                    description: role2Data.description,
                    traits: role2Data.traits,
                    image_url: role2Data.image_url,
                    voice_type: role2Data.voice_type
                };

                console.log('构建的角色对象:', { role1, role2 });

                // 获取辩论信息
                console.log('开始获取辩论信息...');
                const debatePayload = {
                    debate_id: parseInt(debateId),
                    user_id: parseInt(currentUser.id),
                    role1_id: parseInt(role1Id),
                    role2_id: parseInt(role2Id),
                    offset: 0,
                    limit: 10
                };
                console.log('辩论API请求参数:', debatePayload);

                const debateResponse = await fetch('/api/debate/dialogs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(debatePayload)
                });

                console.log('辩论信息响应状态:', debateResponse.status);

                if (debateResponse.ok) {
                    const debateData = await debateResponse.json();
                    console.log('获取到辩论数据:', debateData);

                    // 设置辩论信息并显示房间
                    currentDebateId = debateData.debate_id || debateId;
                    console.log('准备显示辩论房间:', { topic: debateData.topic, role1: role1.name, role2: role2.name });
                    showDebateRoom(debateData.topic, role1, role2);
                } else {
                    const errorText = await debateResponse.text();
                    console.error('加载辩论信息失败:', debateResponse.status, errorText);
                }
            } catch (error) {
                console.error('恢复辩论房间状态失败:', error);
            }
        }

        // 加载辩论历史对话
        async function loadDebateHistory() {
            console.log('loadDebateHistory调用，检查状态:', {
                currentDebateRoles,
                isLoadingDebateHistory,
                debateHasMore
            });

            if (!currentDebateRoles || isLoadingDebateHistory || !debateHasMore) {
                console.log('loadDebateHistory早期退出:', {
                    hasRoles: !!currentDebateRoles,
                    isLoading: isLoadingDebateHistory,
                    hasMore: debateHasMore
                });
                return;
            }

            isLoadingDebateHistory = true;

            try {
                const userId = currentUser?.id;
                if (!userId) {
                    console.error('用户未登录');
                    return;
                }

                console.log('准备发送API请求，角色信息:', {
                    pro: currentDebateRoles.pro,
                    con: currentDebateRoles.con,
                    proRoleId: currentDebateRoles.pro?.role_id,
                    conRoleId: currentDebateRoles.con?.role_id
                });

                const requestPayload = {
                    debate_id: parseInt(currentDebateId),
                    user_id: parseInt(userId),
                    role1_id: currentDebateRoles.pro.role_id,
                    role2_id: currentDebateRoles.con.role_id,
                    offset: debateOffset,
                    limit: 20
                };

                console.log('loadDebateHistory API请求参数:', requestPayload);

                const response = await fetch('/api/debate/dialogs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestPayload)
                });

                if (response.ok) {
                    const data = await response.json();

                    if (debateOffset === 0) {
                        // 首次加载，替换所有对话
                        debateDialogs = data.dialogs || [];
                    } else {
                        // 追加更多对话（历史对话在前面）
                        debateDialogs = [...(data.dialogs || []), ...debateDialogs];
                    }

                    debateOffset += (data.dialogs || []).length;
                    debateHasMore = data.has_more;

                    // 渲染对话
                    renderDebateDialogs();
                } else {
                    console.error('加载辩论历史失败:', response.status);
                }
            } catch (error) {
                console.error('加载辩论历史错误:', error);
            } finally {
                isLoadingDebateHistory = false;
            }
        }

        // 渲染辩论对话
        function renderDebateDialogs() {
            const messagesContainer = document.getElementById('debateMessages');
            if (!messagesContainer || !currentDebateRoles) {
                return;
            }

            // 清空现有内容
            messagesContainer.innerHTML = '';

            // 如果没有对话，显示空状态
            if (debateDialogs.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="debate-empty" id="debateEmpty">
                        <div class="debate-empty-icon">⚔️</div>
                        <div class="debate-empty-text">辩论即将开始</div>
                        <div class="debate-empty-hint">点击"开始辩论"按钮开始这场精彩的辩论</div>
                    </div>
                `;
                return;
            }

            // 渲染所有对话
            debateDialogs.forEach(dialog => {
                console.log('处理对话消息:', {
                    dialogRoleId: dialog.role_id,
                    proRoleId: currentDebateRoles.pro.role_id,
                    conRoleId: currentDebateRoles.con.role_id,
                    isProRole: parseInt(dialog.role_id) === parseInt(currentDebateRoles.pro.role_id)
                });
                const isProRole = parseInt(dialog.role_id) === parseInt(currentDebateRoles.pro.role_id);
                const role = isProRole ? currentDebateRoles.pro : currentDebateRoles.con;
                const messageElement = createDebateMessageElement(dialog, role, isProRole);
                messagesContainer.appendChild(messageElement);
            });

            // 滚动到底部
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 创建辩论消息元素
        function createDebateMessageElement(dialog, role, isProRole) {
            const messageDiv = document.createElement('div');

            // 设置消息类名，匹配聊天消息的结构
            const hasVoiceClass = dialog.voice ? ' has-voice' : '';
            messageDiv.className = `message ${isProRole ? 'pro' : 'con'}${hasVoiceClass}`;

            // 头像处理 - 使用角色真实头像
            let avatarHtml;
            if (role.image_url) {
                if (isEmoji(role.image_url)) {
                    avatarHtml = role.image_url;
                } else {
                    avatarHtml = `<img src="${role.image_url}" alt="${role.name}">`;
                }
            } else {
                // 如果没有头像，使用默认emoji
                avatarHtml = '🎭';
            }

            // 消息内容
            let messageContent = `<div class="message-text">${escapeHtml(dialog.text)}</div>`;

            // 添加语音内容
            if (dialog.voice) {
                messageContent += `
                    <div class="message-voice">
                        <audio controls preload="metadata">
                            <source src="${dialog.voice}" type="audio/mpeg">
                            您的浏览器不支持音频播放。
                        </audio>
                    </div>
                `;
            }

            // 添加时间戳和正反方标志
            const timestampText = getTimeAgo(dialog.timestamp);
            if (timestampText) {
                const sideLabel = isProRole ? '正方' : '反方';
                messageContent += `
                    <div class="message-timestamp" data-timestamp="${dialog.timestamp}">
                        <span class="debate-side-label ${isProRole ? 'pro' : 'con'}">${sideLabel}</span>
                        <span class="time-text">${timestampText}</span>
                    </div>
                `;
            }

            messageDiv.innerHTML = `
                <div class="message-avatar ${isProRole ? 'pro' : 'con'}">${avatarHtml}</div>
                <div class="message-content${hasVoiceClass}">${messageContent}</div>
            `;

            return messageDiv;
        }

        // 播放辩论语音（自动播放）
        async function playDebateVoiceAuto(voiceUrl) {
            return new Promise((resolve) => {
                if (debateAudio) {
                    debateAudio.pause();
                    debateAudio = null;
                }

                // 尝试先从页面中找到对应的audio元素
                const audioElements = document.querySelectorAll('#debateMessages audio');
                let targetAudio = null;

                // 查找匹配URL的音频元素
                for (let audio of audioElements) {
                    if (audio.src === voiceUrl || audio.querySelector('source')?.src === voiceUrl) {
                        targetAudio = audio;
                        break;
                    }
                }

                if (targetAudio) {
                    // 使用页面中的audio元素
                    debateAudio = targetAudio;

                    const endHandler = () => {
                        targetAudio.removeEventListener('ended', endHandler);
                        targetAudio.removeEventListener('error', errorHandler);
                        debateAudio = null;
                        resolve();
                    };

                    const errorHandler = (e) => {
                        console.error('语音自动播放错误:', e);
                        targetAudio.removeEventListener('ended', endHandler);
                        targetAudio.removeEventListener('error', errorHandler);
                        debateAudio = null;
                        resolve();
                    };

                    targetAudio.addEventListener('ended', endHandler);
                    targetAudio.addEventListener('error', errorHandler);

                    targetAudio.play().catch(error => {
                        console.error('语音自动播放失败:', error);
                        targetAudio.removeEventListener('ended', endHandler);
                        targetAudio.removeEventListener('error', errorHandler);
                        debateAudio = null;
                        resolve();
                    });
                } else {
                    // 创建新的Audio对象
                    debateAudio = new Audio(voiceUrl);

                    debateAudio.addEventListener('ended', () => {
                        debateAudio = null;
                        resolve();
                    });

                    debateAudio.addEventListener('error', (e) => {
                        console.error('语音自动播放错误:', e);
                        debateAudio = null;
                        resolve();
                    });

                    debateAudio.play().catch(error => {
                        console.error('语音自动播放失败:', error);
                        debateAudio = null;
                        resolve();
                    });
                }
            });
        }

        // 开始辩论会话
        async function startDebateSession() {
            if (!currentDebateRoles || !currentUser?.id) {
                console.error('缺少必要的辩论信息');
                return;
            }

            console.log('开始辩论会话');

            // 更新按钮状态
            document.getElementById('debateStartBtn').disabled = true;
            document.getElementById('debateEndBtn').disabled = false;

            // 隐藏空状态
            const emptyElement = document.getElementById('debateEmpty');
            if (emptyElement) {
                emptyElement.style.display = 'none';
            }

            debateSessionActive = true;

            // 加载历史对话
            await loadDebateHistory();

            // 开始辩论循环
            startDebateLoop();
        }

        // 结束辩论会话
        function endDebateSession() {
            console.log('结束辩论会话');

            // 停止当前播放的音频
            if (debateAudio) {
                debateAudio.pause();
                debateAudio = null;
            }

            // 更新按钮状态
            document.getElementById('debateStartBtn').disabled = false;
            document.getElementById('debateEndBtn').disabled = true;

            debateSessionActive = false;
        }

        // 辩论循环控制
        async function startDebateLoop() {
            if (!debateSessionActive) {
                return;
            }

            try {
                const userId = currentUser?.id;
                if (!userId) {
                    console.error('用户未登录');
                    return;
                }

                // 确定下一个发言的角色
                let nextSpeakerId, nextRole, isProRole;
                if (debateDialogs.length === 0) {
                    // 第一条消息，从正方开始
                    nextSpeakerId = currentDebateRoles.pro.role_id;
                    nextRole = currentDebateRoles.pro;
                    isProRole = true;
                } else {
                    // 轮换发言
                    const lastSpeakerId = parseInt(debateDialogs[debateDialogs.length - 1].role_id);
                    const isLastPro = lastSpeakerId === parseInt(currentDebateRoles.pro.role_id);
                    nextSpeakerId = isLastPro ? currentDebateRoles.con.role_id : currentDebateRoles.pro.role_id;
                    nextRole = isLastPro ? currentDebateRoles.con : currentDebateRoles.pro;
                    isProRole = !isLastPro;
                }

                // 显示打字指示器
                showDebateTypingIndicator(nextRole, isProRole);

                const response = await fetch('/api/debate/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        debate_id: parseInt(currentDebateId),
                        user_id: parseInt(userId),
                        role1_id: currentDebateRoles.pro.role_id,
                        role2_id: currentDebateRoles.con.role_id,
                    })
                });

                // 隐藏打字指示器
                hideDebateTypingIndicator();

                if (!response.ok) {
                    console.error('辩论API调用失败:', response.status);
                    return;
                }

                const data = await response.json();

                // 创建新的对话消息
                console.log('新消息角色分配:', {
                    currentSpeakerId: data.current_speaker_id,
                    proRoleId: currentDebateRoles.pro.role_id,
                    conRoleId: currentDebateRoles.con.role_id,
                    isProRole: parseInt(data.current_speaker_id) === parseInt(currentDebateRoles.pro.role_id)
                });
                const actualIsProRole = parseInt(data.current_speaker_id) === parseInt(currentDebateRoles.pro.role_id);
                const actualRole = actualIsProRole ? currentDebateRoles.pro : currentDebateRoles.con;

                const newDialog = {
                    id: Date.now(), // 临时ID
                    role_id: data.current_speaker_id,
                    timestamp: data.timestamp,
                    text: data.response,
                    voice: data.voice_url
                };

                // 添加到对话列表
                debateDialogs.push(newDialog);

                // 添加新消息到界面
                addDebateMessage(newDialog, actualRole, actualIsProRole);

                // 等待DOM更新后再自动播放语音
                if (data.voice_url) {
                    // 稍微延迟确保DOM已更新
                    setTimeout(async () => {
                        await playDebateVoiceAuto(data.voice_url);

                        // 语音播放完成后，如果辩论还在进行，继续下一轮
                        if (debateSessionActive) {
                            setTimeout(() => {
                                startDebateLoop();
                            }, 1000);
                        }
                    }, 100);
                } else {
                    // 如果没有语音，直接继续下一轮
                    if (debateSessionActive) {
                        setTimeout(() => {
                            startDebateLoop();
                        }, 1500);
                    }
                }

            } catch (error) {
                console.error('辩论循环错误:', error);
                // 出错时也要隐藏打字指示器
                hideDebateTypingIndicator();
            }
        }

        // 添加辩论消息到界面
        function addDebateMessage(dialog, role, isProRole) {
            const messagesContainer = document.getElementById('debateMessages');
            if (!messagesContainer) {
                return;
            }

            // 如果是第一条消息，清除空状态
            const emptyElement = document.getElementById('debateEmpty');
            if (emptyElement && emptyElement.style.display !== 'none') {
                emptyElement.style.display = 'none';
            }

            const messageElement = createDebateMessageElement(dialog, role, isProRole);
            messagesContainer.appendChild(messageElement);

            // 滚动到底部
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 将角色添加到列表中
        function appendRolesToList(roles) {
            const roleList = document.getElementById('roleList');

            roles.forEach(role => {
                const roleItem = createRoleItem(role);
                roleList.appendChild(roleItem);
            });

            hideRoleListEmpty();
        }

        // 创建角色列表项
        function createRoleItem(role) {
            const roleItem = document.createElement('div');
            roleItem.className = 'role-item';
            roleItem.onclick = () => selectDebateRole(role);

            // 创建头像
            const avatar = document.createElement('div');
            avatar.className = 'role-item-avatar';

            // 判断是否为emoji字符（简单判断：如果是单个字符且不是字母数字，认为是emoji）
            const isEmoji = (str) => {
                if (!str || str.trim().length === 0) return false;
                const trimmed = str.trim();
                // 如果以emoji:开头，则去掉前缀
                if (trimmed.startsWith('emoji:')) {
                    return trimmed.length > 6; // emoji: + at least 1 char
                }
                // 检查是否为emoji字符（基本检查）
                return /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(trimmed)
                    || trimmed.length <= 4; // 简单判断：短字符串可能是emoji
            };

            if (role.image_url && role.image_url.trim()) {
                const imageUrl = role.image_url.trim();

                if (isEmoji(imageUrl)) {
                    // 处理emoji头像
                    avatar.textContent = imageUrl.startsWith('emoji:') ? imageUrl.replace('emoji:', '') : imageUrl;
                } else {
                    // 处理图片URL
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = role.name;
                    img.onerror = () => {
                        // 如果图片加载失败，显示默认emoji
                        img.remove();
                        avatar.textContent = '🎭';
                    };
                    avatar.appendChild(img);
                }
            } else {
                avatar.textContent = '🎭';
            }

            // 创建信息区域
            const info = document.createElement('div');
            info.className = 'role-item-info';

            const name = document.createElement('div');
            name.className = 'role-item-name';
            name.textContent = role.name;

            const desc = document.createElement('div');
            desc.className = 'role-item-desc';
            desc.textContent = role.description || role.traits || '暂无描述';

            info.appendChild(name);
            info.appendChild(desc);

            roleItem.appendChild(avatar);
            roleItem.appendChild(info);

            return roleItem;
        }

        // 选择辩论角色
        function selectDebateRole(role) {
            if (!currentRoleSelectSide) return;

            // 保存选择的角色
            selectedRoles[currentRoleSelectSide] = role;

            // 更新界面显示
            updateRolePreview(currentRoleSelectSide, role);

            // 关闭弹窗
            closeRoleSelectModal();
        }

        // 更新角色预览
        function updateRolePreview(side, role) {
            const preview = document.getElementById(side + 'RolePreview');
            const selector = document.getElementById(side + 'RoleSelector');

            // 判断是否为emoji字符
            const isEmoji = (str) => {
                if (!str || str.trim().length === 0) return false;
                const trimmed = str.trim();
                // 如果以emoji:开头，则去掉前缀
                if (trimmed.startsWith('emoji:')) {
                    return trimmed.length > 6; // emoji: + at least 1 char
                }
                // 检查是否为emoji字符（基本检查）
                return /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(trimmed)
                    || trimmed.length <= 4; // 简单判断：短字符串可能是emoji
            };

            // 创建头像HTML
            let avatarHtml = '';
            if (role.image_url && role.image_url.trim()) {
                const imageUrl = role.image_url.trim();

                if (isEmoji(imageUrl)) {
                    // 处理emoji头像
                    avatarHtml = imageUrl.startsWith('emoji:') ? imageUrl.replace('emoji:', '') : imageUrl;
                } else {
                    // 处理图片URL
                    avatarHtml = `<img src="${imageUrl}" alt="${role.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <div class="role-avatar" style="display: none;">🎭</div>`;
                }
            } else {
                avatarHtml = '🎭';
            }

            preview.innerHTML = `
                <div class="role-avatar">${avatarHtml}</div>
                <div class="role-info">
                    <div class="role-name">${role.name}</div>
                    <div class="role-desc">${role.description || role.traits || '暂无描述'}</div>
                </div>
            `;

            // 添加选中状态的类
            preview.classList.add('selected');
            selector.classList.add('selected');
        }        // 显示角色列表加载状态
        function showRoleListLoading() {
            document.getElementById('roleListLoading').style.display = 'block';
            document.getElementById('roleListEmpty').style.display = 'none';
        }

        // 隐藏角色列表加载状态
        function hideRoleListLoading() {
            document.getElementById('roleListLoading').style.display = 'none';
        }

        // 显示空列表提示
        function showRoleListEmpty() {
            document.getElementById('roleListEmpty').style.display = 'block';
            document.getElementById('roleListLoading').style.display = 'none';
        }

        // 隐藏空列表提示
        function hideRoleListEmpty() {
            document.getElementById('roleListEmpty').style.display = 'none';
        }

        // 显示创建角色页面
        async function showCreateRolePage() {
            currentPage = 'create-role';
            currentChatRoleId = null;

            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('chatPageNew').classList.remove('active');
            document.getElementById('createRolePage').classList.add('active');

            // 重置表单，确保每次打开都是干净的
            resetRoleForm();

            // 异步加载声音列表（如果还没有加载过）
            if (voiceList.length === 0) {
                loadVoiceListAsync();
            }

            // 只在当前URL不是create-role时才更新锚点
            if (window.location.hash !== '#create-role') {
                updateUrlHash();
            }
        }

        // 重置角色表单
        function resetRoleForm() {
            document.getElementById('roleForm').reset();
            selectedRoleAvatar = '🎭';
            selectedRoleAvatarType = 'default';
            customRoleAvatarFile = null;
            selectedVoice = null;
            updateRoleAvatarPreview();
            clearErrors(['roleNameError', 'roleDescriptionError', 'roleTraitsError']);

            // 重置默认头像选中状态
            document.querySelectorAll('.role-default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector('[data-avatar="🎭"]').classList.add('selected');
        }

        // 获取声音列表
        async function fetchVoiceList() {
            try {
                const response = await fetch('https://openai.qiniu.com/v1/voice/list');
                if (response.ok) {
                    const data = await response.json();
                    voiceList = data;
                    console.log('声音列表加载完成:', voiceList.length, '个声音');
                    renderVoiceOptions();
                } else {
                    console.error('获取声音列表失败:', response.status);
                    voiceList = [];
                    renderVoiceError();
                }
            } catch (error) {
                console.error('获取声音列表错误:', error);
                voiceList = [];
                renderVoiceError();
            }
        }

        // 异步加载声音列表（带UI反馈）
        async function loadVoiceListAsync() {
            const voiceContainer = document.getElementById('voiceSelectContainer');
            if (!voiceContainer) return;

            // 显示加载状态
            voiceContainer.innerHTML = '<div class="voice-loading">正在加载声音列表...</div>';

            try {
                await fetchVoiceList();
                if (voiceList.length === 0) {
                    renderVoiceError();
                }
            } catch (error) {
                console.error('异步加载声音列表失败:', error);
                renderVoiceError();
            }
        }

        // 渲染声音加载错误状态
        function renderVoiceError() {
            const voiceContainer = document.getElementById('voiceSelectContainer');
            if (!voiceContainer) return;

            voiceContainer.innerHTML = `
                <div class="voice-error">
                    <div class="voice-error-text">声音列表加载失败</div>
                    <button type="button" class="retry-btn" onclick="loadVoiceListAsync()">重试</button>
                </div>
            `;
        }

        // 渲染声音选择选项
        function renderVoiceOptions() {
            const voiceContainer = document.getElementById('voiceSelectContainer');
            if (!voiceContainer || voiceList.length === 0) return;

            const voiceOptionsHtml = voiceList.map((voice, index) => `
                <label class="voice-option" data-voice-type="${voice.voice_type}">
                    <input type="radio" name="roleVoice" value="${voice.voice_type}" ${index === 0 ? 'checked' : ''}>
                    <span class="voice-label">
                        <span class="voice-name">${voice.voice_name}</span>
                        <span class="voice-type">${voice.voice_type}</span>
                    </span>
                    <button type="button" class="voice-play-btn" onclick="playVoicePreview('${voice.url}')" title="试听">
                        🔊
                    </button>
                </label>
            `).join('');

            voiceContainer.innerHTML = voiceOptionsHtml;

            // 设置默认选中的声音
            if (voiceList.length > 0) {
                selectedVoice = voiceList[0];
            }
        }        // 播放声音预览
        function playVoicePreview(url) {
            const audio = new Audio(url);
            audio.play().catch(error => {
                console.error('声音播放失败:', error);
                alert('声音播放失败，请稍后再试');
            });
        }

        // 选择声音
        function selectVoice(voiceType) {
            selectedVoice = voiceList.find(voice => voice.voice_type === voiceType);
            console.log('选择声音:', selectedVoice);
        }

        // 滚动到选中的声音项
        function scrollToSelectedVoice(voiceRadio) {
            const voiceContainer = document.getElementById('voiceSelectContainer');
            const voiceOption = voiceRadio.closest('.voice-option');

            if (voiceContainer && voiceOption) {
                // 计算选中项在容器中的位置
                const containerRect = voiceContainer.getBoundingClientRect();
                const optionRect = voiceOption.getBoundingClientRect();

                // 计算滚动位置，让选中项显示在容器的顶部
                const scrollTop = voiceOption.offsetTop - voiceContainer.offsetTop;

                // 平滑滚动到选中的声音项
                voiceContainer.scrollTo({
                    top: scrollTop,
                    behavior: 'smooth'
                });

                console.log('滚动到选中的声音:', selectedVoice?.voice_name);
            }
        }

        // 角色头像相关函数
        function uploadRoleAvatar() {
            document.getElementById('roleAvatarInput').click();
        }

        function handleRoleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB限制
                    alert('头像文件大小不能超过5MB');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('请选择图片文件');
                    return;
                }

                customRoleAvatarFile = file;
                selectedRoleAvatarType = 'custom';

                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedRoleAvatar = e.target.result;
                    updateRoleAvatarPreview();
                };
                reader.readAsDataURL(file);

                // 清除默认头像选中状态
                document.querySelectorAll('.role-default-avatar').forEach(el => {
                    el.classList.remove('selected');
                });
            }
        }

        function chooseRoleDefaultAvatar(avatar) {
            selectedRoleAvatar = avatar;
            selectedRoleAvatarType = 'default';
            customRoleAvatarFile = null;
            updateRoleAvatarPreview();

            // 更新选中状态
            document.querySelectorAll('.role-default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-avatar="${avatar}"]`).classList.add('selected');
        }

        function updateRoleAvatarPreview() {
            const preview = document.getElementById('roleAvatarPreview');
            if (selectedRoleAvatarType === 'custom') {
                preview.innerHTML = `
                    <img src="${selectedRoleAvatar}" alt="角色头像">
                    <div class="avatar-upload-hint">点击更换头像</div>
                `;
            } else {
                preview.innerHTML = `
                    <div class="role-avatar-text">${selectedRoleAvatar}</div>
                    <div class="avatar-upload-hint">点击上传头像</div>
                `;
            }
        }

        // 自动填写描述和特点
        let currentAutoFillController = null; // 用于存储当前请求的controller

        // 更新自动填充进度显示
        function updateAutoFillProgress(status) {
            const progressElement = document.getElementById('autoFillProgress');
            if (progressElement) {
                progressElement.textContent = status;
                progressElement.style.display = 'block';
            }
        }

        // 隐藏自动填充进度显示
        function hideAutoFillProgress() {
            const progressElement = document.getElementById('autoFillProgress');
            if (progressElement) {
                progressElement.style.display = 'none';
            }
        }

        async function autoFillDescription() {
            const roleName = document.getElementById('roleName').value.trim();

            if (!roleName) {
                showError('roleNameError', '请先输入角色名称');
                return;
            }

            if (!socket || !socket.connected) {
                alert('连接未建立，请稍后重试');
                return;
            }

            const btn = document.getElementById('autoFillBtn');
            const originalHTML = btn.innerHTML;

            // 如果有正在进行的请求，先取消它
            if (currentAutoFillController) {
                currentAutoFillController.abort();
            }

            // 创建新的AbortController
            currentAutoFillController = new AbortController();

            // 显示进度并更新按钮状态
            updateAutoFillProgress('正在准备...');
            btn.onclick = () => {
                if (currentAutoFillController) {
                    currentAutoFillController.abort();
                    currentAutoFillController = null;
                }
                hideAutoFillProgress();
                resetAutoFillButton(btn, originalHTML);
            };
            btn.innerHTML = `
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <circle cx="8" cy="8" r="3" opacity="0.3"/>
                    <path d="M8 0 A8 8 0 0 1 8 16 A8 8 0 0 1 8 0" opacity="0.8">
                        <animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" values="0 8 8;360 8 8"/>
                    </path>
                </svg>
                生成中... (点击取消)
            `;

            try {
                // 获取当前已填写的内容（可选）
                const currentDescription = document.getElementById('roleDescription').value.trim();
                const currentTraits = document.getElementById('roleTraits').value.trim();
                const gender = document.querySelector('input[name="roleGender"]:checked').value;
                const ageGroup = document.querySelector('input[name="roleAgeGroup"]:checked').value;

                // 调用AI生成接口，包含Socket.IO的sid
                const response = await fetch('/api/role/auto-fill', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: roleName,
                        description: currentDescription || undefined,
                        traits: currentTraits || undefined,
                        gender: gender,
                        age_group: ageGroup,
                        sid: socket.id
                    }),
                    signal: currentAutoFillController.signal
                });

                const data = await response.json();

                if (response.ok) {
                    // 直接使用返回的description和traits
                    if (data.description) {
                        document.getElementById('roleDescription').value = data.description;
                    }
                    if (data.traits) {
                        document.getElementById('roleTraits').value = data.traits;
                    }
                    // 处理返回的性别和年龄段
                    if (data.gender) {
                        const genderRadio = document.querySelector(`input[name="roleGender"][value="${data.gender}"]`);
                        if (genderRadio) {
                            genderRadio.checked = true;
                        }
                    }
                    if (data.age_group) {
                        const ageGroupRadio = document.querySelector(`input[name="roleAgeGroup"][value="${data.age_group}"]`);
                        if (ageGroupRadio) {
                            ageGroupRadio.checked = true;
                        }
                    }
                    // 处理返回的声音类型
                    if (data.voice_type) {
                        // 在声音列表中查找匹配的声音
                        const voiceRadio = document.querySelector(`input[name="roleVoice"][value="${data.voice_type}"]`);
                        if (voiceRadio) {
                            voiceRadio.checked = true;
                            selectedVoice = voiceList.find(voice => voice.voice_type === data.voice_type);

                            // 滚动到选中的声音项
                            scrollToSelectedVoice(voiceRadio);
                        } else {
                            console.warn('未找到匹配的声音类型:', data.voice_type);
                        }
                    }
                } else {
                    alert('自动填写失败，请手动填写');
                }
            } catch (error) {
                console.error('自动填写错误:', error);
                if (error.name === 'AbortError') {
                    console.log('请求已被用户取消');
                } else {
                    alert('网络错误或AI生成超时，请稍后重试');
                }
            } finally {
                hideAutoFillProgress();
                resetAutoFillButton(btn, originalHTML);
                currentAutoFillController = null;
            }
        }

        // 重置自动填写按钮状态
        function resetAutoFillButton(btn, originalHTML) {
            btn.innerHTML = originalHTML;
            btn.onclick = autoFillDescription;
        }

        // 角色表单验证
        function validateRoleForm() {
            let isValid = true;
            const name = document.getElementById('roleName').value.trim();
            const description = document.getElementById('roleDescription').value.trim();
            const traits = document.getElementById('roleTraits').value.trim();

            clearErrors(['roleNameError', 'roleDescriptionError', 'roleTraitsError']);

            if (!name) {
                showError('roleNameError', '请输入角色名称');
                isValid = false;
            } else if (name.length < 2) {
                showError('roleNameError', '角色名称至少2个字符');
                isValid = false;
            }

            if (!description) {
                showError('roleDescriptionError', '请输入角色描述');
                isValid = false;
            } else if (description.length < 20) {
                showError('roleDescriptionError', '角色描述至少20个字符');
                isValid = false;
            }

            if (!traits) {
                showError('roleTraitsError', '请输入角色特点');
                isValid = false;
            } else if (traits.length < 20) {
                showError('roleTraitsError', '角色特点至少20个字符');
                isValid = false;
            }

            return isValid;
        }

        // 处理角色创建
        async function handleRoleCreate(event) {
            event.preventDefault();

            if (!validateRoleForm()) return;

            const name = document.getElementById('roleName').value.trim();
            const description = document.getElementById('roleDescription').value.trim();
            const traits = document.getElementById('roleTraits').value.trim();
            const gender = document.querySelector('input[name="roleGender"]:checked').value;
            const ageGroup = document.querySelector('input[name="roleAgeGroup"]:checked').value;

            // 获取选择的声音
            const voiceInput = document.querySelector('input[name="roleVoice"]:checked');
            const voiceType = voiceInput ? voiceInput.value : '';

            const submitBtn = document.getElementById('createSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '创建中...';

            // 检查声音列表是否已加载
            if (voiceList.length === 0) {
                alert('声音列表尚未加载完成，请稍等片刻再试');
                submitBtn.disabled = false;
                submitBtn.textContent = '创建角色';
                return;
            }

            // 验证声音是否已选择
            if (!voiceType) {
                alert('请选择一个声音');
                submitBtn.disabled = false;
                submitBtn.textContent = '创建角色';
                return;
            }

            try {
                let avatar = null;

                // 处理头像
                if (selectedRoleAvatarType === 'default' && selectedRoleAvatar) {
                    avatar = selectedRoleAvatar;
                } else if (selectedRoleAvatarType === 'custom' && customRoleAvatarFile) {
                    // 如果是自定义头像，先上传头像获取file_url
                    const uploadResponse = await fetch('/api/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'X-File-Name': customRoleAvatarFile.name,
                            'Content-Type': customRoleAvatarFile.type || 'application/octet-stream'
                        },
                        body: customRoleAvatarFile
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        avatar = uploadData.file_url;
                    } else {
                        throw new Error('头像上传失败');
                    }
                }

                // 创建角色请求
                const response = await fetch('/api/role/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        name: name,
                        description: description,
                        traits: traits,
                        avatar: avatar,
                        gender: gender,
                        age_group: ageGroup,
                        voice_type: voiceType
                    })
                });

                const data = await response.json();

                if (response.ok && data.role_id) {
                    // 创建成功
                    alert('角色创建成功！');

                    // 清空表单
                    resetRoleForm();

                    // 重新加载角色列表以获取最新数据
                    await loadRoles();

                    // 返回主页并刷新角色列表
                    backToHome();
                    renderRoles(roles);
                } else {
                    // 创建失败
                    alert(data.message || '角色创建失败');
                }
            } catch (error) {
                console.error('创建角色错误:', error);
                alert('创建失败：' + (error.message || '网络错误，请稍后重试'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '创建角色';
            }
        }

        // 选择角色
        async function selectRole(roleId) {
            if (!isLoggedIn) {
                setPendingAction('selectRole', { roleId: roleId });
                showAuthModal();
                return;
            }

            // 直接导航到聊天页面
            startChatWithRole(roleId);
        }

        // 打开对话
        async function openChat(roleId) {
            if (!isLoggedIn) {
                setPendingAction('openChat', { roleId: roleId });
                showAuthModal();
                return;
            }

            try {
                // 确保角色列表已加载
                if (roles.length === 0) {
                    await loadRoles();
                }

                showChatPage(roleId);
            } catch (error) {
                console.error('打开对话失败:', error);
                alert('打开对话失败: ' + error.message);
            }
        }

        // 直接打开聊天（用于登录后自动执行）
        async function openChatDirect(roleId) {
            try {
                // 确保角色列表已加载
                if (roles.length === 0) {
                    await loadRoles();
                }

                showChatPage(roleId);
            } catch (error) {
                console.error('打开对话失败:', error);
                alert('打开对话失败: ' + error.message);
            }
        }

        // 登录功能
        function login() {
            showAuthModal();
        }

        // 显示认证模态框
        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // 关闭认证模态框
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            resetForms();
        }

        // 切换登录/注册标签
        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
            resetForms();
        }

        // 重置表单
        function resetForms() {
            // 重置登录表单
            document.getElementById('loginForm').reset();
            clearErrors(['loginUsernameError', 'loginPasswordError']);

            // 重置注册表单
            document.getElementById('registerForm').reset();
            clearErrors(['registerUsernameError', 'registerPasswordError', 'confirmPasswordError']);

            // 重置头像选择
            selectedAvatar = '👤';
            selectedAvatarType = 'default';
            customAvatarFile = null;
            updateAvatarPreview();
            hideDefaultAvatars();
        }

        // 清除错误信息
        function clearErrors(errorIds) {
            errorIds.forEach(id => {
                const errorElement = document.getElementById(id);
                errorElement.textContent = '';
                errorElement.classList.remove('show');

                const input = errorElement.previousElementSibling;
                if (input && (input.classList.contains('form-input') || input.classList.contains('role-textarea'))) {
                    input.classList.remove('error');
                }
            });
        }

        // 显示错误信息
        function showError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            const input = errorElement.previousElementSibling;

            errorElement.textContent = message;
            errorElement.classList.add('show');
            if (input) {
                input.classList.add('error');
            }
        }

        // 头像相关函数
        function selectDefaultAvatar() {
            const defaultAvatars = document.getElementById('defaultAvatars');
            defaultAvatars.style.display = defaultAvatars.style.display === 'none' ? 'grid' : 'none';
        }

        function hideDefaultAvatars() {
            document.getElementById('defaultAvatars').style.display = 'none';
        }

        function chooseDefaultAvatar(avatar) {
            selectedAvatar = avatar;
            selectedAvatarType = 'default';
            customAvatarFile = null;
            updateAvatarPreview();
            hideDefaultAvatars();

            // 更新选中状态
            document.querySelectorAll('.default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-avatar="${avatar}"]`).classList.add('selected');
        }

        function uploadAvatar() {
            document.getElementById('avatarInput').click();
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            console.log('选择的文件:', file);
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB限制
                    alert('头像文件大小不能超过5MB');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('请选择图片文件');
                    return;
                }

                customAvatarFile = file;
                selectedAvatarType = 'custom';

                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedAvatar = e.target.result;
                    updateAvatarPreview();
                };
                reader.readAsDataURL(file);
                hideDefaultAvatars();
            }
        }

        function updateAvatarPreview() {
            const preview = document.getElementById('avatarPreview');
            if (selectedAvatarType === 'custom') {
                preview.innerHTML = `<img src="${selectedAvatar}" alt="头像预览">`;
            } else {
                // 为默认头像显示表情符号，但存储时会转换为base64
                preview.innerHTML = `<div class="avatar-preview-text">${selectedAvatar}</div>`;
            }
        }

        // 表单验证
        function validateLogin() {
            let isValid = true;
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            clearErrors(['loginUsernameError', 'loginPasswordError']);

            if (!username) {
                showError('loginUsernameError', '请输入用户名');
                isValid = false;
            }

            if (!password) {
                showError('loginPasswordError', '请输入密码');
                isValid = false;
            }

            return isValid;
        }

        function validateRegister() {
            let isValid = true;
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            clearErrors(['registerUsernameError', 'registerPasswordError', 'confirmPasswordError']);

            if (!username) {
                showError('registerUsernameError', '请输入用户名');
                isValid = false;
            } else if (username.length < 3) {
                showError('registerUsernameError', '用户名至少3个字符');
                isValid = false;
            } else if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(username)) {
                showError('registerUsernameError', '用户名只能包含字母、数字、下划线和中文');
                isValid = false;
            }

            if (!password) {
                showError('registerPasswordError', '请输入密码');
                isValid = false;
            } else if (password.length < 6) {
                showError('registerPasswordError', '密码至少6个字符');
                isValid = false;
            }

            if (!confirmPassword) {
                showError('confirmPasswordError', '请确认密码');
                isValid = false;
            } else if (password !== confirmPassword) {
                showError('confirmPasswordError', '两次输入的密码不一致');
                isValid = false;
            }

            return isValid;
        }

        // 处理登录
        async function handleLogin(event) {
            event.preventDefault();

            if (!validateLogin()) return;

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            const submitBtn = document.getElementById('loginSubmit');
            submitBtn.disabled = true;
            submitBtn.textContent = '登录中...';

            try {
                const hashedPassword = await hashPassword(password);

                // 发送登录请求
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: hashedPassword
                    })
                });

                console.log('登录响应状态:', response.status);
                console.log('登录响应状态文本:', response.statusText);

                if (response.ok) {
                    const data = await response.json();
                    // 登录成功
                    localStorage.setItem('authToken', data.token);
                    isLoggedIn = true;
                    currentUser = {
                        id: data.user_id,
                        name: data.username,
                        avatar: data.avatar
                    };

                    updateUserInfo();
                    closeAuthModal();

                    // 重新加载角色列表
                    await loadRoles();
                    renderRoles(roles);

                    // 加载最近对话和历史辩论
                    await loadRecentChats();
                    await loadRecentDebates();

                    // 执行登录后的待处理操作
                    executePendingAction();

                    alert('登录成功！');
                } else {
                    // 登录失败 - 根据状态码显示不同错误信息
                    console.log('登录失败，状态码:', response.status);

                    let data;
                    try {
                        data = await response.json();
                        console.log('服务器响应数据:', data);
                    } catch (jsonError) {
                        console.warn('无法解析JSON响应:', jsonError);
                        data = {};
                    }

                    if (response.status === 401) {
                        console.log('显示401错误信息');
                        showError('loginPasswordError', '用户名或密码错误');
                    } else {
                        // 其他HTTP错误
                        const errorMessage = data.message || data.error || '登录失败，请稍后重试';
                        console.log('显示其他错误信息:', errorMessage);
                        showError('loginPasswordError', errorMessage);
                    }
                }
            } catch (error) {
                console.error('登录异常捕获:', error);
                console.error('异常类型:', error.constructor.name);
                console.error('异常堆栈:', error.stack);
                // 网络错误或其他异常
                showError('loginPasswordError', '网络错误，请稍后重试');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '登录';
            }
        }

        // 处理注册
        async function handleRegister(event) {
            event.preventDefault();

            if (!validateRegister()) return;

            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            const submitBtn = document.getElementById('registerSubmit');
            submitBtn.disabled = true;
            submitBtn.textContent = '注册中...';

            try {
                const hashedPassword = await hashPassword(password);

                // 第一步：上传头像
                let avatarUrl;
                if (selectedAvatarType === 'custom' && customAvatarFile) {
                    // 上传自定义头像
                    submitBtn.textContent = '上传头像中...';
                    avatarUrl = await uploadCustomAvatar(customAvatarFile);
                } else {
                    // 上传默认头像（转换为blob后上传）
                    submitBtn.textContent = '生成头像中...';
                    avatarUrl = await uploadDefaultAvatar(selectedAvatar);
                }

                // 第二步：注册用户
                submitBtn.textContent = '创建账户中...';
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: hashedPassword,
                        avatar: avatarUrl
                    })
                });

                if (response.ok) {
                    // 注册成功
                    alert('注册成功！请登录');

                    // 切换到登录标签
                    switchTab('login');

                    // 预填用户名
                    document.getElementById('loginUsername').value = username;
                } else {
                    // 注册失败
                    const errorText = await response.text().catch(() => '');

                    // 检查是否是用户名已存在的错误
                    if (errorText.includes('User already exists') || errorText.includes('用户已存在')) {
                        showError('registerUsernameError', '该用户名已被注册');
                    } else {
                        showError('registerPasswordError', errorText || '注册失败，请稍后重试');
                    }
                }
            } catch (error) {
                console.error('注册错误:', error);
                showError('registerPasswordError', '网络错误，请稍后重试');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '注册';
            }
        }

        // 上传自定义头像
        async function uploadCustomAvatar(file) {
            const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                    'X-File-Name': file.name,
                    'Content-Type': file.type || 'application/octet-stream'
                },
                body: file
            });

            if (!response.ok) {
                throw new Error('头像上传失败');
            }

            const data = await response.json();
            return data.file_url;
        }

        // 上传默认头像
        async function uploadDefaultAvatar(emoji) {
            // 生成默认头像的Blob
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 200;

            // 设置背景
            const gradient = ctx.createLinearGradient(0, 0, 200, 200);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 200, 200);

            // 绘制emoji
            ctx.font = '120px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(emoji, 100, 100);

            // 转换为Blob
            return new Promise((resolve, reject) => {
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        reject(new Error('头像生成失败'));
                        return;
                    }

                    try {
                        const fileName = `default_avatar_${emoji.codePointAt(0)}.png`;
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            headers: {
                                'X-File-Name': fileName,
                                'Content-Type': 'image/png'
                            },
                            body: blob
                        });

                        if (!response.ok) {
                            throw new Error('默认头像上传失败');
                        }

                        const data = await response.json();
                        resolve(data.file_url);
                    } catch (error) {
                        reject(error);
                    }
                }, 'image/png');
            });
        }        // 绑定表单提交事件
        document.addEventListener('DOMContentLoaded', function () {
            initPage();

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('roleForm').addEventListener('submit', handleRoleCreate);

            // 初始化懒加载滚动监听
            initScrollListeners();

            // 消息输入框事件监听
            const messageInput = document.getElementById('messageInputNew');
            if (messageInput) {
                messageInput.addEventListener('input', function () {
                    adjustTextareaHeight(this);
                });
                messageInput.addEventListener('keydown', handleInputKeydown);
            }

            // 注册用户名输入框事件监听 - 清除错误提示
            const registerUsernameInput = document.getElementById('registerUsername');
            if (registerUsernameInput) {
                registerUsernameInput.addEventListener('input', function () {
                    clearErrors(['registerUsernameError']);
                });
            }

            // 声音选择事件监听
            document.addEventListener('change', function (e) {
                if (e.target.name === 'roleVoice') {
                    selectVoice(e.target.value);
                }
            });

            // 点击模态框外部关闭
            document.getElementById('authModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeAuthModal();
                }
            });

            // 点击其他地方关闭用户下拉菜单
            document.addEventListener('click', function (event) {
                const userInfo = document.getElementById('userInfo');
                const dropdown = document.getElementById('userDropdown');

                if (userInfo && dropdown && !userInfo.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // ESC键关闭模态框
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    if (document.getElementById('authModal').classList.contains('active')) {
                        closeAuthModal();
                    }
                    if (document.getElementById('roleSelectModal').classList.contains('active')) {
                        closeRoleSelectModal();
                    }
                }
            });

            // 点击角色选择弹窗外部关闭
            document.getElementById('roleSelectModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeRoleSelectModal();
                }
            });

            // 角色列表滚动监听（懒加载）
            document.getElementById('roleListContainer').addEventListener('scroll', function (e) {
                const container = e.target;
                const { scrollTop, scrollHeight, clientHeight } = container;

                // 当滚动到接近底部时加载更多
                if (scrollHeight - scrollTop <= clientHeight + 50) {
                    loadMoreRoles();
                }
            });
        });

        // ====== 对话相关API ======

        // 创建与角色的对话
        async function createConversation(roleId) {
            try {
                const response = await fetch('/api/conversation/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        user_id: parseInt(currentUser.id),
                        role_id: parseInt(roleId)
                    })
                });

                if (!response.ok) {
                    throw new Error('创建对话失败');
                }
            } catch (error) {
                console.error('创建对话错误:', error);
                // 不抛出错误，因为对话可能已经存在
            }
        }

        // 获取用户的对话列表（懒加载版本）
        async function loadRecentChats(append = false) {
            if (lazyLoadState.conversations.loading || !currentUser?.id) return;

            try {
                lazyLoadState.conversations.loading = true;

                if (!append) {
                    lazyLoadState.conversations.offset = 0;
                    lazyLoadState.conversations.hasMore = true;
                }

                if (!lazyLoadState.conversations.hasMore) {
                    lazyLoadState.conversations.loading = false;
                    return;
                }

                const url = `/api/conversation/list?user_id=${parseInt(currentUser.id)}&offset=${lazyLoadState.conversations.offset}&limit=${lazyLoadState.conversations.limit}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取对话列表失败');
                }

                const data = await response.json();
                console.log('对话列表数据:', data);

                if (data && data.items && Array.isArray(data.items)) {
                    lazyLoadState.conversations.total = data.total;
                    lazyLoadState.conversations.hasMore = data.has_more;
                    lazyLoadState.conversations.offset += lazyLoadState.conversations.limit;

                    await renderRecentChats(data.items, append);
                }
            } catch (error) {
                console.error('加载最近对话错误:', error);
            } finally {
                lazyLoadState.conversations.loading = false;
            }
        }

        // 渲染最近对话列表
        async function renderRecentChats(roleIds, append = false) {
            const chatListElement = document.getElementById('chatList');

            if (!append && roleIds.length === 0) {
                chatListElement.innerHTML = '<div class="no-chats">还没有对话记录</div>';
                return;
            }

            // 确保角色列表已加载
            if (roles.length === 0) {
                await loadRoles();
            }

            const chatItems = roleIds.map(roleId => {
                const role = roles.find(r => String(r.id) === String(roleId));
                if (!role) return '';

                // 判断头像格式
                let avatarHtml;
                if (role.image_url && (role.image_url.startsWith('http') || role.image_url.startsWith('/'))) {
                    avatarHtml = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else if (role.image_url && role.image_url.startsWith('data:image')) {
                    avatarHtml = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    avatarHtml = role.image_url || '🎭';
                }

                return `
                    <div class="chat-item" onclick="openChat('${role.id}')">
                        <div class="chat-avatar">${avatarHtml}</div>
                        <div class="chat-info">
                            <div class="chat-name">${role.name}</div>
                            <div class="chat-preview">点击开始对话</div>
                        </div>
                        <div class="chat-delete" onclick="event.stopPropagation(); deleteConversation(${currentUser.id}, ${role.id})" title="删除对话">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"></polyline>
                                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </div>
                    </div>
                `;
            }).filter(item => item).join('');

            if (append) {
                chatListElement.innerHTML += chatItems;
            } else {
                chatListElement.innerHTML = chatItems;
            }
        }

        // 更新最近对话列表排序（在有新消息时调用）
        async function updateRecentChatsList() {
            if (!isLoggedIn || !currentUser?.id) {
                return;
            }

            console.log('更新最近对话列表排序');

            // 重新加载最近对话列表（这会按照最新的last_dialog_timestamp排序）
            try {
                await loadRecentChats(false); // false表示不是追加，而是重新加载
            } catch (error) {
                console.error('更新最近对话列表失败:', error);
            }
        }

        // 获取用户的历史辩论列表（懒加载版本）
        async function loadRecentDebates(append = false) {
            if (lazyLoadState.debates.loading || !currentUser?.id) return;

            try {
                lazyLoadState.debates.loading = true;

                if (!append) {
                    lazyLoadState.debates.offset = 0;
                    lazyLoadState.debates.hasMore = true;
                }

                if (!lazyLoadState.debates.hasMore) {
                    lazyLoadState.debates.loading = false;
                    return;
                }

                const response = await fetch('/api/debate/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: parseInt(currentUser.id),
                        offset: lazyLoadState.debates.offset,
                        limit: lazyLoadState.debates.limit
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('历史辩论数据:', data);

                    if (data.debates && data.debates.length > 0) {
                        lazyLoadState.debates.total = data.total;
                        lazyLoadState.debates.hasMore = data.has_more;
                        lazyLoadState.debates.offset += lazyLoadState.debates.limit;

                        await renderRecentDebates(data.debates, append);

                        // 如果没有更多数据，标记完成
                        if (!data.has_more) {
                            lazyLoadState.debates.hasMore = false;
                        }
                    } else {
                        console.log('没有更多历史辩论数据');
                        lazyLoadState.debates.hasMore = false;

                        // 如果是第一次加载且没有数据，显示空状态
                        if (!append) {
                            await renderRecentDebates([], false);
                        }
                    }
                } else {
                    console.error('加载历史辩论失败:', response.status);
                    lazyLoadState.debates.hasMore = false;

                    // 如果是第一次加载且请求失败，显示空状态
                    if (!append) {
                        await renderRecentDebates([], false);
                    }
                }
            } catch (error) {
                console.error('加载历史辩论错误:', error);
                lazyLoadState.debates.hasMore = false;

                // 如果是第一次加载且出错，显示空状态
                if (!append) {
                    await renderRecentDebates([], false);
                }
            } finally {
                lazyLoadState.debates.loading = false;
            }
        }

        async function renderRecentDebates(debates, append = false) {
            const debateList = document.getElementById('debateList');
            console.log('renderRecentDebates调用:', {
                debatesCount: debates.length,
                append,
                debateListExists: !!debateList
            });

            if (!debateList) {
                console.error('debateList元素不存在，无法渲染辩论列表');
                return;
            }

            if (!append) {
                debateList.innerHTML = '';
            }

            // 如果有辩论记录，隐藏空状态提示
            const noDebates = debateList.querySelector('.no-debates');
            if (noDebates && debates.length > 0) {
                noDebates.remove();
            }

            // 需要获取角色信息来显示头像和名称
            const roleIds = [...new Set(debates.flatMap(debate => [debate.role1_id, debate.role2_id]))];
            const rolesMap = new Map();

            // 批量获取角色信息
            for (const roleId of roleIds) {
                try {
                    const response = await fetch(`/api/role/details?role_id=${roleId}`);
                    if (response.ok) {
                        const roleData = await response.json();
                        // 需要构造完整的角色对象，包含id字段
                        rolesMap.set(roleId, {
                            id: roleId,
                            name: roleData.name,
                            description: roleData.description,
                            traits: roleData.traits,
                            image_url: roleData.image_url,
                            avatar_url: roleData.image_url // 兼容性字段
                        });
                    }
                } catch (error) {
                    console.error('获取角色信息失败:', error);
                }
            }

            debates.forEach(debate => {
                const debateItem = createDebateItem(debate, rolesMap);
                debateList.appendChild(debateItem);
            });

            // 如果没有辩论记录并且不是追加模式，显示空状态
            if (debates.length === 0 && !append) {
                const emptyMessage = isLoggedIn ? '暂无辩论记录' : '登录后查看辩论记录';
                debateList.innerHTML = `<div class="no-debates">${emptyMessage}</div>`;
            }
        }

        function createDebateItem(debate, rolesMap) {
            const debateItem = document.createElement('div');
            debateItem.className = 'debate-item';

            const role1 = rolesMap.get(debate.role1_id);
            const role2 = rolesMap.get(debate.role2_id);

            // 头像处理
            const getAvatarHtml = (role, side) => {
                if (!role) return `<div class="debate-role-avatar ${side}">🎭</div>`;

                if (role.image_url) {
                    if (isEmoji(role.image_url)) {
                        return `<div class="debate-role-avatar ${side}">${role.image_url}</div>`;
                    } else {
                        return `<div class="debate-role-avatar ${side}"><img src="${role.image_url}" alt="${role.name}"></div>`;
                    }
                } else {
                    return `<div class="debate-role-avatar ${side}">🎭</div>`;
                }
            };

            const timeAgo = getTimeAgo(debate.last_dialog_timestamp);

            debateItem.innerHTML = `
                <div class="debate-item-header">
                    <div class="debate-roles">
                        ${getAvatarHtml(role1, 'pro')}
                        <span class="debate-vs">VS</span>
                        ${getAvatarHtml(role2, 'con')}
                    </div>
                    <div class="debate-item-actions">
                        <div class="debate-time">${timeAgo}</div>
                        <div class="debate-delete-btn" onclick="event.stopPropagation(); deleteDebate(${debate.id});">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"></polyline>
                                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="debate-topic">${escapeHtml(debate.topic)}</div>
            `;

            // 点击事件 - 进入辩论房间
            debateItem.onclick = () => {
                if (role1 && role2) {
                    // 设置当前辩论ID，用于加载历史记录
                    currentDebateId = debate.id;
                    // 调用showDebateRoom，role1是正方，role2是反方
                    showDebateRoom(debate.topic, role1, role2);
                    // 更新URL，包含必要的参数用于加载历史记录
                    window.location.hash = `#debate-room?user_id=${currentUser.id}&role1_id=${debate.role1_id}&role2_id=${debate.role2_id}&debate_id=${debate.id}`;
                }
            };

            return debateItem;
        }

        // 删除单个辩论
        async function deleteDebate(debateId) {
            if (!confirm('确定要删除这个辩论吗？此操作无法撤销。')) {
                return;
            }

            try {
                const response = await fetch('/api/debate/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        debate_id: debateId
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('删除辩论成功:', result.message);

                    // 刷新辩论列表
                    await updateRecentDebatesList();

                    alert('辩论删除成功');
                } else {
                    const errorData = await response.text();
                    console.error('删除辩论失败:', response.status, errorData);
                    alert('删除辩论失败，请重试');
                }
            } catch (error) {
                console.error('删除辩论请求出错:', error);
                alert('删除辩论出错，请重试');
            }
        }

        async function updateRecentDebatesList() {
            console.log('更新历史辩论列表');

            // 检查DOM元素是否存在
            const debateList = document.getElementById('debateList');
            console.log('debateList元素存在吗?', !!debateList);

            if (!debateList) {
                console.error('debateList元素不存在，无法更新辩论列表');
                return;
            }

            // 重置懒加载状态
            lazyLoadState.debates.offset = 0;
            lazyLoadState.debates.hasMore = true;
            lazyLoadState.debates.loading = false;

            // 重新加载历史辩论列表
            try {
                await loadRecentDebates(false);
            } catch (error) {
                console.error('更新历史辩论列表失败:', error);
            }
        }

        // 获取对话的聊天记录（懒加载版本）
        async function loadChatDialogs(roleId, append = false) {
            if (lazyLoadState.dialogs.loading || !currentUser?.id) return [];

            try {
                lazyLoadState.dialogs.loading = true;

                if (!append) {
                    lazyLoadState.dialogs.offset = 0;
                    lazyLoadState.dialogs.hasMore = true;
                }

                if (!lazyLoadState.dialogs.hasMore) {
                    lazyLoadState.dialogs.loading = false;
                    return [];
                }

                const url = `/api/conversation/dialogs?user_id=${parseInt(currentUser.id)}&role_id=${parseInt(roleId)}&offset=${lazyLoadState.dialogs.offset}&limit=${lazyLoadState.dialogs.limit}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取聊天记录失败');
                }

                const data = await response.json();
                console.log('聊天记录数据:', data);

                if (data && data.items && Array.isArray(data.items)) {
                    lazyLoadState.dialogs.total = data.total;
                    lazyLoadState.dialogs.hasMore = data.has_more;
                    lazyLoadState.dialogs.offset += lazyLoadState.dialogs.limit;

                    const dialogs = data.items.map(dialog => ({
                        id: ++messageIdCounter,
                        sender: dialog.is_user ? 'user' : 'role',
                        message: dialog.text,
                        timestamp: dialog.timestamp,
                        voice: dialog.voice
                    }));

                    return dialogs;
                } else {
                    return [];
                }
            } catch (error) {
                console.error('加载聊天记录错误:', error);
                return [];
            } finally {
                lazyLoadState.dialogs.loading = false;
            }
        }

        // ====== 聊天相关功能 ======

        let currentChatRole = null; // 当前聊天的角色
        let chatMessages = []; // 聊天消息历史

        // 显示聊天页面
        function showChatPage(roleId) {
            console.log('显示聊天页面，接收到的角色ID:', roleId);
            currentPage = 'chat';
            currentChatRoleId = roleId;

            // 隐藏其他页面
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('createRolePage').classList.remove('active');

            // 显示新的聊天页面
            document.getElementById('chatPageNew').classList.add('active');

            if (roleId) {
                // 如果指定了角色ID，加载该角色的聊天
                console.log('调用loadChatRole，角色ID:', roleId);
                loadChatRole(roleId);
            } else {
                // 否则显示默认状态
                resetChatPage();
            }

            // 只在当前URL不匹配时才更新锚点
            const expectedHash = roleId ? `#chat/${roleId}` : '#chat';
            if (window.location.hash !== expectedHash) {
                updateUrlHash();
            }
        }

        // 加载聊天角色
        async function loadChatRole(roleId) {
            try {
                console.log('尝试加载角色ID:', roleId, '类型:', typeof roleId);
                console.log('当前角色列表:', roles);

                // 确保ID都是字符串格式进行比较
                const targetId = String(roleId);
                const role = roles.find(r => String(r.id) === targetId);

                if (!role) {
                    console.error('角色不存在，目标ID:', targetId);
                    console.error('可用角色ID列表:', roles.map(r => String(r.id)));
                    throw new Error(`角色不存在，ID: ${targetId}`);
                }

                currentChatRole = role;
                console.log('成功加载角色:', role);

                // 更新聊天头部 - 只显示角色名
                const nameElement = document.getElementById('currentRoleNameNew');
                nameElement.textContent = role.name;

                // 重置聊天记录状态
                chatMessages = [];
                lazyLoadState.dialogs.offset = 0;
                lazyLoadState.dialogs.hasMore = true;

                // 加载历史聊天记录（第一页）
                const firstPageMessages = await loadChatDialogs(roleId, false);
                chatMessages = firstPageMessages;
                renderChatMessages();

                // 启用输入框
                enableChatInput();

                // Socket.IO会自动将用户加入socket.id房间，无需手动加入

            } catch (error) {
                console.error('加载角色失败:', error);
                alert('加载角色失败: ' + error.message);
            }
        }

        // 重置聊天页面
        function resetChatPage() {
            currentChatRole = null;
            chatMessages = [];

            // 重置头部 - 只更新角色名
            document.getElementById('currentRoleNameNew').textContent = '选择一个角色开始对话';

            // 显示空状态
            showChatEmpty();

            // 禁用输入框
            disableChatInput();
        }

        // 渲染聊天消息
        function renderChatMessages() {
            const container = document.getElementById('chatMessagesNew');
            const emptyDiv = document.getElementById('chatEmptyNew');

            if (chatMessages.length === 0) {
                showChatEmpty();
                return;
            }

            // 隐藏空状态
            emptyDiv.style.display = 'none';

            // 保存现有的 typing indicator
            const existingTypingIndicator = container.querySelector('.typing-indicator');
            let typingIndicatorHTML = '';
            if (existingTypingIndicator) {
                typingIndicatorHTML = existingTypingIndicator.outerHTML;
            }

            const messagesHTML = chatMessages.map(message => {
                const isUser = message.sender === 'user';
                let avatarHtml;

                if (isUser) {
                    // 用户头像处理
                    if (currentUser.avatar) {
                        if (isEmoji(currentUser.avatar)) {
                            avatarHtml = currentUser.avatar;
                        } else {
                            avatarHtml = `<img src="${currentUser.avatar}" alt="${currentUser.name}">`;
                        }
                    } else {
                        avatarHtml = '👤';
                    }
                } else {
                    // 角色头像处理
                    if (currentChatRole.image_url) {
                        if (isEmoji(currentChatRole.image_url)) {
                            avatarHtml = currentChatRole.image_url;
                        } else {
                            avatarHtml = `<img src="${currentChatRole.image_url}" alt="${currentChatRole.name}">`;
                        }
                    } else {
                        avatarHtml = '🎭';
                    }
                }

                // 消息内容，支持文本和语音
                let messageContent = `<div class="message-text">${message.message}</div>`;
                let hasVoiceClass = '';
                if (message.voice) {
                    hasVoiceClass = ' has-voice'; // 添加CSS类标识
                    messageContent += `
                        <div class="message-voice">
                            <audio controls preload="metadata">
                                <source src="${message.voice}" type="audio/mpeg">
                                您的浏览器不支持音频播放。
                            </audio>
                        </div>
                    `;
                }

                // 添加时间戳显示
                const timestampText = formatTimestamp(message.timestamp);
                if (timestampText) {
                    messageContent += `<div class="message-timestamp" data-timestamp="${message.timestamp}">${timestampText}</div>`;
                }

                return `
                    <div class="message ${isUser ? 'user' : 'role'}${hasVoiceClass}">
                        <div class="message-avatar ${isUser ? 'user' : 'role'}">${avatarHtml}</div>
                        <div class="message-content${hasVoiceClass}">${messageContent}</div>
                    </div>
                `;
            }).join('');

            // 重新设置内容，包括消息和 typing indicator
            container.innerHTML = messagesHTML + '<div id="chatEmptyNew" style="display: none;"></div>' + typingIndicatorHTML;

            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        // 显示聊天空状态
        function showChatEmpty() {
            const container = document.getElementById('chatMessagesNew');

            // 清空消息
            container.innerHTML = `
                <div class="chat-empty" id="chatEmptyNew">
                    <div class="chat-empty-icon">💬</div>
                    <div class="chat-empty-text">${currentChatRole ? '开始与 ' + currentChatRole.name + ' 对话吧！' : '还没有聊天记录'}</div>
                    <div class="chat-empty-hint">${currentChatRole ? '输入消息开始有趣的角色扮演' : '选择一个角色开始有趣的对话吧！'}</div>
                </div>
            `;
        }

        // 启用聊天输入
        function enableChatInput() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            input.disabled = false;
            input.placeholder = '输入消息...';
            checkSendButton();
        }

        // 禁用聊天输入
        function disableChatInput() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            input.disabled = true;
            input.placeholder = '请先选择一个角色...';
            sendBtn.disabled = true;
        }

        // 发送消息
        async function sendMessage() {
            if (!currentChatRole) {
                alert('请先选择一个角色');
                return;
            }

            if (!isLoggedIn) {
                alert('请先登录');
                return;
            }

            const input = document.getElementById('messageInputNew');
            const message = input.value.trim();

            if (!message) {
                return;
            }

            // 添加用户消息到界面
            chatMessages.push({
                id: ++messageIdCounter, // 为文本消息也添加ID
                sender: 'user',
                message: message,
                timestamp: Math.floor(Date.now() / 1000)
            });

            // 清空输入框
            input.value = '';
            input.style.height = 'auto';
            checkSendButton();

            // 重新渲染消息
            renderChatMessages();

            // 触发动态时间更新
            onNewMessageAdded();

            // 显示"正在回复"状态
            showTypingIndicator();

            // 通过Socket.IO发送消息到后端
            sendSocketMessage(currentUser.id, currentChatRole.id, message);
        }

        // 处理输入框键盘事件
        function handleInputKeydown(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    // Shift+Enter 换行
                    return;
                } else {
                    // Enter 发送消息
                    event.preventDefault();
                    sendMessage();
                }
            }
        }

        // 自动调整输入框高度
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

            // 检查发送按钮状态
            checkSendButton();
        }

        // 检查发送按钮状态
        function checkSendButton() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            if (currentChatRole && input.value.trim()) {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = true;
            }
        }

        // 语音录制相关变量
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let messageIdCounter = 0; // 消息ID计数器

        // 语音输入功能
        async function startVoiceInput() {
            if (!currentChatRole) {
                alert('请先选择一个角色');
                return;
            }

            if (!isLoggedIn) {
                alert('请先登录');
                return;
            }

            if (isRecording) {
                // 如果正在录音，停止录音
                stopRecording();
            } else {
                // 开始录音
                await startRecording();
            }
        }

        // 开始录制语音
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // 检查浏览器支持的音频格式
                let mimeType = 'audio/mp4'; // 默认使用mp4格式，比webm更接近mp3
                if (MediaRecorder.isTypeSupported('audio/mpeg')) {
                    mimeType = 'audio/mpeg';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                } else if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus'; // 备用方案
                }

                console.log('使用音频格式:', mimeType);

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });

                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await uploadAndSendVoice(audioBlob);

                    // 停止所有音频流
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                updateVoiceButton();

                console.log('开始录音...');
            } catch (error) {
                console.error('无法访问麦克风:', error);
                alert('无法访问麦克风，请检查权限设置');
            }
        }

        // 停止录制语音
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                updateVoiceButton();
                console.log('停止录音...');
            }
        }

        // 更新语音按钮状态
        function updateVoiceButton() {
            const voiceBtn = document.getElementById('voiceBtnNew');
            if (isRecording) {
                voiceBtn.innerHTML = '⏹️';
                voiceBtn.title = '点击停止录音';
                voiceBtn.style.backgroundColor = '#ff4757';
            } else {
                voiceBtn.innerHTML = '🎤';
                voiceBtn.title = '点击录制语音';
                voiceBtn.style.backgroundColor = '';
            }
        }

        // 上传语音并发送消息
        async function uploadAndSendVoice(audioBlob) {
            try {
                console.log('开始上传语音文件，大小:', audioBlob.size);

                // 检查登录状态和角色
                if (!currentUser || !currentChatRole) {
                    throw new Error('用户未登录或未选择角色');
                }

                // 上传语音文件
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'X-File-Name': `voice_${Date.now()}.mp3`,
                        'Content-Type': 'audio/mpeg'
                    },
                    body: audioBlob
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`语音上传失败: ${response.status} ${errorText}`);
                }

                const uploadData = await response.json();
                console.log('上传响应:', uploadData);

                if (!uploadData.file_url) {
                    throw new Error('上传响应中缺少file_url');
                }

                const voiceUrl = uploadData.file_url;
                console.log('语音上传成功，URL:', voiceUrl);

                // 生成消息ID
                messageIdCounter++;
                const messageId = messageIdCounter;

                // 添加用户语音消息到界面（显示为"[正在将语音转换成文字]"）
                chatMessages.push({
                    id: messageId,
                    sender: 'user',
                    message: '[正在将语音转换成文字]',
                    timestamp: Math.floor(Date.now() / 1000),
                    voice: voiceUrl
                });

                // 重新渲染消息
                renderChatMessages();

                // 通过Socket发送语音消息到后端
                sendVoiceMessage(currentUser.id, currentChatRole.id, voiceUrl, messageId);

            } catch (error) {
                console.error('语音处理失败:', error);
                alert('语音发送失败: ' + error.message);
            }
        }

        // 显示"正在回复"状态 - 显示闪动的消息框
        function showTypingIndicator() {
            if (!currentChatRole) return;

            const container = document.getElementById('chatMessagesNew');
            if (!container) return;

            // 移除已存在的typing indicator
            const existingIndicator = container.querySelector('.typing-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            // 角色头像处理
            let avatarHtml;
            if (currentChatRole.image_url) {
                if (isEmoji(currentChatRole.image_url)) {
                    avatarHtml = currentChatRole.image_url;
                } else {
                    avatarHtml = `<img src="${currentChatRole.image_url}" alt="${currentChatRole.name}">`;
                }
            } else {
                avatarHtml = '🎭';
            }

            // 创建闪动的消息框
            const typingHTML = `
                <div class="typing-indicator show">
                    <div class="typing-message">
                        <div class="message-avatar role">${avatarHtml}</div>
                        <div class="typing-bubble">
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 添加到消息容器末尾
            container.insertAdjacentHTML('beforeend', typingHTML);

            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        // 隐藏"正在回复"状态 - 移除闪动的消息框
        function hideTypingIndicator() {
            const container = document.getElementById('chatMessagesNew');
            if (!container) return;

            const typingIndicator = container.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // 显示辩论"正在思考"状态
        function showDebateTypingIndicator(nextRole, isProRole) {
            const container = document.getElementById('debateMessages');
            if (!container) return;

            // 移除已存在的typing indicator
            const existingIndicator = container.querySelector('.debate-typing-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            // 创建简化的打字指示器，只显示浮动的点
            const typingHTML = `
                <div class="debate-typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;

            // 添加到消息容器末尾
            container.insertAdjacentHTML('beforeend', typingHTML);

            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        // 隐藏辩论"正在思考"状态
        function hideDebateTypingIndicator() {
            const container = document.getElementById('debateMessages');
            if (!container) return;

            const typingIndicator = container.querySelector('.debate-typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // 播放语音
        function playVoice(voiceUrl) {
            try {
                // 在用户对话界面中查找对应的音频控件
                const audioElements = document.querySelectorAll('#chatMessagesNew audio');
                let targetAudio = null;

                // 找到匹配voiceUrl的音频元素
                for (const audioElement of audioElements) {
                    const source = audioElement.querySelector('source');
                    if (source && source.src === voiceUrl) {
                        targetAudio = audioElement;
                        break;
                    }
                }

                if (targetAudio) {
                    // 使用界面中的音频控件播放
                    targetAudio.currentTime = 0; // 重置到开头
                    targetAudio.play().catch(error => {
                        console.error('语音播放失败:', error);
                    });
                } else {
                    // 如果找不到对应的音频控件，使用原来的方式
                    const audio = new Audio(voiceUrl);
                    audio.play().catch(error => {
                        console.error('语音播放失败:', error);
                    });
                }
            } catch (error) {
                console.error('播放语音失败:', error);
            }
        }

        // 删除对话
        async function deleteConversation(userId, roleId) {
            if (!confirm('确定要删除这个对话吗？删除后将无法恢复！')) {
                return;
            }

            try {
                const response = await fetch(`/api/conversation/delete/${userId}/${roleId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('删除对话失败');
                }

                console.log('对话删除成功');

                // 如果删除的是当前正在聊天的对话，则清空聊天界面
                if (currentChatRole && currentChatRole.id === roleId) {
                    currentChatRole = null;
                    chatMessages = [];
                    renderChatMessages();

                    // 隐藏聊天界面，显示主页
                    const chatPageNew = document.getElementById('chatPageNew');
                    const mainPage = document.querySelector('.main-page');
                    if (chatPageNew) chatPageNew.style.display = 'none';
                    if (mainPage) mainPage.style.display = 'block';
                }

                // 重新加载最近对话列表
                await loadRecentChats();

                alert('对话删除成功');
            } catch (error) {
                console.error('删除对话错误:', error);
                alert('删除对话失败：' + error.message);
            }
        }

        // 修改现有的角色卡片点击事件，添加聊天功能
        async function startChatWithRole(roleId) {
            console.log('开始聊天，角色ID:', roleId);
            console.log('当前登录状态:', isLoggedIn);

            if (!isLoggedIn) {
                setPendingAction('startChatWithRole', { roleId: roleId });
                showAuthModal();
                return;
            }

            try {
                // 创建与角色的对话（如果不存在）
                await createConversation(roleId);

                // 确保角色列表已加载
                if (roles.length === 0) {
                    console.log('角色列表为空，重新加载...');
                    await loadRoles();
                }

                console.log('当前roles数组:', roles);
                showChatPage(roleId);

                // 更新最近对话列表
                await loadRecentChats();
            } catch (error) {
                console.error('启动对话失败:', error);
                alert('启动对话失败: ' + error.message);
            }
        }

        // 修改backToHome函数，支持从聊天页面、创建角色页面、辩论页面和用户设置页面返回
        function backToHome() {
            console.log('backToHome被调用，调用堆栈:', new Error().stack);
            currentPage = 'home';
            currentChatRoleId = null;
            currentDebateRoles = null;
            debateSessionActive = false;

            document.querySelector('.header').style.display = 'flex';
            document.querySelector('.content-area').style.display = 'block';
            document.getElementById('createRolePage').classList.remove('active');
            document.getElementById('chatPageNew').classList.remove('active');
            document.getElementById('debatePage').classList.remove('active');
            document.getElementById('debateRoomPage').classList.remove('active');

            // 隐藏用户设置页面（如果存在）
            const settingsPage = document.getElementById('user-settings-page');
            if (settingsPage) {
                settingsPage.style.display = 'none';
            }

            // 只在当前URL不是home时才更新锚点，避免无限循环
            if (window.location.hash !== '#home') {
                updateUrlHash();
            }
        }

        // 用户设置相关函数

        // 密码哈希函数 (与登录/注册保持一致)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function loadUserSettings() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    return;
                }

                // 加载用户头像
                await loadUserAvatar();

                // 加载用户角色
                await loadUserRoles();

            } catch (error) {
                console.error('加载用户设置失败:', error);
            }
        }

        async function loadUserAvatar() {
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch('/api/user/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    console.log('用户数据:', userData); // 调试日志

                    // 更新用户设置页面的头像
                    const settingsAvatarImg = document.getElementById('settingsAvatar');
                    console.log('设置页面头像元素:', settingsAvatarImg); // 调试日志
                    console.log('头像URL:', userData.avatar); // 调试日志

                    if (settingsAvatarImg && userData.avatar) {
                        settingsAvatarImg.src = userData.avatar;
                        console.log('设置头像URL:', userData.avatar); // 调试日志
                    } else if (settingsAvatarImg) {
                        // 设置默认头像
                        console.log('使用默认头像'); // 调试日志
                        settingsAvatarImg.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNjAiIHI9IjYwIiBmaWxsPSIjZjhlOWVhIi8+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNDUiIHI9IjIwIiBmaWxsPSIjZTc0YzNjIi8+CjxwYXRoIGQ9Ik0yMCA5NWM1LTI1IDM1LTI1IDgwIDBaIiBmaWxsPSIjZTc0YzNjIi8+Cjwvc3ZnPgo=';
                    }

                    // 同时更新顶部栏的头像
                    updateTopBarAvatar(userData.avatar);
                } else {
                    console.error('API响应失败:', response.status); // 调试日志
                }
            } catch (error) {
                console.error('加载头像失败:', error);
            }
        }

        function updateTopBarAvatar(avatarUrl) {
            const topBarAvatar = document.getElementById('userAvatar');
            if (topBarAvatar && avatarUrl) {
                // 如果是URL或base64，创建img元素
                if (avatarUrl.startsWith('http') || avatarUrl.startsWith('data:image')) {
                    topBarAvatar.innerHTML = `<img src="${avatarUrl}" alt="用户头像" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    // 如果是表情符号或其他文本
                    topBarAvatar.textContent = avatarUrl;
                }
            }
        }

        async function loadUserRoles() {
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch('/api/user/roles', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const roles = await response.json();
                    const rolesList = document.getElementById('rolesList');

                    if (roles.length === 0) {
                        rolesList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">暂无创建的角色</p>';
                        return;
                    }

                    rolesList.innerHTML = roles.map(role => `
                        <div class="role-item">
                            <button class="role-delete-btn" onclick="deleteRole('${role.id}')" title="删除角色">×</button>
                            <div class="role-name">${role.name}</div>
                            <div class="role-description">${role.description || '暂无描述'}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('加载角色列表失败:', error);
            }
        }

        async function updateUserAvatar() {
            const fileInput = document.getElementById('avatarInput');
            const file = fileInput.files[0];

            if (!file) return;

            // 检查文件大小 (最大2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('头像文件大小不能超过2MB');
                return;
            }

            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件');
                return;
            }

            const token = localStorage.getItem('authToken');

            try {
                // 第一步：上传文件到服务器获取URL
                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-File-Name': file.name,
                        'Content-Type': file.type
                    },
                    body: file
                });

                if (!uploadResponse.ok) {
                    const error = await uploadResponse.text();
                    alert(`文件上传失败: ${error}`);
                    return;
                }

                const uploadResult = await uploadResponse.json();
                const avatarUrl = uploadResult.file_url;

                // 第二步：使用获得的URL更新用户头像
                const updateResponse = await fetch('/api/user/avatar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        avatar_url: avatarUrl
                    })
                });

                if (updateResponse.ok) {
                    alert('头像更新成功！');
                    // 重新加载用户头像
                    await loadUserAvatar();
                } else {
                    const error = await updateResponse.text();
                    alert(`头像更新失败: ${error}`);
                }
            } catch (error) {
                console.error('上传头像失败:', error);
                alert('头像上传失败，请重试');
            }
        }

        async function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword) {
                alert('请输入当前密码');
                return;
            }

            if (!newPassword) {
                alert('请输入新密码');
                return;
            }

            if (!confirmPassword) {
                alert('请确认新密码');
                return;
            }

            if (newPassword.length < 6) {
                alert('新密码长度不能少于6位');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('新密码和确认密码不匹配');
                return;
            }

            const token = localStorage.getItem('authToken');

            try {
                // 哈希密码
                const currentPasswordHash = await hashPassword(currentPassword);
                const newPasswordHash = await hashPassword(newPassword);

                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPasswordHash,
                        new_password: newPasswordHash
                    })
                });

                if (response.ok) {
                    alert('密码更新成功！');
                    // 清空表单
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    const error = await response.text();
                    alert(`密码更新失败: ${error}`);
                }
            } catch (error) {
                console.error('更新密码失败:', error);
                alert('密码更新失败，请重试');
            }
        }

        async function deleteRole(roleId) {
            if (!confirm('确定要删除这个角色吗？此操作无法撤销。')) {
                return;
            }

            const token = localStorage.getItem('authToken');

            try {
                const response = await fetch(`/api/user/role/delete/${roleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('角色删除成功！');

                    // 如果删除的是当前正在聊天的角色，则清空聊天界面
                    if (currentChatRoleId && currentChatRoleId === parseInt(roleId)) {
                        currentChatRoleId = null;
                        // 返回主界面
                        backToHome();
                    }

                    // 重新加载用户设置中的角色列表
                    await loadUserRoles();

                    // 重新加载主界面的角色列表
                    await loadRoles();

                    // 重新加载最近对话列表
                    await loadRecentChats();
                } else {
                    const error = await response.text();
                    alert(`角色删除失败: ${error}`);
                }
            } catch (error) {
                console.error('删除角色失败:', error);
                alert('角色删除失败，请重试');
            }
        }

        async function clearAllConversations() {
            if (!confirm('确定要清空所有对话吗？此操作无法撤销。')) {
                return;
            }

            const token = localStorage.getItem('authToken');

            try {
                const response = await fetch('/api/user/conversations/delete', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`成功清空了 ${result.deleted_count} 条对话！`);
                    // 刷新左侧最近对话列表
                    await loadRecentChats();
                } else {
                    const error = await response.text();
                    alert(`清空对话失败: ${error}`);
                }
            } catch (error) {
                console.error('清空对话失败:', error);
                alert('清空对话失败，请重试');
            }
        }

        // 删除所有辩论
        async function deleteAllDebates() {
            if (!confirm('确定要删除所有辩论吗？这将删除您的所有辩论记录，此操作无法撤销。')) {
                return;
            }

            try {
                const response = await fetch('/api/user/debates/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`成功删除了 ${result.deleted_count} 个辩论！`);

                    // 刷新辩论列表
                    await updateRecentDebatesList();
                } else {
                    const errorData = await response.text();
                    console.error('删除所有辩论失败:', response.status, errorData);
                    alert('删除所有辩论失败，请重试');
                }
            } catch (error) {
                console.error('删除所有辩论请求出错:', error);
                alert('删除所有辩论出错，请重试');
            }
        }
    </script>
</body>

</html>