<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËßíËâ≤ÊâÆÊºîAI</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            width: 100%;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            overflow: hidden;
        }

        /* Â∑¶‰æßËæπÊ†è */
        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow: hidden;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #34495e;
            flex-shrink: 0;
        }

        .create-role-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .create-role-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .recent-chats {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .recent-chats h3 {
            margin-bottom: 15px;
            color: #bdc3c7;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-item:hover {
            background: #34495e;
        }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            font-size: 12px;
            color: #95a5a6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .no-chats {
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
            padding: 20px;
            font-style: italic;
        }

        /* Âè≥‰æß‰∏ªË¶ÅÂÜÖÂÆπÂå∫ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* È°∂ÈÉ®Ê†è */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            z-index: 1000;
        }

        /* Loading ÊåáÁ§∫Âô®Ê†∑Âºè */
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e1e8ed;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .user-dropdown {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item.logout {
            color: #e74c3c;
        }

        .dropdown-item.logout:hover {
            background-color: #ffeaea;
        }

        .welcome-text {
            font-size: 16px;
            color: #2c3e50;
        }

        .login-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
        }

        .search-container {
            position: relative;
        }

        .search-input {
            padding: 10px 16px;
            padding-right: 40px;
            border: 2px solid #ecf0f1;
            border-radius: 20px;
            outline: none;
            width: 300px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #7f8c8d;
        }

        /* ËßíËâ≤Âç°ÁâáÂå∫Âüü */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .role-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .role-image {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            font-weight: bold;
        }

        .role-info {
            padding: 15px;
            flex: 1;
            /* Á°Æ‰øùÂÜÖÂÆπÂûÇÁõ¥ÊéíÂàóÔºöÂêçÂ≠óÂú®‰∏äÔºåÊèèËø∞Âú®‰∏ã */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .role-actions {
            padding: 0 15px 15px 15px;
            display: flex;
            justify-content: flex-end;
        }

        .chat-role-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .chat-role-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .role-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            /* Á°Æ‰øùÊñáÂ≠óÊ∞¥Âπ≥ÊòæÁ§∫ */
            writing-mode: horizontal-tb;
            text-orientation: mixed;
            /* ÈôêÂà∂ÊòæÁ§∫1Ë°åÔºåÂ§ö‰ΩôÊñáÂ≠óÊòæÁ§∫ÁúÅÁï•Âè∑ */
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.2em * 1);
            /* 1Ë°åÁöÑÈ´òÂ∫¶ */
        }

        .role-description {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.4;
            /* ÈôêÂà∂ÊòæÁ§∫5Ë°åÔºåÂ§ö‰ΩôÊñáÂ≠óÊòæÁ§∫ÁúÅÁï•Âè∑ */
            display: -webkit-box;
            -webkit-line-clamp: 5;
            line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.4em * 5);
            /* 5Ë°åÁöÑÈ´òÂ∫¶ */
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #7f8c8d;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 18px;
            margin-bottom: 20px;
        }

        /* ÁôªÂΩï/Ê≥®ÂÜåÊ®°ÊÄÅÊ°Ü */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .auth-modal {
            background: white;
            border-radius: 16px;
            width: 420px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 30px 30px 20px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .auth-tabs {
            display: flex;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #7f8c8d;
        }

        .auth-tab.active {
            background: white;
            color: #2c3e50;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-body {
            padding: 20px 30px 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .form-input.error {
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview-text {
            font-size: 24px;
            color: #7f8c8d;
        }

        .avatar-actions {
            display: flex;
            gap: 10px;
        }

        .avatar-btn {
            padding: 8px 16px;
            border: 1px solid #3498db;
            border-radius: 6px;
            background: white;
            color: #3498db;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .avatar-btn:hover {
            background: #3498db;
            color: white;
        }

        .avatar-btn.primary {
            background: #3498db;
            color: white;
        }

        .avatar-btn.primary:hover {
            background: #2980b9;
        }

        .default-avatars {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .default-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 20px;
        }

        .default-avatar:hover {
            transform: scale(1.1);
            border-color: #3498db;
        }

        .default-avatar.selected {
            border-color: #3498db;
            transform: scale(1.1);
        }

        #avatarInput {
            display: none;
        }

        .auth-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }

        .auth-submit:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }

        /* ÂàõÂª∫ËßíËâ≤È°µÈù¢ */
        .create-role-page {
            display: none;
        }

        .create-role-page.active {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
        }

        .create-role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .back-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .back-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(127, 140, 141, 0.3);
        }

        .create-role-content {
            flex: 1;
            padding: 30px;
            display: flex;
            justify-content: center;
            background: white;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .role-form {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            position: relative;
            z-index: 1;
            overflow: visible;
            box-sizing: border-box;
        }

        .role-form * {
            box-sizing: border-box;
        }

        .role-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border-radius: 12px;
            z-index: -1;
        }

        .role-avatar-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .role-avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #ecf0f1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .role-avatar-preview:hover {
            border-color: #3498db;
            transform: scale(1.05);
        }

        .role-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .role-avatar-text {
            font-size: 48px;
            color: #7f8c8d;
        }

        .avatar-upload-hint {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .role-avatar-preview:hover .avatar-upload-hint {
            opacity: 1;
        }

        .role-default-avatars {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 15px;
            justify-items: center;
        }

        .role-default-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 24px;
        }

        .role-default-avatar:hover {
            transform: scale(1.1);
            border-color: #3498db;
        }

        .role-default-avatar.selected {
            border-color: #3498db;
            border-width: 3px;
            transform: scale(1.1);
        }

        .role-input-group {
            margin-bottom: 25px;
        }

        .role-input-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .role-input-main {
            flex: 1;
        }

        .auto-fill-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 28px;
        }

        .auto-fill-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .auto-fill-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .role-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }

        .role-textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .role-textarea.error {
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }

        .create-submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            margin-bottom: 30px;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
            position: relative;
            z-index: 10;
        }

        .create-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.5);
            background: linear-gradient(135deg, #229954, #27ae60);
        }

        .create-submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(189, 195, 199, 0.3);
        }

        .role-select-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .role-radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .role-radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            accent-color: #3498db;
            cursor: pointer;
        }

        .radio-label {
            font-size: 14px;
            color: #2c3e50;
            cursor: pointer;
        }

        .role-radio-option:hover .radio-label {
            color: #3498db;
        }

        #roleAvatarInput {
            display: none;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            .sidebar {
                width: 100%;
                height: 200px;
                flex-shrink: 0;
            }

            .main-content {
                flex: 1;
                overflow: hidden;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .search-input {
                width: 100%;
            }

            .roles-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .content-area {
                padding: 20px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .auth-modal {
                width: 95vw;
            }

            .modal-body {
                padding: 15px 20px 25px;
            }

            .modal-header {
                padding: 20px 20px 15px;
            }
        }

        /* Êñ∞ËÅäÂ§©È°µÈù¢Ê†∑Âºè */
        .chat-content {
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* ÊòéÁ°ÆËÆæÁΩÆÈ´òÂ∫¶ */
        }

        .chat-messages {
            padding: 20px 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            height: calc(100vh - 160px);
            /* Ë∞ÉÊï¥ÔºöÂ§¥ÈÉ®Á∫¶80px + ËæìÂÖ•Ê°ÜÁ∫¶80px */
            max-height: calc(100vh - 160px);
            /* Á°Æ‰øù‰∏ç‰ºöË∂ÖËøáËÆæÂÆöÈ´òÂ∫¶ */
            flex-shrink: 0;
            /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
            box-sizing: border-box;
            /* ÂåÖÂê´paddingÂú®ÂÜÖ */
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 70%;
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message.role {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .message-avatar.role {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .message.role .message-content {
            background: white;
            color: #2c3e50;
        }

        .message-voice {
            margin-top: 8px;
            min-width: 250px;
            /* Á°Æ‰øùÊúÄÂ∞èÂÆΩÂ∫¶Ë∂≥Â§üÊòæÁ§∫ÂÆåÊï¥Êéß‰ª∂ */
        }

        .message-voice audio {
            width: 100%;
            min-width: 250px;
            /* Èü≥È¢ëÊéß‰ª∂ÊúÄÂ∞èÂÆΩÂ∫¶ */
            max-width: 400px;
            /* Â¢ûÂä†ÊúÄÂ§ßÂÆΩÂ∫¶ */
            height: 36px;
            /* Â¢ûÂä†È´òÂ∫¶ÔºåËÆ©Êéß‰ª∂Êõ¥ÂÆπÊòìÊìç‰Ωú */
            border-radius: 8px;
            /* Ê∑ªÂä†ÂúÜËßí */
            background-color: linear-gradient(135deg, #3498db, #2980b9);
            /* Ê∑ªÂä†ËÉåÊôØËâ≤ */
            outline: none;
            /* ÂéªÈô§ÁÑ¶ÁÇπËΩÆÂªì */
        }

        .message-voice audio::-webkit-media-controls-panel {
            background-color: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 8px;
        }

        /* Áî®Êà∑ÂèëÈÄÅÁöÑËØ≠Èü≥Ê∂àÊÅØÂè≥ÂØπÈΩê */
        .message.user .message-voice {
            text-align: right;
        }

        /* ÂåÖÂê´ËØ≠Èü≥ÁöÑÊ∂àÊÅØÂÆπÂô®ÈúÄË¶ÅÊõ¥Â§ßÁöÑÊúÄÂ∞èÂÆΩÂ∫¶ */
        .message-content:has(.message-voice),
        .message-content.has-voice {
            min-width: 280px !important;
        }

        /* Á°Æ‰øùÊâÄÊúâÊ∂àÊÅØÂÆπÂô®ÈÉΩÊúâÂü∫Êú¨ÁöÑÊúÄÂ∞èÂÆΩÂ∫¶ */
        .message-content {
            min-width: 180px;
        }

        /* ËØ≠Èü≥Ê∂àÊÅØÁöÑÊñáÊú¨Ê†∑Âºè */
        .message-text {
            margin-bottom: 4px;
        }

        .message-text:last-child {
            margin-bottom: 0;
        }

        /* ËØ≠Èü≥Ê∂àÊÅØÊ†áËØÜÊñáÊú¨ÁöÑÊ†∑Âºè */
        .message.has-voice .message-text {
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .message.user.has-voice .message-text {
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-input {
            padding: 15px 30px;
            background: white;
            border-top: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.4;
            overflow-y: auto;
        }

        .message-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .voice-btn,
        .send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .voice-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .send-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .voice-btn:hover,
        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            text-align: center;
        }

        .chat-empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .chat-empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .chat-empty-hint {
            font-size: 14px;
            opacity: 0.7;
        }

        .role-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-avatar-chat {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .role-avatar-chat img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .role-name-chat {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* ÂØπËØùÈ°µÈù¢Ê†∑Âºè */
        .chat-page {
            display: none;
            width: 100%;
            height: 100vh;
            background: #ecf0f1;
        }

        .chat-page.active {
            display: flex;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .role-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-avatar-chat {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .role-avatar-chat img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .role-name-chat {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .chat-back-btn {
            margin-left: auto;
            padding: 8px 16px;
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-back-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 70%;
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message.role {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .message-avatar.role {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .message.role .message-content {
            background: white;
            color: #2c3e50;
        }

        .message-time {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: center;
        }

        .chat-input {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.4;
            overflow-y: auto;
        }

        .message-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .voice-btn:active {
            transform: scale(0.95);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ËÅäÂ§©ËÆ∞ÂΩï‰∏∫Á©∫Êó∂ÁöÑÊèêÁ§∫ */
        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            text-align: center;
        }

        .chat-empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .chat-empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .chat-empty-hint {
            font-size: 14px;
            opacity: 0.7;
        }

        /* ÊúÄËøëÂØπËØùËßíËâ≤ÂàóË°® */
        .recent-roles {
            flex: 1;
            overflow-y: auto;
            padding-top: 10px;
        }

        /* ÊúÄËøëËÅäÂ§©ËßíËâ≤È°πÊ†∑Âºè */
        .recent-role-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 5px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
        }

        .recent-role-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .recent-role-item.active {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .recent-role-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            flex-shrink: 0;
            margin-right: 12px;
        }

        .recent-role-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .recent-role-info {
            flex: 1;
            min-width: 0;
        }

        .recent-role-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-role-desc {
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ÂìçÂ∫îÂºèÈÄÇÈÖç */
        @media (max-width: 768px) {
            .create-role-page.active {
                width: 100%;
                height: 100vh;
            }

            .create-role-header {
                padding: 15px 20px;
            }

            .create-role-content {
                padding: 20px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .role-form {
                max-width: 100%;
                padding: 20px;
                position: relative;
                z-index: 1;
                overflow: visible;
                box-sizing: border-box;
            }

            .role-form::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                border-radius: 12px;
                z-index: -1;
            }

            .role-select-group {
                flex-direction: column;
                gap: 10px;
            }

            .chat-content {
                height: 100%;
            }

            .chat-messages {
                padding: 15px;
                height: calc(100vh - 120px);
                /* ÁßªÂä®Á´ØÂõ∫ÂÆöÈ´òÂ∫¶ */
                max-height: calc(100vh - 120px);
                /* Á°Æ‰øù‰∏ç‰ºöË∂ÖËøáËÆæÂÆöÈ´òÂ∫¶ */
                flex-shrink: 0;
                /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
                box-sizing: border-box;
                /* ÂåÖÂê´paddingÂú®ÂÜÖ */
            }

            .message {
                max-width: 85%;
            }

            .chat-header {
                padding: 10px 15px;
            }

            .role-avatar-chat {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .role-name-chat {
                font-size: 18px;
            }

            .message-avatar {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }

            .message-input {
                font-size: 16px;
                padding: 10px 16px;
            }

            .voice-btn,
            .send-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Â∑¶‰æßËæπÊ†è -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="create-role-btn" onclick="createRole()">
                    <span>‚ûï</span>
                    ÂàõÂª∫ËßíËâ≤
                </button>
            </div>

            <div class="recent-chats">
                <h3>ÊúÄËøëÂØπËØù</h3>
                <div id="chatList">
                    <div class="no-chats">ÁôªÂΩïÂêéÊü•ÁúãÂØπËØùËÆ∞ÂΩï</div>
                </div>
                <div id="chatsLoading" class="loading-indicator" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>Âä†ËΩΩÊõ¥Â§öÂØπËØù...</div>
                </div>
            </div>
        </div>

        <!-- Âè≥‰æß‰∏ªË¶ÅÂÜÖÂÆπÂå∫ -->
        <div class="main-content">
            <!-- È°∂ÈÉ®Ê†è -->
            <div class="header">
                <div class="user-info" id="userInfo">
                    <!-- Â∑≤ÁôªÂΩïÁä∂ÊÄÅ -->
                    <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">Áî®</div>
                    <span class="welcome-text" id="welcomeText">Ê¨¢ËøéÔºåÁî®Êà∑Âêç</span>

                    <!-- Áî®Êà∑‰∏ãÊãâËèúÂçï -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="showUserProfile()">‰∏™‰∫∫ËµÑÊñô</div>
                        <div class="dropdown-item logout" onclick="logout()">ÈÄÄÂá∫ÁôªÂΩï</div>
                    </div>

                    <!-- Êú™ÁôªÂΩïÁä∂ÊÄÅ -->
                    <!-- <button class="login-btn" onclick="login()">ÁôªÂΩï</button> -->
                </div>

                <div class="search-container">
                    <input type="text" class="search-input" placeholder="ÊêúÁ¥¢ËßíËâ≤..." id="searchInput"
                        oninput="searchRoles()">
                    <button class="search-btn">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ËßíËâ≤Âç°ÁâáÂå∫Âüü -->
            <div class="content-area">
                <div class="roles-grid" id="rolesGrid">
                    <!-- Âä®ÊÄÅÂä†ËΩΩÁöÑËßíËâ≤Â∞ÜÊòæÁ§∫Âú®ËøôÈáå -->
                </div>
                <div id="rolesLoading" class="loading-indicator" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>Âä†ËΩΩÊõ¥Â§öËßíËâ≤...</div>
                </div>
            </div>

            <!-- ÂàõÂª∫ËßíËâ≤È°µÈù¢ -->
            <div class="create-role-page" id="createRolePage">
                <div class="create-role-header">
                    <h2 class="page-title">ÂàõÂª∫Êñ∞ËßíËâ≤</h2>
                    <button class="back-btn" onclick="backToHome()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
                        </svg>
                        ËøîÂõû
                    </button>
                </div>

                <div class="create-role-content">
                    <form class="role-form" id="roleForm">
                        <!-- ËßíËâ≤Â§¥ÂÉèÈÉ®ÂàÜ -->
                        <div class="role-avatar-section">
                            <div class="role-avatar-preview" id="roleAvatarPreview" onclick="uploadRoleAvatar()">
                                <div class="role-avatar-text">üé≠</div>
                                <div class="avatar-upload-hint">ÁÇπÂáª‰∏ä‰º†Â§¥ÂÉè</div>
                            </div>
                            <input type="file" id="roleAvatarInput" accept="image/*"
                                onchange="handleRoleAvatarUpload(event)">

                            <div class="role-default-avatars">
                                <div class="role-default-avatar selected" data-avatar="üé≠"
                                    onclick="chooseRoleDefaultAvatar('üé≠')">üé≠</div>
                                <div class="role-default-avatar" data-avatar="üëë"
                                    onclick="chooseRoleDefaultAvatar('üëë')">üëë
                                </div>
                                <div class="role-default-avatar" data-avatar="ü¶∏"
                                    onclick="chooseRoleDefaultAvatar('ü¶∏')">ü¶∏
                                </div>
                                <div class="role-default-avatar" data-avatar="üßô"
                                    onclick="chooseRoleDefaultAvatar('üßô')">üßô
                                </div>
                                <div class="role-default-avatar" data-avatar="üê±"
                                    onclick="chooseRoleDefaultAvatar('üê±')">üê±
                                </div>
                                <div class="role-default-avatar" data-avatar="ü§ñ"
                                    onclick="chooseRoleDefaultAvatar('ü§ñ')">ü§ñ
                                </div>
                                <div class="role-default-avatar" data-avatar="ü¶Ñ"
                                    onclick="chooseRoleDefaultAvatar('ü¶Ñ')">ü¶Ñ
                                </div>
                                <div class="role-default-avatar" data-avatar="üê∂"
                                    onclick="chooseRoleDefaultAvatar('üê∂')">üê∂
                                </div>
                                <div class="role-default-avatar" data-avatar="ü¶ä"
                                    onclick="chooseRoleDefaultAvatar('ü¶ä')">ü¶ä
                                </div>
                                <div class="role-default-avatar" data-avatar="üêº"
                                    onclick="chooseRoleDefaultAvatar('üêº')">üêº
                                </div>
                                <div class="role-default-avatar" data-avatar="üë®‚Äçüéì"
                                    onclick="chooseRoleDefaultAvatar('üë®‚Äçüéì')">
                                    üë®‚Äçüéì</div>
                                <div class="role-default-avatar" data-avatar="üë©‚Äçüè´"
                                    onclick="chooseRoleDefaultAvatar('üë©‚Äçüè´')">
                                    üë©‚Äçüè´</div>
                            </div>
                        </div>

                        <!-- ËßíËâ≤ÂêçÁß∞ -->
                        <div class="role-input-group">
                            <div class="role-input-row">
                                <div class="role-input-main">
                                    <label class="form-label" for="roleName">ËßíËâ≤ÂêçÁß∞</label>
                                    <input type="text" id="roleName" class="form-input" placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞"
                                        maxlength="50">
                                    <div class="error-message" id="roleNameError"></div>
                                </div>
                                <button type="button" class="auto-fill-btn" onclick="autoFillDescription()"
                                    id="autoFillBtn">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path
                                            d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM4.5 9a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM4 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 0 1h-4z" />
                                    </svg>
                                    Ëá™Âä®Â°´ÂÜô
                                </button>
                            </div>
                        </div>

                        <!-- ËßíËâ≤ÊèèËø∞ -->
                        <div class="role-input-group">
                            <label class="form-label" for="roleDescription">ËßíËâ≤ÊèèËø∞</label>
                            <textarea id="roleDescription" class="role-textarea" placeholder="ËØ∑ÊèèËø∞ËßíËâ≤ÁöÑËÉåÊôØ„ÄÅÊÄßÊ†º„ÄÅÂ§ñË≤åÁ≠âÂü∫Êú¨‰ø°ÊÅØ..."
                                maxlength="500"></textarea>
                            <div class="error-message" id="roleDescriptionError"></div>
                        </div>

                        <!-- ËßíËâ≤ÁâπÁÇπ -->
                        <div class="role-input-group">
                            <label class="form-label" for="roleTraits">ËßíËâ≤ÁâπÁÇπ</label>
                            <textarea id="roleTraits" class="role-textarea" placeholder="ËØ∑ÊèèËø∞ËßíËâ≤ÁöÑÁâπÁÇπ„ÄÅÊäÄËÉΩ„ÄÅÁà±Â•Ω„ÄÅËØ¥ËØùÈ£éÊ†ºÁ≠â..."
                                maxlength="500"></textarea>
                            <div class="error-message" id="roleTraitsError"></div>
                        </div>

                        <!-- ËßíËâ≤ÊÄßÂà´ -->
                        <div class="role-input-group">
                            <label class="form-label">ËßíËâ≤ÊÄßÂà´</label>
                            <div class="role-select-group">
                                <label class="role-radio-option">
                                    <input type="radio" name="roleGender" value="male" id="genderMale" checked>
                                    <span class="radio-label">Áî∑ÊÄß</span>
                                </label>
                                <label class="role-radio-option">
                                    <input type="radio" name="roleGender" value="female" id="genderFemale">
                                    <span class="radio-label">Â•≥ÊÄß</span>
                                </label>
                            </div>
                        </div>

                        <!-- ËØ≠Èü≥Á±ªÂûã -->
                        <div class="role-input-group">
                            <label class="form-label">ËØ≠Èü≥Á±ªÂûã</label>
                            <div class="role-select-group">
                                <label class="role-radio-option">
                                    <input type="radio" name="roleVoiceType" value="mature" id="voiceMature" checked>
                                    <span class="radio-label">ÊàêÁÜü</span>
                                </label>
                                <label class="role-radio-option">
                                    <input type="radio" name="roleVoiceType" value="young" id="voiceYoung">
                                    <span class="radio-label">Âπ¥ËΩª</span>
                                </label>
                            </div>
                        </div>

                        <!-- ÂàõÂª∫ÊåâÈíÆ -->
                        <button type="submit" class="create-submit-btn" id="createSubmitBtn">ÂàõÂª∫ËßíËâ≤</button>
                    </form>
                </div>
            </div>

            <!-- ËÅäÂ§©È°µÈù¢ -->
            <div class="create-role-page" id="chatPageNew">
                <div class="create-role-header">
                    <h2 class="page-title" id="currentRoleNameNew">ÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤ÂºÄÂßãÂØπËØù</h2>
                    <button class="back-btn" onclick="backToHome()">ËøîÂõû‰∏ªÈ°µ</button>
                </div>

                <div class="chat-content">
                    <div class="chat-messages" id="chatMessagesNew">
                        <div class="chat-empty" id="chatEmptyNew">
                            <div class="chat-empty-icon">üí¨</div>
                            <div class="chat-empty-text">ËøòÊ≤°ÊúâËÅäÂ§©ËÆ∞ÂΩï</div>
                            <div class="chat-empty-hint">ÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤ÂºÄÂßãÊúâË∂£ÁöÑÂØπËØùÂêßÔºÅ</div>
                        </div>
                        <div id="dialogsLoading" class="loading-indicator" style="display: none;">
                            <div class="loading-spinner"></div>
                            <div>Âä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ...</div>
                        </div>
                    </div>

                    <div class="chat-input">
                        <textarea class="message-input" id="messageInputNew" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1"
                            onkeydown="handleInputKeydown(event)" oninput="adjustTextareaHeight(this)"></textarea>
                        <button class="voice-btn" id="voiceBtnNew" onclick="startVoiceInput()" title="ËØ≠Èü≥ËæìÂÖ•">
                            üé§
                        </button>
                        <button class="send-btn" id="sendBtnNew" onclick="sendMessage()" title="ÂèëÈÄÅÊ∂àÊÅØ" disabled>
                            ‚û§
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂàõÂª∫ËßíËâ≤È°µÈù¢ -->

    <div class="modal-overlay" id="authModal">
        <div class="auth-modal">
            <button class="modal-close" onclick="closeAuthModal()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                </svg>
            </button>

            <div class="modal-header">
                <h2 class="modal-title">Ê¨¢ËøéÊù•Âà∞ËßíËâ≤ÊâÆÊºîAI</h2>
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchTab('login')" id="loginTab">ÁôªÂΩï</button>
                    <button class="auth-tab" onclick="switchTab('register')" id="registerTab">Ê≥®ÂÜå</button>
                </div>
            </div>

            <div class="modal-body">
                <!-- ÁôªÂΩïË°®Âçï -->
                <form id="loginForm" style="display: block;">
                    <div class="form-group">
                        <label class="form-label" for="loginUsername">Áî®Êà∑Âêç</label>
                        <input type="text" id="loginUsername" class="form-input" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç">
                        <div class="error-message" id="loginUsernameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="loginPassword">ÂØÜÁ†Å</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å">
                        <div class="error-message" id="loginPasswordError"></div>
                    </div>

                    <button type="submit" class="auth-submit" id="loginSubmit">ÁôªÂΩï</button>
                </form>

                <!-- Ê≥®ÂÜåË°®Âçï -->
                <form id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="registerUsername">Áî®Êà∑Âêç</label>
                        <input type="text" id="registerUsername" class="form-input" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç">
                        <div class="error-message" id="registerUsernameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="registerPassword">ÂØÜÁ†Å</label>
                        <input type="password" id="registerPassword" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å">
                        <div class="error-message" id="registerPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Á°ÆËÆ§ÂØÜÁ†Å</label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å">
                        <div class="error-message" id="confirmPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Áî®Êà∑Â§¥ÂÉè</label>
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="avatarPreview">
                                <div class="avatar-preview-text">üë§</div>
                            </div>
                            <div class="avatar-actions">
                                <button type="button" class="avatar-btn" onclick="selectDefaultAvatar()">ÈÄâÊã©ÈªòËÆ§Â§¥ÂÉè</button>
                                <button type="button" class="avatar-btn primary" onclick="uploadAvatar()">‰∏ä‰º†Â§¥ÂÉè</button>
                            </div>
                            <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarUpload(event)">
                        </div>

                        <div class="default-avatars" id="defaultAvatars" style="display: none;">
                            <div class="default-avatar" data-avatar="üë§" onclick="chooseDefaultAvatar('üë§')">üë§</div>
                            <div class="default-avatar" data-avatar="üé≠" onclick="chooseDefaultAvatar('üé≠')">üé≠</div>
                            <div class="default-avatar" data-avatar="ü¶Ñ" onclick="chooseDefaultAvatar('ü¶Ñ')">ü¶Ñ</div>
                            <div class="default-avatar" data-avatar="üê±" onclick="chooseDefaultAvatar('üê±')">üê±</div>
                            <div class="default-avatar" data-avatar="üê∂" onclick="chooseDefaultAvatar('üê∂')">üê∂</div>
                            <div class="default-avatar" data-avatar="ü¶ä" onclick="chooseDefaultAvatar('ü¶ä')">ü¶ä</div>
                            <div class="default-avatar" data-avatar="üêº" onclick="chooseDefaultAvatar('üêº')">üêº</div>
                            <div class="default-avatar" data-avatar="üêØ" onclick="chooseDefaultAvatar('üêØ')">üêØ</div>
                        </div>
                    </div>

                    <button type="submit" class="auth-submit" id="registerSubmit">Ê≥®ÂÜå</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ====== Socket.IO ËÅäÂ§©Á≥ªÁªü ======
        let socket = null;

        // ÂàùÂßãÂåñSocket.IOËøûÊé•
        function initSocket() {
            console.log('ÂàùÂßãÂåñSocket.IOËøûÊé•...');

            // Ê£ÄÊü•ÂΩìÂâçURLÂíåÂçèËÆÆ
            console.log('ÂΩìÂâçURL:', window.location.href);
            console.log('ÂçèËÆÆ:', window.location.protocol);

            // ÊòéÁ°ÆÊåáÂÆöSocket.IOÊúçÂä°Âô®Âú∞ÂùÄ
            socket = io({
                autoConnect: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5,
                timeout: 20000
            });

            console.log('Socket.IOÈÖçÁΩÆÂÆåÊàê');

            // ËøûÊé•ÊàêÂäü
            socket.on('connect', () => {
                console.log('SocketËøûÊé•ÊàêÂäü:', socket.id);
                console.log('SocketËøûÊé•Áä∂ÊÄÅ:', socket.connected);
                console.log('SocketÂØπË±°:', socket);

                // ÊµãËØïÂèëÈÄÅ‰∏Ä‰∏™ÁÆÄÂçïÊ∂àÊÅØ
                setTimeout(() => {
                    console.log('ÂèëÈÄÅÊµãËØïÊ∂àÊÅØ...');
                    socket.emit('test', { test: 'hello from frontend' });
                }, 1000);
            });

            // ËøûÊé•Êñ≠ÂºÄ
            socket.on('disconnect', (reason) => {
                console.log('SocketËøûÊé•Êñ≠ÂºÄ, ÂéüÂõ†:', reason);
            });

            // Êé•Êî∂Êù•Ëá™ÂêéÁ´ØÁöÑÊ∂àÊÅØ
            socket.on('message', (data) => {
                console.log('=== Êé•Êî∂Âà∞message‰∫ã‰ª∂ ===');
                console.log('Ê∂àÊÅØÊï∞ÊçÆ:', data);
                console.log('Êï∞ÊçÆÁ±ªÂûã:', typeof data);
                console.log('========================');
                handleReceivedMessage(data);
                hideTypingIndicator(); // Êî∂Âà∞ÂõûÂ§çÂêéÈöêËóè"Ê≠£Âú®ÂõûÂ§ç"Áä∂ÊÄÅ
            });

            // Êé•Êî∂ËØ≠Èü≥ËΩ¨ÊñáÂ≠óÊõ¥Êñ∞‰∫ã‰ª∂
            socket.on('update_message', (data) => {
                console.log('=== Êé•Êî∂Âà∞update_message‰∫ã‰ª∂ ===');
                console.log('Êõ¥Êñ∞Êï∞ÊçÆ:', data);
                console.log('==============================');
                handleMessageUpdate(data);
            });

            // ÁõëÂê¨Áî®Êà∑Ê∂àÊÅØ‰øùÂ≠òÁ°ÆËÆ§‰∫ã‰ª∂
            socket.on('user_message_saved', (data) => {
                console.log('=== Áî®Êà∑Ê∂àÊÅØÂ∑≤‰øùÂ≠ò ===');
                console.log('Êï∞ÊçÆ:', data);
                console.log('===================');
                // Êõ¥Êñ∞ÊúÄËøëÂØπËØùÂàóË°®ÊéíÂ∫è
                updateRecentChatsList();
            });

            // ËøûÊé•ÈîôËØØÂ§ÑÁêÜ
            socket.on('connect_error', (error) => {
                console.error('SocketËøûÊé•ÈîôËØØ:', error);
            });

            // ÁõëÂê¨ÊâÄÊúâ‰∫ã‰ª∂ÔºàË∞ÉËØïÁî®Ôºâ
            socket.onAny((event, ...args) => {
                console.log('=== Socket‰∫ã‰ª∂ ===');
                console.log('‰∫ã‰ª∂Âêç:', event);
                console.log('ÂèÇÊï∞:', args);
                console.log('Êó∂Èó¥:', new Date().toLocaleTimeString());
                console.log('================');
            });

            // È¢ùÂ§ñÁõëÂê¨‰∏Ä‰∫õÂèØËÉΩÁöÑ‰∫ã‰ª∂ÂêçÁß∞
            socket.on('msg', (data) => {
                console.log('Êî∂Âà∞msg‰∫ã‰ª∂:', data);
            });

            socket.on('response', (data) => {
                console.log('Êî∂Âà∞response‰∫ã‰ª∂:', data);
            });

            // ÂÆöÊúüÊ£ÄÊü•ËøûÊé•Áä∂ÊÄÅ
            setInterval(() => {
                if (socket) {
                    console.log('SocketÁä∂ÊÄÅÊ£ÄÊü• - ËøûÊé•:', socket.connected, 'ID:', socket.id);
                }
            }, 10000); // ÊØè10ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
        }

        // ÂèëÈÄÅÊ∂àÊÅØÂà∞ÂêéÁ´Ø
        function sendSocketMessage(userId, roleId, text) {
            if (!socket) {
                console.error('SocketÊú™ÂàùÂßãÂåñ');
                return;
            }

            if (!socket.connected) {
                console.error('SocketÊú™ËøûÊé•');
                return;
            }

            const messageData = {
                user_id: parseInt(userId),
                role_id: parseInt(roleId),
                timestamp: Date.now(),
                text: text
            };

            console.log('=== ÂèëÈÄÅÊ∂àÊÅØ ===');
            console.log('Socket ID:', socket.id);
            console.log('SocketËøûÊé•Áä∂ÊÄÅ:', socket.connected);
            console.log('Ê∂àÊÅØÊï∞ÊçÆ:', messageData);
            console.log('===============');

            socket.emit('message', messageData);
        }

        // ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØÂà∞ÂêéÁ´Ø
        function sendVoiceMessage(userId, roleId, voiceUrl, messageId) {
            if (!socket) {
                console.error('SocketÊú™ÂàùÂßãÂåñ');
                return;
            }

            if (!socket.connected) {
                console.error('SocketÊú™ËøûÊé•');
                return;
            }

            const messageData = {
                user_id: parseInt(userId),
                role_id: parseInt(roleId),
                timestamp: Date.now(),
                voice_url: voiceUrl,
                id: messageId
            };

            console.log('=== ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ ===');
            console.log('Socket ID:', socket.id);
            console.log('SocketËøûÊé•Áä∂ÊÄÅ:', socket.connected);
            console.log('ËØ≠Èü≥Ê∂àÊÅØÊï∞ÊçÆ:', messageData);
            console.log('=================');

            socket.emit('voice', messageData);
        }

        // Â§ÑÁêÜÊ∂àÊÅØÊõ¥Êñ∞ÔºàËØ≠Èü≥ËΩ¨ÊñáÂ≠óÔºâ
        function handleMessageUpdate(data) {
            console.log('Â§ÑÁêÜÊ∂àÊÅØÊõ¥Êñ∞:', data);

            if (!data.id || !data.text) {
                console.error('Ê∂àÊÅØÊõ¥Êñ∞Êï∞ÊçÆ‰∏çÂÆåÊï¥:', data);
                return;
            }

            // Êü•ÊâæÂØπÂ∫îIDÁöÑÊ∂àÊÅØÂπ∂Êõ¥Êñ∞ÊñáÊú¨
            const messageIndex = chatMessages.findIndex(msg => msg.id === data.id);
            if (messageIndex !== -1) {
                chatMessages[messageIndex].message = data.text;
                console.log('Ê∂àÊÅØÊñáÊú¨Â∑≤Êõ¥Êñ∞:', chatMessages[messageIndex]);
                renderChatMessages();
                showTypingIndicator(); // ÊòæÁ§∫"Ê≠£Âú®ÂõûÂ§ç"Áä∂ÊÄÅ
            } else {
                console.error('Êâæ‰∏çÂà∞ÂØπÂ∫îIDÁöÑÊ∂àÊÅØ:', data.id);
            }
        }

        // Â§ÑÁêÜÊé•Êî∂Âà∞ÁöÑÊ∂àÊÅØ
        function handleReceivedMessage(data) {
            console.log('Â§ÑÁêÜÊé•Êî∂Âà∞ÁöÑÊ∂àÊÅØ:', data);
            console.log('ÂΩìÂâçËÅäÂ§©ËßíËâ≤:', currentChatRole);

            if (!currentChatRole) {
                console.log('Ê≤°ÊúâÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåÂøΩÁï•Ê∂àÊÅØ');
                return;
            }

            const currentRoleId = parseInt(currentChatRole.id);
            const messageRoleId = parseInt(data.role_id);
            console.log('ËßíËâ≤IDÊØîËæÉ:', { currentRoleId, messageRoleId });

            if (currentRoleId !== messageRoleId) {
                console.log('Ê∂àÊÅØËßíËâ≤‰∏çÂåπÈÖçÔºåÂøΩÁï•', {
                    current: currentRoleId,
                    received: messageRoleId
                });
                return;
            }

            console.log('Ê∂àÊÅØÈ™åËØÅÈÄöËøáÔºåÊ∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï');

            // Ê∑ªÂä†ËßíËâ≤Ê∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
            const message = {
                id: ++messageIdCounter, // ‰∏∫Êé•Êî∂Âà∞ÁöÑÊ∂àÊÅØ‰πüÊ∑ªÂä†ID
                sender: 'role',
                message: data.text,
                timestamp: new Date(data.timestamp),
                voice: data.voice_url
            };

            chatMessages.push(message);
            console.log('Ê∂àÊÅØÂ∑≤Ê∑ªÂä†ÔºåÈáçÊñ∞Ê∏≤ÊüìÁïåÈù¢');
            renderChatMessages();

            // Êõ¥Êñ∞ÊúÄËøëÂØπËØùÂàóË°®ÊéíÂ∫è
            updateRecentChatsList();
        }

        // Áî®Êà∑Áä∂ÊÄÅÁÆ°ÁêÜ
        let isLoggedIn = false; // Êîπ‰∏∫Êú™ÁôªÂΩïÁä∂ÊÄÅ
        let currentUser = {
            id: "",
            name: "",
            avatar: ""
        };

        // ÂΩìÂâçÈÄâÊã©ÁöÑÂ§¥ÂÉè
        let selectedAvatar = 'üë§';
        let selectedAvatarType = 'default'; // 'default' Êàñ 'custom'
        let customAvatarFile = null;

        // SHA-256 ÂìàÂ∏åÂáΩÊï∞
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // ËßíËâ≤Êï∞ÊçÆ
        let roles = [];

        // ÊáíÂä†ËΩΩÁä∂ÊÄÅ
        const lazyLoadState = {
            roles: {
                offset: 0,
                limit: 15,
                loading: false,
                hasMore: true,
                total: 0
            },
            conversations: {
                offset: 0,
                limit: 15,
                loading: false,
                hasMore: true,
                total: 0
            },
            dialogs: {
                offset: 0,
                limit: 20,
                loading: false,
                hasMore: true,
                total: 0
            }
        };

        // Âä†ËΩΩËßíËâ≤ÂàóË°®ÔºàÊáíÂä†ËΩΩÁâàÊú¨Ôºâ
        async function loadRoles(append = false) {
            if (lazyLoadState.roles.loading) return;

            try {
                lazyLoadState.roles.loading = true;

                if (!append) {
                    // ÈáçÁΩÆÊï∞ÊçÆ
                    roles = [];
                    lazyLoadState.roles.offset = 0;
                    lazyLoadState.roles.hasMore = true;
                }

                if (!lazyLoadState.roles.hasMore) {
                    lazyLoadState.roles.loading = false;
                    return;
                }

                const url = `/api/role/list?offset=${lazyLoadState.roles.offset}&limit=${lazyLoadState.roles.limit}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('ËßíËâ≤ÂàóË°®Êï∞ÊçÆ:', data);

                    if (data && data.items && Array.isArray(data.items)) {
                        const newRoles = data.items.map(role => ({
                            id: String(role.role_id),
                            name: role.name,
                            description: role.description,
                            traits: role.traits,
                            image_url: role.image_url,
                            emoji: isEmoji(role.image_url) ? role.image_url : null
                        }));

                        if (append) {
                            roles.push(...newRoles);
                            // Ê∏≤ÊüìÊñ∞ËßíËâ≤ÔºàËøΩÂä†Ê®°ÂºèÔºâ
                            renderRoles(newRoles, true);
                        } else {
                            roles = newRoles;
                            // Ê∏≤ÊüìÊâÄÊúâËßíËâ≤ÔºàÊõøÊç¢Ê®°ÂºèÔºâ
                            renderRoles(roles, false);
                        }

                        lazyLoadState.roles.total = data.total;
                        lazyLoadState.roles.hasMore = data.has_more;
                        lazyLoadState.roles.offset += lazyLoadState.roles.limit;
                    } else {
                        console.warn('ËßíËâ≤ÂàóË°®Ê†ºÂºèÈîôËØØ:', data);
                        if (!append) {
                            roles = [];
                            lazyLoadState.roles.hasMore = false;
                        }
                    }
                } else {
                    console.warn('Ëé∑ÂèñËßíËâ≤ÂàóË°®Â§±Ë¥•:', response.status);
                    if (!append) {
                        roles = [];
                        lazyLoadState.roles.hasMore = false;
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩËßíËâ≤ÂàóË°®ÈîôËØØ:', error);
                if (!append) {
                    roles = [];
                    lazyLoadState.roles.hasMore = false;
                }
            } finally {
                lazyLoadState.roles.loading = false;
            }
        }

        // Ëé∑ÂèñËßíËâ≤ËØ¶ÊÉÖ
        async function getRoleDetails(roleId) {
            try {
                const response = await fetch(`/api/role/details?role_id=${parseInt(roleId)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return {
                        name: data.name,
                        description: data.description,
                        traits: data.traits,
                        image_url: data.image_url
                    };
                } else {
                    console.warn('Ëé∑ÂèñËßíËâ≤ËØ¶ÊÉÖÂ§±Ë¥•:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Ëé∑ÂèñËßíËâ≤ËØ¶ÊÉÖÈîôËØØ:', error);
                return null;
            }
        }

        // Ê£ÄÊü•ÊòØÂê¶‰∏∫emoji
        function isEmoji(str) {
            if (!str || str.length > 4) return false;
            const emojiRegex = /^[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F900}-\u{1F9FF}]|[\u{1F018}-\u{1F270}]$/u;
            return emojiRegex.test(str);
        }

        // Ëé∑ÂèñÈªòËÆ§ËßíËâ≤Êï∞ÊçÆÔºà‰Ωú‰∏∫fallbackÔºâ
        function getDefaultRoles() {
            return [
                {
                    id: 'princess',
                    name: 'ËâæËéâÂ®ÖÂÖ¨‰∏ª',
                    emoji: 'üëë',
                    image_url: 'üëë',
                    description: 'Êù•Ëá™È≠îÊ≥ïÁéãÂõΩÁöÑ‰ºòÈõÖÂÖ¨‰∏ªÔºåÂñÑËâØËÅ™ÊÖßÔºåÊã•ÊúâÂº∫Â§ßÁöÑÈ≠îÊ≥ïÂäõÈáè',
                    traits: '‰ºòÈõÖ„ÄÅÂñÑËâØ„ÄÅËÅ™ÊÖß„ÄÅÈ≠îÊ≥ï'
                },
                {
                    id: 'assistant',
                    name: 'Êô∫ËÉΩÂä©Êâã',
                    emoji: 'ü§ñ',
                    image_url: 'ü§ñ',
                    description: '‰∏ì‰∏öÁöÑAIÂä©ÊâãÔºåÂèØ‰ª•Â∏ÆÂä©ÊÇ®Ëß£ÂÜ≥ÂêÑÁßçÈóÆÈ¢òÂíåÊèê‰æõÂª∫ËÆÆ',
                    traits: '‰∏ì‰∏ö„ÄÅÈ´òÊïà„ÄÅÊúâÂ∏ÆÂä©„ÄÅÊô∫ËÉΩ'
                },
                {
                    id: 'catgirl',
                    name: 'Áå´Â®òÂ•≥‰ªÜ',
                    emoji: 'üê±',
                    image_url: 'üê±',
                    description: 'ÂèØÁà±ÁöÑÁå´Â®òÂ•≥‰ªÜÔºåÊ∏©Êüî‰ΩìË¥¥Ôºå‰ºöÁÖßÈ°æ‰∏ª‰∫∫ÁöÑÊó•Â∏∏ÁîüÊ¥ª',
                    traits: 'ÂèØÁà±„ÄÅÊ∏©Êüî„ÄÅ‰ΩìË¥¥„ÄÅÂø†ËØö'
                },
                {
                    id: 'detective',
                    name: 'Âêç‰æ¶Êé¢',
                    emoji: 'üïµÔ∏è',
                    image_url: 'üïµÔ∏è',
                    description: 'ÊïèÈîêÁöÑËßÇÂØüÂäõÂíåÈÄªËæëÊÄùÁª¥ÔºåÊìÖÈïøËß£ÂÜ≥ÂêÑÁßçÁ•ûÁßòÊ°à‰ª∂',
                    traits: 'ÊïèÈîê„ÄÅÈÄªËæë„ÄÅÊé®ÁêÜ„ÄÅÁ•ûÁßò'
                },
                {
                    id: 'wizard',
                    name: 'Âè§ËÄÅÊ≥ïÂ∏à',
                    emoji: 'üßô‚Äç‚ôÇÔ∏è',
                    image_url: 'üßô‚Äç‚ôÇÔ∏è',
                    description: 'Êã•ÊúâÂçÉÂπ¥Êô∫ÊÖßÁöÑÊ≥ïÂ∏àÔºåÊéåÊè°ÁùÄÂè§ËÄÅËÄåÂº∫Â§ßÁöÑÈ≠îÊ≥ïÁü•ËØÜ',
                    traits: 'Êô∫ÊÖß„ÄÅÁ•ûÁßò„ÄÅÂº∫Â§ß„ÄÅÂè§ËÄÅ'
                },
                {
                    id: 'teacher',
                    name: 'Ê∏©ÊüîËÄÅÂ∏à',
                    emoji: 'üë©‚Äçüè´',
                    image_url: 'üë©‚Äçüè´',
                    description: 'ËÄêÂøÉÊ∏©ÂíåÁöÑËÄÅÂ∏àÔºåÊìÖÈïøÊïôÂ≠¶ÂíåÂºïÂØºÂ≠¶ÁîüÊÄùËÄÉ',
                    traits: 'ËÄêÂøÉ„ÄÅÊ∏©Âíå„ÄÅÊïôÂ≠¶„ÄÅÂºïÂØº'
                }
            ];
        }

        // ÂàùÂßãÂåñÈ°µÈù¢
        async function initPage() {
            // ÂàùÂßãÂåñSocket.IOËøûÊé•
            initSocket();

            // Ê£ÄÊü•Êú¨Âú∞Â≠òÂÇ®ÁöÑtokenÔºåÂ∞ùËØïÊÅ¢Â§çÁôªÂΩïÁä∂ÊÄÅ
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const response = await fetch('/api/auth/verify', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        isLoggedIn = true;
                        currentUser = {
                            id: userData.user_id,
                            name: userData.username,
                            avatar: userData.avatar
                        };
                    } else {
                        // TokenÊó†ÊïàÔºåÊ∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®
                        localStorage.removeItem('authToken');
                        isLoggedIn = false;
                    }
                } catch (error) {
                    console.error('È™åËØÅtokenÂ§±Ë¥•:', error);
                    localStorage.removeItem('authToken');
                    isLoggedIn = false;
                }
            }

            updateUserInfo();
            await loadRoles();

            // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÂä†ËΩΩÊúÄËøëÂØπËØù
            if (isLoggedIn) {
                await loadRecentChats();
            }

            // ‰ªéURLÈîöÁÇπÊÅ¢Â§çÈ°µÈù¢Áä∂ÊÄÅ
            restoreFromUrlHash();
        }

        // Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÊòæÁ§∫
        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            if (isLoggedIn) {
                // Âà§Êñ≠Â§¥ÂÉèÊ†ºÂºèÔºöURL„ÄÅbase64ÊàñË°®ÊÉÖÁ¨¶Âè∑
                let avatarElement;
                if (currentUser.avatar.startsWith('http') || currentUser.avatar.startsWith('/')) {
                    // ÂõæÁâáURL
                    avatarElement = `<img src="${currentUser.avatar}" alt="Áî®Êà∑Â§¥ÂÉè" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else if (currentUser.avatar.startsWith('data:image')) {
                    // base64Ê†ºÂºè
                    avatarElement = `<img src="${currentUser.avatar}" alt="Áî®Êà∑Â§¥ÂÉè" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    // Ë°®ÊÉÖÁ¨¶Âè∑
                    avatarElement = currentUser.avatar;
                }

                userInfo.innerHTML = `
                    <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">${avatarElement}</div>
                    <span class="welcome-text">Ê¨¢ËøéÔºå${currentUser.name}</span>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="showUserProfile()">‰∏™‰∫∫ËµÑÊñô</div>
                        <div class="dropdown-item logout" onclick="logout()">ÈÄÄÂá∫ÁôªÂΩï</div>
                    </div>
                `;
            } else {
                userInfo.innerHTML = `
                    <button class="login-btn" onclick="login()">ÁôªÂΩï</button>
                `;
            }
        }

        // Áî®Êà∑‰∏ãÊãâËèúÂçïÊéßÂà∂
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // ÊòæÁ§∫Áî®Êà∑ËµÑÊñôÔºàÊöÇÊó∂Áî®alert‰ª£ÊõøÔºâ
        function showUserProfile() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');
            alert('‰∏™‰∫∫ËµÑÊñôÂäüËÉΩÂæÖÂÆûÁé∞');
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');

            // Ê∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®
            localStorage.removeItem('authToken');

            // ÈáçÁΩÆÁôªÂΩïÁä∂ÊÄÅ
            isLoggedIn = false;
            currentUser = { id: null, name: '', avatar: '' };

            // Êõ¥Êñ∞UI
            updateUserInfo();

            // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢Êï∞ÊçÆ
            loadRoles();
            document.getElementById('chatList').innerHTML = '<div class="no-chats">ÁôªÂΩïÂêéÊü•ÁúãÂØπËØùËÆ∞ÂΩï</div>';

            // Â¶ÇÊûúÂΩìÂâçÂú®ËÅäÂ§©È°µÈù¢ÔºåËøîÂõû‰∏ªÈ°µ
            if (currentPage === 'chat') {
                backToHome();
            }

            alert('Â∑≤ÈÄÄÂá∫ÁôªÂΩï');
        }

        // ÂàùÂßãÂåñÊªöÂä®ÁõëÂê¨Âô®
        function initScrollListeners() {
            // ËßíËâ≤ÂÜÖÂÆπÂå∫ÂüüÊªöÂä®ÁõëÂê¨ÔºàËßíËâ≤ÊáíÂä†ËΩΩÔºâ
            const contentArea = document.querySelector('.content-area');
            if (contentArea) {
                contentArea.addEventListener('scroll', function () {
                    if (getCurrentPage() === 'home') {
                        handleMainContentScroll();
                    }
                });
            }

            // ‰æßËæπÊ†èÂØπËØùÂàóË°®ÊªöÂä®ÁõëÂê¨
            const recentChats = document.querySelector('.recent-chats');
            if (recentChats) {
                recentChats.addEventListener('scroll', function () {
                    handleChatListScroll();
                });
            }

            // ËÅäÂ§©Ê∂àÊÅØÂå∫ÂüüÊªöÂä®ÁõëÂê¨
            const chatMessages = document.getElementById('chatMessagesNew');
            if (chatMessages) {
                chatMessages.addEventListener('scroll', function () {
                    if (getCurrentPage() === 'chat') {
                        handleChatMessagesScroll();
                    }
                });
            }
        }

        // Â§ÑÁêÜ‰∏ªÂÜÖÂÆπÂå∫ÂüüÊªöÂä®ÔºàËßíËâ≤ÊáíÂä†ËΩΩÔºâ
        function handleMainContentScroll() {
            const contentArea = document.querySelector('.content-area');
            const scrollTop = contentArea.scrollTop;
            const scrollHeight = contentArea.scrollHeight;
            const clientHeight = contentArea.clientHeight;

            console.log('ËßíËâ≤Âå∫ÂüüÊªöÂä®Ê£ÄÊµã:', {
                scrollTop, scrollHeight, clientHeight,
                distance: scrollHeight - scrollTop - clientHeight,
                loading: lazyLoadState.roles.loading,
                hasMore: lazyLoadState.roles.hasMore
            });

            // Ë∑ùÁ¶ªÂ∫ïÈÉ®100pxÊó∂ÂºÄÂßãÂä†ËΩΩÊõ¥Â§ö
            if (scrollHeight - scrollTop - clientHeight < 100 && !lazyLoadState.roles.loading && lazyLoadState.roles.hasMore) {
                console.log('Ëß¶ÂèëËßíËâ≤ÊáíÂä†ËΩΩ');
                showLoadingIndicator('roles');
                loadRoles(true).finally(() => {
                    hideLoadingIndicator('roles');
                });
            }
        }

        // Â§ÑÁêÜÂØπËØùÂàóË°®ÊªöÂä®
        function handleChatListScroll() {
            const recentChats = document.querySelector('.recent-chats');
            const scrollTop = recentChats.scrollTop;
            const scrollHeight = recentChats.scrollHeight;
            const clientHeight = recentChats.clientHeight;

            console.log('ÂØπËØùÂàóË°®ÊªöÂä®Ê£ÄÊµã:', {
                scrollTop, scrollHeight, clientHeight,
                distance: scrollHeight - scrollTop - clientHeight,
                loading: lazyLoadState.conversations.loading,
                hasMore: lazyLoadState.conversations.hasMore
            });

            if (scrollHeight - scrollTop - clientHeight < 50 && !lazyLoadState.conversations.loading && lazyLoadState.conversations.hasMore) {
                console.log('Ëß¶ÂèëÂØπËØùÊáíÂä†ËΩΩ');
                showLoadingIndicator('chats');
                loadRecentChats(true).then(() => {
                    hideLoadingIndicator('chats');
                });
            }
        }

        // Â§ÑÁêÜËÅäÂ§©Ê∂àÊÅØÊªöÂä®
        function handleChatMessagesScroll() {
            const chatMessagesElement = document.getElementById('chatMessagesNew');
            const scrollTop = chatMessagesElement.scrollTop;

            // Âú®È°∂ÈÉ®Êó∂Âä†ËΩΩÊõ¥Êó©ÁöÑÊ∂àÊÅØÔºàËÅäÂ§©ËÆ∞ÂΩïÊòØ‰ªé‰∏äÂæÄ‰∏ãÊªöÂä®ÁúãÂéÜÂè≤Ê∂àÊÅØÔºâ
            if (scrollTop < 100 && !lazyLoadState.dialogs.loading && lazyLoadState.dialogs.hasMore && currentChatRole) {
                showLoadingIndicator('dialogs');
                const currentScrollHeight = chatMessagesElement.scrollHeight;

                loadChatDialogs(currentChatRole.id, true).then((newMessages) => {
                    if (newMessages.length > 0) {
                        // Â∞ÜÊñ∞Ê∂àÊÅØÊ∑ªÂä†Âà∞Êï∞ÁªÑÂâçÈù¢ÔºàÂéÜÂè≤Ê∂àÊÅØÂú®ÂâçÔºâ
                        chatMessages = [...newMessages, ...chatMessages];
                        renderChatMessages();

                        // ‰øùÊåÅÊªöÂä®‰ΩçÁΩÆ
                        const newScrollHeight = chatMessagesElement.scrollHeight;
                        chatMessagesElement.scrollTop = newScrollHeight - currentScrollHeight;
                    }
                    hideLoadingIndicator('dialogs');
                });
            }
        }

        // ÊòæÁ§∫Âä†ËΩΩÊåáÁ§∫Âô®
        function showLoadingIndicator(type) {
            const indicators = {
                'roles': 'rolesLoading',
                'chats': 'chatsLoading',
                'dialogs': 'dialogsLoading'
            };

            const elementId = indicators[type];
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'flex';
                }
            }
        }

        // ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
        function hideLoadingIndicator(type) {
            const indicators = {
                'roles': 'rolesLoading',
                'chats': 'chatsLoading',
                'dialogs': 'dialogsLoading'
            };

            const elementId = indicators[type];
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'none';
                }
            }
        }

        // Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢
        function getCurrentPage() {
            const hash = window.location.hash;
            if (hash.startsWith('#chat/')) return 'chat';
            if (hash === '#create-role') return 'create-role';
            return 'home';
        }

        // Ê∏≤ÊüìËßíËâ≤Âç°Áâá
        function renderRoles(rolesToRender, append = false) {
            const rolesGrid = document.getElementById('rolesGrid');

            if (!append && rolesToRender.length === 0) {
                rolesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-text">ÊöÇÊó†ËßíËâ≤</div>
                    </div>
                `;
                return;
            }

            const roleCardsHtml = rolesToRender.map(role => {
                // Â§ÑÁêÜËßíËâ≤ÂõæÁâáÊòæÁ§∫
                let roleImageContent = '';
                if (role.image_url) {
                    if (isEmoji(role.image_url)) {
                        // Â¶ÇÊûúÊòØemojiÔºåÁõ¥Êé•ÊòæÁ§∫
                        roleImageContent = role.image_url;
                    } else {
                        // Â¶ÇÊûúÊòØURLÔºåÊòæÁ§∫ÂõæÁâá
                        roleImageContent = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                    }
                } else if (role.emoji) {
                    // ÂÖºÂÆπÊóßÁöÑemojiÂ≠óÊÆµ
                    roleImageContent = role.emoji;
                } else {
                    // ÈªòËÆ§Â§¥ÂÉè
                    roleImageContent = 'üé≠';
                }

                return `
                    <div class="role-card">
                        <div class="role-image" onclick="selectRole('${role.id}')">${roleImageContent}</div>
                        <div class="role-info" onclick="selectRole('${role.id}')">
                            <div class="role-name">${role.name}</div>
                            <div class="role-description">${role.description}</div>
                        </div>
                        <div class="role-actions">
                            <button class="chat-role-btn" onclick="event.stopPropagation(); startChatWithRole('${role.id}')" title="ÂºÄÂßãÂØπËØù">
                                üí¨
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            if (append) {
                rolesGrid.innerHTML += roleCardsHtml;
            } else {
                rolesGrid.innerHTML = roleCardsHtml;
            }
        }

        // ÊêúÁ¥¢ËßíËâ≤
        async function searchRoles() {
            const searchTerm = document.getElementById('searchInput').value.trim();

            if (!searchTerm) {
                // Â¶ÇÊûúÊêúÁ¥¢ËØç‰∏∫Á©∫ÔºåÊòæÁ§∫ÊâÄÊúâËßíËâ≤
                renderRoles(roles);
                return;
            }

            try {
                // Ë∞ÉÁî®ÂêéÁ´ØÊêúÁ¥¢Êé•Âè£
                const response = await fetch(`/api/role/search?q=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const searchResults = await response.json();
                    const formattedResults = searchResults.map(role => ({
                        id: String(role.role_id), // Á°Æ‰øùIDÊòØÂ≠óÁ¨¶‰∏≤
                        name: role.name,
                        description: role.description,
                        traits: role.traits,
                        image_url: role.image_url,
                        gender: role.gender,
                        voice_type: role.voice_type
                    }));
                    renderRoles(formattedResults);
                } else {
                    console.warn('ÊêúÁ¥¢ËØ∑Ê±ÇÂ§±Ë¥•:', response.status);
                    // ÈôçÁ∫ßÂà∞ÂÆ¢Êà∑Á´ØÊêúÁ¥¢
                    const filteredRoles = roles.filter(role =>
                        role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        role.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (role.traits && role.traits.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                    renderRoles(filteredRoles);
                }
            } catch (error) {
                console.error('ÊêúÁ¥¢ÈîôËØØ:', error);
                // ÈôçÁ∫ßÂà∞ÂÆ¢Êà∑Á´ØÊêúÁ¥¢
                const filteredRoles = roles.filter(role =>
                    role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    role.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (role.traits && role.traits.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                renderRoles(filteredRoles);
            }
        }

        // ÂΩìÂâçÈ°µÈù¢Áä∂ÊÄÅ
        let currentPage = 'home'; // 'home', 'create-role', 'chat'
        let currentChatRoleId = null; // ÂΩìÂâçËÅäÂ§©ÁöÑËßíËâ≤ID
        let pendingAction = null; // ÁôªÂΩïÂêéÈúÄË¶ÅÊâßË°åÁöÑÊìç‰Ωú

        // ËÆæÁΩÆÁôªÂΩïÂêéÈúÄË¶ÅÊâßË°åÁöÑÊìç‰Ωú
        function setPendingAction(action, params = null) {
            pendingAction = {
                action: action,
                params: params
            };
            console.log('ËÆæÁΩÆÁôªÂΩïÂêéÂæÖÊâßË°åÊìç‰Ωú:', pendingAction);
        }

        // ÊâßË°åÁôªÂΩïÂêéÁöÑÂæÖÂ§ÑÁêÜÊìç‰Ωú
        function executePendingAction() {
            if (!pendingAction) return;

            console.log('ÊâßË°åÁôªÂΩïÂêéÂæÖÂ§ÑÁêÜÊìç‰Ωú:', pendingAction);
            const { action, params } = pendingAction;

            // Ê∏ÖÈô§ÂæÖÂ§ÑÁêÜÊìç‰Ωú
            pendingAction = null;

            // ÊâßË°åÂØπÂ∫îÁöÑÊìç‰Ωú
            switch (action) {
                case 'createRole':
                    showCreateRolePage();
                    break;
                case 'selectRole':
                    if (params && params.roleId) {
                        startChatWithRole(params.roleId);
                    }
                    break;
                case 'openChat':
                    if (params && params.roleId) {
                        openChatDirect(params.roleId);
                    }
                    break;
                case 'startChatWithRole':
                    if (params && params.roleId) {
                        startChatWithRole(params.roleId);
                    }
                    break;
                default:
                    console.warn('Êú™Áü•ÁöÑÂæÖÂ§ÑÁêÜÊìç‰Ωú:', action);
                    break;
            }
        }

        // Êõ¥Êñ∞URLÈîöÁÇπ
        function updateUrlHash() {
            let hash = '';
            switch (currentPage) {
                case 'create-role':
                    hash = '#create-role';
                    break;
                case 'chat':
                    if (currentChatRoleId) {
                        hash = `#chat/${currentChatRoleId}`;
                    } else {
                        hash = '#chat';
                    }
                    break;
                case 'home':
                default:
                    hash = '#home';
                    break;
            }
            console.log('Êõ¥Êñ∞URLÈîöÁÇπ:', hash);
            window.location.hash = hash;
        }

        // ‰ªéURLÈîöÁÇπÊÅ¢Â§çÈ°µÈù¢Áä∂ÊÄÅ
        function restoreFromUrlHash() {
            const hash = window.location.hash.substring(1); // ÁßªÈô§ # Á¨¶Âè∑
            console.log('‰ªéURLÈîöÁÇπÊÅ¢Â§çÈ°µÈù¢Áä∂ÊÄÅ:', hash);

            if (!hash) {
                backToHome();
                return;
            }

            const parts = hash.split('/');
            const page = parts[0];

            switch (page) {
                case 'create-role':
                    showCreateRolePage();
                    break;
                case 'chat':
                    const roleId = parts[1];
                    if (roleId && isLoggedIn) {
                        // Âè™ÊúâÂú®ÁôªÂΩïÁä∂ÊÄÅ‰∏ãÊâçÊÅ¢Â§çËÅäÂ§©È°µÈù¢
                        showChatPage(roleId);
                    } else if (!isLoggedIn) {
                        // Êú™ÁôªÂΩïÊó∂Ë∑≥ËΩ¨Âà∞‰∏ªÈ°µ
                        backToHome();
                    } else {
                        // Ê≤°ÊúâËßíËâ≤IDÔºåÊòæÁ§∫ËÅäÂ§©È°µÈù¢‰ΩÜ‰∏çÂä†ËΩΩÁâπÂÆöÂØπËØù
                        showChatPage(null);
                    }
                    break;
                case 'home':
                default:
                    backToHome();
                    break;
            }
        }

        // ÁõëÂê¨ÊµèËßàÂô®ÂâçËøõÂêéÈÄÄ‰∫ã‰ª∂
        window.addEventListener('hashchange', function () {
            console.log('Ê£ÄÊµãÂà∞ÈîöÁÇπÂèòÂåñ');
            restoreFromUrlHash();
        });

        // ËßíËâ≤ÂàõÂª∫Áõ∏ÂÖ≥ÂèòÈáè
        let selectedRoleAvatar = 'üé≠';
        let selectedRoleAvatarType = 'default';
        let customRoleAvatarFile = null;

        // ÂàõÂª∫ËßíËâ≤
        function createRole() {
            if (!isLoggedIn) {
                setPendingAction('createRole');
                showAuthModal();
                return;
            }
            showCreateRolePage();
        }

        // ÊòæÁ§∫ÂàõÂª∫ËßíËâ≤È°µÈù¢
        function showCreateRolePage() {
            currentPage = 'create-role';
            currentChatRoleId = null;

            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('chatPageNew').classList.remove('active');
            document.getElementById('createRolePage').classList.add('active');

            // ÈáçÁΩÆË°®ÂçïÔºåÁ°Æ‰øùÊØèÊ¨°ÊâìÂºÄÈÉΩÊòØÂπ≤ÂáÄÁöÑ
            resetRoleForm();

            // Âè™Âú®ÂΩìÂâçURL‰∏çÊòØcreate-roleÊó∂ÊâçÊõ¥Êñ∞ÈîöÁÇπ
            if (window.location.hash !== '#create-role') {
                updateUrlHash();
            }
        }

        // ÈáçÁΩÆËßíËâ≤Ë°®Âçï
        function resetRoleForm() {
            document.getElementById('roleForm').reset();
            selectedRoleAvatar = 'üé≠';
            selectedRoleAvatarType = 'default';
            customRoleAvatarFile = null;
            updateRoleAvatarPreview();
            clearErrors(['roleNameError', 'roleDescriptionError', 'roleTraitsError']);

            // ÈáçÁΩÆÈªòËÆ§Â§¥ÂÉèÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.role-default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector('[data-avatar="üé≠"]').classList.add('selected');
        }

        // ËßíËâ≤Â§¥ÂÉèÁõ∏ÂÖ≥ÂáΩÊï∞
        function uploadRoleAvatar() {
            document.getElementById('roleAvatarInput').click();
        }

        function handleRoleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MBÈôêÂà∂
                    alert('Â§¥ÂÉèÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    return;
                }

                customRoleAvatarFile = file;
                selectedRoleAvatarType = 'custom';

                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedRoleAvatar = e.target.result;
                    updateRoleAvatarPreview();
                };
                reader.readAsDataURL(file);

                // Ê∏ÖÈô§ÈªòËÆ§Â§¥ÂÉèÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.role-default-avatar').forEach(el => {
                    el.classList.remove('selected');
                });
            }
        }

        function chooseRoleDefaultAvatar(avatar) {
            selectedRoleAvatar = avatar;
            selectedRoleAvatarType = 'default';
            customRoleAvatarFile = null;
            updateRoleAvatarPreview();

            // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.role-default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-avatar="${avatar}"]`).classList.add('selected');
        }

        function updateRoleAvatarPreview() {
            const preview = document.getElementById('roleAvatarPreview');
            if (selectedRoleAvatarType === 'custom') {
                preview.innerHTML = `
                    <img src="${selectedRoleAvatar}" alt="ËßíËâ≤Â§¥ÂÉè">
                    <div class="avatar-upload-hint">ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</div>
                `;
            } else {
                preview.innerHTML = `
                    <div class="role-avatar-text">${selectedRoleAvatar}</div>
                    <div class="avatar-upload-hint">ÁÇπÂáª‰∏ä‰º†Â§¥ÂÉè</div>
                `;
            }
        }

        // Ëá™Âä®Â°´ÂÜôÊèèËø∞ÂíåÁâπÁÇπ
        let currentAutoFillController = null; // Áî®‰∫éÂ≠òÂÇ®ÂΩìÂâçËØ∑Ê±ÇÁöÑcontroller

        async function autoFillDescription() {
            const roleName = document.getElementById('roleName').value.trim();

            if (!roleName) {
                showError('roleNameError', 'ËØ∑ÂÖàËæìÂÖ•ËßíËâ≤ÂêçÁß∞');
                return;
            }

            const btn = document.getElementById('autoFillBtn');
            const originalHTML = btn.innerHTML;

            // Â¶ÇÊûúÊúâÊ≠£Âú®ËøõË°åÁöÑËØ∑Ê±ÇÔºåÂÖàÂèñÊ∂àÂÆÉ
            if (currentAutoFillController) {
                currentAutoFillController.abort();
            }

            // ÂàõÂª∫Êñ∞ÁöÑAbortController
            currentAutoFillController = new AbortController();

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ‰∏∫ÁîüÊàê‰∏≠ÔºåÂπ∂Ê∑ªÂä†ÂèñÊ∂àÂäüËÉΩ
            btn.onclick = () => {
                if (currentAutoFillController) {
                    currentAutoFillController.abort();
                    currentAutoFillController = null;
                }
                resetAutoFillButton(btn, originalHTML);
            };
            btn.innerHTML = `
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <circle cx="8" cy="8" r="3" opacity="0.3"/>
                    <path d="M8 0 A8 8 0 0 1 8 16 A8 8 0 0 1 8 0" opacity="0.8">
                        <animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" values="0 8 8;360 8 8"/>
                    </path>
                </svg>
                ÁîüÊàê‰∏≠... (ÁÇπÂáªÂèñÊ∂à)
            `;

            try {
                // Ëé∑ÂèñÂΩìÂâçÂ∑≤Â°´ÂÜôÁöÑÂÜÖÂÆπÔºàÂèØÈÄâÔºâ
                const currentDescription = document.getElementById('roleDescription').value.trim();
                const currentTraits = document.getElementById('roleTraits').value.trim();
                const gender = document.querySelector('input[name="roleGender"]:checked').value;
                const voiceType = document.querySelector('input[name="roleVoiceType"]:checked').value;

                // Ë∞ÉÁî®AIÁîüÊàêÊé•Âè£Ôºå‰∏çËÆæÁΩÆË∂ÖÊó∂ÈôêÂà∂
                const response = await fetch('/api/role/auto-fill', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: roleName,
                        description: currentDescription || undefined,
                        traits: currentTraits || undefined,
                        gender: gender,
                        voice_type: voiceType
                    }),
                    signal: currentAutoFillController.signal
                });

                const data = await response.json();

                if (response.ok) {
                    // Áõ¥Êé•‰ΩøÁî®ËøîÂõûÁöÑdescriptionÂíåtraits
                    if (data.description) {
                        document.getElementById('roleDescription').value = data.description;
                    }
                    if (data.traits) {
                        document.getElementById('roleTraits').value = data.traits;
                    }
                    // Â§ÑÁêÜËøîÂõûÁöÑÊÄßÂà´ÂíåËØ≠Èü≥Á±ªÂûã
                    if (data.gender) {
                        const genderRadio = document.querySelector(`input[name="roleGender"][value="${data.gender}"]`);
                        if (genderRadio) {
                            genderRadio.checked = true;
                        }
                    }
                    if (data.voice_type) {
                        const voiceTypeRadio = document.querySelector(`input[name="roleVoiceType"][value="${data.voice_type}"]`);
                        if (voiceTypeRadio) {
                            voiceTypeRadio.checked = true;
                        }
                    }
                } else {
                    alert('Ëá™Âä®Â°´ÂÜôÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®Â°´ÂÜô');
                }
            } catch (error) {
                console.error('Ëá™Âä®Â°´ÂÜôÈîôËØØ:', error);
                if (error.name === 'AbortError') {
                    console.log('ËØ∑Ê±ÇÂ∑≤Ë¢´Áî®Êà∑ÂèñÊ∂à');
                } else {
                    alert('ÁΩëÁªúÈîôËØØÊàñAIÁîüÊàêË∂ÖÊó∂ÔºåËØ∑Á®çÂêéÈáçËØï');
                }
            } finally {
                resetAutoFillButton(btn, originalHTML);
                currentAutoFillController = null;
            }
        }

        // ÈáçÁΩÆËá™Âä®Â°´ÂÜôÊåâÈíÆÁä∂ÊÄÅ
        function resetAutoFillButton(btn, originalHTML) {
            btn.innerHTML = originalHTML;
            btn.onclick = autoFillDescription;
        }

        // ËßíËâ≤Ë°®ÂçïÈ™åËØÅ
        function validateRoleForm() {
            let isValid = true;
            const name = document.getElementById('roleName').value.trim();
            const description = document.getElementById('roleDescription').value.trim();
            const traits = document.getElementById('roleTraits').value.trim();

            clearErrors(['roleNameError', 'roleDescriptionError', 'roleTraitsError']);

            if (!name) {
                showError('roleNameError', 'ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞');
                isValid = false;
            } else if (name.length < 2) {
                showError('roleNameError', 'ËßíËâ≤ÂêçÁß∞Ëá≥Â∞ë2‰∏™Â≠óÁ¨¶');
                isValid = false;
            }

            if (!description) {
                showError('roleDescriptionError', 'ËØ∑ËæìÂÖ•ËßíËâ≤ÊèèËø∞');
                isValid = false;
            } else if (description.length < 20) {
                showError('roleDescriptionError', 'ËßíËâ≤ÊèèËø∞Ëá≥Â∞ë20‰∏™Â≠óÁ¨¶');
                isValid = false;
            }

            if (!traits) {
                showError('roleTraitsError', 'ËØ∑ËæìÂÖ•ËßíËâ≤ÁâπÁÇπ');
                isValid = false;
            } else if (traits.length < 20) {
                showError('roleTraitsError', 'ËßíËâ≤ÁâπÁÇπËá≥Â∞ë20‰∏™Â≠óÁ¨¶');
                isValid = false;
            }

            return isValid;
        }

        // Â§ÑÁêÜËßíËâ≤ÂàõÂª∫
        async function handleRoleCreate(event) {
            event.preventDefault();

            if (!validateRoleForm()) return;

            const name = document.getElementById('roleName').value.trim();
            const description = document.getElementById('roleDescription').value.trim();
            const traits = document.getElementById('roleTraits').value.trim();
            const gender = document.querySelector('input[name="roleGender"]:checked').value;
            const voiceType = document.querySelector('input[name="roleVoiceType"]:checked').value;

            const submitBtn = document.getElementById('createSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ÂàõÂª∫‰∏≠...';

            try {
                let avatar = null;

                // Â§ÑÁêÜÂ§¥ÂÉè
                if (selectedRoleAvatarType === 'default' && selectedRoleAvatar) {
                    avatar = selectedRoleAvatar;
                } else if (selectedRoleAvatarType === 'custom' && customRoleAvatarFile) {
                    // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÂ§¥ÂÉèÔºåÂÖà‰∏ä‰º†Â§¥ÂÉèËé∑Âèñfile_url
                    const uploadResponse = await fetch('/api/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'X-File-Name': customRoleAvatarFile.name,
                            'Content-Type': customRoleAvatarFile.type || 'application/octet-stream'
                        },
                        body: customRoleAvatarFile
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        avatar = uploadData.file_url;
                    } else {
                        throw new Error('Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•');
                    }
                }

                // ÂàõÂª∫ËßíËâ≤ËØ∑Ê±Ç
                const response = await fetch('/api/role/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        traits: traits,
                        avatar: avatar,
                        gender: gender,
                        voice_type: voiceType
                    })
                });

                const data = await response.json();

                if (response.ok && data.role_id) {
                    // ÂàõÂª∫ÊàêÂäü
                    alert('ËßíËâ≤ÂàõÂª∫ÊàêÂäüÔºÅ');

                    // Ê∏ÖÁ©∫Ë°®Âçï
                    resetRoleForm();

                    // ÈáçÊñ∞Âä†ËΩΩËßíËâ≤ÂàóË°®‰ª•Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ
                    await loadRoles();

                    // ËøîÂõû‰∏ªÈ°µÂπ∂Âà∑Êñ∞ËßíËâ≤ÂàóË°®
                    backToHome();
                    renderRoles(roles);
                } else {
                    // ÂàõÂª∫Â§±Ë¥•
                    alert(data.message || 'ËßíËâ≤ÂàõÂª∫Â§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂàõÂª∫ËßíËâ≤ÈîôËØØ:', error);
                alert('ÂàõÂª∫Â§±Ë¥•Ôºö' + (error.message || 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ÂàõÂª∫ËßíËâ≤';
            }
        }

        // ÈÄâÊã©ËßíËâ≤
        async function selectRole(roleId) {
            if (!isLoggedIn) {
                setPendingAction('selectRole', { roleId: roleId });
                showAuthModal();
                return;
            }

            // Áõ¥Êé•ÂØºËà™Âà∞ËÅäÂ§©È°µÈù¢
            startChatWithRole(roleId);
        }

        // ÊâìÂºÄÂØπËØù
        async function openChat(roleId) {
            if (!isLoggedIn) {
                setPendingAction('openChat', { roleId: roleId });
                showAuthModal();
                return;
            }

            try {
                // Á°Æ‰øùËßíËâ≤ÂàóË°®Â∑≤Âä†ËΩΩ
                if (roles.length === 0) {
                    await loadRoles();
                }

                showChatPage(roleId);
            } catch (error) {
                console.error('ÊâìÂºÄÂØπËØùÂ§±Ë¥•:', error);
                alert('ÊâìÂºÄÂØπËØùÂ§±Ë¥•: ' + error.message);
            }
        }

        // Áõ¥Êé•ÊâìÂºÄËÅäÂ§©ÔºàÁî®‰∫éÁôªÂΩïÂêéËá™Âä®ÊâßË°åÔºâ
        async function openChatDirect(roleId) {
            try {
                // Á°Æ‰øùËßíËâ≤ÂàóË°®Â∑≤Âä†ËΩΩ
                if (roles.length === 0) {
                    await loadRoles();
                }

                showChatPage(roleId);
            } catch (error) {
                console.error('ÊâìÂºÄÂØπËØùÂ§±Ë¥•:', error);
                alert('ÊâìÂºÄÂØπËØùÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÁôªÂΩïÂäüËÉΩ
        function login() {
            showAuthModal();
        }

        // ÊòæÁ§∫ËÆ§ËØÅÊ®°ÊÄÅÊ°Ü
        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // ÂÖ≥Èó≠ËÆ§ËØÅÊ®°ÊÄÅÊ°Ü
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            resetForms();
        }

        // ÂàáÊç¢ÁôªÂΩï/Ê≥®ÂÜåÊ†áÁ≠æ
        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
            resetForms();
        }

        // ÈáçÁΩÆË°®Âçï
        function resetForms() {
            // ÈáçÁΩÆÁôªÂΩïË°®Âçï
            document.getElementById('loginForm').reset();
            clearErrors(['loginUsernameError', 'loginPasswordError']);

            // ÈáçÁΩÆÊ≥®ÂÜåË°®Âçï
            document.getElementById('registerForm').reset();
            clearErrors(['registerUsernameError', 'registerPasswordError', 'confirmPasswordError']);

            // ÈáçÁΩÆÂ§¥ÂÉèÈÄâÊã©
            selectedAvatar = 'üë§';
            selectedAvatarType = 'default';
            customAvatarFile = null;
            updateAvatarPreview();
            hideDefaultAvatars();
        }

        // Ê∏ÖÈô§ÈîôËØØ‰ø°ÊÅØ
        function clearErrors(errorIds) {
            errorIds.forEach(id => {
                const errorElement = document.getElementById(id);
                errorElement.textContent = '';
                errorElement.classList.remove('show');

                const input = errorElement.previousElementSibling;
                if (input && (input.classList.contains('form-input') || input.classList.contains('role-textarea'))) {
                    input.classList.remove('error');
                }
            });
        }

        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            const input = errorElement.previousElementSibling;

            errorElement.textContent = message;
            errorElement.classList.add('show');
            if (input) {
                input.classList.add('error');
            }
        }

        // Â§¥ÂÉèÁõ∏ÂÖ≥ÂáΩÊï∞
        function selectDefaultAvatar() {
            const defaultAvatars = document.getElementById('defaultAvatars');
            defaultAvatars.style.display = defaultAvatars.style.display === 'none' ? 'grid' : 'none';
        }

        function hideDefaultAvatars() {
            document.getElementById('defaultAvatars').style.display = 'none';
        }

        function chooseDefaultAvatar(avatar) {
            selectedAvatar = avatar;
            selectedAvatarType = 'default';
            customAvatarFile = null;
            updateAvatarPreview();
            hideDefaultAvatars();

            // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-avatar="${avatar}"]`).classList.add('selected');
        }

        function uploadAvatar() {
            document.getElementById('avatarInput').click();
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            console.log('ÈÄâÊã©ÁöÑÊñá‰ª∂:', file);
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MBÈôêÂà∂
                    alert('Â§¥ÂÉèÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    return;
                }

                customAvatarFile = file;
                selectedAvatarType = 'custom';

                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedAvatar = e.target.result;
                    updateAvatarPreview();
                };
                reader.readAsDataURL(file);
                hideDefaultAvatars();
            }
        }

        function updateAvatarPreview() {
            const preview = document.getElementById('avatarPreview');
            if (selectedAvatarType === 'custom') {
                preview.innerHTML = `<img src="${selectedAvatar}" alt="Â§¥ÂÉèÈ¢ÑËßà">`;
            } else {
                // ‰∏∫ÈªòËÆ§Â§¥ÂÉèÊòæÁ§∫Ë°®ÊÉÖÁ¨¶Âè∑Ôºå‰ΩÜÂ≠òÂÇ®Êó∂‰ºöËΩ¨Êç¢‰∏∫base64
                preview.innerHTML = `<div class="avatar-preview-text">${selectedAvatar}</div>`;
            }
        }

        // Ë°®ÂçïÈ™åËØÅ
        function validateLogin() {
            let isValid = true;
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            clearErrors(['loginUsernameError', 'loginPasswordError']);

            if (!username) {
                showError('loginUsernameError', 'ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
                isValid = false;
            }

            if (!password) {
                showError('loginPasswordError', 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å');
                isValid = false;
            }

            return isValid;
        }

        function validateRegister() {
            let isValid = true;
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            clearErrors(['registerUsernameError', 'registerPasswordError', 'confirmPasswordError']);

            if (!username) {
                showError('registerUsernameError', 'ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
                isValid = false;
            } else if (username.length < 3) {
                showError('registerUsernameError', 'Áî®Êà∑ÂêçËá≥Â∞ë3‰∏™Â≠óÁ¨¶');
                isValid = false;
            } else if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(username)) {
                showError('registerUsernameError', 'Áî®Êà∑ÂêçÂè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÂíå‰∏≠Êñá');
                isValid = false;
            }

            if (!password) {
                showError('registerPasswordError', 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å');
                isValid = false;
            } else if (password.length < 6) {
                showError('registerPasswordError', 'ÂØÜÁ†ÅËá≥Â∞ë6‰∏™Â≠óÁ¨¶');
                isValid = false;
            }

            if (!confirmPassword) {
                showError('confirmPasswordError', 'ËØ∑Á°ÆËÆ§ÂØÜÁ†Å');
                isValid = false;
            } else if (password !== confirmPassword) {
                showError('confirmPasswordError', '‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
                isValid = false;
            }

            return isValid;
        }

        // Â§ÑÁêÜÁôªÂΩï
        async function handleLogin(event) {
            event.preventDefault();

            if (!validateLogin()) return;

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            const submitBtn = document.getElementById('loginSubmit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ÁôªÂΩï‰∏≠...';

            try {
                const hashedPassword = await hashPassword(password);

                // ÂèëÈÄÅÁôªÂΩïËØ∑Ê±Ç
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: hashedPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // ÁôªÂΩïÊàêÂäü
                    localStorage.setItem('authToken', data.token);
                    isLoggedIn = true;
                    currentUser = {
                        id: data.user_id,
                        name: data.username,
                        avatar: data.avatar
                    };

                    updateUserInfo();
                    closeAuthModal();

                    // ÈáçÊñ∞Âä†ËΩΩËßíËâ≤ÂàóË°®
                    await loadRoles();
                    renderRoles(roles);

                    // Âä†ËΩΩÊúÄËøëÂØπËØù
                    await loadRecentChats();

                    // ÊâßË°åÁôªÂΩïÂêéÁöÑÂæÖÂ§ÑÁêÜÊìç‰Ωú
                    executePendingAction();

                    alert('ÁôªÂΩïÊàêÂäüÔºÅ');
                } else {
                    // ÁôªÂΩïÂ§±Ë¥•
                    showError('loginPasswordError', 'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å');
                }
            } catch (error) {
                console.error('ÁôªÂΩïÈîôËØØ:', error);
                showError('loginPasswordError', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ÁôªÂΩï';
            }
        }

        // Â§ÑÁêÜÊ≥®ÂÜå
        async function handleRegister(event) {
            event.preventDefault();

            if (!validateRegister()) return;

            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            const submitBtn = document.getElementById('registerSubmit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ê≥®ÂÜå‰∏≠...';

            try {
                const hashedPassword = await hashPassword(password);

                // Á¨¨‰∏ÄÊ≠•Ôºö‰∏ä‰º†Â§¥ÂÉè
                let avatarUrl;
                if (selectedAvatarType === 'custom' && customAvatarFile) {
                    // ‰∏ä‰º†Ëá™ÂÆö‰πâÂ§¥ÂÉè
                    submitBtn.textContent = '‰∏ä‰º†Â§¥ÂÉè‰∏≠...';
                    avatarUrl = await uploadCustomAvatar(customAvatarFile);
                } else {
                    // ‰∏ä‰º†ÈªòËÆ§Â§¥ÂÉèÔºàËΩ¨Êç¢‰∏∫blobÂêé‰∏ä‰º†Ôºâ
                    submitBtn.textContent = 'ÁîüÊàêÂ§¥ÂÉè‰∏≠...';
                    avatarUrl = await uploadDefaultAvatar(selectedAvatar);
                }

                // Á¨¨‰∫åÊ≠•ÔºöÊ≥®ÂÜåÁî®Êà∑
                submitBtn.textContent = 'ÂàõÂª∫Ë¥¶Êà∑‰∏≠...';
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: hashedPassword,
                        avatar: avatarUrl
                    })
                });

                if (response.ok) {
                    // Ê≥®ÂÜåÊàêÂäü
                    alert('Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑ÁôªÂΩï');

                    // ÂàáÊç¢Âà∞ÁôªÂΩïÊ†áÁ≠æ
                    switchTab('login');

                    // È¢ÑÂ°´Áî®Êà∑Âêç
                    document.getElementById('loginUsername').value = username;
                } else {
                    // Ê≥®ÂÜåÂ§±Ë¥•
                    const errorData = await response.json().catch(() => ({}));
                    showError('registerPasswordError', errorData.message || 'Ê≥®ÂÜåÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
                }
            } catch (error) {
                console.error('Ê≥®ÂÜåÈîôËØØ:', error);
                showError('registerPasswordError', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Ê≥®ÂÜå';
            }
        }

        // ‰∏ä‰º†Ëá™ÂÆö‰πâÂ§¥ÂÉè
        async function uploadCustomAvatar(file) {
            const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                    'X-File-Name': file.name,
                    'Content-Type': file.type || 'application/octet-stream'
                },
                body: file
            });

            if (!response.ok) {
                throw new Error('Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•');
            }

            const data = await response.json();
            return data.file_url;
        }

        // ‰∏ä‰º†ÈªòËÆ§Â§¥ÂÉè
        async function uploadDefaultAvatar(emoji) {
            // ÁîüÊàêÈªòËÆ§Â§¥ÂÉèÁöÑBlob
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 200;

            // ËÆæÁΩÆËÉåÊôØ
            const gradient = ctx.createLinearGradient(0, 0, 200, 200);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 200, 200);

            // ÁªòÂà∂emoji
            ctx.font = '120px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(emoji, 100, 100);

            // ËΩ¨Êç¢‰∏∫Blob
            return new Promise((resolve, reject) => {
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        reject(new Error('Â§¥ÂÉèÁîüÊàêÂ§±Ë¥•'));
                        return;
                    }

                    try {
                        const fileName = `default_avatar_${emoji.codePointAt(0)}.png`;
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            headers: {
                                'X-File-Name': fileName,
                                'Content-Type': 'image/png'
                            },
                            body: blob
                        });

                        if (!response.ok) {
                            throw new Error('ÈªòËÆ§Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•');
                        }

                        const data = await response.json();
                        resolve(data.file_url);
                    } catch (error) {
                        reject(error);
                    }
                }, 'image/png');
            });
        }        // ÁªëÂÆöË°®ÂçïÊèê‰∫§‰∫ã‰ª∂
        document.addEventListener('DOMContentLoaded', function () {
            initPage();

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('roleForm').addEventListener('submit', handleRoleCreate);

            // ÂàùÂßãÂåñÊáíÂä†ËΩΩÊªöÂä®ÁõëÂê¨
            initScrollListeners();

            // Ê∂àÊÅØËæìÂÖ•Ê°Ü‰∫ã‰ª∂ÁõëÂê¨
            const messageInput = document.getElementById('messageInputNew');
            if (messageInput) {
                messageInput.addEventListener('input', function () {
                    adjustTextareaHeight(this);
                });
                messageInput.addEventListener('keydown', handleInputKeydown);
            }

            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
            document.getElementById('authModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeAuthModal();
                }
            });

            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Áî®Êà∑‰∏ãÊãâËèúÂçï
            document.addEventListener('click', function (event) {
                const userInfo = document.getElementById('userInfo');
                const dropdown = document.getElementById('userDropdown');

                if (userInfo && dropdown && !userInfo.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // ESCÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    if (document.getElementById('authModal').classList.contains('active')) {
                        closeAuthModal();
                    }
                }
            });
        });

        // ====== ÂØπËØùÁõ∏ÂÖ≥API ======

        // ÂàõÂª∫‰∏éËßíËâ≤ÁöÑÂØπËØù
        async function createConversation(roleId) {
            try {
                const response = await fetch('/api/conversation/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        user_id: parseInt(currentUser.id),
                        role_id: parseInt(roleId)
                    })
                });

                if (!response.ok) {
                    throw new Error('ÂàõÂª∫ÂØπËØùÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂàõÂª∫ÂØπËØùÈîôËØØ:', error);
                // ‰∏çÊäõÂá∫ÈîôËØØÔºåÂõ†‰∏∫ÂØπËØùÂèØËÉΩÂ∑≤ÁªèÂ≠òÂú®
            }
        }

        // Ëé∑ÂèñÁî®Êà∑ÁöÑÂØπËØùÂàóË°®ÔºàÊáíÂä†ËΩΩÁâàÊú¨Ôºâ
        async function loadRecentChats(append = false) {
            if (lazyLoadState.conversations.loading || !currentUser?.id) return;

            try {
                lazyLoadState.conversations.loading = true;

                if (!append) {
                    lazyLoadState.conversations.offset = 0;
                    lazyLoadState.conversations.hasMore = true;
                }

                if (!lazyLoadState.conversations.hasMore) {
                    lazyLoadState.conversations.loading = false;
                    return;
                }

                const url = `/api/conversation/list?user_id=${parseInt(currentUser.id)}&offset=${lazyLoadState.conversations.offset}&limit=${lazyLoadState.conversations.limit}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Ëé∑ÂèñÂØπËØùÂàóË°®Â§±Ë¥•');
                }

                const data = await response.json();
                console.log('ÂØπËØùÂàóË°®Êï∞ÊçÆ:', data);

                if (data && data.items && Array.isArray(data.items)) {
                    lazyLoadState.conversations.total = data.total;
                    lazyLoadState.conversations.hasMore = data.has_more;
                    lazyLoadState.conversations.offset += lazyLoadState.conversations.limit;

                    await renderRecentChats(data.items, append);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊúÄËøëÂØπËØùÈîôËØØ:', error);
            } finally {
                lazyLoadState.conversations.loading = false;
            }
        }

        // Ê∏≤ÊüìÊúÄËøëÂØπËØùÂàóË°®
        async function renderRecentChats(roleIds, append = false) {
            const chatListElement = document.getElementById('chatList');

            if (!append && roleIds.length === 0) {
                chatListElement.innerHTML = '<div class="no-chats">ËøòÊ≤°ÊúâÂØπËØùËÆ∞ÂΩï</div>';
                return;
            }

            // Á°Æ‰øùËßíËâ≤ÂàóË°®Â∑≤Âä†ËΩΩ
            if (roles.length === 0) {
                await loadRoles();
            }

            const chatItems = roleIds.map(roleId => {
                const role = roles.find(r => String(r.id) === String(roleId));
                if (!role) return '';

                // Âà§Êñ≠Â§¥ÂÉèÊ†ºÂºè
                let avatarHtml;
                if (role.image_url && (role.image_url.startsWith('http') || role.image_url.startsWith('/'))) {
                    avatarHtml = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else if (role.image_url && role.image_url.startsWith('data:image')) {
                    avatarHtml = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    avatarHtml = role.image_url || 'üé≠';
                }

                return `
                    <div class="chat-item" onclick="openChat('${role.id}')">
                        <div class="chat-avatar">${avatarHtml}</div>
                        <div class="chat-info">
                            <div class="chat-name">${role.name}</div>
                            <div class="chat-preview">ÁÇπÂáªÂºÄÂßãÂØπËØù</div>
                        </div>
                    </div>
                `;
            }).filter(item => item).join('');

            if (append) {
                chatListElement.innerHTML += chatItems;
            } else {
                chatListElement.innerHTML = chatItems;
            }
        }

        // Êõ¥Êñ∞ÊúÄËøëÂØπËØùÂàóË°®ÊéíÂ∫èÔºàÂú®ÊúâÊñ∞Ê∂àÊÅØÊó∂Ë∞ÉÁî®Ôºâ
        async function updateRecentChatsList() {
            if (!isLoggedIn || !currentUser?.id) {
                return;
            }

            console.log('Êõ¥Êñ∞ÊúÄËøëÂØπËØùÂàóË°®ÊéíÂ∫è');

            // ÈáçÊñ∞Âä†ËΩΩÊúÄËøëÂØπËØùÂàóË°®ÔºàËøô‰ºöÊåâÁÖßÊúÄÊñ∞ÁöÑlast_dialog_timestampÊéíÂ∫èÔºâ
            try {
                await loadRecentChats(false); // falseË°®Á§∫‰∏çÊòØËøΩÂä†ÔºåËÄåÊòØÈáçÊñ∞Âä†ËΩΩ
            } catch (error) {
                console.error('Êõ¥Êñ∞ÊúÄËøëÂØπËØùÂàóË°®Â§±Ë¥•:', error);
            }
        }

        // Ëé∑ÂèñÂØπËØùÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºàÊáíÂä†ËΩΩÁâàÊú¨Ôºâ
        async function loadChatDialogs(roleId, append = false) {
            if (lazyLoadState.dialogs.loading || !currentUser?.id) return [];

            try {
                lazyLoadState.dialogs.loading = true;

                if (!append) {
                    lazyLoadState.dialogs.offset = 0;
                    lazyLoadState.dialogs.hasMore = true;
                }

                if (!lazyLoadState.dialogs.hasMore) {
                    lazyLoadState.dialogs.loading = false;
                    return [];
                }

                const url = `/api/conversation/dialogs?user_id=${parseInt(currentUser.id)}&role_id=${parseInt(roleId)}&offset=${lazyLoadState.dialogs.offset}&limit=${lazyLoadState.dialogs.limit}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Ëé∑ÂèñËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•');
                }

                const data = await response.json();
                console.log('ËÅäÂ§©ËÆ∞ÂΩïÊï∞ÊçÆ:', data);

                if (data && data.items && Array.isArray(data.items)) {
                    lazyLoadState.dialogs.total = data.total;
                    lazyLoadState.dialogs.hasMore = data.has_more;
                    lazyLoadState.dialogs.offset += lazyLoadState.dialogs.limit;

                    const dialogs = data.items.map(dialog => ({
                        id: ++messageIdCounter,
                        sender: dialog.is_user ? 'user' : 'role',
                        message: dialog.text,
                        timestamp: dialog.timestamp,
                        voice: dialog.voice
                    }));

                    return dialogs;
                } else {
                    return [];
                }
            } catch (error) {
                console.error('Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩïÈîôËØØ:', error);
                return [];
            } finally {
                lazyLoadState.dialogs.loading = false;
            }
        }

        // ====== ËÅäÂ§©Áõ∏ÂÖ≥ÂäüËÉΩ ======

        let currentChatRole = null; // ÂΩìÂâçËÅäÂ§©ÁöÑËßíËâ≤
        let chatMessages = []; // ËÅäÂ§©Ê∂àÊÅØÂéÜÂè≤

        // ÊòæÁ§∫ËÅäÂ§©È°µÈù¢
        function showChatPage(roleId) {
            console.log('ÊòæÁ§∫ËÅäÂ§©È°µÈù¢ÔºåÊé•Êî∂Âà∞ÁöÑËßíËâ≤ID:', roleId);
            currentPage = 'chat';
            currentChatRoleId = roleId;

            // ÈöêËóèÂÖ∂‰ªñÈ°µÈù¢
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('createRolePage').classList.remove('active');

            // ÊòæÁ§∫Êñ∞ÁöÑËÅäÂ§©È°µÈù¢
            document.getElementById('chatPageNew').classList.add('active');

            if (roleId) {
                // Â¶ÇÊûúÊåáÂÆö‰∫ÜËßíËâ≤IDÔºåÂä†ËΩΩËØ•ËßíËâ≤ÁöÑËÅäÂ§©
                console.log('Ë∞ÉÁî®loadChatRoleÔºåËßíËâ≤ID:', roleId);
                loadChatRole(roleId);
            } else {
                // Âê¶ÂàôÊòæÁ§∫ÈªòËÆ§Áä∂ÊÄÅ
                resetChatPage();
            }

            // Âè™Âú®ÂΩìÂâçURL‰∏çÂåπÈÖçÊó∂ÊâçÊõ¥Êñ∞ÈîöÁÇπ
            const expectedHash = roleId ? `#chat/${roleId}` : '#chat';
            if (window.location.hash !== expectedHash) {
                updateUrlHash();
            }
        }

        // Âä†ËΩΩËÅäÂ§©ËßíËâ≤
        async function loadChatRole(roleId) {
            try {
                console.log('Â∞ùËØïÂä†ËΩΩËßíËâ≤ID:', roleId, 'Á±ªÂûã:', typeof roleId);
                console.log('ÂΩìÂâçËßíËâ≤ÂàóË°®:', roles);

                // Á°Æ‰øùIDÈÉΩÊòØÂ≠óÁ¨¶‰∏≤Ê†ºÂºèËøõË°åÊØîËæÉ
                const targetId = String(roleId);
                const role = roles.find(r => String(r.id) === targetId);

                if (!role) {
                    console.error('ËßíËâ≤‰∏çÂ≠òÂú®ÔºåÁõÆÊ†áID:', targetId);
                    console.error('ÂèØÁî®ËßíËâ≤IDÂàóË°®:', roles.map(r => String(r.id)));
                    throw new Error(`ËßíËâ≤‰∏çÂ≠òÂú®ÔºåID: ${targetId}`);
                }

                currentChatRole = role;
                console.log('ÊàêÂäüÂä†ËΩΩËßíËâ≤:', role);

                // Êõ¥Êñ∞ËÅäÂ§©Â§¥ÈÉ® - Âè™ÊòæÁ§∫ËßíËâ≤Âêç
                const nameElement = document.getElementById('currentRoleNameNew');
                nameElement.textContent = role.name;

                // ÈáçÁΩÆËÅäÂ§©ËÆ∞ÂΩïÁä∂ÊÄÅ
                chatMessages = [];
                lazyLoadState.dialogs.offset = 0;
                lazyLoadState.dialogs.hasMore = true;

                // Âä†ËΩΩÂéÜÂè≤ËÅäÂ§©ËÆ∞ÂΩïÔºàÁ¨¨‰∏ÄÈ°µÔºâ
                const firstPageMessages = await loadChatDialogs(roleId, false);
                chatMessages = firstPageMessages;
                renderChatMessages();

                // ÂêØÁî®ËæìÂÖ•Ê°Ü
                enableChatInput();

                // Socket.IO‰ºöËá™Âä®Â∞ÜÁî®Êà∑Âä†ÂÖ•socket.idÊàøÈó¥ÔºåÊó†ÈúÄÊâãÂä®Âä†ÂÖ•

            } catch (error) {
                console.error('Âä†ËΩΩËßíËâ≤Â§±Ë¥•:', error);
                alert('Âä†ËΩΩËßíËâ≤Â§±Ë¥•: ' + error.message);
            }
        }

        // ÈáçÁΩÆËÅäÂ§©È°µÈù¢
        function resetChatPage() {
            currentChatRole = null;
            chatMessages = [];

            // ÈáçÁΩÆÂ§¥ÈÉ® - Âè™Êõ¥Êñ∞ËßíËâ≤Âêç
            document.getElementById('currentRoleNameNew').textContent = 'ÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤ÂºÄÂßãÂØπËØù';

            // ÊòæÁ§∫Á©∫Áä∂ÊÄÅ
            showChatEmpty();

            // Á¶ÅÁî®ËæìÂÖ•Ê°Ü
            disableChatInput();
        }

        // Ê∏≤ÊüìËÅäÂ§©Ê∂àÊÅØ
        function renderChatMessages() {
            const container = document.getElementById('chatMessagesNew');
            const emptyDiv = document.getElementById('chatEmptyNew');

            if (chatMessages.length === 0) {
                showChatEmpty();
                return;
            }

            // ÈöêËóèÁ©∫Áä∂ÊÄÅ
            emptyDiv.style.display = 'none';

            container.innerHTML = chatMessages.map(message => {
                const isUser = message.sender === 'user';
                let avatarHtml;

                if (isUser) {
                    // Áî®Êà∑Â§¥ÂÉèÂ§ÑÁêÜ
                    if (currentUser.avatar) {
                        if (isEmoji(currentUser.avatar)) {
                            avatarHtml = currentUser.avatar;
                        } else {
                            avatarHtml = `<img src="${currentUser.avatar}" alt="${currentUser.name}">`;
                        }
                    } else {
                        avatarHtml = 'üë§';
                    }
                } else {
                    // ËßíËâ≤Â§¥ÂÉèÂ§ÑÁêÜ
                    if (currentChatRole.image_url) {
                        if (isEmoji(currentChatRole.image_url)) {
                            avatarHtml = currentChatRole.image_url;
                        } else {
                            avatarHtml = `<img src="${currentChatRole.image_url}" alt="${currentChatRole.name}">`;
                        }
                    } else {
                        avatarHtml = 'üé≠';
                    }
                }

                // Ê∂àÊÅØÂÜÖÂÆπÔºåÊîØÊåÅÊñáÊú¨ÂíåËØ≠Èü≥
                let messageContent = `<div class="message-text">${message.message}</div>`;
                let hasVoiceClass = '';
                if (message.voice) {
                    hasVoiceClass = ' has-voice'; // Ê∑ªÂä†CSSÁ±ªÊ†áËØÜ
                    messageContent += `
                        <div class="message-voice">
                            <audio controls preload="metadata">
                                <source src="${message.voice}" type="audio/mpeg">
                                ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ„ÄÇ
                            </audio>
                        </div>
                    `;
                }

                return `
                    <div class="message ${isUser ? 'user' : 'role'}${hasVoiceClass}">
                        <div class="message-avatar ${isUser ? 'user' : 'role'}">${avatarHtml}</div>
                        <div class="message-content${hasVoiceClass}">${messageContent}</div>
                    </div>
                `;
            }).join('') + '<div id="chatEmptyNew" style="display: none;"></div>';

            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            container.scrollTop = container.scrollHeight;
        }

        // ÊòæÁ§∫ËÅäÂ§©Á©∫Áä∂ÊÄÅ
        function showChatEmpty() {
            const container = document.getElementById('chatMessagesNew');

            // Ê∏ÖÁ©∫Ê∂àÊÅØ
            container.innerHTML = `
                <div class="chat-empty" id="chatEmptyNew">
                    <div class="chat-empty-icon">üí¨</div>
                    <div class="chat-empty-text">${currentChatRole ? 'ÂºÄÂßã‰∏é ' + currentChatRole.name + ' ÂØπËØùÂêßÔºÅ' : 'ËøòÊ≤°ÊúâËÅäÂ§©ËÆ∞ÂΩï'}</div>
                    <div class="chat-empty-hint">${currentChatRole ? 'ËæìÂÖ•Ê∂àÊÅØÂºÄÂßãÊúâË∂£ÁöÑËßíËâ≤ÊâÆÊºî' : 'ÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤ÂºÄÂßãÊúâË∂£ÁöÑÂØπËØùÂêßÔºÅ'}</div>
                </div>
            `;
        }

        // ÂêØÁî®ËÅäÂ§©ËæìÂÖ•
        function enableChatInput() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            input.disabled = false;
            input.placeholder = 'ËæìÂÖ•Ê∂àÊÅØ...';
            checkSendButton();
        }

        // Á¶ÅÁî®ËÅäÂ§©ËæìÂÖ•
        function disableChatInput() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            input.disabled = true;
            input.placeholder = 'ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤...';
            sendBtn.disabled = true;
        }

        // ÂèëÈÄÅÊ∂àÊÅØ
        async function sendMessage() {
            if (!currentChatRole) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            if (!isLoggedIn) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }

            const input = document.getElementById('messageInputNew');
            const message = input.value.trim();

            if (!message) {
                return;
            }

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÁïåÈù¢
            chatMessages.push({
                id: ++messageIdCounter, // ‰∏∫ÊñáÊú¨Ê∂àÊÅØ‰πüÊ∑ªÂä†ID
                sender: 'user',
                message: message,
                timestamp: new Date()
            });

            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            input.value = '';
            input.style.height = 'auto';
            checkSendButton();

            // ÈáçÊñ∞Ê∏≤ÊüìÊ∂àÊÅØ
            renderChatMessages();

            // ÈÄöËøáSocket.IOÂèëÈÄÅÊ∂àÊÅØÂà∞ÂêéÁ´Ø
            sendSocketMessage(currentUser.id, currentChatRole.id, message);
        }

        // Â§ÑÁêÜËæìÂÖ•Ê°ÜÈîÆÁõò‰∫ã‰ª∂
        function handleInputKeydown(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    // Shift+Enter Êç¢Ë°å
                    return;
                } else {
                    // Enter ÂèëÈÄÅÊ∂àÊÅØ
                    event.preventDefault();
                    sendMessage();
                }
            }
        }

        // Ëá™Âä®Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

            // Ê£ÄÊü•ÂèëÈÄÅÊåâÈíÆÁä∂ÊÄÅ
            checkSendButton();
        }

        // Ê£ÄÊü•ÂèëÈÄÅÊåâÈíÆÁä∂ÊÄÅ
        function checkSendButton() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            if (currentChatRole && input.value.trim()) {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = true;
            }
        }

        // ËØ≠Èü≥ÂΩïÂà∂Áõ∏ÂÖ≥ÂèòÈáè
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let messageIdCounter = 0; // Ê∂àÊÅØIDËÆ°Êï∞Âô®

        // ËØ≠Èü≥ËæìÂÖ•ÂäüËÉΩ
        async function startVoiceInput() {
            if (!currentChatRole) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            if (!isLoggedIn) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }

            if (isRecording) {
                // Â¶ÇÊûúÊ≠£Âú®ÂΩïÈü≥ÔºåÂÅúÊ≠¢ÂΩïÈü≥
                stopRecording();
            } else {
                // ÂºÄÂßãÂΩïÈü≥
                await startRecording();
            }
        }

        // ÂºÄÂßãÂΩïÂà∂ËØ≠Èü≥
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅÁöÑÈü≥È¢ëÊ†ºÂºè
                let mimeType = 'audio/mp4'; // ÈªòËÆ§‰ΩøÁî®mp4Ê†ºÂºèÔºåÊØîwebmÊõ¥Êé•Ëøëmp3
                if (MediaRecorder.isTypeSupported('audio/mpeg')) {
                    mimeType = 'audio/mpeg';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                } else if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus'; // Â§áÁî®ÊñπÊ°à
                }

                console.log('‰ΩøÁî®Èü≥È¢ëÊ†ºÂºè:', mimeType);

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });

                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await uploadAndSendVoice(audioBlob);

                    // ÂÅúÊ≠¢ÊâÄÊúâÈü≥È¢ëÊµÅ
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                updateVoiceButton();

                console.log('ÂºÄÂßãÂΩïÈü≥...');
            } catch (error) {
                console.error('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é:', error);
                alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
            }
        }

        // ÂÅúÊ≠¢ÂΩïÂà∂ËØ≠Èü≥
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                updateVoiceButton();
                console.log('ÂÅúÊ≠¢ÂΩïÈü≥...');
            }
        }

        // Êõ¥Êñ∞ËØ≠Èü≥ÊåâÈíÆÁä∂ÊÄÅ
        function updateVoiceButton() {
            const voiceBtn = document.getElementById('voiceBtnNew');
            if (isRecording) {
                voiceBtn.innerHTML = '‚èπÔ∏è';
                voiceBtn.title = 'ÁÇπÂáªÂÅúÊ≠¢ÂΩïÈü≥';
                voiceBtn.style.backgroundColor = '#ff4757';
            } else {
                voiceBtn.innerHTML = 'üé§';
                voiceBtn.title = 'ÁÇπÂáªÂΩïÂà∂ËØ≠Èü≥';
                voiceBtn.style.backgroundColor = '';
            }
        }

        // ‰∏ä‰º†ËØ≠Èü≥Âπ∂ÂèëÈÄÅÊ∂àÊÅØ
        async function uploadAndSendVoice(audioBlob) {
            try {
                console.log('ÂºÄÂßã‰∏ä‰º†ËØ≠Èü≥Êñá‰ª∂ÔºåÂ§ßÂ∞è:', audioBlob.size);

                // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂíåËßíËâ≤
                if (!currentUser || !currentChatRole) {
                    throw new Error('Áî®Êà∑Êú™ÁôªÂΩïÊàñÊú™ÈÄâÊã©ËßíËâ≤');
                }

                // ‰∏ä‰º†ËØ≠Èü≥Êñá‰ª∂
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'X-File-Name': `voice_${Date.now()}.mp3`,
                        'Content-Type': 'audio/mpeg'
                    },
                    body: audioBlob
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ËØ≠Èü≥‰∏ä‰º†Â§±Ë¥•: ${response.status} ${errorText}`);
                }

                const uploadData = await response.json();
                console.log('‰∏ä‰º†ÂìçÂ∫î:', uploadData);

                if (!uploadData.file_url) {
                    throw new Error('‰∏ä‰º†ÂìçÂ∫î‰∏≠Áº∫Â∞ëfile_url');
                }

                const voiceUrl = uploadData.file_url;
                console.log('ËØ≠Èü≥‰∏ä‰º†ÊàêÂäüÔºåURL:', voiceUrl);

                // ÁîüÊàêÊ∂àÊÅØID
                messageIdCounter++;
                const messageId = messageIdCounter;

                // Ê∑ªÂä†Áî®Êà∑ËØ≠Èü≥Ê∂àÊÅØÂà∞ÁïåÈù¢ÔºàÊòæÁ§∫‰∏∫"[Ê≠£Âú®Â∞ÜËØ≠Èü≥ËΩ¨Êç¢ÊàêÊñáÂ≠ó]"Ôºâ
                chatMessages.push({
                    id: messageId,
                    sender: 'user',
                    message: '[Ê≠£Âú®Â∞ÜËØ≠Èü≥ËΩ¨Êç¢ÊàêÊñáÂ≠ó]',
                    timestamp: new Date(),
                    voice: voiceUrl
                });

                // ÈáçÊñ∞Ê∏≤ÊüìÊ∂àÊÅØ
                renderChatMessages();

                // ÈÄöËøáSocketÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØÂà∞ÂêéÁ´Ø
                sendVoiceMessage(currentUser.id, currentChatRole.id, voiceUrl, messageId);

            } catch (error) {
                console.error('ËØ≠Èü≥Â§ÑÁêÜÂ§±Ë¥•:', error);
                alert('ËØ≠Èü≥ÂèëÈÄÅÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÊòæÁ§∫"Ê≠£Âú®ÂõûÂ§ç"Áä∂ÊÄÅ
        function showTypingIndicator() {
            const roleNameElement = document.getElementById('currentRoleNameNew');
            if (roleNameElement && currentChatRole) {
                roleNameElement.innerHTML = `${currentChatRole.name} <span style="font-size: 12px; color: #7f8c8d; font-weight: normal;">Ê≠£Âú®ÂõûÂ§ç</span>`;
            }
        }

        // ÈöêËóè"Ê≠£Âú®ÂõûÂ§ç"Áä∂ÊÄÅ
        function hideTypingIndicator() {
            const roleNameElement = document.getElementById('currentRoleNameNew');
            if (roleNameElement && currentChatRole) {
                roleNameElement.textContent = currentChatRole.name;
            }
        }

        // ‰øÆÊîπÁé∞ÊúâÁöÑËßíËâ≤Âç°ÁâáÁÇπÂáª‰∫ã‰ª∂ÔºåÊ∑ªÂä†ËÅäÂ§©ÂäüËÉΩ
        async function startChatWithRole(roleId) {
            console.log('ÂºÄÂßãËÅäÂ§©ÔºåËßíËâ≤ID:', roleId);
            console.log('ÂΩìÂâçÁôªÂΩïÁä∂ÊÄÅ:', isLoggedIn);

            if (!isLoggedIn) {
                setPendingAction('startChatWithRole', { roleId: roleId });
                showAuthModal();
                return;
            }

            try {
                // ÂàõÂª∫‰∏éËßíËâ≤ÁöÑÂØπËØùÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
                await createConversation(roleId);

                // Á°Æ‰øùËßíËâ≤ÂàóË°®Â∑≤Âä†ËΩΩ
                if (roles.length === 0) {
                    console.log('ËßíËâ≤ÂàóË°®‰∏∫Á©∫ÔºåÈáçÊñ∞Âä†ËΩΩ...');
                    await loadRoles();
                }

                console.log('ÂΩìÂâçrolesÊï∞ÁªÑ:', roles);
                showChatPage(roleId);

                // Êõ¥Êñ∞ÊúÄËøëÂØπËØùÂàóË°®
                await loadRecentChats();
            } catch (error) {
                console.error('ÂêØÂä®ÂØπËØùÂ§±Ë¥•:', error);
                alert('ÂêØÂä®ÂØπËØùÂ§±Ë¥•: ' + error.message);
            }
        }

        // ‰øÆÊîπbackToHomeÂáΩÊï∞ÔºåÊîØÊåÅ‰ªéËÅäÂ§©È°µÈù¢ËøîÂõû
        function backToHome() {
            currentPage = 'home';
            currentChatRoleId = null;

            document.querySelector('.header').style.display = 'flex';
            document.querySelector('.content-area').style.display = 'block';
            document.getElementById('createRolePage').classList.remove('active');
            document.getElementById('chatPageNew').classList.remove('active');

            // Âè™Âú®ÂΩìÂâçURL‰∏çÊòØhomeÊó∂ÊâçÊõ¥Êñ∞ÈîöÁÇπÔºåÈÅøÂÖçÊó†ÈôêÂæ™ÁéØ
            if (window.location.hash !== '#home') {
                updateUrlHash();
            }
        }
    </script>
</body>

</html>