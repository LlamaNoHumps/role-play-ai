<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色扮演AI</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            width: 100%;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            overflow: hidden;
        }

        /* 左侧边栏 */
        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow: hidden;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #34495e;
            flex-shrink: 0;
        }

        .create-role-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .create-role-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .recent-chats {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .recent-chats h3 {
            margin-bottom: 15px;
            color: #bdc3c7;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-item:hover {
            background: #34495e;
        }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            font-size: 12px;
            color: #95a5a6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .chat-delete {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #95a5a6;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .chat-delete:hover {
            background: #e74c3c;
            color: white;
        }

        .no-chats {
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
            padding: 20px;
            font-style: italic;
        }

        /* 右侧主要内容区 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* 顶部栏 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            z-index: 1000;
        }

        /* Loading 指示器样式 */
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e1e8ed;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .user-dropdown {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item.logout {
            color: #e74c3c;
        }

        .dropdown-item.logout:hover {
            background-color: #ffeaea;
        }

        .welcome-text {
            font-size: 16px;
            color: #2c3e50;
        }

        .login-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
        }

        .search-container {
            position: relative;
        }

        .search-input {
            padding: 10px 16px;
            padding-right: 40px;
            border: 2px solid #ecf0f1;
            border-radius: 20px;
            outline: none;
            width: 300px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #7f8c8d;
        }

        /* 角色卡片区域 */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .role-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .role-image {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            font-weight: bold;
        }

        .role-info {
            padding: 15px;
            flex: 1;
            /* 确保内容垂直排列：名字在上，描述在下 */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .role-actions {
            padding: 0 15px 15px 15px;
            display: flex;
            justify-content: flex-end;
        }

        .chat-role-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .chat-role-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .delete-role-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 4px;
            background: #95a5a6;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            transition: all 0.2s ease;
        }

        .delete-role-btn:hover {
            background: #e74c3c;
            transform: scale(1.05);
        }

        .role-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            /* 确保文字水平显示 */
            writing-mode: horizontal-tb;
            text-orientation: mixed;
            /* 限制显示1行，多余文字显示省略号 */
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.2em * 1);
            /* 1行的高度 */
        }

        .role-description {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.4;
            /* 限制显示5行，多余文字显示省略号 */
            display: -webkit-box;
            -webkit-line-clamp: 5;
            line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.4em * 5);
            /* 5行的高度 */
        }

        /* 空状态 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #7f8c8d;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 18px;
            margin-bottom: 20px;
        }

        /* 登录/注册模态框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .auth-modal {
            background: white;
            border-radius: 16px;
            width: 420px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 30px 30px 20px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .auth-tabs {
            display: flex;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #7f8c8d;
        }

        .auth-tab.active {
            background: white;
            color: #2c3e50;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-body {
            padding: 20px 30px 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .form-input.error {
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview-text {
            font-size: 24px;
            color: #7f8c8d;
        }

        .avatar-actions {
            display: flex;
            gap: 10px;
        }

        .avatar-btn {
            padding: 8px 16px;
            border: 1px solid #3498db;
            border-radius: 6px;
            background: white;
            color: #3498db;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .avatar-btn:hover {
            background: #3498db;
            color: white;
        }

        .avatar-btn.primary {
            background: #3498db;
            color: white;
        }

        .avatar-btn.primary:hover {
            background: #2980b9;
        }

        .default-avatars {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .default-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 20px;
        }

        .default-avatar:hover {
            transform: scale(1.1);
            border-color: #3498db;
        }

        .default-avatar.selected {
            border-color: #3498db;
            transform: scale(1.1);
        }

        #avatarInput {
            display: none;
        }

        .auth-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }

        .auth-submit:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }

        /* 创建角色页面 */
        .create-role-page {
            display: none;
        }

        .create-role-page.active {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
        }

        .create-role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .back-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .back-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(127, 140, 141, 0.3);
        }

        .create-role-content {
            flex: 1;
            padding: 30px;
            display: flex;
            justify-content: center;
            background: white;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .role-form {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            position: relative;
            z-index: 1;
            overflow: visible;
            box-sizing: border-box;
        }

        .role-form * {
            box-sizing: border-box;
        }

        .role-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border-radius: 12px;
            z-index: -1;
        }

        .role-avatar-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .role-avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #ecf0f1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .role-avatar-preview:hover {
            border-color: #3498db;
            transform: scale(1.05);
        }

        .role-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .role-avatar-text {
            font-size: 48px;
            color: #7f8c8d;
        }

        .avatar-upload-hint {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .role-avatar-preview:hover .avatar-upload-hint {
            opacity: 1;
        }

        .role-default-avatars {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 15px;
            justify-items: center;
        }

        .role-default-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 24px;
        }

        .role-default-avatar:hover {
            transform: scale(1.1);
            border-color: #3498db;
        }

        .role-default-avatar.selected {
            border-color: #3498db;
            border-width: 3px;
            transform: scale(1.1);
        }

        .role-input-group {
            margin-bottom: 25px;
        }

        .role-input-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .role-input-main {
            flex: 1;
        }

        .auto-fill-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .auto-fill-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .auto-fill-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .auto-fill-container {
            display: flex;
            align-items: center;
            margin-top: 12px;
            margin-bottom: 16px;
        }

        .auto-fill-progress {
            font-size: 12px;
            color: #7f8c8d;
            margin-left: 12px;
            display: flex;
            align-items: center;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }
        }

        .role-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }

        .role-textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .role-textarea.error {
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }

        .create-submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            margin-bottom: 30px;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
            position: relative;
            z-index: 10;
        }

        .create-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.5);
            background: linear-gradient(135deg, #229954, #27ae60);
        }

        .create-submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(189, 195, 199, 0.3);
        }

        .role-select-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .role-radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .role-radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            accent-color: #3498db;
            cursor: pointer;
        }

        .radio-label {
            font-size: 14px;
            color: #2c3e50;
            cursor: pointer;
        }

        .role-radio-option:hover .radio-label {
            color: #3498db;
        }

        #roleAvatarInput {
            display: none;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            .sidebar {
                width: 100%;
                height: 200px;
                flex-shrink: 0;
            }

            .main-content {
                flex: 1;
                overflow: hidden;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .search-input {
                width: 100%;
            }

            .roles-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .content-area {
                padding: 20px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .auth-modal {
                width: 95vw;
            }

            .modal-body {
                padding: 15px 20px 25px;
            }

            .modal-header {
                padding: 20px 20px 15px;
            }
        }

        /* 新聊天页面样式 */
        .chat-content {
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* 明确设置高度 */
        }

        .chat-messages {
            padding: 20px 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            height: calc(100vh - 160px);
            /* 调整：头部约80px + 输入框约80px */
            max-height: calc(100vh - 160px);
            /* 确保不会超过设定高度 */
            flex-shrink: 0;
            /* 防止被压缩 */
            box-sizing: border-box;
            /* 包含padding在内 */
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 70%;
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message.role {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .message-avatar.role {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .message.role .message-content {
            background: white;
            color: #2c3e50;
        }

        .message-voice {
            margin-top: 8px;
            min-width: 250px;
            /* 确保最小宽度足够显示完整控件 */
        }

        .message-voice audio {
            width: 100%;
            min-width: 250px;
            /* 音频控件最小宽度 */
            max-width: 400px;
            /* 增加最大宽度 */
            height: 36px;
            /* 增加高度，让控件更容易操作 */
            border-radius: 8px;
            /* 添加圆角 */
            background-color: linear-gradient(135deg, #3498db, #2980b9);
            /* 添加背景色 */
            outline: none;
            /* 去除焦点轮廓 */
        }

        .message-voice audio::-webkit-media-controls-panel {
            background-color: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 8px;
        }

        /* 用户发送的语音消息右对齐 */
        .message.user .message-voice {
            text-align: right;
        }

        /* 包含语音的消息容器需要更大的最小宽度 */
        .message-content:has(.message-voice),
        .message-content.has-voice {
            min-width: 280px !important;
        }

        /* 确保所有消息容器都有基本的最小宽度 */
        .message-content {
            min-width: 180px;
        }

        /* 语音消息的文本样式 */
        .message-text {
            margin-bottom: 4px;
        }

        .message-text:last-child {
            margin-bottom: 0;
        }

        /* 时间戳样式 */
        .message-timestamp {
            font-size: 0.75em;
            color: #95a5a6;
            margin-top: 4px;
            text-align: right;
            font-weight: 400;
        }

        .message.user .message-timestamp {
            color: rgba(255, 255, 255, 0.7);
        }

        .message.role .message-timestamp {
            color: #95a5a6;
            text-align: left;
        }

        /* 语音消息标识文本的样式 */
        .message.has-voice .message-text {
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .message.user.has-voice .message-text {
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-input {
            padding: 15px 30px;
            background: white;
            border-top: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.4;
            overflow-y: auto;
        }

        .message-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .voice-btn,
        .send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .voice-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .send-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .voice-btn:hover,
        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            text-align: center;
        }

        .chat-empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .chat-empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .chat-empty-hint {
            font-size: 14px;
            opacity: 0.7;
        }

        .role-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-avatar-chat {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .role-avatar-chat img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .role-name-chat {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* 对话页面样式 */
        .chat-page {
            display: none;
            width: 100%;
            height: 100vh;
            background: #ecf0f1;
        }

        .chat-page.active {
            display: flex;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #ecf0f1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .role-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-avatar-chat {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .role-avatar-chat img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .role-name-chat {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .chat-back-btn {
            margin-left: auto;
            padding: 8px 16px;
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-back-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 70%;
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message.role {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .message-avatar.role {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .message.role .message-content {
            background: white;
            color: #2c3e50;
        }

        .message-time {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: center;
        }

        .chat-input {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.4;
            overflow-y: auto;
        }

        .message-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .voice-btn:active {
            transform: scale(0.95);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 聊天记录为空时的提示 */
        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            text-align: center;
        }

        .chat-empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .chat-empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .chat-empty-hint {
            font-size: 14px;
            opacity: 0.7;
        }

        /* 最近对话角色列表 */
        .recent-roles {
            flex: 1;
            overflow-y: auto;
            padding-top: 10px;
        }

        /* 最近聊天角色项样式 */
        .recent-role-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 5px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
        }

        .recent-role-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .recent-role-item.active {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .recent-role-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            flex-shrink: 0;
            margin-right: 12px;
        }

        .recent-role-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .recent-role-info {
            flex: 1;
            min-width: 0;
        }

        .recent-role-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-role-desc {
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 响应式适配 */
        @media (max-width: 768px) {
            .create-role-page.active {
                width: 100%;
                height: 100vh;
            }

            .create-role-header {
                padding: 15px 20px;
            }

            .create-role-content {
                padding: 20px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .role-form {
                max-width: 100%;
                padding: 20px;
                position: relative;
                z-index: 1;
                overflow: visible;
                box-sizing: border-box;
            }

            .role-form::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                border-radius: 12px;
                z-index: -1;
            }

            .role-select-group {
                flex-direction: column;
                gap: 10px;
            }

            .chat-content {
                height: 100%;
            }

            .chat-messages {
                padding: 15px;
                height: calc(100vh - 120px);
                /* 移动端固定高度 */
                max-height: calc(100vh - 120px);
                /* 确保不会超过设定高度 */
                flex-shrink: 0;
                /* 防止被压缩 */
                box-sizing: border-box;
                /* 包含padding在内 */
            }

            .message {
                max-width: 85%;
            }

            .chat-header {
                padding: 10px 15px;
            }

            .role-avatar-chat {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .role-name-chat {
                font-size: 18px;
            }

            .message-avatar {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }

            .message-input {
                font-size: 16px;
                padding: 10px 16px;
            }

            .voice-btn,
            .send-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 左侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="create-role-btn" onclick="createRole()">
                    <span>➕</span>
                    创建角色
                </button>
            </div>

            <div class="recent-chats">
                <h3>最近对话</h3>
                <div id="chatList">
                    <div class="no-chats">登录后查看对话记录</div>
                </div>
                <div id="chatsLoading" class="loading-indicator" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>加载更多对话...</div>
                </div>
            </div>
        </div>

        <!-- 右侧主要内容区 -->
        <div class="main-content">
            <!-- 顶部栏 -->
            <div class="header">
                <div class="user-info" id="userInfo">
                    <!-- 已登录状态 -->
                    <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">用</div>
                    <span class="welcome-text" id="welcomeText">欢迎，用户名</span>

                    <!-- 用户下拉菜单 -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="showUserProfile()">个人资料</div>
                        <div class="dropdown-item logout" onclick="logout()">退出登录</div>
                    </div>

                    <!-- 未登录状态 -->
                    <!-- <button class="login-btn" onclick="login()">登录</button> -->
                </div>

                <div class="search-container">
                    <input type="text" class="search-input" placeholder="搜索角色..." id="searchInput"
                        oninput="searchRoles()">
                    <button class="search-btn">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- 角色卡片区域 -->
            <div class="content-area">
                <div class="roles-grid" id="rolesGrid">
                    <!-- 动态加载的角色将显示在这里 -->
                </div>
                <div id="rolesLoading" class="loading-indicator" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>加载更多角色...</div>
                </div>
            </div>

            <!-- 创建角色页面 -->
            <div class="create-role-page" id="createRolePage">
                <div class="create-role-header">
                    <h2 class="page-title">创建新角色</h2>
                    <button class="back-btn" onclick="backToHome()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
                        </svg>
                        返回
                    </button>
                </div>

                <div class="create-role-content">
                    <form class="role-form" id="roleForm">
                        <!-- 角色头像部分 -->
                        <div class="role-avatar-section">
                            <div class="role-avatar-preview" id="roleAvatarPreview" onclick="uploadRoleAvatar()">
                                <div class="role-avatar-text">🎭</div>
                                <div class="avatar-upload-hint">点击上传头像</div>
                            </div>
                            <input type="file" id="roleAvatarInput" accept="image/*"
                                onchange="handleRoleAvatarUpload(event)">

                            <div class="role-default-avatars">
                                <div class="role-default-avatar selected" data-avatar="🎭"
                                    onclick="chooseRoleDefaultAvatar('🎭')">🎭</div>
                                <div class="role-default-avatar" data-avatar="👑"
                                    onclick="chooseRoleDefaultAvatar('👑')">👑
                                </div>
                                <div class="role-default-avatar" data-avatar="🦸"
                                    onclick="chooseRoleDefaultAvatar('🦸')">🦸
                                </div>
                                <div class="role-default-avatar" data-avatar="🧙"
                                    onclick="chooseRoleDefaultAvatar('🧙')">🧙
                                </div>
                                <div class="role-default-avatar" data-avatar="🐱"
                                    onclick="chooseRoleDefaultAvatar('🐱')">🐱
                                </div>
                                <div class="role-default-avatar" data-avatar="🤖"
                                    onclick="chooseRoleDefaultAvatar('🤖')">🤖
                                </div>
                                <div class="role-default-avatar" data-avatar="🦄"
                                    onclick="chooseRoleDefaultAvatar('🦄')">🦄
                                </div>
                                <div class="role-default-avatar" data-avatar="🐶"
                                    onclick="chooseRoleDefaultAvatar('🐶')">🐶
                                </div>
                                <div class="role-default-avatar" data-avatar="🦊"
                                    onclick="chooseRoleDefaultAvatar('🦊')">🦊
                                </div>
                                <div class="role-default-avatar" data-avatar="🐼"
                                    onclick="chooseRoleDefaultAvatar('🐼')">🐼
                                </div>
                                <div class="role-default-avatar" data-avatar="👨‍🎓"
                                    onclick="chooseRoleDefaultAvatar('👨‍🎓')">
                                    👨‍🎓</div>
                                <div class="role-default-avatar" data-avatar="👩‍🏫"
                                    onclick="chooseRoleDefaultAvatar('👩‍🏫')">
                                    👩‍🏫</div>
                            </div>
                        </div>

                        <!-- 角色名称 -->
                        <div class="role-input-group">
                            <label class="form-label" for="roleName">角色名称</label>
                            <input type="text" id="roleName" class="form-input" placeholder="请输入角色名称" maxlength="50">
                            <div class="error-message" id="roleNameError"></div>
                        </div>

                        <!-- 自动填写按钮 -->
                        <div class="auto-fill-container">
                            <button type="button" class="auto-fill-btn" onclick="autoFillDescription()"
                                id="autoFillBtn">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path
                                        d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM4.5 9a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM4 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 0 1h-4z" />
                                </svg>
                                自动填写
                            </button>
                            <div class="auto-fill-progress" id="autoFillProgress" style="display: none;">
                                正在准备...
                            </div>
                        </div>

                        <!-- 角色描述 -->
                        <div class="role-input-group">
                            <label class="form-label" for="roleDescription">角色描述</label>
                            <textarea id="roleDescription" class="role-textarea" placeholder="请描述角色的背景、性格、外貌等基本信息..."
                                maxlength="500"></textarea>
                            <div class="error-message" id="roleDescriptionError"></div>
                        </div>

                        <!-- 角色特点 -->
                        <div class="role-input-group">
                            <label class="form-label" for="roleTraits">角色特点</label>
                            <textarea id="roleTraits" class="role-textarea" placeholder="请描述角色的特点、技能、爱好、说话风格等..."
                                maxlength="500"></textarea>
                            <div class="error-message" id="roleTraitsError"></div>
                        </div>

                        <!-- 角色性别 -->
                        <div class="role-input-group">
                            <label class="form-label">角色性别</label>
                            <div class="role-select-group">
                                <label class="role-radio-option">
                                    <input type="radio" name="roleGender" value="male" id="genderMale" checked>
                                    <span class="radio-label">男性</span>
                                </label>
                                <label class="role-radio-option">
                                    <input type="radio" name="roleGender" value="female" id="genderFemale">
                                    <span class="radio-label">女性</span>
                                </label>
                            </div>
                        </div>

                        <!-- 语音类型 -->
                        <div class="role-input-group">
                            <label class="form-label">语音类型</label>
                            <div class="role-select-group">
                                <label class="role-radio-option">
                                    <input type="radio" name="roleVoiceType" value="mature" id="voiceMature" checked>
                                    <span class="radio-label">成熟</span>
                                </label>
                                <label class="role-radio-option">
                                    <input type="radio" name="roleVoiceType" value="young" id="voiceYoung">
                                    <span class="radio-label">年轻</span>
                                </label>
                            </div>
                        </div>

                        <!-- 创建按钮 -->
                        <button type="submit" class="create-submit-btn" id="createSubmitBtn">创建角色</button>
                    </form>
                </div>
            </div>

            <!-- 聊天页面 -->
            <div class="create-role-page" id="chatPageNew">
                <div class="create-role-header">
                    <h2 class="page-title" id="currentRoleNameNew">选择一个角色开始对话</h2>
                    <button class="back-btn" onclick="backToHome()">返回主页</button>
                </div>

                <div class="chat-content">
                    <div class="chat-messages" id="chatMessagesNew">
                        <div class="chat-empty" id="chatEmptyNew">
                            <div class="chat-empty-icon">💬</div>
                            <div class="chat-empty-text">还没有聊天记录</div>
                            <div class="chat-empty-hint">选择一个角色开始有趣的对话吧！</div>
                        </div>
                        <div id="dialogsLoading" class="loading-indicator" style="display: none;">
                            <div class="loading-spinner"></div>
                            <div>加载更多消息...</div>
                        </div>
                    </div>

                    <div class="chat-input">
                        <textarea class="message-input" id="messageInputNew" placeholder="输入消息..." rows="1"
                            onkeydown="handleInputKeydown(event)" oninput="adjustTextareaHeight(this)"></textarea>
                        <button class="voice-btn" id="voiceBtnNew" onclick="startVoiceInput()" title="语音输入">
                            🎤
                        </button>
                        <button class="send-btn" id="sendBtnNew" onclick="sendMessage()" title="发送消息" disabled>
                            ➤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建角色页面 -->

    <div class="modal-overlay" id="authModal">
        <div class="auth-modal">
            <button class="modal-close" onclick="closeAuthModal()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                </svg>
            </button>

            <div class="modal-header">
                <h2 class="modal-title">欢迎来到角色扮演AI</h2>
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchTab('login')" id="loginTab">登录</button>
                    <button class="auth-tab" onclick="switchTab('register')" id="registerTab">注册</button>
                </div>
            </div>

            <div class="modal-body">
                <!-- 登录表单 -->
                <form id="loginForm" style="display: block;">
                    <div class="form-group">
                        <label class="form-label" for="loginUsername">用户名</label>
                        <input type="text" id="loginUsername" class="form-input" placeholder="请输入用户名">
                        <div class="error-message" id="loginUsernameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="loginPassword">密码</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="请输入密码">
                        <div class="error-message" id="loginPasswordError"></div>
                    </div>

                    <button type="submit" class="auth-submit" id="loginSubmit">登录</button>
                </form>

                <!-- 注册表单 -->
                <form id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="registerUsername">用户名</label>
                        <input type="text" id="registerUsername" class="form-input" placeholder="请输入用户名">
                        <div class="error-message" id="registerUsernameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="registerPassword">密码</label>
                        <input type="password" id="registerPassword" class="form-input" placeholder="请输入密码">
                        <div class="error-message" id="registerPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">确认密码</label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="请再次输入密码">
                        <div class="error-message" id="confirmPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">用户头像</label>
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="avatarPreview">
                                <div class="avatar-preview-text">👤</div>
                            </div>
                            <div class="avatar-actions">
                                <button type="button" class="avatar-btn" onclick="selectDefaultAvatar()">选择默认头像</button>
                                <button type="button" class="avatar-btn primary" onclick="uploadAvatar()">上传头像</button>
                            </div>
                            <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarUpload(event)">
                        </div>

                        <div class="default-avatars" id="defaultAvatars" style="display: none;">
                            <div class="default-avatar" data-avatar="👤" onclick="chooseDefaultAvatar('👤')">👤</div>
                            <div class="default-avatar" data-avatar="🎭" onclick="chooseDefaultAvatar('🎭')">🎭</div>
                            <div class="default-avatar" data-avatar="🦄" onclick="chooseDefaultAvatar('🦄')">🦄</div>
                            <div class="default-avatar" data-avatar="🐱" onclick="chooseDefaultAvatar('🐱')">🐱</div>
                            <div class="default-avatar" data-avatar="🐶" onclick="chooseDefaultAvatar('🐶')">🐶</div>
                            <div class="default-avatar" data-avatar="🦊" onclick="chooseDefaultAvatar('🦊')">🦊</div>
                            <div class="default-avatar" data-avatar="🐼" onclick="chooseDefaultAvatar('🐼')">🐼</div>
                            <div class="default-avatar" data-avatar="🐯" onclick="chooseDefaultAvatar('🐯')">🐯</div>
                        </div>
                    </div>

                    <button type="submit" class="auth-submit" id="registerSubmit">注册</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ====== Socket.IO 聊天系统 ======
        let socket = null;

        // 初始化Socket.IO连接
        function initSocket() {
            console.log('初始化Socket.IO连接...');

            // 检查当前URL和协议
            console.log('当前URL:', window.location.href);
            console.log('协议:', window.location.protocol);

            // 明确指定Socket.IO服务器地址
            socket = io({
                autoConnect: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5,
                timeout: 20000
            });

            console.log('Socket.IO配置完成');

            // 连接成功
            socket.on('connect', () => {
                console.log('Socket连接成功:', socket.id);
                console.log('Socket连接状态:', socket.connected);
                console.log('Socket对象:', socket);

                // 测试发送一个简单消息
                setTimeout(() => {
                    console.log('发送测试消息...');
                    socket.emit('test', { test: 'hello from frontend' });
                }, 1000);
            });

            // 连接断开
            socket.on('disconnect', (reason) => {
                console.log('Socket连接断开, 原因:', reason);
            });

            // 接收来自后端的消息
            socket.on('message', (data) => {
                console.log('=== 接收到message事件 ===');
                console.log('消息数据:', data);
                console.log('数据类型:', typeof data);
                console.log('========================');
                handleReceivedMessage(data);
                hideTypingIndicator(); // 收到回复后隐藏"正在回复"状态
            });

            // 接收语音转文字更新事件
            socket.on('update_message', (data) => {
                console.log('=== 接收到update_message事件 ===');
                console.log('更新数据:', data);
                console.log('==============================');
                handleMessageUpdate(data);
            });

            // 监听用户消息保存确认事件
            socket.on('user_message_saved', (data) => {
                console.log('=== 用户消息已保存 ===');
                console.log('数据:', data);
                console.log('===================');
                // 更新最近对话列表排序
                updateRecentChatsList();
            });

            // 监听角色构建进度事件
            socket.on('role_build_status', (status) => {
                console.log('=== 角色构建进度 ===');
                console.log('状态:', status);
                console.log('==================');
                updateAutoFillProgress(status);
            });

            // 连接错误处理
            socket.on('connect_error', (error) => {
                console.error('Socket连接错误:', error);
            });

            // 监听所有事件（调试用）
            socket.onAny((event, ...args) => {
                console.log('=== Socket事件 ===');
                console.log('事件名:', event);
                console.log('参数:', args);
                console.log('时间:', new Date().toLocaleTimeString());
                console.log('================');
            });

            // 额外监听一些可能的事件名称
            socket.on('msg', (data) => {
                console.log('收到msg事件:', data);
            });

            socket.on('response', (data) => {
                console.log('收到response事件:', data);
            });

            // 定期检查连接状态
            setInterval(() => {
                if (socket) {
                    console.log('Socket状态检查 - 连接:', socket.connected, 'ID:', socket.id);
                }
            }, 10000); // 每10秒检查一次
        }

        // 发送消息到后端
        function sendSocketMessage(userId, roleId, text) {
            if (!socket) {
                console.error('Socket未初始化');
                return;
            }

            if (!socket.connected) {
                console.error('Socket未连接');
                return;
            }

            const messageData = {
                user_id: parseInt(userId),
                role_id: parseInt(roleId),
                timestamp: Date.now(),
                text: text
            };

            console.log('=== 发送消息 ===');
            console.log('Socket ID:', socket.id);
            console.log('Socket连接状态:', socket.connected);
            console.log('消息数据:', messageData);
            console.log('===============');

            socket.emit('message', messageData);
        }

        // 发送语音消息到后端
        function sendVoiceMessage(userId, roleId, voiceUrl, messageId) {
            if (!socket) {
                console.error('Socket未初始化');
                return;
            }

            if (!socket.connected) {
                console.error('Socket未连接');
                return;
            }

            const messageData = {
                user_id: parseInt(userId),
                role_id: parseInt(roleId),
                timestamp: Date.now(),
                voice_url: voiceUrl,
                id: messageId
            };

            console.log('=== 发送语音消息 ===');
            console.log('Socket ID:', socket.id);
            console.log('Socket连接状态:', socket.connected);
            console.log('语音消息数据:', messageData);
            console.log('=================');

            socket.emit('voice', messageData);
        }

        // 处理消息更新（语音转文字）
        function handleMessageUpdate(data) {
            console.log('处理消息更新:', data);

            if (!data.id || !data.text) {
                console.error('消息更新数据不完整:', data);
                return;
            }

            // 查找对应ID的消息并更新文本
            const messageIndex = chatMessages.findIndex(msg => msg.id === data.id);
            if (messageIndex !== -1) {
                chatMessages[messageIndex].message = data.text;
                console.log('消息文本已更新:', chatMessages[messageIndex]);
                renderChatMessages();
                showTypingIndicator(); // 显示"正在回复"状态
            } else {
                console.error('找不到对应ID的消息:', data.id);
            }
        }

        // 处理接收到的消息
        function handleReceivedMessage(data) {
            console.log('处理接收到的消息:', data);
            console.log('当前聊天角色:', currentChatRole);

            if (!currentChatRole) {
                console.log('没有当前聊天角色，忽略消息');
                return;
            }

            const currentRoleId = parseInt(currentChatRole.id);
            const messageRoleId = parseInt(data.role_id);
            console.log('角色ID比较:', { currentRoleId, messageRoleId });

            if (currentRoleId !== messageRoleId) {
                console.log('消息角色不匹配，忽略', {
                    current: currentRoleId,
                    received: messageRoleId
                });
                return;
            }

            console.log('消息验证通过，添加到聊天记录');

            // 添加角色消息到聊天记录
            const message = {
                id: ++messageIdCounter, // 为接收到的消息也添加ID
                sender: 'role',
                message: data.text,
                timestamp: data.timestamp || Math.floor(Date.now() / 1000),
                voice: data.voice_url
            };

            chatMessages.push(message);
            console.log('消息已添加，重新渲染界面');
            renderChatMessages();

            // 自动播放AI回复的语音
            if (data.voice_url) {
                console.log('自动播放AI语音:', data.voice_url);
                playVoice(data.voice_url);
            }

            // 更新最近对话列表排序
            updateRecentChatsList();
        }

        // 用户状态管理
        let isLoggedIn = false; // 改为未登录状态
        let currentUser = {
            id: "",
            name: "",
            avatar: ""
        };

        // 当前选择的头像
        let selectedAvatar = '👤';
        let selectedAvatarType = 'default'; // 'default' 或 'custom'
        let customAvatarFile = null;

        // SHA-256 哈希函数
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // 角色数据
        let roles = [];

        // 懒加载状态
        const lazyLoadState = {
            roles: {
                offset: 0,
                limit: 15,
                loading: false,
                hasMore: true,
                total: 0
            },
            conversations: {
                offset: 0,
                limit: 15,
                loading: false,
                hasMore: true,
                total: 0
            },
            dialogs: {
                offset: 0,
                limit: 20,
                loading: false,
                hasMore: true,
                total: 0
            }
        };

        // 加载角色列表（懒加载版本）
        async function loadRoles(append = false) {
            if (lazyLoadState.roles.loading) return;

            try {
                lazyLoadState.roles.loading = true;

                if (!append) {
                    // 重置数据
                    roles = [];
                    lazyLoadState.roles.offset = 0;
                    lazyLoadState.roles.hasMore = true;
                }

                if (!lazyLoadState.roles.hasMore) {
                    lazyLoadState.roles.loading = false;
                    return;
                }

                const url = `/api/role/list?offset=${lazyLoadState.roles.offset}&limit=${lazyLoadState.roles.limit}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('角色列表数据:', data);

                    if (data && data.items && Array.isArray(data.items)) {
                        const newRoles = data.items.map(role => ({
                            id: String(role.role_id),
                            user_id: role.user_id,
                            name: role.name,
                            description: role.description,
                            traits: role.traits,
                            image_url: role.image_url,
                            emoji: isEmoji(role.image_url) ? role.image_url : null
                        }));

                        if (append) {
                            roles.push(...newRoles);
                            // 渲染新角色（追加模式）
                            renderRoles(newRoles, true);
                        } else {
                            roles = newRoles;
                            // 渲染所有角色（替换模式）
                            renderRoles(roles, false);
                        }

                        lazyLoadState.roles.total = data.total;
                        lazyLoadState.roles.hasMore = data.has_more;
                        lazyLoadState.roles.offset += lazyLoadState.roles.limit;
                    } else {
                        console.warn('角色列表格式错误:', data);
                        if (!append) {
                            roles = [];
                            lazyLoadState.roles.hasMore = false;
                        }
                    }
                } else {
                    console.warn('获取角色列表失败:', response.status);
                    if (!append) {
                        roles = [];
                        lazyLoadState.roles.hasMore = false;
                    }
                }
            } catch (error) {
                console.error('加载角色列表错误:', error);
                if (!append) {
                    roles = [];
                    lazyLoadState.roles.hasMore = false;
                }
            } finally {
                lazyLoadState.roles.loading = false;
            }
        }

        // 获取角色详情
        async function getRoleDetails(roleId) {
            try {
                const response = await fetch(`/api/role/details?role_id=${parseInt(roleId)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return {
                        name: data.name,
                        description: data.description,
                        traits: data.traits,
                        image_url: data.image_url
                    };
                } else {
                    console.warn('获取角色详情失败:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('获取角色详情错误:', error);
                return null;
            }
        }

        // 检查是否为emoji
        function isEmoji(str) {
            if (!str || str.length > 4) return false;
            const emojiRegex = /^[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F900}-\u{1F9FF}]|[\u{1F018}-\u{1F270}]$/u;
            return emojiRegex.test(str);
        }

        // 格式化时间戳为友好显示格式
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';

            try {
                let date;

                // 处理不同的时间戳格式
                if (typeof timestamp === 'number') {
                    // 判断是毫秒还是秒格式
                    if (timestamp > 9999999999) { // 大于这个数字就是毫秒格式
                        date = new Date(timestamp);
                    } else {
                        // 否则是秒格式，转换为毫秒
                        date = new Date(timestamp * 1000);
                    }
                } else if (timestamp instanceof Date) {
                    date = timestamp;
                } else {
                    // 尝试解析字符串或其他格式
                    date = new Date(timestamp);
                }

                // 检查日期是否有效
                if (isNaN(date.getTime())) {
                    console.error('无效的时间戳:', timestamp);
                    return '';
                }

                const now = new Date();
                const diff = now - date;

                // 如果时间差为负数（未来的时间），直接显示日期
                if (diff < 0) {
                    const isThisYear = date.getFullYear() === now.getFullYear();
                    if (isThisYear) {
                        return `${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    } else {
                        return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    }
                }

                // 小于1分钟显示"刚刚"
                if (diff < 60000) {
                    return '刚刚';
                }

                // 小于1小时显示"X分钟前"
                if (diff < 3600000) {
                    const minutes = Math.floor(diff / 60000);
                    return `${minutes}分钟前`;
                }

                // 超过1小时显示具体日期时间
                const isThisYear = date.getFullYear() === now.getFullYear();

                if (isThisYear) {
                    return `${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                } else {
                    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                }
            } catch (error) {
                console.error('时间格式化错误:', error, '原始时间戳:', timestamp);
                return '';
            }
        }

        // 获取默认角色数据（作为fallback）
        function getDefaultRoles() {
            return [
                {
                    id: 'princess',
                    name: '艾莉娅公主',
                    emoji: '👑',
                    image_url: '👑',
                    description: '来自魔法王国的优雅公主，善良聪慧，拥有强大的魔法力量',
                    traits: '优雅、善良、聪慧、魔法'
                },
                {
                    id: 'assistant',
                    name: '智能助手',
                    emoji: '🤖',
                    image_url: '🤖',
                    description: '专业的AI助手，可以帮助您解决各种问题和提供建议',
                    traits: '专业、高效、有帮助、智能'
                },
                {
                    id: 'catgirl',
                    name: '猫娘女仆',
                    emoji: '🐱',
                    image_url: '🐱',
                    description: '可爱的猫娘女仆，温柔体贴，会照顾主人的日常生活',
                    traits: '可爱、温柔、体贴、忠诚'
                },
                {
                    id: 'detective',
                    name: '名侦探',
                    emoji: '🕵️',
                    image_url: '🕵️',
                    description: '敏锐的观察力和逻辑思维，擅长解决各种神秘案件',
                    traits: '敏锐、逻辑、推理、神秘'
                },
                {
                    id: 'wizard',
                    name: '古老法师',
                    emoji: '🧙‍♂️',
                    image_url: '🧙‍♂️',
                    description: '拥有千年智慧的法师，掌握着古老而强大的魔法知识',
                    traits: '智慧、神秘、强大、古老'
                },
                {
                    id: 'teacher',
                    name: '温柔老师',
                    emoji: '👩‍🏫',
                    image_url: '👩‍🏫',
                    description: '耐心温和的老师，擅长教学和引导学生思考',
                    traits: '耐心、温和、教学、引导'
                }
            ];
        }

        // 初始化页面
        async function initPage() {
            // 初始化Socket.IO连接
            initSocket();

            // 检查本地存储的token，尝试恢复登录状态
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const response = await fetch('/api/auth/verify', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        isLoggedIn = true;
                        currentUser = {
                            id: userData.user_id,
                            name: userData.username,
                            avatar: userData.avatar
                        };
                    } else {
                        // Token无效，清除本地存储
                        localStorage.removeItem('authToken');
                        isLoggedIn = false;
                    }
                } catch (error) {
                    console.error('验证token失败:', error);
                    localStorage.removeItem('authToken');
                    isLoggedIn = false;
                }
            }

            updateUserInfo();
            await loadRoles();

            // 如果已登录，加载最近对话
            if (isLoggedIn) {
                await loadRecentChats();
            }

            // 从URL锚点恢复页面状态
            restoreFromUrlHash();
        }

        // 更新用户信息显示
        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            if (isLoggedIn) {
                // 判断头像格式：URL、base64或表情符号
                let avatarElement;
                if (currentUser.avatar.startsWith('http') || currentUser.avatar.startsWith('/')) {
                    // 图片URL
                    avatarElement = `<img src="${currentUser.avatar}" alt="用户头像" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else if (currentUser.avatar.startsWith('data:image')) {
                    // base64格式
                    avatarElement = `<img src="${currentUser.avatar}" alt="用户头像" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    // 表情符号
                    avatarElement = currentUser.avatar;
                }

                userInfo.innerHTML = `
                    <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">${avatarElement}</div>
                    <span class="welcome-text">欢迎，${currentUser.name}</span>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="showUserProfile()">个人资料</div>
                        <div class="dropdown-item logout" onclick="logout()">退出登录</div>
                    </div>
                `;
            } else {
                userInfo.innerHTML = `
                    <button class="login-btn" onclick="login()">登录</button>
                `;
            }
        }

        // 用户下拉菜单控制
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // 显示用户资料（暂时用alert代替）
        function showUserProfile() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');
            alert('个人资料功能待实现');
        }

        // 退出登录
        function logout() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');

            // 清除本地存储
            localStorage.removeItem('authToken');

            // 重置登录状态
            isLoggedIn = false;
            currentUser = { id: null, name: '', avatar: '' };

            // 更新UI
            updateUserInfo();

            // 重新加载页面数据
            loadRoles();
            document.getElementById('chatList').innerHTML = '<div class="no-chats">登录后查看对话记录</div>';

            // 如果当前在聊天页面，返回主页
            if (currentPage === 'chat') {
                backToHome();
            }

            alert('已退出登录');
        }

        // 初始化滚动监听器
        function initScrollListeners() {
            // 角色内容区域滚动监听（角色懒加载）
            const contentArea = document.querySelector('.content-area');
            if (contentArea) {
                contentArea.addEventListener('scroll', function () {
                    if (getCurrentPage() === 'home') {
                        handleMainContentScroll();
                    }
                });
            }

            // 侧边栏对话列表滚动监听
            const recentChats = document.querySelector('.recent-chats');
            if (recentChats) {
                recentChats.addEventListener('scroll', function () {
                    handleChatListScroll();
                });
            }

            // 聊天消息区域滚动监听
            const chatMessages = document.getElementById('chatMessagesNew');
            if (chatMessages) {
                chatMessages.addEventListener('scroll', function () {
                    if (getCurrentPage() === 'chat') {
                        handleChatMessagesScroll();
                    }
                });
            }
        }

        // 处理主内容区域滚动（角色懒加载）
        function handleMainContentScroll() {
            const contentArea = document.querySelector('.content-area');
            const scrollTop = contentArea.scrollTop;
            const scrollHeight = contentArea.scrollHeight;
            const clientHeight = contentArea.clientHeight;

            console.log('角色区域滚动检测:', {
                scrollTop, scrollHeight, clientHeight,
                distance: scrollHeight - scrollTop - clientHeight,
                loading: lazyLoadState.roles.loading,
                hasMore: lazyLoadState.roles.hasMore
            });

            // 距离底部100px时开始加载更多
            if (scrollHeight - scrollTop - clientHeight < 100 && !lazyLoadState.roles.loading && lazyLoadState.roles.hasMore) {
                console.log('触发角色懒加载');
                showLoadingIndicator('roles');
                loadRoles(true).finally(() => {
                    hideLoadingIndicator('roles');
                });
            }
        }

        // 处理对话列表滚动
        function handleChatListScroll() {
            const recentChats = document.querySelector('.recent-chats');
            const scrollTop = recentChats.scrollTop;
            const scrollHeight = recentChats.scrollHeight;
            const clientHeight = recentChats.clientHeight;

            console.log('对话列表滚动检测:', {
                scrollTop, scrollHeight, clientHeight,
                distance: scrollHeight - scrollTop - clientHeight,
                loading: lazyLoadState.conversations.loading,
                hasMore: lazyLoadState.conversations.hasMore
            });

            if (scrollHeight - scrollTop - clientHeight < 50 && !lazyLoadState.conversations.loading && lazyLoadState.conversations.hasMore) {
                console.log('触发对话懒加载');
                showLoadingIndicator('chats');
                loadRecentChats(true).then(() => {
                    hideLoadingIndicator('chats');
                });
            }
        }

        // 处理聊天消息滚动
        function handleChatMessagesScroll() {
            const chatMessagesElement = document.getElementById('chatMessagesNew');
            const scrollTop = chatMessagesElement.scrollTop;

            // 在顶部时加载更早的消息（聊天记录是从上往下滚动看历史消息）
            if (scrollTop < 100 && !lazyLoadState.dialogs.loading && lazyLoadState.dialogs.hasMore && currentChatRole) {
                showLoadingIndicator('dialogs');
                const currentScrollHeight = chatMessagesElement.scrollHeight;

                loadChatDialogs(currentChatRole.id, true).then((newMessages) => {
                    if (newMessages.length > 0) {
                        // 将新消息添加到数组前面（历史消息在前）
                        chatMessages = [...newMessages, ...chatMessages];
                        renderChatMessages();

                        // 保持滚动位置
                        const newScrollHeight = chatMessagesElement.scrollHeight;
                        chatMessagesElement.scrollTop = newScrollHeight - currentScrollHeight;
                    }
                    hideLoadingIndicator('dialogs');
                });
            }
        }

        // 显示加载指示器
        function showLoadingIndicator(type) {
            const indicators = {
                'roles': 'rolesLoading',
                'chats': 'chatsLoading',
                'dialogs': 'dialogsLoading'
            };

            const elementId = indicators[type];
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'flex';
                }
            }
        }

        // 隐藏加载指示器
        function hideLoadingIndicator(type) {
            const indicators = {
                'roles': 'rolesLoading',
                'chats': 'chatsLoading',
                'dialogs': 'dialogsLoading'
            };

            const elementId = indicators[type];
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'none';
                }
            }
        }

        // 获取当前页面
        function getCurrentPage() {
            const hash = window.location.hash;
            if (hash.startsWith('#chat/')) return 'chat';
            if (hash === '#create-role') return 'create-role';
            return 'home';
        }

        // 渲染角色卡片
        function renderRoles(rolesToRender, append = false) {
            const rolesGrid = document.getElementById('rolesGrid');

            if (!append && rolesToRender.length === 0) {
                rolesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">🔍</div>
                        <div class="empty-text">暂无角色</div>
                    </div>
                `;
                return;
            }

            const roleCardsHtml = rolesToRender.map(role => {
                // 调试信息
                console.log('渲染角色:', role.name, 'user_id:', role.user_id, 'currentUser:', currentUser);

                // 处理角色图片显示
                let roleImageContent = '';
                if (role.image_url) {
                    if (isEmoji(role.image_url)) {
                        // 如果是emoji，直接显示
                        roleImageContent = role.image_url;
                    } else {
                        // 如果是URL，显示图片
                        roleImageContent = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                    }
                } else if (role.emoji) {
                    // 兼容旧的emoji字段
                    roleImageContent = role.emoji;
                } else {
                    // 默认头像
                    roleImageContent = '🎭';
                }

                return `
                    <div class="role-card">
                        <div class="role-image" onclick="selectRole('${role.id}')">${roleImageContent}</div>
                        <div class="role-info" onclick="selectRole('${role.id}')">
                            <div class="role-name">${role.name}</div>
                            <div class="role-description">${role.description}</div>
                        </div>
                        <div class="role-actions">
                            <button class="chat-role-btn" onclick="event.stopPropagation(); startChatWithRole('${role.id}')" title="开始对话">
                                💬
                            </button>
                            ${(() => {
                        const canDelete = currentUser && role.user_id === currentUser.id;
                        console.log(`角色 ${role.name} 删除权限检查:`, 'currentUser:', currentUser, 'role.user_id:', role.user_id, 'canDelete:', canDelete);
                        return canDelete ? `
                            <button class="delete-role-btn" onclick="event.stopPropagation(); deleteRole('${role.id}')" title="删除角色">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                            ` : '';
                    })()}
                        </div>
                    </div>
                `;
            }).join('');

            if (append) {
                rolesGrid.innerHTML += roleCardsHtml;
            } else {
                rolesGrid.innerHTML = roleCardsHtml;
            }
        }

        // 搜索角色
        async function searchRoles() {
            const searchTerm = document.getElementById('searchInput').value.trim();

            if (!searchTerm) {
                // 如果搜索词为空，显示所有角色
                renderRoles(roles);
                return;
            }

            try {
                // 调用后端搜索接口
                const response = await fetch(`/api/role/search?q=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const searchResults = await response.json();
                    const formattedResults = searchResults.map(role => ({
                        id: String(role.role_id), // 确保ID是字符串
                        name: role.name,
                        description: role.description,
                        traits: role.traits,
                        image_url: role.image_url,
                        gender: role.gender,
                        voice_type: role.voice_type
                    }));
                    renderRoles(formattedResults);
                } else {
                    console.warn('搜索请求失败:', response.status);
                    // 降级到客户端搜索
                    const filteredRoles = roles.filter(role =>
                        role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        role.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (role.traits && role.traits.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                    renderRoles(filteredRoles);
                }
            } catch (error) {
                console.error('搜索错误:', error);
                // 降级到客户端搜索
                const filteredRoles = roles.filter(role =>
                    role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    role.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (role.traits && role.traits.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                renderRoles(filteredRoles);
            }
        }

        // 当前页面状态
        let currentPage = 'home'; // 'home', 'create-role', 'chat'
        let currentChatRoleId = null; // 当前聊天的角色ID
        let pendingAction = null; // 登录后需要执行的操作

        // 设置登录后需要执行的操作
        function setPendingAction(action, params = null) {
            pendingAction = {
                action: action,
                params: params
            };
            console.log('设置登录后待执行操作:', pendingAction);
        }

        // 执行登录后的待处理操作
        function executePendingAction() {
            if (!pendingAction) return;

            console.log('执行登录后待处理操作:', pendingAction);
            const { action, params } = pendingAction;

            // 清除待处理操作
            pendingAction = null;

            // 执行对应的操作
            switch (action) {
                case 'createRole':
                    showCreateRolePage();
                    break;
                case 'selectRole':
                    if (params && params.roleId) {
                        startChatWithRole(params.roleId);
                    }
                    break;
                case 'openChat':
                    if (params && params.roleId) {
                        openChatDirect(params.roleId);
                    }
                    break;
                case 'startChatWithRole':
                    if (params && params.roleId) {
                        startChatWithRole(params.roleId);
                    }
                    break;
                default:
                    console.warn('未知的待处理操作:', action);
                    break;
            }
        }

        // 更新URL锚点
        function updateUrlHash() {
            let hash = '';
            switch (currentPage) {
                case 'create-role':
                    hash = '#create-role';
                    break;
                case 'chat':
                    if (currentChatRoleId) {
                        hash = `#chat/${currentChatRoleId}`;
                    } else {
                        hash = '#chat';
                    }
                    break;
                case 'home':
                default:
                    hash = '#home';
                    break;
            }
            console.log('更新URL锚点:', hash);
            window.location.hash = hash;
        }

        // 从URL锚点恢复页面状态
        function restoreFromUrlHash() {
            const hash = window.location.hash.substring(1); // 移除 # 符号
            console.log('从URL锚点恢复页面状态:', hash);

            if (!hash) {
                backToHome();
                return;
            }

            const parts = hash.split('/');
            const page = parts[0];

            switch (page) {
                case 'create-role':
                    showCreateRolePage();
                    break;
                case 'chat':
                    const roleId = parts[1];
                    if (roleId && isLoggedIn) {
                        // 只有在登录状态下才恢复聊天页面
                        showChatPage(roleId);
                    } else if (!isLoggedIn) {
                        // 未登录时跳转到主页
                        backToHome();
                    } else {
                        // 没有角色ID，显示聊天页面但不加载特定对话
                        showChatPage(null);
                    }
                    break;
                case 'home':
                default:
                    backToHome();
                    break;
            }
        }

        // 监听浏览器前进后退事件
        window.addEventListener('hashchange', function () {
            console.log('检测到锚点变化');
            restoreFromUrlHash();
        });

        // 角色创建相关变量
        let selectedRoleAvatar = '🎭';
        let selectedRoleAvatarType = 'default';
        let customRoleAvatarFile = null;

        // 创建角色
        function createRole() {
            if (!isLoggedIn) {
                setPendingAction('createRole');
                showAuthModal();
                return;
            }
            showCreateRolePage();
        }

        // 显示创建角色页面
        function showCreateRolePage() {
            currentPage = 'create-role';
            currentChatRoleId = null;

            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('chatPageNew').classList.remove('active');
            document.getElementById('createRolePage').classList.add('active');

            // 重置表单，确保每次打开都是干净的
            resetRoleForm();

            // 只在当前URL不是create-role时才更新锚点
            if (window.location.hash !== '#create-role') {
                updateUrlHash();
            }
        }

        // 重置角色表单
        function resetRoleForm() {
            document.getElementById('roleForm').reset();
            selectedRoleAvatar = '🎭';
            selectedRoleAvatarType = 'default';
            customRoleAvatarFile = null;
            updateRoleAvatarPreview();
            clearErrors(['roleNameError', 'roleDescriptionError', 'roleTraitsError']);

            // 重置默认头像选中状态
            document.querySelectorAll('.role-default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector('[data-avatar="🎭"]').classList.add('selected');
        }

        // 角色头像相关函数
        function uploadRoleAvatar() {
            document.getElementById('roleAvatarInput').click();
        }

        function handleRoleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB限制
                    alert('头像文件大小不能超过5MB');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('请选择图片文件');
                    return;
                }

                customRoleAvatarFile = file;
                selectedRoleAvatarType = 'custom';

                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedRoleAvatar = e.target.result;
                    updateRoleAvatarPreview();
                };
                reader.readAsDataURL(file);

                // 清除默认头像选中状态
                document.querySelectorAll('.role-default-avatar').forEach(el => {
                    el.classList.remove('selected');
                });
            }
        }

        function chooseRoleDefaultAvatar(avatar) {
            selectedRoleAvatar = avatar;
            selectedRoleAvatarType = 'default';
            customRoleAvatarFile = null;
            updateRoleAvatarPreview();

            // 更新选中状态
            document.querySelectorAll('.role-default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-avatar="${avatar}"]`).classList.add('selected');
        }

        function updateRoleAvatarPreview() {
            const preview = document.getElementById('roleAvatarPreview');
            if (selectedRoleAvatarType === 'custom') {
                preview.innerHTML = `
                    <img src="${selectedRoleAvatar}" alt="角色头像">
                    <div class="avatar-upload-hint">点击更换头像</div>
                `;
            } else {
                preview.innerHTML = `
                    <div class="role-avatar-text">${selectedRoleAvatar}</div>
                    <div class="avatar-upload-hint">点击上传头像</div>
                `;
            }
        }

        // 自动填写描述和特点
        let currentAutoFillController = null; // 用于存储当前请求的controller

        // 更新自动填充进度显示
        function updateAutoFillProgress(status) {
            const progressElement = document.getElementById('autoFillProgress');
            if (progressElement) {
                progressElement.textContent = status;
                progressElement.style.display = 'block';
            }
        }

        // 隐藏自动填充进度显示
        function hideAutoFillProgress() {
            const progressElement = document.getElementById('autoFillProgress');
            if (progressElement) {
                progressElement.style.display = 'none';
            }
        }

        async function autoFillDescription() {
            const roleName = document.getElementById('roleName').value.trim();

            if (!roleName) {
                showError('roleNameError', '请先输入角色名称');
                return;
            }

            if (!socket || !socket.connected) {
                alert('连接未建立，请稍后重试');
                return;
            }

            const btn = document.getElementById('autoFillBtn');
            const originalHTML = btn.innerHTML;

            // 如果有正在进行的请求，先取消它
            if (currentAutoFillController) {
                currentAutoFillController.abort();
            }

            // 创建新的AbortController
            currentAutoFillController = new AbortController();

            // 显示进度并更新按钮状态
            updateAutoFillProgress('正在准备...');
            btn.onclick = () => {
                if (currentAutoFillController) {
                    currentAutoFillController.abort();
                    currentAutoFillController = null;
                }
                hideAutoFillProgress();
                resetAutoFillButton(btn, originalHTML);
            };
            btn.innerHTML = `
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <circle cx="8" cy="8" r="3" opacity="0.3"/>
                    <path d="M8 0 A8 8 0 0 1 8 16 A8 8 0 0 1 8 0" opacity="0.8">
                        <animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" values="0 8 8;360 8 8"/>
                    </path>
                </svg>
                生成中... (点击取消)
            `;

            try {
                // 获取当前已填写的内容（可选）
                const currentDescription = document.getElementById('roleDescription').value.trim();
                const currentTraits = document.getElementById('roleTraits').value.trim();
                const gender = document.querySelector('input[name="roleGender"]:checked').value;
                const voiceType = document.querySelector('input[name="roleVoiceType"]:checked').value;

                // 调用AI生成接口，包含Socket.IO的sid
                const response = await fetch('/api/role/auto-fill', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: roleName,
                        description: currentDescription || undefined,
                        traits: currentTraits || undefined,
                        gender: gender,
                        voice_type: voiceType,
                        sid: socket.id
                    }),
                    signal: currentAutoFillController.signal
                });

                const data = await response.json();

                if (response.ok) {
                    // 直接使用返回的description和traits
                    if (data.description) {
                        document.getElementById('roleDescription').value = data.description;
                    }
                    if (data.traits) {
                        document.getElementById('roleTraits').value = data.traits;
                    }
                    // 处理返回的性别和语音类型
                    if (data.gender) {
                        const genderRadio = document.querySelector(`input[name="roleGender"][value="${data.gender}"]`);
                        if (genderRadio) {
                            genderRadio.checked = true;
                        }
                    }
                    if (data.voice_type) {
                        const voiceTypeRadio = document.querySelector(`input[name="roleVoiceType"][value="${data.voice_type}"]`);
                        if (voiceTypeRadio) {
                            voiceTypeRadio.checked = true;
                        }
                    }
                } else {
                    alert('自动填写失败，请手动填写');
                }
            } catch (error) {
                console.error('自动填写错误:', error);
                if (error.name === 'AbortError') {
                    console.log('请求已被用户取消');
                } else {
                    alert('网络错误或AI生成超时，请稍后重试');
                }
            } finally {
                hideAutoFillProgress();
                resetAutoFillButton(btn, originalHTML);
                currentAutoFillController = null;
            }
        }

        // 重置自动填写按钮状态
        function resetAutoFillButton(btn, originalHTML) {
            btn.innerHTML = originalHTML;
            btn.onclick = autoFillDescription;
        }

        // 角色表单验证
        function validateRoleForm() {
            let isValid = true;
            const name = document.getElementById('roleName').value.trim();
            const description = document.getElementById('roleDescription').value.trim();
            const traits = document.getElementById('roleTraits').value.trim();

            clearErrors(['roleNameError', 'roleDescriptionError', 'roleTraitsError']);

            if (!name) {
                showError('roleNameError', '请输入角色名称');
                isValid = false;
            } else if (name.length < 2) {
                showError('roleNameError', '角色名称至少2个字符');
                isValid = false;
            }

            if (!description) {
                showError('roleDescriptionError', '请输入角色描述');
                isValid = false;
            } else if (description.length < 20) {
                showError('roleDescriptionError', '角色描述至少20个字符');
                isValid = false;
            }

            if (!traits) {
                showError('roleTraitsError', '请输入角色特点');
                isValid = false;
            } else if (traits.length < 20) {
                showError('roleTraitsError', '角色特点至少20个字符');
                isValid = false;
            }

            return isValid;
        }

        // 处理角色创建
        async function handleRoleCreate(event) {
            event.preventDefault();

            if (!validateRoleForm()) return;

            const name = document.getElementById('roleName').value.trim();
            const description = document.getElementById('roleDescription').value.trim();
            const traits = document.getElementById('roleTraits').value.trim();
            const gender = document.querySelector('input[name="roleGender"]:checked').value;
            const voiceType = document.querySelector('input[name="roleVoiceType"]:checked').value;

            const submitBtn = document.getElementById('createSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '创建中...';

            try {
                let avatar = null;

                // 处理头像
                if (selectedRoleAvatarType === 'default' && selectedRoleAvatar) {
                    avatar = selectedRoleAvatar;
                } else if (selectedRoleAvatarType === 'custom' && customRoleAvatarFile) {
                    // 如果是自定义头像，先上传头像获取file_url
                    const uploadResponse = await fetch('/api/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'X-File-Name': customRoleAvatarFile.name,
                            'Content-Type': customRoleAvatarFile.type || 'application/octet-stream'
                        },
                        body: customRoleAvatarFile
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        avatar = uploadData.file_url;
                    } else {
                        throw new Error('头像上传失败');
                    }
                }

                // 创建角色请求
                const response = await fetch('/api/role/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        name: name,
                        description: description,
                        traits: traits,
                        avatar: avatar,
                        gender: gender,
                        voice_type: voiceType
                    })
                });

                const data = await response.json();

                if (response.ok && data.role_id) {
                    // 创建成功
                    alert('角色创建成功！');

                    // 清空表单
                    resetRoleForm();

                    // 重新加载角色列表以获取最新数据
                    await loadRoles();

                    // 返回主页并刷新角色列表
                    backToHome();
                    renderRoles(roles);
                } else {
                    // 创建失败
                    alert(data.message || '角色创建失败');
                }
            } catch (error) {
                console.error('创建角色错误:', error);
                alert('创建失败：' + (error.message || '网络错误，请稍后重试'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '创建角色';
            }
        }

        // 选择角色
        async function selectRole(roleId) {
            if (!isLoggedIn) {
                setPendingAction('selectRole', { roleId: roleId });
                showAuthModal();
                return;
            }

            // 直接导航到聊天页面
            startChatWithRole(roleId);
        }

        // 打开对话
        async function openChat(roleId) {
            if (!isLoggedIn) {
                setPendingAction('openChat', { roleId: roleId });
                showAuthModal();
                return;
            }

            try {
                // 确保角色列表已加载
                if (roles.length === 0) {
                    await loadRoles();
                }

                showChatPage(roleId);
            } catch (error) {
                console.error('打开对话失败:', error);
                alert('打开对话失败: ' + error.message);
            }
        }

        // 直接打开聊天（用于登录后自动执行）
        async function openChatDirect(roleId) {
            try {
                // 确保角色列表已加载
                if (roles.length === 0) {
                    await loadRoles();
                }

                showChatPage(roleId);
            } catch (error) {
                console.error('打开对话失败:', error);
                alert('打开对话失败: ' + error.message);
            }
        }

        // 登录功能
        function login() {
            showAuthModal();
        }

        // 显示认证模态框
        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // 关闭认证模态框
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            resetForms();
        }

        // 切换登录/注册标签
        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
            resetForms();
        }

        // 重置表单
        function resetForms() {
            // 重置登录表单
            document.getElementById('loginForm').reset();
            clearErrors(['loginUsernameError', 'loginPasswordError']);

            // 重置注册表单
            document.getElementById('registerForm').reset();
            clearErrors(['registerUsernameError', 'registerPasswordError', 'confirmPasswordError']);

            // 重置头像选择
            selectedAvatar = '👤';
            selectedAvatarType = 'default';
            customAvatarFile = null;
            updateAvatarPreview();
            hideDefaultAvatars();
        }

        // 清除错误信息
        function clearErrors(errorIds) {
            errorIds.forEach(id => {
                const errorElement = document.getElementById(id);
                errorElement.textContent = '';
                errorElement.classList.remove('show');

                const input = errorElement.previousElementSibling;
                if (input && (input.classList.contains('form-input') || input.classList.contains('role-textarea'))) {
                    input.classList.remove('error');
                }
            });
        }

        // 显示错误信息
        function showError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            const input = errorElement.previousElementSibling;

            errorElement.textContent = message;
            errorElement.classList.add('show');
            if (input) {
                input.classList.add('error');
            }
        }

        // 头像相关函数
        function selectDefaultAvatar() {
            const defaultAvatars = document.getElementById('defaultAvatars');
            defaultAvatars.style.display = defaultAvatars.style.display === 'none' ? 'grid' : 'none';
        }

        function hideDefaultAvatars() {
            document.getElementById('defaultAvatars').style.display = 'none';
        }

        function chooseDefaultAvatar(avatar) {
            selectedAvatar = avatar;
            selectedAvatarType = 'default';
            customAvatarFile = null;
            updateAvatarPreview();
            hideDefaultAvatars();

            // 更新选中状态
            document.querySelectorAll('.default-avatar').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-avatar="${avatar}"]`).classList.add('selected');
        }

        function uploadAvatar() {
            document.getElementById('avatarInput').click();
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            console.log('选择的文件:', file);
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB限制
                    alert('头像文件大小不能超过5MB');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('请选择图片文件');
                    return;
                }

                customAvatarFile = file;
                selectedAvatarType = 'custom';

                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedAvatar = e.target.result;
                    updateAvatarPreview();
                };
                reader.readAsDataURL(file);
                hideDefaultAvatars();
            }
        }

        function updateAvatarPreview() {
            const preview = document.getElementById('avatarPreview');
            if (selectedAvatarType === 'custom') {
                preview.innerHTML = `<img src="${selectedAvatar}" alt="头像预览">`;
            } else {
                // 为默认头像显示表情符号，但存储时会转换为base64
                preview.innerHTML = `<div class="avatar-preview-text">${selectedAvatar}</div>`;
            }
        }

        // 表单验证
        function validateLogin() {
            let isValid = true;
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            clearErrors(['loginUsernameError', 'loginPasswordError']);

            if (!username) {
                showError('loginUsernameError', '请输入用户名');
                isValid = false;
            }

            if (!password) {
                showError('loginPasswordError', '请输入密码');
                isValid = false;
            }

            return isValid;
        }

        function validateRegister() {
            let isValid = true;
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            clearErrors(['registerUsernameError', 'registerPasswordError', 'confirmPasswordError']);

            if (!username) {
                showError('registerUsernameError', '请输入用户名');
                isValid = false;
            } else if (username.length < 3) {
                showError('registerUsernameError', '用户名至少3个字符');
                isValid = false;
            } else if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(username)) {
                showError('registerUsernameError', '用户名只能包含字母、数字、下划线和中文');
                isValid = false;
            }

            if (!password) {
                showError('registerPasswordError', '请输入密码');
                isValid = false;
            } else if (password.length < 6) {
                showError('registerPasswordError', '密码至少6个字符');
                isValid = false;
            }

            if (!confirmPassword) {
                showError('confirmPasswordError', '请确认密码');
                isValid = false;
            } else if (password !== confirmPassword) {
                showError('confirmPasswordError', '两次输入的密码不一致');
                isValid = false;
            }

            return isValid;
        }

        // 处理登录
        async function handleLogin(event) {
            event.preventDefault();

            if (!validateLogin()) return;

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            const submitBtn = document.getElementById('loginSubmit');
            submitBtn.disabled = true;
            submitBtn.textContent = '登录中...';

            try {
                const hashedPassword = await hashPassword(password);

                // 发送登录请求
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: hashedPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // 登录成功
                    localStorage.setItem('authToken', data.token);
                    isLoggedIn = true;
                    currentUser = {
                        id: data.user_id,
                        name: data.username,
                        avatar: data.avatar
                    };

                    updateUserInfo();
                    closeAuthModal();

                    // 重新加载角色列表
                    await loadRoles();
                    renderRoles(roles);

                    // 加载最近对话
                    await loadRecentChats();

                    // 执行登录后的待处理操作
                    executePendingAction();

                    alert('登录成功！');
                } else {
                    // 登录失败
                    showError('loginPasswordError', '登录失败，请检查用户名和密码');
                }
            } catch (error) {
                console.error('登录错误:', error);
                showError('loginPasswordError', '网络错误，请稍后重试');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '登录';
            }
        }

        // 处理注册
        async function handleRegister(event) {
            event.preventDefault();

            if (!validateRegister()) return;

            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            const submitBtn = document.getElementById('registerSubmit');
            submitBtn.disabled = true;
            submitBtn.textContent = '注册中...';

            try {
                const hashedPassword = await hashPassword(password);

                // 第一步：上传头像
                let avatarUrl;
                if (selectedAvatarType === 'custom' && customAvatarFile) {
                    // 上传自定义头像
                    submitBtn.textContent = '上传头像中...';
                    avatarUrl = await uploadCustomAvatar(customAvatarFile);
                } else {
                    // 上传默认头像（转换为blob后上传）
                    submitBtn.textContent = '生成头像中...';
                    avatarUrl = await uploadDefaultAvatar(selectedAvatar);
                }

                // 第二步：注册用户
                submitBtn.textContent = '创建账户中...';
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: hashedPassword,
                        avatar: avatarUrl
                    })
                });

                if (response.ok) {
                    // 注册成功
                    alert('注册成功！请登录');

                    // 切换到登录标签
                    switchTab('login');

                    // 预填用户名
                    document.getElementById('loginUsername').value = username;
                } else {
                    // 注册失败
                    const errorText = await response.text().catch(() => '');

                    // 检查是否是用户名已存在的错误
                    if (errorText.includes('User already exists') || errorText.includes('用户已存在')) {
                        showError('registerUsernameError', '该用户名已被注册');
                    } else {
                        showError('registerPasswordError', errorText || '注册失败，请稍后重试');
                    }
                }
            } catch (error) {
                console.error('注册错误:', error);
                showError('registerPasswordError', '网络错误，请稍后重试');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '注册';
            }
        }

        // 上传自定义头像
        async function uploadCustomAvatar(file) {
            const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                    'X-File-Name': file.name,
                    'Content-Type': file.type || 'application/octet-stream'
                },
                body: file
            });

            if (!response.ok) {
                throw new Error('头像上传失败');
            }

            const data = await response.json();
            return data.file_url;
        }

        // 上传默认头像
        async function uploadDefaultAvatar(emoji) {
            // 生成默认头像的Blob
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 200;

            // 设置背景
            const gradient = ctx.createLinearGradient(0, 0, 200, 200);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 200, 200);

            // 绘制emoji
            ctx.font = '120px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(emoji, 100, 100);

            // 转换为Blob
            return new Promise((resolve, reject) => {
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        reject(new Error('头像生成失败'));
                        return;
                    }

                    try {
                        const fileName = `default_avatar_${emoji.codePointAt(0)}.png`;
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            headers: {
                                'X-File-Name': fileName,
                                'Content-Type': 'image/png'
                            },
                            body: blob
                        });

                        if (!response.ok) {
                            throw new Error('默认头像上传失败');
                        }

                        const data = await response.json();
                        resolve(data.file_url);
                    } catch (error) {
                        reject(error);
                    }
                }, 'image/png');
            });
        }        // 绑定表单提交事件
        document.addEventListener('DOMContentLoaded', function () {
            initPage();

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('roleForm').addEventListener('submit', handleRoleCreate);

            // 初始化懒加载滚动监听
            initScrollListeners();

            // 消息输入框事件监听
            const messageInput = document.getElementById('messageInputNew');
            if (messageInput) {
                messageInput.addEventListener('input', function () {
                    adjustTextareaHeight(this);
                });
                messageInput.addEventListener('keydown', handleInputKeydown);
            }

            // 注册用户名输入框事件监听 - 清除错误提示
            const registerUsernameInput = document.getElementById('registerUsername');
            if (registerUsernameInput) {
                registerUsernameInput.addEventListener('input', function () {
                    clearErrors(['registerUsernameError']);
                });
            }

            // 点击模态框外部关闭
            document.getElementById('authModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeAuthModal();
                }
            });

            // 点击其他地方关闭用户下拉菜单
            document.addEventListener('click', function (event) {
                const userInfo = document.getElementById('userInfo');
                const dropdown = document.getElementById('userDropdown');

                if (userInfo && dropdown && !userInfo.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // ESC键关闭模态框
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    if (document.getElementById('authModal').classList.contains('active')) {
                        closeAuthModal();
                    }
                }
            });
        });

        // ====== 对话相关API ======

        // 创建与角色的对话
        async function createConversation(roleId) {
            try {
                const response = await fetch('/api/conversation/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        user_id: parseInt(currentUser.id),
                        role_id: parseInt(roleId)
                    })
                });

                if (!response.ok) {
                    throw new Error('创建对话失败');
                }
            } catch (error) {
                console.error('创建对话错误:', error);
                // 不抛出错误，因为对话可能已经存在
            }
        }

        // 获取用户的对话列表（懒加载版本）
        async function loadRecentChats(append = false) {
            if (lazyLoadState.conversations.loading || !currentUser?.id) return;

            try {
                lazyLoadState.conversations.loading = true;

                if (!append) {
                    lazyLoadState.conversations.offset = 0;
                    lazyLoadState.conversations.hasMore = true;
                }

                if (!lazyLoadState.conversations.hasMore) {
                    lazyLoadState.conversations.loading = false;
                    return;
                }

                const url = `/api/conversation/list?user_id=${parseInt(currentUser.id)}&offset=${lazyLoadState.conversations.offset}&limit=${lazyLoadState.conversations.limit}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取对话列表失败');
                }

                const data = await response.json();
                console.log('对话列表数据:', data);

                if (data && data.items && Array.isArray(data.items)) {
                    lazyLoadState.conversations.total = data.total;
                    lazyLoadState.conversations.hasMore = data.has_more;
                    lazyLoadState.conversations.offset += lazyLoadState.conversations.limit;

                    await renderRecentChats(data.items, append);
                }
            } catch (error) {
                console.error('加载最近对话错误:', error);
            } finally {
                lazyLoadState.conversations.loading = false;
            }
        }

        // 渲染最近对话列表
        async function renderRecentChats(roleIds, append = false) {
            const chatListElement = document.getElementById('chatList');

            if (!append && roleIds.length === 0) {
                chatListElement.innerHTML = '<div class="no-chats">还没有对话记录</div>';
                return;
            }

            // 确保角色列表已加载
            if (roles.length === 0) {
                await loadRoles();
            }

            const chatItems = roleIds.map(roleId => {
                const role = roles.find(r => String(r.id) === String(roleId));
                if (!role) return '';

                // 判断头像格式
                let avatarHtml;
                if (role.image_url && (role.image_url.startsWith('http') || role.image_url.startsWith('/'))) {
                    avatarHtml = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else if (role.image_url && role.image_url.startsWith('data:image')) {
                    avatarHtml = `<img src="${role.image_url}" alt="${role.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    avatarHtml = role.image_url || '🎭';
                }

                return `
                    <div class="chat-item" onclick="openChat('${role.id}')">
                        <div class="chat-avatar">${avatarHtml}</div>
                        <div class="chat-info">
                            <div class="chat-name">${role.name}</div>
                            <div class="chat-preview">点击开始对话</div>
                        </div>
                        <div class="chat-delete" onclick="event.stopPropagation(); deleteConversation(${currentUser.id}, ${role.id})" title="删除对话">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"></polyline>
                                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </div>
                    </div>
                `;
            }).filter(item => item).join('');

            if (append) {
                chatListElement.innerHTML += chatItems;
            } else {
                chatListElement.innerHTML = chatItems;
            }
        }

        // 更新最近对话列表排序（在有新消息时调用）
        async function updateRecentChatsList() {
            if (!isLoggedIn || !currentUser?.id) {
                return;
            }

            console.log('更新最近对话列表排序');

            // 重新加载最近对话列表（这会按照最新的last_dialog_timestamp排序）
            try {
                await loadRecentChats(false); // false表示不是追加，而是重新加载
            } catch (error) {
                console.error('更新最近对话列表失败:', error);
            }
        }

        // 获取对话的聊天记录（懒加载版本）
        async function loadChatDialogs(roleId, append = false) {
            if (lazyLoadState.dialogs.loading || !currentUser?.id) return [];

            try {
                lazyLoadState.dialogs.loading = true;

                if (!append) {
                    lazyLoadState.dialogs.offset = 0;
                    lazyLoadState.dialogs.hasMore = true;
                }

                if (!lazyLoadState.dialogs.hasMore) {
                    lazyLoadState.dialogs.loading = false;
                    return [];
                }

                const url = `/api/conversation/dialogs?user_id=${parseInt(currentUser.id)}&role_id=${parseInt(roleId)}&offset=${lazyLoadState.dialogs.offset}&limit=${lazyLoadState.dialogs.limit}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取聊天记录失败');
                }

                const data = await response.json();
                console.log('聊天记录数据:', data);

                if (data && data.items && Array.isArray(data.items)) {
                    lazyLoadState.dialogs.total = data.total;
                    lazyLoadState.dialogs.hasMore = data.has_more;
                    lazyLoadState.dialogs.offset += lazyLoadState.dialogs.limit;

                    const dialogs = data.items.map(dialog => ({
                        id: ++messageIdCounter,
                        sender: dialog.is_user ? 'user' : 'role',
                        message: dialog.text,
                        timestamp: dialog.timestamp,
                        voice: dialog.voice
                    }));

                    return dialogs;
                } else {
                    return [];
                }
            } catch (error) {
                console.error('加载聊天记录错误:', error);
                return [];
            } finally {
                lazyLoadState.dialogs.loading = false;
            }
        }

        // ====== 聊天相关功能 ======

        let currentChatRole = null; // 当前聊天的角色
        let chatMessages = []; // 聊天消息历史

        // 显示聊天页面
        function showChatPage(roleId) {
            console.log('显示聊天页面，接收到的角色ID:', roleId);
            currentPage = 'chat';
            currentChatRoleId = roleId;

            // 隐藏其他页面
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content-area').style.display = 'none';
            document.getElementById('createRolePage').classList.remove('active');

            // 显示新的聊天页面
            document.getElementById('chatPageNew').classList.add('active');

            if (roleId) {
                // 如果指定了角色ID，加载该角色的聊天
                console.log('调用loadChatRole，角色ID:', roleId);
                loadChatRole(roleId);
            } else {
                // 否则显示默认状态
                resetChatPage();
            }

            // 只在当前URL不匹配时才更新锚点
            const expectedHash = roleId ? `#chat/${roleId}` : '#chat';
            if (window.location.hash !== expectedHash) {
                updateUrlHash();
            }
        }

        // 加载聊天角色
        async function loadChatRole(roleId) {
            try {
                console.log('尝试加载角色ID:', roleId, '类型:', typeof roleId);
                console.log('当前角色列表:', roles);

                // 确保ID都是字符串格式进行比较
                const targetId = String(roleId);
                const role = roles.find(r => String(r.id) === targetId);

                if (!role) {
                    console.error('角色不存在，目标ID:', targetId);
                    console.error('可用角色ID列表:', roles.map(r => String(r.id)));
                    throw new Error(`角色不存在，ID: ${targetId}`);
                }

                currentChatRole = role;
                console.log('成功加载角色:', role);

                // 更新聊天头部 - 只显示角色名
                const nameElement = document.getElementById('currentRoleNameNew');
                nameElement.textContent = role.name;

                // 重置聊天记录状态
                chatMessages = [];
                lazyLoadState.dialogs.offset = 0;
                lazyLoadState.dialogs.hasMore = true;

                // 加载历史聊天记录（第一页）
                const firstPageMessages = await loadChatDialogs(roleId, false);
                chatMessages = firstPageMessages;
                renderChatMessages();

                // 启用输入框
                enableChatInput();

                // Socket.IO会自动将用户加入socket.id房间，无需手动加入

            } catch (error) {
                console.error('加载角色失败:', error);
                alert('加载角色失败: ' + error.message);
            }
        }

        // 重置聊天页面
        function resetChatPage() {
            currentChatRole = null;
            chatMessages = [];

            // 重置头部 - 只更新角色名
            document.getElementById('currentRoleNameNew').textContent = '选择一个角色开始对话';

            // 显示空状态
            showChatEmpty();

            // 禁用输入框
            disableChatInput();
        }

        // 渲染聊天消息
        function renderChatMessages() {
            const container = document.getElementById('chatMessagesNew');
            const emptyDiv = document.getElementById('chatEmptyNew');

            if (chatMessages.length === 0) {
                showChatEmpty();
                return;
            }

            // 隐藏空状态
            emptyDiv.style.display = 'none';

            container.innerHTML = chatMessages.map(message => {
                const isUser = message.sender === 'user';
                let avatarHtml;

                if (isUser) {
                    // 用户头像处理
                    if (currentUser.avatar) {
                        if (isEmoji(currentUser.avatar)) {
                            avatarHtml = currentUser.avatar;
                        } else {
                            avatarHtml = `<img src="${currentUser.avatar}" alt="${currentUser.name}">`;
                        }
                    } else {
                        avatarHtml = '👤';
                    }
                } else {
                    // 角色头像处理
                    if (currentChatRole.image_url) {
                        if (isEmoji(currentChatRole.image_url)) {
                            avatarHtml = currentChatRole.image_url;
                        } else {
                            avatarHtml = `<img src="${currentChatRole.image_url}" alt="${currentChatRole.name}">`;
                        }
                    } else {
                        avatarHtml = '🎭';
                    }
                }

                // 消息内容，支持文本和语音
                let messageContent = `<div class="message-text">${message.message}</div>`;
                let hasVoiceClass = '';
                if (message.voice) {
                    hasVoiceClass = ' has-voice'; // 添加CSS类标识
                    messageContent += `
                        <div class="message-voice">
                            <audio controls preload="metadata">
                                <source src="${message.voice}" type="audio/mpeg">
                                您的浏览器不支持音频播放。
                            </audio>
                        </div>
                    `;
                }

                // 添加时间戳显示
                const timestampText = formatTimestamp(message.timestamp);
                if (timestampText) {
                    messageContent += `<div class="message-timestamp">${timestampText}</div>`;
                }

                return `
                    <div class="message ${isUser ? 'user' : 'role'}${hasVoiceClass}">
                        <div class="message-avatar ${isUser ? 'user' : 'role'}">${avatarHtml}</div>
                        <div class="message-content${hasVoiceClass}">${messageContent}</div>
                    </div>
                `;
            }).join('') + '<div id="chatEmptyNew" style="display: none;"></div>';

            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        // 显示聊天空状态
        function showChatEmpty() {
            const container = document.getElementById('chatMessagesNew');

            // 清空消息
            container.innerHTML = `
                <div class="chat-empty" id="chatEmptyNew">
                    <div class="chat-empty-icon">💬</div>
                    <div class="chat-empty-text">${currentChatRole ? '开始与 ' + currentChatRole.name + ' 对话吧！' : '还没有聊天记录'}</div>
                    <div class="chat-empty-hint">${currentChatRole ? '输入消息开始有趣的角色扮演' : '选择一个角色开始有趣的对话吧！'}</div>
                </div>
            `;
        }

        // 启用聊天输入
        function enableChatInput() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            input.disabled = false;
            input.placeholder = '输入消息...';
            checkSendButton();
        }

        // 禁用聊天输入
        function disableChatInput() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            input.disabled = true;
            input.placeholder = '请先选择一个角色...';
            sendBtn.disabled = true;
        }

        // 发送消息
        async function sendMessage() {
            if (!currentChatRole) {
                alert('请先选择一个角色');
                return;
            }

            if (!isLoggedIn) {
                alert('请先登录');
                return;
            }

            const input = document.getElementById('messageInputNew');
            const message = input.value.trim();

            if (!message) {
                return;
            }

            // 添加用户消息到界面
            chatMessages.push({
                id: ++messageIdCounter, // 为文本消息也添加ID
                sender: 'user',
                message: message,
                timestamp: Math.floor(Date.now() / 1000)
            });

            // 清空输入框
            input.value = '';
            input.style.height = 'auto';
            checkSendButton();

            // 重新渲染消息
            renderChatMessages();

            // 显示"正在回复"状态
            showTypingIndicator();

            // 通过Socket.IO发送消息到后端
            sendSocketMessage(currentUser.id, currentChatRole.id, message);
        }

        // 处理输入框键盘事件
        function handleInputKeydown(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    // Shift+Enter 换行
                    return;
                } else {
                    // Enter 发送消息
                    event.preventDefault();
                    sendMessage();
                }
            }
        }

        // 自动调整输入框高度
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

            // 检查发送按钮状态
            checkSendButton();
        }

        // 检查发送按钮状态
        function checkSendButton() {
            const input = document.getElementById('messageInputNew');
            const sendBtn = document.getElementById('sendBtnNew');

            if (currentChatRole && input.value.trim()) {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = true;
            }
        }

        // 语音录制相关变量
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let messageIdCounter = 0; // 消息ID计数器

        // 语音输入功能
        async function startVoiceInput() {
            if (!currentChatRole) {
                alert('请先选择一个角色');
                return;
            }

            if (!isLoggedIn) {
                alert('请先登录');
                return;
            }

            if (isRecording) {
                // 如果正在录音，停止录音
                stopRecording();
            } else {
                // 开始录音
                await startRecording();
            }
        }

        // 开始录制语音
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // 检查浏览器支持的音频格式
                let mimeType = 'audio/mp4'; // 默认使用mp4格式，比webm更接近mp3
                if (MediaRecorder.isTypeSupported('audio/mpeg')) {
                    mimeType = 'audio/mpeg';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                } else if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus'; // 备用方案
                }

                console.log('使用音频格式:', mimeType);

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });

                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await uploadAndSendVoice(audioBlob);

                    // 停止所有音频流
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                updateVoiceButton();

                console.log('开始录音...');
            } catch (error) {
                console.error('无法访问麦克风:', error);
                alert('无法访问麦克风，请检查权限设置');
            }
        }

        // 停止录制语音
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                updateVoiceButton();
                console.log('停止录音...');
            }
        }

        // 更新语音按钮状态
        function updateVoiceButton() {
            const voiceBtn = document.getElementById('voiceBtnNew');
            if (isRecording) {
                voiceBtn.innerHTML = '⏹️';
                voiceBtn.title = '点击停止录音';
                voiceBtn.style.backgroundColor = '#ff4757';
            } else {
                voiceBtn.innerHTML = '🎤';
                voiceBtn.title = '点击录制语音';
                voiceBtn.style.backgroundColor = '';
            }
        }

        // 上传语音并发送消息
        async function uploadAndSendVoice(audioBlob) {
            try {
                console.log('开始上传语音文件，大小:', audioBlob.size);

                // 检查登录状态和角色
                if (!currentUser || !currentChatRole) {
                    throw new Error('用户未登录或未选择角色');
                }

                // 上传语音文件
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'X-File-Name': `voice_${Date.now()}.mp3`,
                        'Content-Type': 'audio/mpeg'
                    },
                    body: audioBlob
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`语音上传失败: ${response.status} ${errorText}`);
                }

                const uploadData = await response.json();
                console.log('上传响应:', uploadData);

                if (!uploadData.file_url) {
                    throw new Error('上传响应中缺少file_url');
                }

                const voiceUrl = uploadData.file_url;
                console.log('语音上传成功，URL:', voiceUrl);

                // 生成消息ID
                messageIdCounter++;
                const messageId = messageIdCounter;

                // 添加用户语音消息到界面（显示为"[正在将语音转换成文字]"）
                chatMessages.push({
                    id: messageId,
                    sender: 'user',
                    message: '[正在将语音转换成文字]',
                    timestamp: Math.floor(Date.now() / 1000),
                    voice: voiceUrl
                });

                // 重新渲染消息
                renderChatMessages();

                // 通过Socket发送语音消息到后端
                sendVoiceMessage(currentUser.id, currentChatRole.id, voiceUrl, messageId);

            } catch (error) {
                console.error('语音处理失败:', error);
                alert('语音发送失败: ' + error.message);
            }
        }

        // 显示"正在回复"状态
        function showTypingIndicator() {
            const roleNameElement = document.getElementById('currentRoleNameNew');
            if (roleNameElement && currentChatRole) {
                roleNameElement.innerHTML = `${currentChatRole.name} <span style="font-size: 12px; color: #7f8c8d; font-weight: normal;">正在回复</span>`;
            }
        }

        // 隐藏"正在回复"状态
        function hideTypingIndicator() {
            const roleNameElement = document.getElementById('currentRoleNameNew');
            if (roleNameElement && currentChatRole) {
                roleNameElement.textContent = currentChatRole.name;
            }
        }

        // 播放语音
        function playVoice(voiceUrl) {
            try {
                const audio = new Audio(voiceUrl);
                audio.play().catch(error => {
                    console.error('语音播放失败:', error);
                });
            } catch (error) {
                console.error('创建音频对象失败:', error);
            }
        }

        // 删除对话
        async function deleteConversation(userId, roleId) {
            if (!confirm('确定要删除这个对话吗？删除后将无法恢复！')) {
                return;
            }

            try {
                const response = await fetch(`/api/conversation/delete/${userId}/${roleId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('删除对话失败');
                }

                console.log('对话删除成功');

                // 如果删除的是当前正在聊天的对话，则清空聊天界面
                if (currentChatRole && currentChatRole.id === roleId) {
                    currentChatRole = null;
                    chatMessages = [];
                    renderChatMessages();

                    // 隐藏聊天界面，显示主页
                    const chatPageNew = document.getElementById('chatPageNew');
                    const mainPage = document.querySelector('.main-page');
                    if (chatPageNew) chatPageNew.style.display = 'none';
                    if (mainPage) mainPage.style.display = 'block';
                }

                // 重新加载最近对话列表
                await loadRecentChats();

                alert('对话删除成功');
            } catch (error) {
                console.error('删除对话错误:', error);
                alert('删除对话失败：' + error.message);
            }
        }

        // 删除角色
        async function deleteRole(roleId) {
            if (!confirm('确定要删除这个角色吗？删除后将无法恢复！')) {
                return;
            }

            if (!currentUser?.id) {
                alert('请先登录');
                return;
            }

            try {
                const response = await fetch(`/api/role/delete/${roleId}/${currentUser.id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('删除角色失败');
                }

                console.log('角色删除成功');

                // 如果删除的是当前正在聊天的角色，则清空聊天界面
                if (currentChatRole && currentChatRole.id === parseInt(roleId)) {
                    currentChatRole = null;
                    chatMessages = [];
                    renderChatMessages();

                    // 隐藏聊天界面，显示主页
                    const chatPageNew = document.getElementById('chatPageNew');
                    const mainPage = document.querySelector('.main-page');
                    if (chatPageNew) chatPageNew.style.display = 'none';
                    if (mainPage) mainPage.style.display = 'block';
                }

                // 重新加载角色列表
                await loadRoles();

                // 重新加载最近对话列表（删除角色可能会影响对话列表）
                await loadRecentChats();

                alert('角色删除成功');
            } catch (error) {
                console.error('删除角色错误:', error);
                alert('删除角色失败：' + error.message);
            }
        }

        // 修改现有的角色卡片点击事件，添加聊天功能
        async function startChatWithRole(roleId) {
            console.log('开始聊天，角色ID:', roleId);
            console.log('当前登录状态:', isLoggedIn);

            if (!isLoggedIn) {
                setPendingAction('startChatWithRole', { roleId: roleId });
                showAuthModal();
                return;
            }

            try {
                // 创建与角色的对话（如果不存在）
                await createConversation(roleId);

                // 确保角色列表已加载
                if (roles.length === 0) {
                    console.log('角色列表为空，重新加载...');
                    await loadRoles();
                }

                console.log('当前roles数组:', roles);
                showChatPage(roleId);

                // 更新最近对话列表
                await loadRecentChats();
            } catch (error) {
                console.error('启动对话失败:', error);
                alert('启动对话失败: ' + error.message);
            }
        }

        // 修改backToHome函数，支持从聊天页面返回
        function backToHome() {
            currentPage = 'home';
            currentChatRoleId = null;

            document.querySelector('.header').style.display = 'flex';
            document.querySelector('.content-area').style.display = 'block';
            document.getElementById('createRolePage').classList.remove('active');
            document.getElementById('chatPageNew').classList.remove('active');

            // 只在当前URL不是home时才更新锚点，避免无限循环
            if (window.location.hash !== '#home') {
                updateUrlHash();
            }
        }
    </script>
</body>

</html>